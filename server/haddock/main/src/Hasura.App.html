<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hasura.App</span><span>
</span><span id="line-4"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.App.html#ExitCode"><span class="hs-identifier">ExitCode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#DatabaseMigrationError"><span class="hs-identifier">DatabaseMigrationError</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.App.html#DowngradeProcessError"><span class="hs-identifier">DowngradeProcessError</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.App.html#MetadataCleanError"><span class="hs-identifier">MetadataCleanError</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.App.html#MetadataExportError"><span class="hs-identifier">MetadataExportError</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.App.html#SchemaCacheInitError"><span class="hs-identifier">SchemaCacheInitError</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-5"></span><span>    </span><span class="annot"><a href="Hasura.App.html#ExitException"><span class="hs-identifier">ExitException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#ExitException"><span class="hs-identifier">ExitException</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="Hasura.App.html#GlobalCtx"><span class="hs-identifier">GlobalCtx</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Hasura.App.html#Loggers"><span class="hs-identifier">Loggers</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Hasura.App.html#PGMetadataStorageAppT"><span class="hs-identifier">PGMetadataStorageAppT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#runPGMetadataStorageAppT"><span class="hs-identifier">runPGMetadataStorageAppT</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Hasura.App.html#ServeCtx"><span class="hs-identifier">ServeCtx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#ServeCtx"><span class="hs-identifier">ServeCtx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.App.html#_scLoggers"><span class="hs-identifier">_scLoggers</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.App.html#_scMetadataDbPool"><span class="hs-identifier">_scMetadataDbPool</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.App.html#_scShutdownLatch"><span class="hs-identifier">_scShutdownLatch</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Hasura.App.html#ShutdownLatch"><span class="hs-identifier">ShutdownLatch</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Hasura.App.html#accessDeniedErrMsg"><span class="hs-identifier">accessDeniedErrMsg</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Hasura.App.html#flushLogger"><span class="hs-identifier">flushLogger</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Hasura.App.html#getCatalogStateTx"><span class="hs-identifier">getCatalogStateTx</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Hasura.App.html#initGlobalCtx"><span class="hs-identifier">initGlobalCtx</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><a href="Hasura.App.html#initialiseServeCtx"><span class="hs-identifier">initialiseServeCtx</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Hasura.App.html#migrateCatalogSchema"><span class="hs-identifier">migrateCatalogSchema</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><a href="Hasura.App.html#mkLoggers"><span class="hs-identifier">mkLoggers</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="Hasura.App.html#mkPGLogger"><span class="hs-identifier">mkPGLogger</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="Hasura.App.html#newShutdownLatch"><span class="hs-identifier">newShutdownLatch</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="Hasura.App.html#notifySchemaCacheSyncTx"><span class="hs-identifier">notifySchemaCacheSyncTx</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><a href="Hasura.App.html#parseArgs"><span class="hs-identifier">parseArgs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>    </span><span class="annot"><a href="Hasura.App.html#printErrExit"><span class="hs-identifier">printErrExit</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><a href="Hasura.App.html#printErrJExit"><span class="hs-identifier">printErrJExit</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><a href="Hasura.App.html#printJSON"><span class="hs-identifier">printJSON</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><a href="Hasura.App.html#printYaml"><span class="hs-identifier">printYaml</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><a href="Hasura.App.html#readTlsAllowlist"><span class="hs-identifier">readTlsAllowlist</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><a href="Hasura.App.html#resolvePostgresConnInfo"><span class="hs-identifier">resolvePostgresConnInfo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><a href="Hasura.App.html#runHGEServer"><span class="hs-identifier">runHGEServer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><a href="Hasura.App.html#setCatalogStateTx"><span class="hs-identifier">setCatalogStateTx</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><a href="Hasura.App.html#shutdownGracefully"><span class="hs-identifier">shutdownGracefully</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Exported for testing</span></span><span>
</span><span id="line-33"></span><span>    </span><span class="annot"><a href="Hasura.App.html#mkHGEServer"><span class="hs-identifier">mkHGEServer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>    </span><span class="annot"><a href="Hasura.App.html#mkPgSourceResolver"><span class="hs-identifier">mkPgSourceResolver</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>    </span><span class="annot"><a href="Hasura.App.html#mkMSSQLSourceResolver"><span class="hs-identifier">mkMSSQLSourceResolver</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">where</span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Async.Lifted.Safe</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LA</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Control.Concurrent.Extended.html"><span class="hs-identifier">Control.Concurrent.Extended</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">STM</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM.TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">readTVarIO</span></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">bracket_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">throwIO</span></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Catch</span></span><span>
</span><span id="line-45"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Exception</span></span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span>    </span><span class="annot"><span class="hs-identifier">MonadCatch</span></span><span class="hs-special">,</span><span>
</span><span id="line-47"></span><span>    </span><span class="annot"><span class="hs-identifier">MonadMask</span></span><span class="hs-special">,</span><span>
</span><span id="line-48"></span><span>    </span><span class="annot"><span class="hs-identifier">MonadThrow</span></span><span class="hs-special">,</span><span>
</span><span id="line-49"></span><span>    </span><span class="annot"><span class="hs-identifier">onException</span></span><span class="hs-special">,</span><span>
</span><span id="line-50"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Morph</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">hoist</span></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.STM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">atomically</span></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Control.Monad.Stateless.html"><span class="hs-identifier">Control.Monad.Stateless</span></a></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Control</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadBaseControl</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Control.Monad.Trans.Managed.html"><span class="hs-identifier">Control.Monad.Trans.Managed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Monad.Trans.Managed.html#ManagedT"><span class="hs-identifier">ManagedT</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Monad.Trans.Managed.html#allocate_"><span class="hs-identifier">allocate_</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">A</span></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Char8</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BC</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Lazy.Char8</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BLC</span></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Environment.html"><span class="hs-identifier">Data.Environment</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Env</span></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.FileEmbed</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">makeRelativeToProject</span></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HM</span></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.IORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">readIORef</span></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Time.Clock</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">UTCTime</span></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Time.Clock</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Clock</span></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Yaml</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Y</span></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Database.PG.Query</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Q</span></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.AssertNF.CPP.html"><span class="hs-identifier">GHC.AssertNF.CPP</span></a></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html"><span class="hs-identifier">Hasura.Backends.MSSQL.Connection</span></a></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.html"><span class="hs-identifier">Hasura.Backends.Postgres.Connection</span></a></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Eventing.Common.html"><span class="hs-identifier">Hasura.Eventing.Common</span></a></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Eventing.EventTrigger.html"><span class="hs-identifier">Hasura.Eventing.EventTrigger</span></a></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Eventing.ScheduledTrigger.html"><span class="hs-identifier">Hasura.Eventing.ScheduledTrigger</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.html"><span class="hs-identifier">Hasura.GraphQL.Execute</span></a></span><span>
</span><span id="line-76"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Backend.html#ExecutionStep"><span class="hs-identifier">ExecutionStep</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-77"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Common.html#MonadGQLExecutionCheck"><span class="hs-identifier">MonadGQLExecutionCheck</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-78"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.html#checkQueryInAllowlist"><span class="hs-identifier">checkQueryInAllowlist</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-79"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Action.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Action</span></a></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Action.Subscription.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Action.Subscription</span></a></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Backend.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Backend</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">EB</span></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html"><span class="hs-identifier">Hasura.GraphQL.Execute.LiveQuery.Poll</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">EL</span></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Logging.html"><span class="hs-identifier">Hasura.GraphQL.Logging</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Logging.html#MonadQueryLog"><span class="hs-identifier">MonadQueryLog</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.html"><span class="hs-identifier">Hasura.GraphQL.Transport.HTTP</span></a></span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.html#CacheStoreSuccess"><span class="hs-identifier">CacheStoreSuccess</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.html#CacheStoreSkipped"><span class="hs-identifier">CacheStoreSkipped</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-87"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.html#MonadExecuteQuery"><span class="hs-identifier">MonadExecuteQuery</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-88"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html"><span class="hs-identifier">Hasura.GraphQL.Transport.HTTP.Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#toParsed"><span class="hs-identifier">toParsed</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Server.html"><span class="hs-identifier">Hasura.GraphQL.Transport.WebSocket.Server</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">WS</span></span><span>
</span><span id="line-91"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Logging.html"><span class="hs-identifier">Hasura.Logging</span></a></span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Metadata.Class.html"><span class="hs-identifier">Hasura.Metadata.Class</span></a></span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Prelude.html"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-94"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.QueryTags.html"><span class="hs-identifier">Hasura.QueryTags</span></a></span><span>
</span><span id="line-95"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema.Cache</span></a></span><span>
</span><span id="line-96"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema.Cache.Common</span></a></span><span>
</span><span id="line-97"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Catalog.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema.Catalog</span></a></span><span>
</span><span id="line-98"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.html"><span class="hs-identifier">Hasura.RQL.Types</span></a></span><span>
</span><span id="line-99"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Eventing.Backend.html"><span class="hs-identifier">Hasura.RQL.Types.Eventing.Backend</span></a></span><span>
</span><span id="line-100"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.SQL.AnyBackend.html"><span class="hs-identifier">Hasura.SQL.AnyBackend</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AB</span></span><span>
</span><span id="line-101"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.API.Query.html"><span class="hs-identifier">Hasura.Server.API.Query</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.API.Query.html#requiresAdmin"><span class="hs-identifier">requiresAdmin</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-102"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.App.html"><span class="hs-identifier">Hasura.Server.App</span></a></span><span>
</span><span id="line-103"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Auth.html"><span class="hs-identifier">Hasura.Server.Auth</span></a></span><span>
</span><span id="line-104"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.CheckUpdates.html"><span class="hs-identifier">Hasura.Server.CheckUpdates</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.CheckUpdates.html#checkForUpdates"><span class="hs-identifier">checkForUpdates</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Init.html"><span class="hs-identifier">Hasura.Server.Init</span></a></span><span>
</span><span id="line-106"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Limits.html"><span class="hs-identifier">Hasura.Server.Limits</span></a></span><span>
</span><span id="line-107"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Logging.html"><span class="hs-identifier">Hasura.Server.Logging</span></a></span><span>
</span><span id="line-108"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Metrics.html"><span class="hs-identifier">Hasura.Server.Metrics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Metrics.html#ServerMetrics"><span class="hs-identifier">ServerMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Migrate.html"><span class="hs-identifier">Hasura.Server.Migrate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Migrate.html#migrateCatalog"><span class="hs-identifier">migrateCatalog</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.SchemaUpdate.html"><span class="hs-identifier">Hasura.Server.SchemaUpdate</span></a></span><span>
</span><span id="line-111"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Telemetry.html"><span class="hs-identifier">Hasura.Server.Telemetry</span></a></span><span>
</span><span id="line-112"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html"><span class="hs-identifier">Hasura.Server.Types</span></a></span><span>
</span><span id="line-113"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Version.html"><span class="hs-identifier">Hasura.Server.Version</span></a></span><span>
</span><span id="line-114"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Session.html"><span class="hs-identifier">Hasura.Session</span></a></span><span>
</span><span id="line-115"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Tracing.html"><span class="hs-identifier">Hasura.Tracing</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Tracing</span></span><span>
</span><span id="line-116"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP.Client.DynamicTlsPermissions.html"><span class="hs-identifier">Network.HTTP.Client.DynamicTlsPermissions</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP.Client.DynamicTlsPermissions.html#mkHttpManager"><span class="hs-identifier">mkHttpManager</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-117"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP.Client.Manager.html"><span class="hs-identifier">Network.HTTP.Client.Manager</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP.Client.Manager.html#HasHttpManagerM"><span class="hs-identifier">HasHttpManagerM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP.Client.Transformable.html"><span class="hs-identifier">Network.HTTP.Client.Transformable</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HTTP</span></span><span>
</span><span id="line-119"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.Wai</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Application</span></span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.Wai.Handler.Warp</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Warp</span></span><span>
</span><span id="line-121"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Options.Applicative</span></span><span>
</span><span id="line-122"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Environment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">getEnvironment</span></span><span class="hs-special">)</span><span>
</span><span id="line-123"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Log.FastLogger</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">FL</span></span><span>
</span><span id="line-124"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Metrics</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">EKG</span></span><span>
</span><span id="line-125"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Metrics.Gauge</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">EKG.Gauge</span></span><span>
</span><span id="line-126"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Text.Mustache.Compile</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-127"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Web.Spock.Core</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Spock</span></span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span class="hs-keyword">data</span><span> </span><span id="ExitCode"><span class="annot"><a href="Hasura.App.html#ExitCode"><span class="hs-identifier hs-var">ExitCode</span></a></span></span><span>
</span><span id="line-130"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- these are used during server initialization:</span><span>
</span><span id="line-131"></span><span>    </span><span id="InvalidEnvironmentVariableOptionsError"><span class="annot"><a href="Hasura.App.html#InvalidEnvironmentVariableOptionsError"><span class="hs-identifier hs-var">InvalidEnvironmentVariableOptionsError</span></a></span></span><span>
</span><span id="line-132"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="InvalidDatabaseConnectionParamsError"><span class="annot"><a href="Hasura.App.html#InvalidDatabaseConnectionParamsError"><span class="hs-identifier hs-var">InvalidDatabaseConnectionParamsError</span></a></span></span><span>
</span><span id="line-133"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="AuthConfigurationError"><span class="annot"><a href="Hasura.App.html#AuthConfigurationError"><span class="hs-identifier hs-var">AuthConfigurationError</span></a></span></span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="EventSubSystemError"><span class="annot"><a href="Hasura.App.html#EventSubSystemError"><span class="hs-identifier hs-var">EventSubSystemError</span></a></span></span><span>
</span><span id="line-135"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="DatabaseMigrationError"><span class="annot"><a href="Hasura.App.html#DatabaseMigrationError"><span class="hs-identifier hs-var">DatabaseMigrationError</span></a></span></span><span>
</span><span id="line-136"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- | used by MT because it initialises the schema cache only</span><span>
</span><span id="line-137"></span><span>    </span><span class="hs-comment">-- these are used in app/Main.hs:</span><span>
</span><span id="line-138"></span><span>    </span><span id="SchemaCacheInitError"><span class="annot"><a href="Hasura.App.html#SchemaCacheInitError"><span class="hs-identifier hs-var">SchemaCacheInitError</span></a></span></span><span>
</span><span id="line-139"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="MetadataExportError"><span class="annot"><a href="Hasura.App.html#MetadataExportError"><span class="hs-identifier hs-var">MetadataExportError</span></a></span></span><span>
</span><span id="line-140"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="MetadataCleanError"><span class="annot"><a href="Hasura.App.html#MetadataCleanError"><span class="hs-identifier hs-var">MetadataCleanError</span></a></span></span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="ExecuteProcessError"><span class="annot"><a href="Hasura.App.html#ExecuteProcessError"><span class="hs-identifier hs-var">ExecuteProcessError</span></a></span></span><span>
</span><span id="line-142"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="DowngradeProcessError"><span class="annot"><a href="Hasura.App.html#DowngradeProcessError"><span class="hs-identifier hs-var">DowngradeProcessError</span></a></span></span><span>
</span><span id="line-143"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688185644"><span id="local-6989586621688185646"><span id="local-6989586621688185648"><span class="annot"><span class="annottext">Int -&gt; ExitCode -&gt; ShowS
[ExitCode] -&gt; ShowS
ExitCode -&gt; String
(Int -&gt; ExitCode -&gt; ShowS)
-&gt; (ExitCode -&gt; String) -&gt; ([ExitCode] -&gt; ShowS) -&gt; Show ExitCode
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ExitCode] -&gt; ShowS
$cshowList :: [ExitCode] -&gt; ShowS
show :: ExitCode -&gt; String
$cshow :: ExitCode -&gt; String
showsPrec :: Int -&gt; ExitCode -&gt; ShowS
$cshowsPrec :: Int -&gt; ExitCode -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span class="hs-keyword">data</span><span> </span><span id="ExitException"><span class="annot"><a href="Hasura.App.html#ExitException"><span class="hs-identifier hs-var">ExitException</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ExitException"><span class="annot"><a href="Hasura.App.html#ExitException"><span class="hs-identifier hs-var">ExitException</span></a></span></span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="eeCode"><span class="annot"><span class="annottext">ExitException -&gt; ExitCode
</span><a href="Hasura.App.html#eeCode"><span class="hs-identifier hs-var hs-var">eeCode</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.App.html#ExitCode"><span class="hs-identifier hs-type">ExitCode</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-147"></span><span>    </span><span id="eeMessage"><span class="annot"><span class="annottext">ExitException -&gt; ByteString
</span><a href="Hasura.App.html#eeMessage"><span class="hs-identifier hs-var hs-var">eeMessage</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">BC.ByteString</span></span><span>
</span><span id="line-148"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-149"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688185635"><span id="local-6989586621688185637"><span id="local-6989586621688185639"><span class="annot"><span class="annottext">Int -&gt; ExitException -&gt; ShowS
[ExitException] -&gt; ShowS
ExitException -&gt; String
(Int -&gt; ExitException -&gt; ShowS)
-&gt; (ExitException -&gt; String)
-&gt; ([ExitException] -&gt; ShowS)
-&gt; Show ExitException
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ExitException] -&gt; ShowS
$cshowList :: [ExitException] -&gt; ShowS
show :: ExitException -&gt; String
$cshow :: ExitException -&gt; String
showsPrec :: Int -&gt; ExitException -&gt; ShowS
$cshowsPrec :: Int -&gt; ExitException -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621688185627"><span id="local-6989586621688185629"><span id="local-6989586621688185631"><span class="annot"><span class="hs-identifier hs-type">Exception</span></span><span> </span><span class="annot"><a href="Hasura.App.html#ExitException"><span class="hs-identifier hs-type">ExitException</span></a></span></span></span></span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span id="local-6989586621688186307"><span class="annot"><a href="Hasura.App.html#printErrExit"><span class="hs-identifier hs-type">printErrExit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688186307"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688186368"><span class="annot"><a href="#local-6989586621688186368"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Hasura.App.html#ExitCode"><span class="hs-identifier hs-type">ExitCode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688186307"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688186368"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-154"></span><span id="printErrExit"><span class="annot"><span class="annottext">printErrExit :: forall a. ExitCode -&gt; String -&gt; m a
</span><a href="Hasura.App.html#printErrExit"><span class="hs-identifier hs-var hs-var">printErrExit</span></a></span></span><span> </span><span id="local-6989586621688185625"><span class="annot"><span class="annottext">ExitCode
</span><a href="#local-6989586621688185625"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO a -&gt; m a) -&gt; (String -&gt; IO a) -&gt; String -&gt; m a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ExitException -&gt; IO a
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">(ExitException -&gt; IO a)
-&gt; (String -&gt; ExitException) -&gt; String -&gt; IO a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ExitCode -&gt; ByteString -&gt; ExitException
</span><a href="Hasura.App.html#ExitException"><span class="hs-identifier hs-var">ExitException</span></a></span><span> </span><span class="annot"><span class="annottext">ExitCode
</span><a href="#local-6989586621688185625"><span class="hs-identifier hs-var">reason</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ExitException)
-&gt; (String -&gt; ByteString) -&gt; String -&gt; ExitException
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ByteString
</span><span class="hs-identifier hs-var">BC.pack</span></span><span>
</span><span id="line-155"></span><span>
</span><span id="line-156"></span><span id="local-6989586621688186036"><span id="local-6989586621688186037"><span class="annot"><a href="Hasura.App.html#printErrJExit"><span class="hs-identifier hs-type">printErrJExit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">A.ToJSON</span></span><span> </span><span class="annot"><a href="#local-6989586621688186037"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688186036"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688186356"><span class="annot"><a href="#local-6989586621688186356"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Hasura.App.html#ExitCode"><span class="hs-identifier hs-type">ExitCode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688186037"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688186036"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688186356"><span class="hs-identifier hs-type">b</span></a></span></span></span><span>
</span><span id="line-157"></span><span id="printErrJExit"><span class="annot"><span class="annottext">printErrJExit :: forall b. ExitCode -&gt; a -&gt; m b
</span><a href="Hasura.App.html#printErrJExit"><span class="hs-identifier hs-var hs-var">printErrJExit</span></a></span></span><span> </span><span id="local-6989586621688185621"><span class="annot"><span class="annottext">ExitCode
</span><a href="#local-6989586621688185621"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO b -&gt; m b
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO b -&gt; m b) -&gt; (a -&gt; IO b) -&gt; a -&gt; m b
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ExitException -&gt; IO b
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">(ExitException -&gt; IO b) -&gt; (a -&gt; ExitException) -&gt; a -&gt; IO b
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ExitCode -&gt; ByteString -&gt; ExitException
</span><a href="Hasura.App.html#ExitException"><span class="hs-identifier hs-var">ExitException</span></a></span><span> </span><span class="annot"><span class="annottext">ExitCode
</span><a href="#local-6989586621688185621"><span class="hs-identifier hs-var">reason</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ExitException)
-&gt; (a -&gt; ByteString) -&gt; a -&gt; ExitException
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString
</span><span class="hs-identifier hs-var">BLC.toStrict</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ByteString) -&gt; (a -&gt; ByteString) -&gt; a -&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">A.encode</span></span><span>
</span><span id="line-158"></span><span>
</span><span id="line-159"></span><span id="local-6989586621688186302"><span class="annot"><a href="Hasura.App.html#parseHGECommand"><span class="hs-identifier hs-type">parseHGECommand</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Logging.html#EnabledLogTypes"><span class="hs-identifier hs-type">EnabledLogTypes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688186302"><span class="hs-identifier hs-type">impl</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Parser</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Init.Config.html#RawHGECommand"><span class="hs-identifier hs-type">RawHGECommand</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688186302"><span class="hs-identifier hs-type">impl</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-160"></span><span id="parseHGECommand"><span class="annot"><span class="annottext">parseHGECommand :: Parser (RawHGECommand impl)
</span><a href="Hasura.App.html#parseHGECommand"><span class="hs-identifier hs-var hs-var">parseHGECommand</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-161"></span><span>  </span><span class="annot"><span class="annottext">Mod CommandFields (RawHGECommand impl)
-&gt; Parser (RawHGECommand impl)
forall a. Mod CommandFields a -&gt; Parser a
</span><span class="hs-identifier hs-var">subparser</span></span><span>
</span><span id="line-162"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">String
-&gt; ParserInfo (RawHGECommand impl)
-&gt; Mod CommandFields (RawHGECommand impl)
forall a. String -&gt; ParserInfo a -&gt; Mod CommandFields a
</span><span class="hs-identifier hs-var">command</span></span><span>
</span><span id="line-163"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;serve&quot;</span></span><span>
</span><span id="line-164"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Parser (RawHGECommand impl)
-&gt; InfoMod (RawHGECommand impl) -&gt; ParserInfo (RawHGECommand impl)
forall a. Parser a -&gt; InfoMod a -&gt; ParserInfo a
</span><span class="hs-identifier hs-var">info</span></span><span>
</span><span id="line-165"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Parser (RawHGECommand impl -&gt; RawHGECommand impl)
forall a. Parser (a -&gt; a)
</span><span class="hs-identifier hs-var">helper</span></span><span> </span><span class="annot"><span class="annottext">Parser (RawHGECommand impl -&gt; RawHGECommand impl)
-&gt; Parser (RawHGECommand impl) -&gt; Parser (RawHGECommand impl)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RawServeOptions impl -&gt; RawHGECommand impl
forall a. a -&gt; HGECommandG a
</span><a href="Hasura.Server.Init.Config.html#HCServe"><span class="hs-identifier hs-var">HCServe</span></a></span><span> </span><span class="annot"><span class="annottext">(RawServeOptions impl -&gt; RawHGECommand impl)
-&gt; Parser (RawServeOptions impl) -&gt; Parser (RawHGECommand impl)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Parser (RawServeOptions impl)
forall impl. EnabledLogTypes impl =&gt; Parser (RawServeOptions impl)
</span><a href="Hasura.Server.Init.html#serveOptionsParser"><span class="hs-identifier hs-var">serveOptionsParser</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">String -&gt; InfoMod (RawHGECommand impl)
forall a. String -&gt; InfoMod a
</span><span class="hs-identifier hs-var">progDesc</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Start the GraphQL Engine Server&quot;</span></span><span>
</span><span id="line-167"></span><span>                </span><span class="annot"><span class="annottext">InfoMod (RawHGECommand impl)
-&gt; InfoMod (RawHGECommand impl) -&gt; InfoMod (RawHGECommand impl)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Doc -&gt; InfoMod (RawHGECommand impl)
forall a. Maybe Doc -&gt; InfoMod a
</span><span class="hs-identifier hs-var">footerDoc</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Doc -&gt; Maybe Doc
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><a href="Hasura.Server.Init.html#serveCmdFooter"><span class="hs-identifier hs-var">serveCmdFooter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span>        </span><span class="annot"><span class="annottext">Mod CommandFields (RawHGECommand impl)
-&gt; Mod CommandFields (RawHGECommand impl)
-&gt; Mod CommandFields (RawHGECommand impl)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; ParserInfo (RawHGECommand impl)
-&gt; Mod CommandFields (RawHGECommand impl)
forall a. String -&gt; ParserInfo a -&gt; Mod CommandFields a
</span><span class="hs-identifier hs-var">command</span></span><span>
</span><span id="line-171"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;export&quot;</span></span><span>
</span><span id="line-172"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Parser (RawHGECommand impl)
-&gt; InfoMod (RawHGECommand impl) -&gt; ParserInfo (RawHGECommand impl)
forall a. Parser a -&gt; InfoMod a -&gt; ParserInfo a
</span><span class="hs-identifier hs-var">info</span></span><span>
</span><span id="line-173"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RawHGECommand impl -&gt; Parser (RawHGECommand impl)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">RawHGECommand impl
forall a. HGECommandG a
</span><a href="Hasura.Server.Init.Config.html#HCExport"><span class="hs-identifier hs-var">HCExport</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; InfoMod (RawHGECommand impl)
forall a. String -&gt; InfoMod a
</span><span class="hs-identifier hs-var">progDesc</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Export graphql-engine's metadata to stdout&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-175"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>        </span><span class="annot"><span class="annottext">Mod CommandFields (RawHGECommand impl)
-&gt; Mod CommandFields (RawHGECommand impl)
-&gt; Mod CommandFields (RawHGECommand impl)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; ParserInfo (RawHGECommand impl)
-&gt; Mod CommandFields (RawHGECommand impl)
forall a. String -&gt; ParserInfo a -&gt; Mod CommandFields a
</span><span class="hs-identifier hs-var">command</span></span><span>
</span><span id="line-177"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;clean&quot;</span></span><span>
</span><span id="line-178"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Parser (RawHGECommand impl)
-&gt; InfoMod (RawHGECommand impl) -&gt; ParserInfo (RawHGECommand impl)
forall a. Parser a -&gt; InfoMod a -&gt; ParserInfo a
</span><span class="hs-identifier hs-var">info</span></span><span>
</span><span id="line-179"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RawHGECommand impl -&gt; Parser (RawHGECommand impl)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">RawHGECommand impl
forall a. HGECommandG a
</span><a href="Hasura.Server.Init.Config.html#HCClean"><span class="hs-identifier hs-var">HCClean</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; InfoMod (RawHGECommand impl)
forall a. String -&gt; InfoMod a
</span><span class="hs-identifier hs-var">progDesc</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Clean graphql-engine's metadata to start afresh&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-181"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span>        </span><span class="annot"><span class="annottext">Mod CommandFields (RawHGECommand impl)
-&gt; Mod CommandFields (RawHGECommand impl)
-&gt; Mod CommandFields (RawHGECommand impl)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; ParserInfo (RawHGECommand impl)
-&gt; Mod CommandFields (RawHGECommand impl)
forall a. String -&gt; ParserInfo a -&gt; Mod CommandFields a
</span><span class="hs-identifier hs-var">command</span></span><span>
</span><span id="line-183"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;downgrade&quot;</span></span><span>
</span><span id="line-184"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Parser (RawHGECommand impl)
-&gt; InfoMod (RawHGECommand impl) -&gt; ParserInfo (RawHGECommand impl)
forall a. Parser a -&gt; InfoMod a -&gt; ParserInfo a
</span><span class="hs-identifier hs-var">info</span></span><span>
</span><span id="line-185"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DowngradeOptions -&gt; RawHGECommand impl
forall a. DowngradeOptions -&gt; HGECommandG a
</span><a href="Hasura.Server.Init.Config.html#HCDowngrade"><span class="hs-identifier hs-var">HCDowngrade</span></a></span><span> </span><span class="annot"><span class="annottext">(DowngradeOptions -&gt; RawHGECommand impl)
-&gt; Parser DowngradeOptions -&gt; Parser (RawHGECommand impl)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Parser DowngradeOptions
</span><a href="Hasura.Server.Init.html#downgradeOptionsParser"><span class="hs-identifier hs-var">downgradeOptionsParser</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; InfoMod (RawHGECommand impl)
forall a. String -&gt; InfoMod a
</span><span class="hs-identifier hs-var">progDesc</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Downgrade the GraphQL Engine schema to the specified version&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-187"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-188"></span><span>        </span><span class="annot"><span class="annottext">Mod CommandFields (RawHGECommand impl)
-&gt; Mod CommandFields (RawHGECommand impl)
-&gt; Mod CommandFields (RawHGECommand impl)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; ParserInfo (RawHGECommand impl)
-&gt; Mod CommandFields (RawHGECommand impl)
forall a. String -&gt; ParserInfo a -&gt; Mod CommandFields a
</span><span class="hs-identifier hs-var">command</span></span><span>
</span><span id="line-189"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;version&quot;</span></span><span>
</span><span id="line-190"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Parser (RawHGECommand impl)
-&gt; InfoMod (RawHGECommand impl) -&gt; ParserInfo (RawHGECommand impl)
forall a. Parser a -&gt; InfoMod a -&gt; ParserInfo a
</span><span class="hs-identifier hs-var">info</span></span><span>
</span><span id="line-191"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RawHGECommand impl -&gt; Parser (RawHGECommand impl)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">RawHGECommand impl
forall a. HGECommandG a
</span><a href="Hasura.Server.Init.Config.html#HCVersion"><span class="hs-identifier hs-var">HCVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; InfoMod (RawHGECommand impl)
forall a. String -&gt; InfoMod a
</span><span class="hs-identifier hs-var">progDesc</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Prints the version of GraphQL Engine&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span>
</span><span id="line-196"></span><span id="local-6989586621688185602"><span class="annot"><a href="Hasura.App.html#parseArgs"><span class="hs-identifier hs-type">parseArgs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Logging.html#EnabledLogTypes"><span class="hs-identifier hs-type">EnabledLogTypes</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185602"><span class="hs-identifier hs-type">impl</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Init.Config.html#HGEOptions"><span class="hs-identifier hs-type">HGEOptions</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185602"><span class="hs-identifier hs-type">impl</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-197"></span><span id="parseArgs"><span class="annot"><span class="annottext">parseArgs :: IO (HGEOptions impl)
</span><a href="Hasura.App.html#parseArgs"><span class="hs-identifier hs-var hs-var">parseArgs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-198"></span><span>  </span><span id="local-6989586621688185601"><span class="annot"><span class="annottext">HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl)
</span><a href="#local-6989586621688185601"><span class="hs-identifier hs-var">rawHGEOpts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ParserInfo
  (HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
-&gt; IO
     (HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
forall a. ParserInfo a -&gt; IO a
</span><span class="hs-identifier hs-var">execParser</span></span><span> </span><span class="annot"><span class="annottext">ParserInfo
  (HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
</span><a href="#local-6989586621688185599"><span class="hs-identifier hs-var">opts</span></a></span><span>
</span><span id="line-199"></span><span>  </span><span id="local-6989586621688185598"><span class="annot"><span class="annottext">[(String, String)]
</span><a href="#local-6989586621688185598"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO [(String, String)]
</span><span class="hs-identifier hs-var">getEnvironment</span></span><span>
</span><span id="line-200"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688185597"><span class="annot"><span class="annottext">eitherOpts :: Either String (HGEOptions impl)
</span><a href="#local-6989586621688185597"><span class="hs-identifier hs-var hs-var">eitherOpts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(String, String)]
-&gt; WithEnv (HGEOptions impl) -&gt; Either String (HGEOptions impl)
forall a. [(String, String)] -&gt; WithEnv a -&gt; Either String a
</span><a href="Hasura.Server.Init.Config.html#runWithEnv"><span class="hs-identifier hs-var">runWithEnv</span></a></span><span> </span><span class="annot"><span class="annottext">[(String, String)]
</span><a href="#local-6989586621688185598"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">(WithEnv (HGEOptions impl) -&gt; Either String (HGEOptions impl))
-&gt; WithEnv (HGEOptions impl) -&gt; Either String (HGEOptions impl)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl)
-&gt; WithEnv (HGEOptions impl)
forall impl.
EnabledLogTypes impl =&gt;
RawHGEOptions impl -&gt; WithEnv (HGEOptions impl)
</span><a href="Hasura.Server.Init.html#mkHGEOptions"><span class="hs-identifier hs-var">mkHGEOptions</span></a></span><span> </span><span class="annot"><span class="annottext">HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl)
</span><a href="#local-6989586621688185601"><span class="hs-identifier hs-var">rawHGEOpts</span></a></span><span>
</span><span id="line-201"></span><span>  </span><span class="annot"><span class="annottext">Either String (HGEOptions impl)
-&gt; (String -&gt; IO (HGEOptions impl)) -&gt; IO (HGEOptions impl)
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="Hasura.Prelude.html#onLeft"><span class="hs-identifier hs-var">onLeft</span></a></span><span> </span><span class="annot"><span class="annottext">Either String (HGEOptions impl)
</span><a href="#local-6989586621688185597"><span class="hs-identifier hs-var">eitherOpts</span></a></span><span> </span><span class="annot"><span class="annottext">((String -&gt; IO (HGEOptions impl)) -&gt; IO (HGEOptions impl))
-&gt; (String -&gt; IO (HGEOptions impl)) -&gt; IO (HGEOptions impl)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExitCode -&gt; String -&gt; IO (HGEOptions impl)
forall (m :: * -&gt; *) a. MonadIO m =&gt; ExitCode -&gt; String -&gt; m a
</span><a href="Hasura.App.html#printErrExit"><span class="hs-identifier hs-var">printErrExit</span></a></span><span> </span><span class="annot"><span class="annottext">ExitCode
</span><a href="Hasura.App.html#InvalidEnvironmentVariableOptionsError"><span class="hs-identifier hs-var">InvalidEnvironmentVariableOptionsError</span></a></span><span>
</span><span id="line-202"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-203"></span><span>    </span><span id="local-6989586621688185599"><span class="annot"><span class="annottext">opts :: ParserInfo
  (HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
</span><a href="#local-6989586621688185599"><span class="hs-identifier hs-var hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-204"></span><span>      </span><span class="annot"><span class="annottext">Parser
  (HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
-&gt; InfoMod
     (HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
-&gt; ParserInfo
     (HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
forall a. Parser a -&gt; InfoMod a -&gt; ParserInfo a
</span><span class="hs-identifier hs-var">info</span></span><span>
</span><span id="line-205"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Parser
  (HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl)
   -&gt; HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
forall a. Parser (a -&gt; a)
</span><span class="hs-identifier hs-var">helper</span></span><span> </span><span class="annot"><span class="annottext">Parser
  (HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl)
   -&gt; HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
-&gt; Parser
     (HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
-&gt; Parser
     (HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Parser
  (HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
</span><a href="#local-6989586621688185593"><span class="hs-identifier hs-var">hgeOpts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-206"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">InfoMod
  (HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
forall a. InfoMod a
</span><span class="hs-identifier hs-var">fullDesc</span></span><span>
</span><span id="line-207"></span><span>            </span><span class="annot"><span class="annottext">InfoMod
  (HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
-&gt; InfoMod
     (HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
-&gt; InfoMod
     (HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; InfoMod
     (HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
forall a. String -&gt; InfoMod a
</span><span class="hs-identifier hs-var">header</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Hasura GraphQL Engine: Realtime GraphQL API over Postgres with access control&quot;</span></span><span>
</span><span id="line-208"></span><span>            </span><span class="annot"><span class="annottext">InfoMod
  (HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
-&gt; InfoMod
     (HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
-&gt; InfoMod
     (HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Doc
-&gt; InfoMod
     (HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
forall a. Maybe Doc -&gt; InfoMod a
</span><span class="hs-identifier hs-var">footerDoc</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Doc -&gt; Maybe Doc
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><a href="Hasura.Server.Init.html#mainCmdFooter"><span class="hs-identifier hs-var">mainCmdFooter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-210"></span><span>    </span><span id="local-6989586621688185593"><span class="annot"><span class="annottext">hgeOpts :: Parser
  (HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
</span><a href="#local-6989586621688185593"><span class="hs-identifier hs-var hs-var">hgeOpts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-211"></span><span>      </span><span class="annot"><span class="annottext">PostgresConnInfo (Maybe PostgresRawConnInfo)
-&gt; Maybe String
-&gt; HGECommandG (RawServeOptions impl)
-&gt; HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl)
forall a b.
PostgresConnInfo a
-&gt; Maybe String -&gt; HGECommandG b -&gt; HGEOptionsG a b
</span><a href="Hasura.Server.Init.Config.html#HGEOptionsG"><span class="hs-identifier hs-var">HGEOptionsG</span></a></span><span> </span><span class="annot"><span class="annottext">(PostgresConnInfo (Maybe PostgresRawConnInfo)
 -&gt; Maybe String
 -&gt; HGECommandG (RawServeOptions impl)
 -&gt; HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
-&gt; Parser (PostgresConnInfo (Maybe PostgresRawConnInfo))
-&gt; Parser
     (Maybe String
      -&gt; HGECommandG (RawServeOptions impl)
      -&gt; HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Parser (PostgresConnInfo (Maybe PostgresRawConnInfo))
</span><a href="Hasura.Server.Init.html#parsePostgresConnInfo"><span class="hs-identifier hs-var">parsePostgresConnInfo</span></a></span><span>
</span><span id="line-212"></span><span>        </span><span class="annot"><span class="annottext">Parser
  (Maybe String
   -&gt; HGECommandG (RawServeOptions impl)
   -&gt; HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
-&gt; Parser (Maybe String)
-&gt; Parser
     (HGECommandG (RawServeOptions impl)
      -&gt; HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Parser (Maybe String)
</span><a href="Hasura.Server.Init.html#parseMetadataDbUrl"><span class="hs-identifier hs-var">parseMetadataDbUrl</span></a></span><span>
</span><span id="line-213"></span><span>        </span><span class="annot"><span class="annottext">Parser
  (HGECommandG (RawServeOptions impl)
   -&gt; HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
-&gt; Parser (HGECommandG (RawServeOptions impl))
-&gt; Parser
     (HGEOptionsG (Maybe PostgresRawConnInfo) (RawServeOptions impl))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Parser (HGECommandG (RawServeOptions impl))
forall impl. EnabledLogTypes impl =&gt; Parser (RawHGECommand impl)
</span><a href="Hasura.App.html#parseHGECommand"><span class="hs-identifier hs-var">parseHGECommand</span></a></span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span id="local-6989586621688185585"><span id="local-6989586621688185586"><span class="annot"><a href="Hasura.App.html#printJSON"><span class="hs-identifier hs-type">printJSON</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">A.ToJSON</span></span><span> </span><span class="annot"><a href="#local-6989586621688185586"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688185585"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688185586"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688185585"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-216"></span><span id="printJSON"><span class="annot"><span class="annottext">printJSON :: a -&gt; m ()
</span><a href="Hasura.App.html#printJSON"><span class="hs-identifier hs-var hs-var">printJSON</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; (a -&gt; IO ()) -&gt; a -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; IO ()
</span><span class="hs-identifier hs-var">BLC.putStrLn</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; IO ()) -&gt; (a -&gt; ByteString) -&gt; a -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">A.encode</span></span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span id="local-6989586621688185582"><span id="local-6989586621688185583"><span class="annot"><a href="Hasura.App.html#printYaml"><span class="hs-identifier hs-type">printYaml</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">A.ToJSON</span></span><span> </span><span class="annot"><a href="#local-6989586621688185583"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688185582"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688185583"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688185582"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-219"></span><span id="printYaml"><span class="annot"><span class="annottext">printYaml :: a -&gt; m ()
</span><a href="Hasura.App.html#printYaml"><span class="hs-identifier hs-var hs-var">printYaml</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; (a -&gt; IO ()) -&gt; a -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; IO ()
</span><span class="hs-identifier hs-var">BC.putStrLn</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; IO ()) -&gt; (a -&gt; ByteString) -&gt; a -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">Y.encode</span></span><span>
</span><span id="line-220"></span><span>
</span><span id="line-221"></span><span class="annot"><a href="Hasura.App.html#mkPGLogger"><span class="hs-identifier hs-type">mkPGLogger</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Q.PGLogger</span></span><span>
</span><span id="line-222"></span><span id="mkPGLogger"><span class="annot"><span class="annottext">mkPGLogger :: Logger Hasura -&gt; PGLogger
</span><a href="Hasura.App.html#mkPGLogger"><span class="hs-identifier hs-var hs-var">mkPGLogger</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span id="local-6989586621688185578"><span class="annot"><span class="annottext">forall a (m :: * -&gt; *).
(ToEngineLog a Hasura, MonadIO m) =&gt;
a -&gt; m ()
</span><a href="#local-6989586621688185578"><span class="hs-identifier hs-var">logger</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Q.PLERetryMsg</span></span><span> </span><span id="local-6989586621688185576"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688185576"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-223"></span><span>  </span><span class="annot"><span class="annottext">PGLog -&gt; IO ()
forall a (m :: * -&gt; *).
(ToEngineLog a Hasura, MonadIO m) =&gt;
a -&gt; m ()
</span><a href="#local-6989586621688185578"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(PGLog -&gt; IO ()) -&gt; PGLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogLevel -&gt; Text -&gt; PGLog
</span><a href="Hasura.Server.Logging.html#PGLog"><span class="hs-identifier hs-var">PGLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelWarn"><span class="hs-identifier hs-var">LevelWarn</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688185576"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span class="hs-comment">-- | Context required for all graphql-engine CLI commands</span><span>
</span><span id="line-226"></span><span class="hs-keyword">data</span><span> </span><span id="GlobalCtx"><span class="annot"><a href="Hasura.App.html#GlobalCtx"><span class="hs-identifier hs-var">GlobalCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="GlobalCtx"><span class="annot"><a href="Hasura.App.html#GlobalCtx"><span class="hs-identifier hs-var">GlobalCtx</span></a></span></span><span>
</span><span id="line-227"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_gcMetadataDbConnInfo"><span class="annot"><span class="annottext">GlobalCtx -&gt; ConnInfo
</span><a href="Hasura.App.html#_gcMetadataDbConnInfo"><span class="hs-identifier hs-var hs-var">_gcMetadataDbConnInfo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Q.ConnInfo</span></span><span class="hs-special">,</span><span>
</span><span id="line-228"></span><span>    </span><span class="hs-comment">-- | --database-url option, @'UrlConf' is required to construct default source configuration</span><span>
</span><span id="line-229"></span><span>    </span><span class="hs-comment">-- and optional retries</span><span>
</span><span id="line-230"></span><span>    </span><span id="_gcDefaultPostgresConnInfo"><span class="annot"><span class="annottext">GlobalCtx -&gt; (Maybe (UrlConf, ConnInfo), Maybe Int)
</span><a href="Hasura.App.html#_gcDefaultPostgresConnInfo"><span class="hs-identifier hs-var hs-var">_gcDefaultPostgresConnInfo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Common.html#UrlConf"><span class="hs-identifier hs-type">UrlConf</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Q.ConnInfo</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-231"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-232"></span><span>
</span><span id="line-233"></span><span class="annot"><a href="Hasura.App.html#readTlsAllowlist"><span class="hs-identifier hs-type">readTlsAllowlist</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Server.App.html#SchemaCacheRef"><span class="hs-identifier hs-type">SchemaCacheRef</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Network.html#TlsAllow"><span class="hs-identifier hs-type">TlsAllow</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-234"></span><span id="readTlsAllowlist"><span class="annot"><span class="annottext">readTlsAllowlist :: SchemaCacheRef -&gt; IO [TlsAllow]
</span><a href="Hasura.App.html#readTlsAllowlist"><span class="hs-identifier hs-var hs-var">readTlsAllowlist</span></a></span></span><span> </span><span id="local-6989586621688185570"><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621688185570"><span class="hs-identifier hs-var">scRef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-235"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621688185569"><span class="annot"><span class="annottext">RebuildableSchemaCache
</span><a href="#local-6989586621688185569"><span class="hs-identifier hs-var">rbsc</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SchemaCacheVer
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef (RebuildableSchemaCache, SchemaCacheVer)
-&gt; IO (RebuildableSchemaCache, SchemaCacheVer)
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SchemaCacheRef -&gt; IORef (RebuildableSchemaCache, SchemaCacheVer)
</span><a href="Hasura.Server.App.html#_scrCache"><span class="hs-identifier hs-var hs-var">_scrCache</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621688185570"><span class="hs-identifier hs-var">scRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-236"></span><span>  </span><span class="annot"><span class="annottext">[TlsAllow] -&gt; IO [TlsAllow]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">([TlsAllow] -&gt; IO [TlsAllow]) -&gt; [TlsAllow] -&gt; IO [TlsAllow]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; [TlsAllow]
</span><a href="Hasura.RQL.Types.SchemaCache.html#scTlsAllowlist"><span class="hs-identifier hs-var hs-var">scTlsAllowlist</span></a></span><span> </span><span class="annot"><span class="annottext">(SchemaCache -&gt; [TlsAllow]) -&gt; SchemaCache -&gt; [TlsAllow]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RebuildableSchemaCache -&gt; SchemaCache
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#lastBuiltSchemaCache"><span class="hs-identifier hs-var hs-var">lastBuiltSchemaCache</span></a></span><span> </span><span class="annot"><span class="annottext">RebuildableSchemaCache
</span><a href="#local-6989586621688185569"><span class="hs-identifier hs-var">rbsc</span></a></span><span>
</span><span id="line-237"></span><span>
</span><span id="line-238"></span><span id="local-6989586621688185565"><span class="annot"><a href="Hasura.App.html#initGlobalCtx"><span class="hs-identifier hs-type">initGlobalCtx</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-239"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688185565"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-240"></span><span>  </span><span class="annot"><a href="Data.Environment.html#Environment"><span class="hs-identifier hs-type">Env.Environment</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-241"></span><span>  </span><span class="hs-comment">-- | the metadata DB URL</span><span>
</span><span id="line-242"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-243"></span><span>  </span><span class="hs-comment">-- | the user's DB URL</span><span>
</span><span id="line-244"></span><span>  </span><span class="annot"><a href="Hasura.Server.Init.Config.html#PostgresConnInfo"><span class="hs-identifier hs-type">PostgresConnInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#UrlConf"><span class="hs-identifier hs-type">UrlConf</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-245"></span><span>  </span><span class="annot"><a href="#local-6989586621688185565"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#GlobalCtx"><span class="hs-identifier hs-type">GlobalCtx</span></a></span></span><span>
</span><span id="line-246"></span><span id="initGlobalCtx"><span class="annot"><span class="annottext">initGlobalCtx :: Environment
-&gt; Maybe String -&gt; PostgresConnInfo (Maybe UrlConf) -&gt; m GlobalCtx
</span><a href="Hasura.App.html#initGlobalCtx"><span class="hs-identifier hs-var hs-var">initGlobalCtx</span></a></span></span><span> </span><span id="local-6989586621688185564"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688185564"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621688185563"><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621688185563"><span class="hs-identifier hs-var">metadataDbUrl</span></a></span></span><span> </span><span id="local-6989586621688185562"><span class="annot"><span class="annottext">PostgresConnInfo (Maybe UrlConf)
</span><a href="#local-6989586621688185562"><span class="hs-identifier hs-var">defaultPgConnInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-247"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Hasura.Server.Init.Config.html#PostgresConnInfo"><span class="hs-identifier hs-type">PostgresConnInfo</span></a></span><span> </span><span id="local-6989586621688185560"><span class="annot"><span class="annottext">Maybe UrlConf
</span><a href="#local-6989586621688185560"><span class="hs-identifier hs-var">dbUrlConf</span></a></span></span><span> </span><span id="local-6989586621688185559"><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621688185559"><span class="hs-identifier hs-var">maybeRetries</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PostgresConnInfo (Maybe UrlConf)
</span><a href="#local-6989586621688185562"><span class="hs-identifier hs-var">defaultPgConnInfo</span></a></span><span>
</span><span id="line-248"></span><span>      </span><span id="local-6989586621688185558"><span class="annot"><span class="annottext">mkConnInfoFromSource :: UrlConf -&gt; m ConnInfo
</span><a href="#local-6989586621688185558"><span class="hs-identifier hs-var hs-var">mkConnInfoFromSource</span></a></span></span><span> </span><span id="local-6989586621688185557"><span class="annot"><span class="annottext">UrlConf
</span><a href="#local-6989586621688185557"><span class="hs-identifier hs-var">dbUrl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-249"></span><span>        </span><span class="annot"><span class="annottext">Environment -&gt; UrlConf -&gt; Maybe Int -&gt; m ConnInfo
forall (m :: * -&gt; *).
MonadIO m =&gt;
Environment -&gt; UrlConf -&gt; Maybe Int -&gt; m ConnInfo
</span><a href="Hasura.App.html#resolvePostgresConnInfo"><span class="hs-identifier hs-var">resolvePostgresConnInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688185564"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">UrlConf
</span><a href="#local-6989586621688185557"><span class="hs-identifier hs-var">dbUrl</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621688185559"><span class="hs-identifier hs-var">maybeRetries</span></a></span><span>
</span><span id="line-250"></span><span>
</span><span id="line-251"></span><span>      </span><span id="local-6989586621688185556"><span class="annot"><span class="annottext">mkConnInfoFromMDb :: String -&gt; ConnInfo
</span><a href="#local-6989586621688185556"><span class="hs-identifier hs-var hs-var">mkConnInfoFromMDb</span></a></span></span><span> </span><span id="local-6989586621688185555"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688185555"><span class="hs-identifier hs-var">mdbUrl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-252"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688185554"><span class="annot"><span class="annottext">retries :: Int
</span><a href="#local-6989586621688185554"><span class="hs-identifier hs-var hs-var">retries</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int -&gt; Int
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621688185559"><span class="hs-identifier hs-var">maybeRetries</span></a></span><span>
</span><span id="line-253"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; ConnDetails -&gt; ConnInfo
</span><span class="hs-identifier hs-var">Q.ConnInfo</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688185554"><span class="hs-identifier hs-var">retries</span></a></span><span> </span><span class="annot"><span class="annottext">(ConnDetails -&gt; ConnInfo)
-&gt; (String -&gt; ConnDetails) -&gt; String -&gt; ConnInfo
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ConnDetails
</span><span class="hs-identifier hs-var">Q.CDDatabaseURI</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ConnDetails)
-&gt; (String -&gt; ByteString) -&gt; String -&gt; ConnDetails
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; ByteString
</span><a href="Hasura.Prelude.html#txtToBs"><span class="hs-identifier hs-var">txtToBs</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; ByteString) -&gt; (String -&gt; Text) -&gt; String -&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688185555"><span class="hs-identifier hs-var">mdbUrl</span></a></span><span>
</span><span id="line-254"></span><span>
</span><span id="line-255"></span><span>      </span><span id="local-6989586621688185548"><span class="annot"><span class="annottext">mkGlobalCtx :: ConnInfo -&gt; Maybe (UrlConf, ConnInfo) -&gt; m GlobalCtx
</span><a href="#local-6989586621688185548"><span class="hs-identifier hs-var hs-var">mkGlobalCtx</span></a></span></span><span> </span><span id="local-6989586621688185547"><span class="annot"><span class="annottext">ConnInfo
</span><a href="#local-6989586621688185547"><span class="hs-identifier hs-var">mdbConnInfo</span></a></span></span><span> </span><span id="local-6989586621688185546"><span class="annot"><span class="annottext">Maybe (UrlConf, ConnInfo)
</span><a href="#local-6989586621688185546"><span class="hs-identifier hs-var">sourceConnInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-256"></span><span>        </span><span class="annot"><span class="annottext">GlobalCtx -&gt; m GlobalCtx
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(GlobalCtx -&gt; m GlobalCtx) -&gt; GlobalCtx -&gt; m GlobalCtx
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConnInfo -&gt; (Maybe (UrlConf, ConnInfo), Maybe Int) -&gt; GlobalCtx
</span><a href="Hasura.App.html#GlobalCtx"><span class="hs-identifier hs-var">GlobalCtx</span></a></span><span> </span><span class="annot"><span class="annottext">ConnInfo
</span><a href="#local-6989586621688185547"><span class="hs-identifier hs-var">mdbConnInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (UrlConf, ConnInfo)
</span><a href="#local-6989586621688185546"><span class="hs-identifier hs-var">sourceConnInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621688185559"><span class="hs-identifier hs-var">maybeRetries</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-257"></span><span>
</span><span id="line-258"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe String
</span><a href="#local-6989586621688185563"><span class="hs-identifier hs-var">metadataDbUrl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe UrlConf
</span><a href="#local-6989586621688185560"><span class="hs-identifier hs-var">dbUrlConf</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-259"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe String
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe UrlConf
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-260"></span><span>      </span><span class="annot"><span class="annottext">ExitCode -&gt; String -&gt; m GlobalCtx
forall (m :: * -&gt; *) a. MonadIO m =&gt; ExitCode -&gt; String -&gt; m a
</span><a href="Hasura.App.html#printErrExit"><span class="hs-identifier hs-var">printErrExit</span></a></span><span>
</span><span id="line-261"></span><span>        </span><span class="annot"><span class="annottext">ExitCode
</span><a href="Hasura.App.html#InvalidDatabaseConnectionParamsError"><span class="hs-identifier hs-var">InvalidDatabaseConnectionParamsError</span></a></span><span>
</span><span id="line-262"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Fatal Error: Either of --metadata-database-url or --database-url option expected&quot;</span></span><span>
</span><span id="line-263"></span><span>    </span><span class="hs-comment">-- If no metadata storage specified consider use default database as</span><span>
</span><span id="line-264"></span><span>    </span><span class="hs-comment">-- metadata storage</span><span>
</span><span id="line-265"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe String
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621688185545"><span class="annot"><span class="annottext">UrlConf
</span><a href="#local-6989586621688185545"><span class="hs-identifier hs-var">dbUrl</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-266"></span><span>      </span><span id="local-6989586621688185544"><span class="annot"><span class="annottext">ConnInfo
</span><a href="#local-6989586621688185544"><span class="hs-identifier hs-var">connInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UrlConf -&gt; m ConnInfo
</span><a href="#local-6989586621688185558"><span class="hs-identifier hs-var">mkConnInfoFromSource</span></a></span><span> </span><span class="annot"><span class="annottext">UrlConf
</span><a href="#local-6989586621688185545"><span class="hs-identifier hs-var">dbUrl</span></a></span><span>
</span><span id="line-267"></span><span>      </span><span class="annot"><span class="annottext">ConnInfo -&gt; Maybe (UrlConf, ConnInfo) -&gt; m GlobalCtx
</span><a href="#local-6989586621688185548"><span class="hs-identifier hs-var">mkGlobalCtx</span></a></span><span> </span><span class="annot"><span class="annottext">ConnInfo
</span><a href="#local-6989586621688185544"><span class="hs-identifier hs-var">connInfo</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (UrlConf, ConnInfo) -&gt; m GlobalCtx)
-&gt; Maybe (UrlConf, ConnInfo) -&gt; m GlobalCtx
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(UrlConf, ConnInfo) -&gt; Maybe (UrlConf, ConnInfo)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UrlConf
</span><a href="#local-6989586621688185545"><span class="hs-identifier hs-var">dbUrl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnInfo
</span><a href="#local-6989586621688185544"><span class="hs-identifier hs-var">connInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621688185543"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688185543"><span class="hs-identifier hs-var">mdUrl</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe UrlConf
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-269"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688185542"><span class="annot"><span class="annottext">mdConnInfo :: ConnInfo
</span><a href="#local-6989586621688185542"><span class="hs-identifier hs-var hs-var">mdConnInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; ConnInfo
</span><a href="#local-6989586621688185556"><span class="hs-identifier hs-var">mkConnInfoFromMDb</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688185543"><span class="hs-identifier hs-var">mdUrl</span></a></span><span>
</span><span id="line-270"></span><span>      </span><span class="annot"><span class="annottext">ConnInfo -&gt; Maybe (UrlConf, ConnInfo) -&gt; m GlobalCtx
</span><a href="#local-6989586621688185548"><span class="hs-identifier hs-var">mkGlobalCtx</span></a></span><span> </span><span class="annot"><span class="annottext">ConnInfo
</span><a href="#local-6989586621688185542"><span class="hs-identifier hs-var">mdConnInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (UrlConf, ConnInfo)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-271"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621688185541"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688185541"><span class="hs-identifier hs-var">mdUrl</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621688185540"><span class="annot"><span class="annottext">UrlConf
</span><a href="#local-6989586621688185540"><span class="hs-identifier hs-var">dbUrl</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-272"></span><span>      </span><span id="local-6989586621688185539"><span class="annot"><span class="annottext">ConnInfo
</span><a href="#local-6989586621688185539"><span class="hs-identifier hs-var">srcConnInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UrlConf -&gt; m ConnInfo
</span><a href="#local-6989586621688185558"><span class="hs-identifier hs-var">mkConnInfoFromSource</span></a></span><span> </span><span class="annot"><span class="annottext">UrlConf
</span><a href="#local-6989586621688185540"><span class="hs-identifier hs-var">dbUrl</span></a></span><span>
</span><span id="line-273"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688185538"><span class="annot"><span class="annottext">mdConnInfo :: ConnInfo
</span><a href="#local-6989586621688185538"><span class="hs-identifier hs-var hs-var">mdConnInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; ConnInfo
</span><a href="#local-6989586621688185556"><span class="hs-identifier hs-var">mkConnInfoFromMDb</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688185541"><span class="hs-identifier hs-var">mdUrl</span></a></span><span>
</span><span id="line-274"></span><span>      </span><span class="annot"><span class="annottext">ConnInfo -&gt; Maybe (UrlConf, ConnInfo) -&gt; m GlobalCtx
</span><a href="#local-6989586621688185548"><span class="hs-identifier hs-var">mkGlobalCtx</span></a></span><span> </span><span class="annot"><span class="annottext">ConnInfo
</span><a href="#local-6989586621688185538"><span class="hs-identifier hs-var">mdConnInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(UrlConf, ConnInfo) -&gt; Maybe (UrlConf, ConnInfo)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UrlConf
</span><a href="#local-6989586621688185540"><span class="hs-identifier hs-var">dbUrl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnInfo
</span><a href="#local-6989586621688185539"><span class="hs-identifier hs-var">srcConnInfo</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-275"></span><span>
</span><span id="line-276"></span><span class="hs-comment">-- | Context required for the 'serve' CLI command.</span><span>
</span><span id="line-277"></span><span class="hs-keyword">data</span><span> </span><span id="ServeCtx"><span class="annot"><a href="Hasura.App.html#ServeCtx"><span class="hs-identifier hs-var">ServeCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ServeCtx"><span class="annot"><a href="Hasura.App.html#ServeCtx"><span class="hs-identifier hs-var">ServeCtx</span></a></span></span><span>
</span><span id="line-278"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_scHttpManager"><span class="annot"><span class="annottext">ServeCtx -&gt; Manager
</span><a href="Hasura.App.html#_scHttpManager"><span class="hs-identifier hs-var hs-var">_scHttpManager</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">HTTP.Manager</span></span><span class="hs-special">,</span><span>
</span><span id="line-279"></span><span>    </span><span id="_scInstanceId"><span class="annot"><span class="annottext">ServeCtx -&gt; InstanceId
</span><a href="Hasura.App.html#_scInstanceId"><span class="hs-identifier hs-var hs-var">_scInstanceId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.Server.Types.html#InstanceId"><span class="hs-identifier hs-type">InstanceId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-280"></span><span>    </span><span id="_scLoggers"><span class="annot"><span class="annottext">ServeCtx -&gt; Loggers
</span><a href="Hasura.App.html#_scLoggers"><span class="hs-identifier hs-var hs-var">_scLoggers</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.App.html#Loggers"><span class="hs-identifier hs-type">Loggers</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-281"></span><span>    </span><span id="_scEnabledLogTypes"><span class="annot"><span class="annottext">ServeCtx -&gt; HashSet (EngineLogType Hasura)
</span><a href="Hasura.App.html#_scEnabledLogTypes"><span class="hs-identifier hs-var hs-var">_scEnabledLogTypes</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HashSet</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#EngineLogType"><span class="hs-identifier hs-type">EngineLogType</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-282"></span><span>    </span><span id="_scMetadataDbPool"><span class="annot"><span class="annottext">ServeCtx -&gt; PGPool
</span><a href="Hasura.App.html#_scMetadataDbPool"><span class="hs-identifier hs-var hs-var">_scMetadataDbPool</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Q.PGPool</span></span><span class="hs-special">,</span><span>
</span><span id="line-283"></span><span>    </span><span id="_scShutdownLatch"><span class="annot"><span class="annottext">ServeCtx -&gt; ShutdownLatch
</span><a href="Hasura.App.html#_scShutdownLatch"><span class="hs-identifier hs-var hs-var">_scShutdownLatch</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.App.html#ShutdownLatch"><span class="hs-identifier hs-type">ShutdownLatch</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-284"></span><span>    </span><span id="_scSchemaCache"><span class="annot"><span class="annottext">ServeCtx -&gt; RebuildableSchemaCache
</span><a href="Hasura.App.html#_scSchemaCache"><span class="hs-identifier hs-var hs-var">_scSchemaCache</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#RebuildableSchemaCache"><span class="hs-identifier hs-type">RebuildableSchemaCache</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-285"></span><span>    </span><span id="_scSchemaCacheRef"><span class="annot"><span class="annottext">ServeCtx -&gt; SchemaCacheRef
</span><a href="Hasura.App.html#_scSchemaCacheRef"><span class="hs-identifier hs-var hs-var">_scSchemaCacheRef</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.Server.App.html#SchemaCacheRef"><span class="hs-identifier hs-type">SchemaCacheRef</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-286"></span><span>    </span><span id="_scMetaVersionRef"><span class="annot"><span class="annottext">ServeCtx -&gt; TMVar MetadataResourceVersion
</span><a href="Hasura.App.html#_scMetaVersionRef"><span class="hs-identifier hs-var hs-var">_scMetaVersionRef</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">STM.TMVar</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataResourceVersion"><span class="hs-identifier hs-type">MetadataResourceVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-288"></span><span>
</span><span id="line-289"></span><span class="hs-comment">-- | Collection of the LoggerCtx, the regular Logger and the PGLogger</span><span>
</span><span id="line-290"></span><span class="hs-comment">-- TODO (from master): better naming?</span><span>
</span><span id="line-291"></span><span class="hs-keyword">data</span><span> </span><span id="Loggers"><span class="annot"><a href="Hasura.App.html#Loggers"><span class="hs-identifier hs-var">Loggers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Loggers"><span class="annot"><a href="Hasura.App.html#Loggers"><span class="hs-identifier hs-var">Loggers</span></a></span></span><span>
</span><span id="line-292"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_lsLoggerCtx"><span class="annot"><span class="annottext">Loggers -&gt; LoggerCtx Hasura
</span><a href="Hasura.App.html#_lsLoggerCtx"><span class="hs-identifier hs-var hs-var">_lsLoggerCtx</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#LoggerCtx"><span class="hs-identifier hs-type">LoggerCtx</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-293"></span><span>    </span><span id="_lsLogger"><span class="annot"><span class="annottext">Loggers -&gt; Logger Hasura
</span><a href="Hasura.App.html#_lsLogger"><span class="hs-identifier hs-var hs-var">_lsLogger</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-294"></span><span>    </span><span id="_lsPgLogger"><span class="annot"><span class="annottext">Loggers -&gt; PGLogger
</span><a href="Hasura.App.html#_lsPgLogger"><span class="hs-identifier hs-var hs-var">_lsPgLogger</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Q.PGLogger</span></span><span>
</span><span id="line-295"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span class="hs-comment">-- | An application with Postgres database as a metadata storage</span><span>
</span><span id="line-298"></span><span class="hs-keyword">newtype</span><span> </span><span id="PGMetadataStorageAppT"><span class="annot"><a href="Hasura.App.html#PGMetadataStorageAppT"><span class="hs-identifier hs-var">PGMetadataStorageAppT</span></a></span></span><span> </span><span id="local-6989586621688185527"><span class="annot"><a href="#local-6989586621688185527"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621688185526"><span class="annot"><a href="#local-6989586621688185526"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PGMetadataStorageAppT"><span class="annot"><a href="Hasura.App.html#PGMetadataStorageAppT"><span class="hs-identifier hs-var">PGMetadataStorageAppT</span></a></span></span><span> </span><span class="hs-special">{</span><span id="runPGMetadataStorageAppT"><span class="annot"><span class="annottext">PGMetadataStorageAppT m a -&gt; (PGPool, PGLogger) -&gt; m a
</span><a href="Hasura.App.html#runPGMetadataStorageAppT"><span class="hs-identifier hs-var hs-var">runPGMetadataStorageAppT</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Q.PGPool</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Q.PGLogger</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688185527"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185526"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-299"></span><span>  </span><span class="hs-keyword">deriving</span><span>
</span><span id="line-300"></span><span>    </span><span class="hs-special">(</span><span> </span><span id="local-6989586621688185521"><span id="local-6989586621688185523"><span class="annot"><span class="annottext">a -&gt; PGMetadataStorageAppT m b -&gt; PGMetadataStorageAppT m a
(a -&gt; b) -&gt; PGMetadataStorageAppT m a -&gt; PGMetadataStorageAppT m b
(forall a b.
 (a -&gt; b) -&gt; PGMetadataStorageAppT m a -&gt; PGMetadataStorageAppT m b)
-&gt; (forall a b.
    a -&gt; PGMetadataStorageAppT m b -&gt; PGMetadataStorageAppT m a)
-&gt; Functor (PGMetadataStorageAppT m)
forall a b.
a -&gt; PGMetadataStorageAppT m b -&gt; PGMetadataStorageAppT m a
forall a b.
(a -&gt; b) -&gt; PGMetadataStorageAppT m a -&gt; PGMetadataStorageAppT m b
forall (m :: * -&gt; *) a b.
Functor m =&gt;
a -&gt; PGMetadataStorageAppT m b -&gt; PGMetadataStorageAppT m a
forall (m :: * -&gt; *) a b.
Functor m =&gt;
(a -&gt; b) -&gt; PGMetadataStorageAppT m a -&gt; PGMetadataStorageAppT m b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
&lt;$ :: a -&gt; PGMetadataStorageAppT m b -&gt; PGMetadataStorageAppT m a
$c&lt;$ :: forall (m :: * -&gt; *) a b.
Functor m =&gt;
a -&gt; PGMetadataStorageAppT m b -&gt; PGMetadataStorageAppT m a
fmap :: (a -&gt; b) -&gt; PGMetadataStorageAppT m a -&gt; PGMetadataStorageAppT m b
$cfmap :: forall (m :: * -&gt; *) a b.
Functor m =&gt;
(a -&gt; b) -&gt; PGMetadataStorageAppT m a -&gt; PGMetadataStorageAppT m b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-301"></span><span>      </span><span id="local-6989586621688185509"><span id="local-6989586621688185511"><span id="local-6989586621688185513"><span id="local-6989586621688185515"><span id="local-6989586621688185517"><span class="annot"><span class="annottext">Functor (PGMetadataStorageAppT m)
a -&gt; PGMetadataStorageAppT m a
Functor (PGMetadataStorageAppT m)
-&gt; (forall a. a -&gt; PGMetadataStorageAppT m a)
-&gt; (forall a b.
    PGMetadataStorageAppT m (a -&gt; b)
    -&gt; PGMetadataStorageAppT m a -&gt; PGMetadataStorageAppT m b)
-&gt; (forall a b c.
    (a -&gt; b -&gt; c)
    -&gt; PGMetadataStorageAppT m a
    -&gt; PGMetadataStorageAppT m b
    -&gt; PGMetadataStorageAppT m c)
-&gt; (forall a b.
    PGMetadataStorageAppT m a
    -&gt; PGMetadataStorageAppT m b -&gt; PGMetadataStorageAppT m b)
-&gt; (forall a b.
    PGMetadataStorageAppT m a
    -&gt; PGMetadataStorageAppT m b -&gt; PGMetadataStorageAppT m a)
-&gt; Applicative (PGMetadataStorageAppT m)
PGMetadataStorageAppT m a
-&gt; PGMetadataStorageAppT m b -&gt; PGMetadataStorageAppT m b
PGMetadataStorageAppT m a
-&gt; PGMetadataStorageAppT m b -&gt; PGMetadataStorageAppT m a
PGMetadataStorageAppT m (a -&gt; b)
-&gt; PGMetadataStorageAppT m a -&gt; PGMetadataStorageAppT m b
(a -&gt; b -&gt; c)
-&gt; PGMetadataStorageAppT m a
-&gt; PGMetadataStorageAppT m b
-&gt; PGMetadataStorageAppT m c
forall a. a -&gt; PGMetadataStorageAppT m a
forall a b.
PGMetadataStorageAppT m a
-&gt; PGMetadataStorageAppT m b -&gt; PGMetadataStorageAppT m a
forall a b.
PGMetadataStorageAppT m a
-&gt; PGMetadataStorageAppT m b -&gt; PGMetadataStorageAppT m b
forall a b.
PGMetadataStorageAppT m (a -&gt; b)
-&gt; PGMetadataStorageAppT m a -&gt; PGMetadataStorageAppT m b
forall a b c.
(a -&gt; b -&gt; c)
-&gt; PGMetadataStorageAppT m a
-&gt; PGMetadataStorageAppT m b
-&gt; PGMetadataStorageAppT m c
forall (f :: * -&gt; *).
Functor f
-&gt; (forall a. a -&gt; f a)
-&gt; (forall a b. f (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b c. (a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c)
-&gt; (forall a b. f a -&gt; f b -&gt; f b)
-&gt; (forall a b. f a -&gt; f b -&gt; f a)
-&gt; Applicative f
forall (m :: * -&gt; *).
Applicative m =&gt;
Functor (PGMetadataStorageAppT m)
forall (m :: * -&gt; *) a.
Applicative m =&gt;
a -&gt; PGMetadataStorageAppT m a
forall (m :: * -&gt; *) a b.
Applicative m =&gt;
PGMetadataStorageAppT m a
-&gt; PGMetadataStorageAppT m b -&gt; PGMetadataStorageAppT m a
forall (m :: * -&gt; *) a b.
Applicative m =&gt;
PGMetadataStorageAppT m a
-&gt; PGMetadataStorageAppT m b -&gt; PGMetadataStorageAppT m b
forall (m :: * -&gt; *) a b.
Applicative m =&gt;
PGMetadataStorageAppT m (a -&gt; b)
-&gt; PGMetadataStorageAppT m a -&gt; PGMetadataStorageAppT m b
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; c)
-&gt; PGMetadataStorageAppT m a
-&gt; PGMetadataStorageAppT m b
-&gt; PGMetadataStorageAppT m c
&lt;* :: PGMetadataStorageAppT m a
-&gt; PGMetadataStorageAppT m b -&gt; PGMetadataStorageAppT m a
$c&lt;* :: forall (m :: * -&gt; *) a b.
Applicative m =&gt;
PGMetadataStorageAppT m a
-&gt; PGMetadataStorageAppT m b -&gt; PGMetadataStorageAppT m a
*&gt; :: PGMetadataStorageAppT m a
-&gt; PGMetadataStorageAppT m b -&gt; PGMetadataStorageAppT m b
$c*&gt; :: forall (m :: * -&gt; *) a b.
Applicative m =&gt;
PGMetadataStorageAppT m a
-&gt; PGMetadataStorageAppT m b -&gt; PGMetadataStorageAppT m b
liftA2 :: (a -&gt; b -&gt; c)
-&gt; PGMetadataStorageAppT m a
-&gt; PGMetadataStorageAppT m b
-&gt; PGMetadataStorageAppT m c
$cliftA2 :: forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; c)
-&gt; PGMetadataStorageAppT m a
-&gt; PGMetadataStorageAppT m b
-&gt; PGMetadataStorageAppT m c
&lt;*&gt; :: PGMetadataStorageAppT m (a -&gt; b)
-&gt; PGMetadataStorageAppT m a -&gt; PGMetadataStorageAppT m b
$c&lt;*&gt; :: forall (m :: * -&gt; *) a b.
Applicative m =&gt;
PGMetadataStorageAppT m (a -&gt; b)
-&gt; PGMetadataStorageAppT m a -&gt; PGMetadataStorageAppT m b
pure :: a -&gt; PGMetadataStorageAppT m a
$cpure :: forall (m :: * -&gt; *) a.
Applicative m =&gt;
a -&gt; PGMetadataStorageAppT m a
$cp1Applicative :: forall (m :: * -&gt; *).
Applicative m =&gt;
Functor (PGMetadataStorageAppT m)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Applicative</span></span></span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-302"></span><span>      </span><span id="local-6989586621688185501"><span id="local-6989586621688185503"><span id="local-6989586621688185505"><span class="annot"><span class="annottext">Applicative (PGMetadataStorageAppT m)
a -&gt; PGMetadataStorageAppT m a
Applicative (PGMetadataStorageAppT m)
-&gt; (forall a b.
    PGMetadataStorageAppT m a
    -&gt; (a -&gt; PGMetadataStorageAppT m b) -&gt; PGMetadataStorageAppT m b)
-&gt; (forall a b.
    PGMetadataStorageAppT m a
    -&gt; PGMetadataStorageAppT m b -&gt; PGMetadataStorageAppT m b)
-&gt; (forall a. a -&gt; PGMetadataStorageAppT m a)
-&gt; Monad (PGMetadataStorageAppT m)
PGMetadataStorageAppT m a
-&gt; (a -&gt; PGMetadataStorageAppT m b) -&gt; PGMetadataStorageAppT m b
PGMetadataStorageAppT m a
-&gt; PGMetadataStorageAppT m b -&gt; PGMetadataStorageAppT m b
forall a. a -&gt; PGMetadataStorageAppT m a
forall a b.
PGMetadataStorageAppT m a
-&gt; PGMetadataStorageAppT m b -&gt; PGMetadataStorageAppT m b
forall a b.
PGMetadataStorageAppT m a
-&gt; (a -&gt; PGMetadataStorageAppT m b) -&gt; PGMetadataStorageAppT m b
forall (m :: * -&gt; *).
Monad m =&gt;
Applicative (PGMetadataStorageAppT m)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; PGMetadataStorageAppT m a
forall (m :: * -&gt; *) a b.
Monad m =&gt;
PGMetadataStorageAppT m a
-&gt; PGMetadataStorageAppT m b -&gt; PGMetadataStorageAppT m b
forall (m :: * -&gt; *) a b.
Monad m =&gt;
PGMetadataStorageAppT m a
-&gt; (a -&gt; PGMetadataStorageAppT m b) -&gt; PGMetadataStorageAppT m b
forall (m :: * -&gt; *).
Applicative m
-&gt; (forall a b. m a -&gt; (a -&gt; m b) -&gt; m b)
-&gt; (forall a b. m a -&gt; m b -&gt; m b)
-&gt; (forall a. a -&gt; m a)
-&gt; Monad m
return :: a -&gt; PGMetadataStorageAppT m a
$creturn :: forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; PGMetadataStorageAppT m a
&gt;&gt; :: PGMetadataStorageAppT m a
-&gt; PGMetadataStorageAppT m b -&gt; PGMetadataStorageAppT m b
$c&gt;&gt; :: forall (m :: * -&gt; *) a b.
Monad m =&gt;
PGMetadataStorageAppT m a
-&gt; PGMetadataStorageAppT m b -&gt; PGMetadataStorageAppT m b
&gt;&gt;= :: PGMetadataStorageAppT m a
-&gt; (a -&gt; PGMetadataStorageAppT m b) -&gt; PGMetadataStorageAppT m b
$c&gt;&gt;= :: forall (m :: * -&gt; *) a b.
Monad m =&gt;
PGMetadataStorageAppT m a
-&gt; (a -&gt; PGMetadataStorageAppT m b) -&gt; PGMetadataStorageAppT m b
$cp1Monad :: forall (m :: * -&gt; *).
Monad m =&gt;
Applicative (PGMetadataStorageAppT m)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monad</span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-303"></span><span>      </span><span id="local-6989586621688185497"><span class="annot"><span class="annottext">Monad (PGMetadataStorageAppT m)
Monad (PGMetadataStorageAppT m)
-&gt; (forall a. IO a -&gt; PGMetadataStorageAppT m a)
-&gt; MonadIO (PGMetadataStorageAppT m)
IO a -&gt; PGMetadataStorageAppT m a
forall a. IO a -&gt; PGMetadataStorageAppT m a
forall (m :: * -&gt; *).
Monad m -&gt; (forall a. IO a -&gt; m a) -&gt; MonadIO m
forall (m :: * -&gt; *). MonadIO m =&gt; Monad (PGMetadataStorageAppT m)
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
IO a -&gt; PGMetadataStorageAppT m a
liftIO :: IO a -&gt; PGMetadataStorageAppT m a
$cliftIO :: forall (m :: * -&gt; *) a.
MonadIO m =&gt;
IO a -&gt; PGMetadataStorageAppT m a
$cp1MonadIO :: forall (m :: * -&gt; *). MonadIO m =&gt; Monad (PGMetadataStorageAppT m)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var">MonadIO</span></span></span><span class="hs-special">,</span><span>
</span><span id="line-304"></span><span>      </span><span id="local-6989586621688185493"><span class="annot"><span class="annottext">MonadThrow (PGMetadataStorageAppT m)
MonadThrow (PGMetadataStorageAppT m)
-&gt; (forall e a.
    Exception e =&gt;
    PGMetadataStorageAppT m a
    -&gt; (e -&gt; PGMetadataStorageAppT m a) -&gt; PGMetadataStorageAppT m a)
-&gt; MonadCatch (PGMetadataStorageAppT m)
PGMetadataStorageAppT m a
-&gt; (e -&gt; PGMetadataStorageAppT m a) -&gt; PGMetadataStorageAppT m a
forall e a.
Exception e =&gt;
PGMetadataStorageAppT m a
-&gt; (e -&gt; PGMetadataStorageAppT m a) -&gt; PGMetadataStorageAppT m a
forall (m :: * -&gt; *).
MonadThrow m
-&gt; (forall e a. Exception e =&gt; m a -&gt; (e -&gt; m a) -&gt; m a)
-&gt; MonadCatch m
forall (m :: * -&gt; *).
MonadCatch m =&gt;
MonadThrow (PGMetadataStorageAppT m)
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
PGMetadataStorageAppT m a
-&gt; (e -&gt; PGMetadataStorageAppT m a) -&gt; PGMetadataStorageAppT m a
catch :: PGMetadataStorageAppT m a
-&gt; (e -&gt; PGMetadataStorageAppT m a) -&gt; PGMetadataStorageAppT m a
$ccatch :: forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
PGMetadataStorageAppT m a
-&gt; (e -&gt; PGMetadataStorageAppT m a) -&gt; PGMetadataStorageAppT m a
$cp1MonadCatch :: forall (m :: * -&gt; *).
MonadCatch m =&gt;
MonadThrow (PGMetadataStorageAppT m)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var">MonadCatch</span></span></span><span class="hs-special">,</span><span>
</span><span id="line-305"></span><span>      </span><span id="local-6989586621688185489"><span class="annot"><span class="annottext">Monad (PGMetadataStorageAppT m)
e -&gt; PGMetadataStorageAppT m a
Monad (PGMetadataStorageAppT m)
-&gt; (forall e a. Exception e =&gt; e -&gt; PGMetadataStorageAppT m a)
-&gt; MonadThrow (PGMetadataStorageAppT m)
forall e a. Exception e =&gt; e -&gt; PGMetadataStorageAppT m a
forall (m :: * -&gt; *).
Monad m -&gt; (forall e a. Exception e =&gt; e -&gt; m a) -&gt; MonadThrow m
forall (m :: * -&gt; *).
MonadThrow m =&gt;
Monad (PGMetadataStorageAppT m)
forall (m :: * -&gt; *) e a.
(MonadThrow m, Exception e) =&gt;
e -&gt; PGMetadataStorageAppT m a
throwM :: e -&gt; PGMetadataStorageAppT m a
$cthrowM :: forall (m :: * -&gt; *) e a.
(MonadThrow m, Exception e) =&gt;
e -&gt; PGMetadataStorageAppT m a
$cp1MonadThrow :: forall (m :: * -&gt; *).
MonadThrow m =&gt;
Monad (PGMetadataStorageAppT m)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var">MonadThrow</span></span></span><span class="hs-special">,</span><span>
</span><span id="line-306"></span><span>      </span><span id="local-6989586621688185481"><span id="local-6989586621688185483"><span id="local-6989586621688185485"><span class="annot"><span class="annottext">MonadCatch (PGMetadataStorageAppT m)
MonadCatch (PGMetadataStorageAppT m)
-&gt; (forall b.
    ((forall a. PGMetadataStorageAppT m a -&gt; PGMetadataStorageAppT m a)
     -&gt; PGMetadataStorageAppT m b)
    -&gt; PGMetadataStorageAppT m b)
-&gt; (forall b.
    ((forall a. PGMetadataStorageAppT m a -&gt; PGMetadataStorageAppT m a)
     -&gt; PGMetadataStorageAppT m b)
    -&gt; PGMetadataStorageAppT m b)
-&gt; (forall a b c.
    PGMetadataStorageAppT m a
    -&gt; (a -&gt; ExitCase b -&gt; PGMetadataStorageAppT m c)
    -&gt; (a -&gt; PGMetadataStorageAppT m b)
    -&gt; PGMetadataStorageAppT m (b, c))
-&gt; MonadMask (PGMetadataStorageAppT m)
PGMetadataStorageAppT m a
-&gt; (a -&gt; ExitCase b -&gt; PGMetadataStorageAppT m c)
-&gt; (a -&gt; PGMetadataStorageAppT m b)
-&gt; PGMetadataStorageAppT m (b, c)
((forall a. PGMetadataStorageAppT m a -&gt; PGMetadataStorageAppT m a)
 -&gt; PGMetadataStorageAppT m b)
-&gt; PGMetadataStorageAppT m b
((forall a. PGMetadataStorageAppT m a -&gt; PGMetadataStorageAppT m a)
 -&gt; PGMetadataStorageAppT m b)
-&gt; PGMetadataStorageAppT m b
forall b.
((forall a. PGMetadataStorageAppT m a -&gt; PGMetadataStorageAppT m a)
 -&gt; PGMetadataStorageAppT m b)
-&gt; PGMetadataStorageAppT m b
forall a b c.
PGMetadataStorageAppT m a
-&gt; (a -&gt; ExitCase b -&gt; PGMetadataStorageAppT m c)
-&gt; (a -&gt; PGMetadataStorageAppT m b)
-&gt; PGMetadataStorageAppT m (b, c)
forall (m :: * -&gt; *).
MonadCatch m
-&gt; (forall b. ((forall a. m a -&gt; m a) -&gt; m b) -&gt; m b)
-&gt; (forall b. ((forall a. m a -&gt; m a) -&gt; m b) -&gt; m b)
-&gt; (forall a b c.
    m a -&gt; (a -&gt; ExitCase b -&gt; m c) -&gt; (a -&gt; m b) -&gt; m (b, c))
-&gt; MonadMask m
forall (m :: * -&gt; *).
MonadMask m =&gt;
MonadCatch (PGMetadataStorageAppT m)
forall (m :: * -&gt; *) b.
MonadMask m =&gt;
((forall a. PGMetadataStorageAppT m a -&gt; PGMetadataStorageAppT m a)
 -&gt; PGMetadataStorageAppT m b)
-&gt; PGMetadataStorageAppT m b
forall (m :: * -&gt; *) a b c.
MonadMask m =&gt;
PGMetadataStorageAppT m a
-&gt; (a -&gt; ExitCase b -&gt; PGMetadataStorageAppT m c)
-&gt; (a -&gt; PGMetadataStorageAppT m b)
-&gt; PGMetadataStorageAppT m (b, c)
generalBracket :: PGMetadataStorageAppT m a
-&gt; (a -&gt; ExitCase b -&gt; PGMetadataStorageAppT m c)
-&gt; (a -&gt; PGMetadataStorageAppT m b)
-&gt; PGMetadataStorageAppT m (b, c)
$cgeneralBracket :: forall (m :: * -&gt; *) a b c.
MonadMask m =&gt;
PGMetadataStorageAppT m a
-&gt; (a -&gt; ExitCase b -&gt; PGMetadataStorageAppT m c)
-&gt; (a -&gt; PGMetadataStorageAppT m b)
-&gt; PGMetadataStorageAppT m (b, c)
uninterruptibleMask :: ((forall a. PGMetadataStorageAppT m a -&gt; PGMetadataStorageAppT m a)
 -&gt; PGMetadataStorageAppT m b)
-&gt; PGMetadataStorageAppT m b
$cuninterruptibleMask :: forall (m :: * -&gt; *) b.
MonadMask m =&gt;
((forall a. PGMetadataStorageAppT m a -&gt; PGMetadataStorageAppT m a)
 -&gt; PGMetadataStorageAppT m b)
-&gt; PGMetadataStorageAppT m b
mask :: ((forall a. PGMetadataStorageAppT m a -&gt; PGMetadataStorageAppT m a)
 -&gt; PGMetadataStorageAppT m b)
-&gt; PGMetadataStorageAppT m b
$cmask :: forall (m :: * -&gt; *) b.
MonadMask m =&gt;
((forall a. PGMetadataStorageAppT m a -&gt; PGMetadataStorageAppT m a)
 -&gt; PGMetadataStorageAppT m b)
-&gt; PGMetadataStorageAppT m b
$cp1MonadMask :: forall (m :: * -&gt; *).
MonadMask m =&gt;
MonadCatch (PGMetadataStorageAppT m)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">MonadMask</span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-307"></span><span>      </span><span id="local-6989586621688185477"><span class="annot"><span class="annottext">Monad (PGMetadataStorageAppT m)
PGMetadataStorageAppT m Manager
Monad (PGMetadataStorageAppT m)
-&gt; PGMetadataStorageAppT m Manager
-&gt; HasHttpManagerM (PGMetadataStorageAppT m)
forall (m :: * -&gt; *). Monad m -&gt; m Manager -&gt; HasHttpManagerM m
forall (m :: * -&gt; *).
HasHttpManagerM m =&gt;
Monad (PGMetadataStorageAppT m)
forall (m :: * -&gt; *).
HasHttpManagerM m =&gt;
PGMetadataStorageAppT m Manager
askHttpManager :: PGMetadataStorageAppT m Manager
$caskHttpManager :: forall (m :: * -&gt; *).
HasHttpManagerM m =&gt;
PGMetadataStorageAppT m Manager
$cp1HasHttpManagerM :: forall (m :: * -&gt; *).
HasHttpManagerM m =&gt;
Monad (PGMetadataStorageAppT m)
</span><a href="Network.HTTP.Client.Manager.html#C%3AHasHttpManagerM"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var">HasHttpManagerM</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-308"></span><span>      </span><span id="local-6989586621688185473"><span class="annot"><span class="annottext">Monad (PGMetadataStorageAppT m)
PGMetadataStorageAppT m ServerConfigCtx
Monad (PGMetadataStorageAppT m)
-&gt; PGMetadataStorageAppT m ServerConfigCtx
-&gt; HasServerConfigCtx (PGMetadataStorageAppT m)
forall (m :: * -&gt; *).
Monad m -&gt; m ServerConfigCtx -&gt; HasServerConfigCtx m
forall (m :: * -&gt; *).
HasServerConfigCtx m =&gt;
Monad (PGMetadataStorageAppT m)
forall (m :: * -&gt; *).
HasServerConfigCtx m =&gt;
PGMetadataStorageAppT m ServerConfigCtx
askServerConfigCtx :: PGMetadataStorageAppT m ServerConfigCtx
$caskServerConfigCtx :: forall (m :: * -&gt; *).
HasServerConfigCtx m =&gt;
PGMetadataStorageAppT m ServerConfigCtx
$cp1HasServerConfigCtx :: forall (m :: * -&gt; *).
HasServerConfigCtx m =&gt;
Monad (PGMetadataStorageAppT m)
</span><a href="Hasura.RQL.Types.html#C%3AHasServerConfigCtx"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var">HasServerConfigCtx</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-309"></span><span>      </span><span id="local-6989586621688185465"><span id="local-6989586621688185467"><span id="local-6989586621688185469"><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Q.PGPool</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Q.PGLogger</span></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-310"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-311"></span><span>    </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Q.PGPool</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Q.PGLogger</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688185527"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-312"></span><span>
</span><span id="line-313"></span><span id="local-6989586621688185457"><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621688185455"><span class="hs-keyword">via</span><span>
</span><span id="line-314"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Q.PGPool</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Q.PGLogger</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688185455"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-315"></span><span>  </span><span class="hs-keyword">instance</span><span>
</span><span id="line-316"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadBase</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688185455"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadBase</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#PGMetadataStorageAppT"><span class="hs-identifier hs-type">PGMetadataStorageAppT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185455"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-317"></span><span>
</span><span id="line-318"></span><span id="local-6989586621688185450"><span id="local-6989586621688185452"><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621688185448"><span class="hs-keyword">via</span><span>
</span><span id="line-319"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Q.PGPool</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Q.PGLogger</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688185448"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-320"></span><span>  </span><span class="hs-keyword">instance</span><span>
</span><span id="line-321"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688185448"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#PGMetadataStorageAppT"><span class="hs-identifier hs-type">PGMetadataStorageAppT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185448"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-322"></span><span>
</span><span id="line-323"></span><span id="local-6989586621688185446"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">via</span><span>
</span><span id="line-324"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Q.PGPool</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Q.PGLogger</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-325"></span><span>  </span><span class="hs-keyword">instance</span><span>
</span><span id="line-326"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadTrans</span></span><span> </span><span class="annot"><a href="Hasura.App.html#PGMetadataStorageAppT"><span class="hs-identifier hs-type">PGMetadataStorageAppT</span></a></span></span><span>
</span><span id="line-327"></span><span>
</span><span id="line-328"></span><span id="local-6989586621688186274"><span class="annot"><a href="Hasura.App.html#resolvePostgresConnInfo"><span class="hs-identifier hs-type">resolvePostgresConnInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-329"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688186274"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Data.Environment.html#Environment"><span class="hs-identifier hs-type">Env.Environment</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#UrlConf"><span class="hs-identifier hs-type">UrlConf</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688186274"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Q.ConnInfo</span></span></span><span>
</span><span id="line-330"></span><span id="resolvePostgresConnInfo"><span class="annot"><span class="annottext">resolvePostgresConnInfo :: Environment -&gt; UrlConf -&gt; Maybe Int -&gt; m ConnInfo
</span><a href="Hasura.App.html#resolvePostgresConnInfo"><span class="hs-identifier hs-var hs-var">resolvePostgresConnInfo</span></a></span></span><span> </span><span id="local-6989586621688185444"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688185444"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621688185443"><span class="annot"><span class="annottext">UrlConf
</span><a href="#local-6989586621688185443"><span class="hs-identifier hs-var">dbUrlConf</span></a></span></span><span> </span><span id="local-6989586621688185442"><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621688185442"><span class="hs-identifier hs-var">maybeRetries</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-331"></span><span>  </span><span id="local-6989586621688185441"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688185441"><span class="hs-identifier hs-var">dbUrlText</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-332"></span><span>    </span><span class="annot"><span class="annottext">Except QErr Text -&gt; Either QErr Text
forall e a. Except e a -&gt; Either e a
</span><span class="hs-identifier hs-var">runExcept</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Environment -&gt; UrlConf -&gt; Except QErr Text
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
Environment -&gt; UrlConf -&gt; m Text
</span><a href="Hasura.RQL.Types.Common.html#resolveUrlConf"><span class="hs-identifier hs-var">resolveUrlConf</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688185444"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">UrlConf
</span><a href="#local-6989586621688185443"><span class="hs-identifier hs-var">dbUrlConf</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Either QErr Text -&gt; (QErr -&gt; m Text) -&gt; m Text
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="Hasura.Prelude.html#onLeft"><span class="hs-operator hs-var">`onLeft`</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688185438"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688185438"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-333"></span><span>      </span><span class="annot"><span class="annottext">IO Text -&gt; m Text
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExitCode -&gt; String -&gt; IO Text
forall (m :: * -&gt; *) a. MonadIO m =&gt; ExitCode -&gt; String -&gt; m a
</span><a href="Hasura.App.html#printErrExit"><span class="hs-identifier hs-var">printErrExit</span></a></span><span> </span><span class="annot"><span class="annottext">ExitCode
</span><a href="Hasura.App.html#InvalidDatabaseConnectionParamsError"><span class="hs-identifier hs-var">InvalidDatabaseConnectionParamsError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; String
</span><span class="hs-identifier hs-var">BLC.unpack</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; String) -&gt; ByteString -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">A.encode</span></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688185438"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-334"></span><span>  </span><span class="annot"><span class="annottext">ConnInfo -&gt; m ConnInfo
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ConnInfo -&gt; m ConnInfo) -&gt; ConnInfo -&gt; m ConnInfo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; ConnDetails -&gt; ConnInfo
</span><span class="hs-identifier hs-var">Q.ConnInfo</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688185436"><span class="hs-identifier hs-var">retries</span></a></span><span> </span><span class="annot"><span class="annottext">(ConnDetails -&gt; ConnInfo) -&gt; ConnDetails -&gt; ConnInfo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ConnDetails
</span><span class="hs-identifier hs-var">Q.CDDatabaseURI</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ConnDetails) -&gt; ByteString -&gt; ConnDetails
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; ByteString
</span><a href="Hasura.Prelude.html#txtToBs"><span class="hs-identifier hs-var">txtToBs</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688185441"><span class="hs-identifier hs-var">dbUrlText</span></a></span><span>
</span><span id="line-335"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-336"></span><span>    </span><span id="local-6989586621688185436"><span class="annot"><span class="annottext">retries :: Int
</span><a href="#local-6989586621688185436"><span class="hs-identifier hs-var hs-var">retries</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int -&gt; Int
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621688185442"><span class="hs-identifier hs-var">maybeRetries</span></a></span><span>
</span><span id="line-337"></span><span>
</span><span id="line-338"></span><span class="hs-comment">-- | Initializes or migrates the catalog and returns the context required to start the server.</span><span>
</span><span id="line-339"></span><span id="local-6989586621688185435"><span class="annot"><a href="Hasura.App.html#initialiseServeCtx"><span class="hs-identifier hs-type">initialiseServeCtx</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-340"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Extended.html#ForkableMonadIO"><span class="hs-identifier hs-type">C.ForkableMonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185435"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadCatch</span></span><span> </span><span class="annot"><a href="#local-6989586621688185435"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-341"></span><span>  </span><span class="annot"><a href="Data.Environment.html#Environment"><span class="hs-identifier hs-type">Env.Environment</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-342"></span><span>  </span><span class="annot"><a href="Hasura.App.html#GlobalCtx"><span class="hs-identifier hs-type">GlobalCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-343"></span><span>  </span><span class="annot"><a href="Hasura.Server.Init.Config.html#ServeOptions"><span class="hs-identifier hs-type">ServeOptions</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-344"></span><span>  </span><span class="annot"><a href="Control.Monad.Trans.Managed.html#ManagedT"><span class="hs-identifier hs-type">ManagedT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185435"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#ServeCtx"><span class="hs-identifier hs-type">ServeCtx</span></a></span></span><span>
</span><span id="line-345"></span><span id="initialiseServeCtx"><span class="annot"><span class="annottext">initialiseServeCtx :: Environment
-&gt; GlobalCtx -&gt; ServeOptions Hasura -&gt; ManagedT m ServeCtx
</span><a href="Hasura.App.html#initialiseServeCtx"><span class="hs-identifier hs-var hs-var">initialiseServeCtx</span></a></span></span><span> </span><span id="local-6989586621688185434"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688185434"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="annot"><a href="Hasura.App.html#GlobalCtx"><span class="hs-identifier hs-type">GlobalCtx</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688185432"><span id="local-6989586621688185433"><span class="annot"><span class="annottext">(Maybe (UrlConf, ConnInfo), Maybe Int)
ConnInfo
_gcDefaultPostgresConnInfo :: (Maybe (UrlConf, ConnInfo), Maybe Int)
_gcMetadataDbConnInfo :: ConnInfo
_gcDefaultPostgresConnInfo :: GlobalCtx -&gt; (Maybe (UrlConf, ConnInfo), Maybe Int)
_gcMetadataDbConnInfo :: GlobalCtx -&gt; ConnInfo
</span><a href="#local-6989586621688185432"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621688185431"><span class="annot"><span class="annottext">so :: ServeOptions Hasura
</span><a href="#local-6989586621688185431"><span class="hs-identifier hs-var">so</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.Server.Init.Config.html#ServeOptions"><span class="hs-identifier hs-type">ServeOptions</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688185393"><span id="local-6989586621688185394"><span id="local-6989586621688185395"><span id="local-6989586621688185396"><span id="local-6989586621688185397"><span id="local-6989586621688185398"><span id="local-6989586621688185399"><span id="local-6989586621688185400"><span id="local-6989586621688185401"><span id="local-6989586621688185402"><span id="local-6989586621688185403"><span id="local-6989586621688185404"><span id="local-6989586621688185405"><span id="local-6989586621688185406"><span id="local-6989586621688185407"><span id="local-6989586621688185408"><span id="local-6989586621688185409"><span id="local-6989586621688185410"><span id="local-6989586621688185411"><span id="local-6989586621688185412"><span id="local-6989586621688185413"><span id="local-6989586621688185414"><span id="local-6989586621688185415"><span id="local-6989586621688185416"><span id="local-6989586621688185417"><span id="local-6989586621688185418"><span id="local-6989586621688185419"><span id="local-6989586621688185420"><span id="local-6989586621688185421"><span id="local-6989586621688185422"><span id="local-6989586621688185423"><span id="local-6989586621688185424"><span id="local-6989586621688185425"><span id="local-6989586621688185426"><span id="local-6989586621688185427"><span id="local-6989586621688185428"><span id="local-6989586621688185429"><span class="annot"><span class="annottext">Bool
Int
[JWTConfig]
Maybe Int
Maybe Text
Maybe Milliseconds
Maybe RoleName
Maybe AuthHook
HashSet (EngineLogType Hasura)
HashSet ExperimentalFeature
HashSet AdminSecretHash
HashSet API
Seconds
LogLevel
ConnParams
TxIsolation
CorsConfig
NonNegativeInt
StringifyNumbers
FunctionPermissionsCtx
LiveQueriesOptions
RemoteSchemaPermsCtx
EventingMode
ReadOnlyMode
MaintenanceMode
HostPreference
ConnectionOptions
OptionalInterval
KeepAliveDelay
ResponseInternalErrorsConfig
WSConnectionInitTimeout
soReadOnlyMode :: forall impl. ServeOptions impl -&gt; ReadOnlyMode
soEventingMode :: forall impl. ServeOptions impl -&gt; EventingMode
soWebsocketConnectionInitTimeout :: forall impl. ServeOptions impl -&gt; WSConnectionInitTimeout
soGracefulShutdownTimeout :: forall impl. ServeOptions impl -&gt; Seconds
soDevMode :: forall impl. ServeOptions impl -&gt; Bool
soEventsFetchBatchSize :: forall impl. ServeOptions impl -&gt; NonNegativeInt
soExperimentalFeatures :: forall impl. ServeOptions impl -&gt; HashSet ExperimentalFeature
soSchemaPollInterval :: forall impl. ServeOptions impl -&gt; OptionalInterval
soEnableMaintenanceMode :: forall impl. ServeOptions impl -&gt; MaintenanceMode
soInferFunctionPermissions :: forall impl. ServeOptions impl -&gt; FunctionPermissionsCtx
soWebsocketKeepAlive :: forall impl. ServeOptions impl -&gt; KeepAliveDelay
soConnectionOptions :: forall impl. ServeOptions impl -&gt; ConnectionOptions
soEnableRemoteSchemaPermissions :: forall impl. ServeOptions impl -&gt; RemoteSchemaPermsCtx
soLogHeadersFromEnv :: forall impl. ServeOptions impl -&gt; Bool
soAsyncActionsFetchInterval :: forall impl. ServeOptions impl -&gt; OptionalInterval
soEventsFetchInterval :: forall impl. ServeOptions impl -&gt; Maybe Milliseconds
soEventsHttpPoolSize :: forall impl. ServeOptions impl -&gt; Maybe Int
soResponseInternalErrorsConfig :: forall impl. ServeOptions impl -&gt; ResponseInternalErrorsConfig
soLogLevel :: forall impl. ServeOptions impl -&gt; LogLevel
soEnabledLogTypes :: forall impl. ServeOptions impl -&gt; HashSet (EngineLogType impl)
soEnableAllowlist :: forall impl. ServeOptions impl -&gt; Bool
soLiveQueryOpts :: forall impl. ServeOptions impl -&gt; LiveQueriesOptions
soEnabledAPIs :: forall impl. ServeOptions impl -&gt; HashSet API
soDangerousBooleanCollapse :: forall impl. ServeOptions impl -&gt; Bool
soStringifyNum :: forall impl. ServeOptions impl -&gt; StringifyNumbers
soEnableTelemetry :: forall impl. ServeOptions impl -&gt; Bool
soConsoleAssetsDir :: forall impl. ServeOptions impl -&gt; Maybe Text
soEnableConsole :: forall impl. ServeOptions impl -&gt; Bool
soCorsConfig :: forall impl. ServeOptions impl -&gt; CorsConfig
soUnAuthRole :: forall impl. ServeOptions impl -&gt; Maybe RoleName
soJwtSecret :: forall impl. ServeOptions impl -&gt; [JWTConfig]
soAuthHook :: forall impl. ServeOptions impl -&gt; Maybe AuthHook
soAdminSecret :: forall impl. ServeOptions impl -&gt; HashSet AdminSecretHash
soTxIso :: forall impl. ServeOptions impl -&gt; TxIsolation
soConnParams :: forall impl. ServeOptions impl -&gt; ConnParams
soHost :: forall impl. ServeOptions impl -&gt; HostPreference
soPort :: forall impl. ServeOptions impl -&gt; Int
soReadOnlyMode :: ReadOnlyMode
soEventingMode :: EventingMode
soWebsocketConnectionInitTimeout :: WSConnectionInitTimeout
soGracefulShutdownTimeout :: Seconds
soDevMode :: Bool
soEventsFetchBatchSize :: NonNegativeInt
soExperimentalFeatures :: HashSet ExperimentalFeature
soSchemaPollInterval :: OptionalInterval
soEnableMaintenanceMode :: MaintenanceMode
soInferFunctionPermissions :: FunctionPermissionsCtx
soWebsocketKeepAlive :: KeepAliveDelay
soConnectionOptions :: ConnectionOptions
soEnableRemoteSchemaPermissions :: RemoteSchemaPermsCtx
soLogHeadersFromEnv :: Bool
soAsyncActionsFetchInterval :: OptionalInterval
soEventsFetchInterval :: Maybe Milliseconds
soEventsHttpPoolSize :: Maybe Int
soResponseInternalErrorsConfig :: ResponseInternalErrorsConfig
soLogLevel :: LogLevel
soEnabledLogTypes :: HashSet (EngineLogType Hasura)
soEnableAllowlist :: Bool
soLiveQueryOpts :: LiveQueriesOptions
soEnabledAPIs :: HashSet API
soDangerousBooleanCollapse :: Bool
soStringifyNum :: StringifyNumbers
soEnableTelemetry :: Bool
soConsoleAssetsDir :: Maybe Text
soEnableConsole :: Bool
soCorsConfig :: CorsConfig
soUnAuthRole :: Maybe RoleName
soJwtSecret :: [JWTConfig]
soAuthHook :: Maybe AuthHook
soAdminSecret :: HashSet AdminSecretHash
soTxIso :: TxIsolation
soConnParams :: ConnParams
soHost :: HostPreference
soPort :: Int
</span><a href="Hasura.Server.Init.Config.html#soReadOnlyMode"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-346"></span><span>  </span><span id="local-6989586621688185355"><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621688185355"><span class="hs-identifier hs-var">instanceId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO InstanceId -&gt; ManagedT m InstanceId
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO InstanceId
</span><a href="Hasura.Server.Init.html#generateInstanceId"><span class="hs-identifier hs-var">generateInstanceId</span></a></span><span>
</span><span id="line-347"></span><span>  </span><span id="local-6989586621688185353"><span class="annot"><span class="annottext">ShutdownLatch
</span><a href="#local-6989586621688185353"><span class="hs-identifier hs-var">latch</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ShutdownLatch -&gt; ManagedT m ShutdownLatch
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO ShutdownLatch
</span><a href="Hasura.App.html#newShutdownLatch"><span class="hs-identifier hs-var">newShutdownLatch</span></a></span><span>
</span><span id="line-348"></span><span>  </span><span id="local-6989586621688185352"><span class="annot"><span class="annottext">loggers :: Loggers
</span><a href="#local-6989586621688185352"><span class="hs-identifier hs-var">loggers</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#Loggers"><span class="hs-identifier hs-type">Loggers</span></a></span><span> </span><span id="local-6989586621688185351"><span class="annot"><span class="annottext">LoggerCtx Hasura
</span><a href="#local-6989586621688185351"><span class="hs-identifier hs-var">loggerCtx</span></a></span></span><span> </span><span id="local-6989586621688185350"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185350"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621688185349"><span class="annot"><span class="annottext">PGLogger
</span><a href="#local-6989586621688185349"><span class="hs-identifier hs-var">pgLogger</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HashSet (EngineLogType Hasura) -&gt; LogLevel -&gt; ManagedT m Loggers
forall (m :: * -&gt; *).
(MonadIO m, MonadBaseControl IO m) =&gt;
HashSet (EngineLogType Hasura) -&gt; LogLevel -&gt; ManagedT m Loggers
</span><a href="Hasura.App.html#mkLoggers"><span class="hs-identifier hs-var">mkLoggers</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (EngineLogType Hasura)
</span><a href="#local-6989586621688185412"><span class="hs-identifier hs-var">soEnabledLogTypes</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="#local-6989586621688185411"><span class="hs-identifier hs-var">soLogLevel</span></a></span><span>
</span><span id="line-349"></span><span>  </span><span class="hs-comment">-- log serve options</span><span>
</span><span id="line-350"></span><span>  </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185350"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(StartupLog -&gt; ManagedT m ()) -&gt; StartupLog -&gt; ManagedT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServeOptions Hasura -&gt; StartupLog
forall impl.
ToJSON (EngineLogType impl) =&gt;
ServeOptions impl -&gt; StartupLog
</span><a href="Hasura.Server.Init.html#serveOptsToLog"><span class="hs-identifier hs-var">serveOptsToLog</span></a></span><span> </span><span class="annot"><span class="annottext">ServeOptions Hasura
</span><a href="#local-6989586621688185431"><span class="hs-identifier hs-var">so</span></a></span><span>
</span><span id="line-351"></span><span>
</span><span id="line-352"></span><span>  </span><span class="hs-comment">-- log postgres connection info</span><span>
</span><span id="line-353"></span><span>  </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185350"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(StartupLog -&gt; ManagedT m ()) -&gt; StartupLog -&gt; ManagedT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConnInfo -&gt; StartupLog
</span><a href="Hasura.Server.Init.html#connInfoToLog"><span class="hs-identifier hs-var">connInfoToLog</span></a></span><span> </span><span class="annot"><span class="annottext">ConnInfo
</span><a href="#local-6989586621688185433"><span class="hs-identifier hs-var">_gcMetadataDbConnInfo</span></a></span><span>
</span><span id="line-354"></span><span>
</span><span id="line-355"></span><span>  </span><span id="local-6989586621688185345"><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621688185345"><span class="hs-identifier hs-var">metadataDbPool</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO PGPool -&gt; ManagedT m PGPool
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO PGPool -&gt; ManagedT m PGPool) -&gt; IO PGPool -&gt; ManagedT m PGPool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConnInfo -&gt; ConnParams -&gt; PGLogger -&gt; IO PGPool
</span><span class="hs-identifier hs-var">Q.initPGPool</span></span><span> </span><span class="annot"><span class="annottext">ConnInfo
</span><a href="#local-6989586621688185433"><span class="hs-identifier hs-var">_gcMetadataDbConnInfo</span></a></span><span> </span><span class="annot"><span class="annottext">ConnParams
</span><a href="#local-6989586621688185427"><span class="hs-identifier hs-var">soConnParams</span></a></span><span> </span><span class="annot"><span class="annottext">PGLogger
</span><a href="#local-6989586621688185349"><span class="hs-identifier hs-var">pgLogger</span></a></span><span>
</span><span id="line-356"></span><span>
</span><span id="line-357"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688185343"><span class="annot"><span class="annottext">maybeDefaultSourceConfig :: Maybe PostgresConnConfiguration
</span><a href="#local-6989586621688185343"><span class="hs-identifier hs-var hs-var">maybeDefaultSourceConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-358"></span><span>        </span><span class="annot"><span class="annottext">(Maybe (UrlConf, ConnInfo), Maybe Int) -&gt; Maybe (UrlConf, ConnInfo)
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (UrlConf, ConnInfo), Maybe Int)
</span><a href="#local-6989586621688185432"><span class="hs-identifier hs-var">_gcDefaultPostgresConnInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (UrlConf, ConnInfo)
-&gt; ((UrlConf, ConnInfo) -&gt; PostgresConnConfiguration)
-&gt; Maybe PostgresConnConfiguration
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621688185341"><span class="annot"><span class="annottext">UrlConf
</span><a href="#local-6989586621688185341"><span class="hs-identifier hs-var">dbUrlConf</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConnInfo
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-359"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688185340"><span class="annot"><span class="annottext">connSettings :: PostgresPoolSettings
</span><a href="#local-6989586621688185340"><span class="hs-identifier hs-var hs-var">connSettings</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-360"></span><span>                </span><span class="annot"><span class="annottext">PostgresPoolSettings :: Maybe Int
-&gt; Maybe Int
-&gt; Maybe Int
-&gt; Maybe NominalDiffTime
-&gt; Maybe NominalDiffTime
-&gt; PostgresPoolSettings
</span><a href="Hasura.Backends.Postgres.Connection.html#PostgresPoolSettings"><span class="hs-identifier hs-type">PostgresPoolSettings</span></a></span><span>
</span><span id="line-361"></span><span>                  </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_ppsMaxConnections :: Maybe Int
</span><a href="Hasura.Backends.Postgres.Connection.html#_ppsMaxConnections"><span class="hs-identifier hs-var">_ppsMaxConnections</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Maybe Int) -&gt; Int -&gt; Maybe Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConnParams -&gt; Int
</span><span class="hs-identifier hs-var hs-var">Q.cpConns</span></span><span> </span><span class="annot"><span class="annottext">ConnParams
</span><a href="#local-6989586621688185427"><span class="hs-identifier hs-var">soConnParams</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-362"></span><span>                    </span><span class="annot"><span class="annottext">_ppsIdleTimeout :: Maybe Int
</span><a href="Hasura.Backends.Postgres.Connection.html#_ppsIdleTimeout"><span class="hs-identifier hs-var">_ppsIdleTimeout</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Maybe Int) -&gt; Int -&gt; Maybe Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConnParams -&gt; Int
</span><span class="hs-identifier hs-var hs-var">Q.cpIdleTime</span></span><span> </span><span class="annot"><span class="annottext">ConnParams
</span><a href="#local-6989586621688185427"><span class="hs-identifier hs-var">soConnParams</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-363"></span><span>                    </span><span class="annot"><span class="annottext">_ppsRetries :: Maybe Int
</span><a href="Hasura.Backends.Postgres.Connection.html#_ppsRetries"><span class="hs-identifier hs-var">_ppsRetries</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe (UrlConf, ConnInfo), Maybe Int) -&gt; Maybe Int
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (UrlConf, ConnInfo), Maybe Int)
</span><a href="#local-6989586621688185432"><span class="hs-identifier hs-var">_gcDefaultPostgresConnInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int -&gt; Maybe Int -&gt; Maybe Int
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span>
</span><span id="line-364"></span><span>                    </span><span class="annot"><span class="annottext">_ppsPoolTimeout :: Maybe NominalDiffTime
</span><a href="Hasura.Backends.Postgres.Connection.html#_ppsPoolTimeout"><span class="hs-identifier hs-var">_ppsPoolTimeout</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnParams -&gt; Maybe NominalDiffTime
</span><span class="hs-identifier hs-var hs-var">Q.cpTimeout</span></span><span> </span><span class="annot"><span class="annottext">ConnParams
</span><a href="#local-6989586621688185427"><span class="hs-identifier hs-var">soConnParams</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-365"></span><span>                    </span><span class="annot"><span class="annottext">_ppsConnectionLifetime :: Maybe NominalDiffTime
</span><a href="Hasura.Backends.Postgres.Connection.html#_ppsConnectionLifetime"><span class="hs-identifier hs-var">_ppsConnectionLifetime</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConnParams -&gt; Maybe NominalDiffTime
</span><span class="hs-identifier hs-var hs-var">Q.cpMbLifetime</span></span><span> </span><span class="annot"><span class="annottext">ConnParams
</span><a href="#local-6989586621688185427"><span class="hs-identifier hs-var">soConnParams</span></a></span><span>
</span><span id="line-366"></span><span>                  </span><span class="hs-special">}</span><span>
</span><span id="line-367"></span><span>              </span><span id="local-6989586621688185328"><span class="annot"><span class="annottext">sourceConnInfo :: PostgresSourceConnInfo
</span><a href="#local-6989586621688185328"><span class="hs-identifier hs-var hs-var">sourceConnInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UrlConf
-&gt; Maybe PostgresPoolSettings
-&gt; Bool
-&gt; TxIsolation
-&gt; Maybe (PGClientCerts CertVar CertVar)
-&gt; PostgresSourceConnInfo
</span><a href="Hasura.Backends.Postgres.Connection.html#PostgresSourceConnInfo"><span class="hs-identifier hs-var">PostgresSourceConnInfo</span></a></span><span> </span><span class="annot"><span class="annottext">UrlConf
</span><a href="#local-6989586621688185341"><span class="hs-identifier hs-var">dbUrlConf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PostgresPoolSettings -&gt; Maybe PostgresPoolSettings
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">PostgresPoolSettings
</span><a href="#local-6989586621688185340"><span class="hs-identifier hs-var">connSettings</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConnParams -&gt; Bool
</span><span class="hs-identifier hs-var hs-var">Q.cpAllowPrepare</span></span><span> </span><span class="annot"><span class="annottext">ConnParams
</span><a href="#local-6989586621688185427"><span class="hs-identifier hs-var">soConnParams</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TxIsolation
</span><a href="#local-6989586621688185426"><span class="hs-identifier hs-var">soTxIso</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (PGClientCerts CertVar CertVar)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-368"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">PostgresSourceConnInfo
-&gt; Maybe (NonEmpty PostgresSourceConnInfo)
-&gt; PostgresConnConfiguration
</span><a href="Hasura.Backends.Postgres.Connection.html#PostgresConnConfiguration"><span class="hs-identifier hs-var">PostgresConnConfiguration</span></a></span><span> </span><span class="annot"><span class="annottext">PostgresSourceConnInfo
</span><a href="#local-6989586621688185328"><span class="hs-identifier hs-var">sourceConnInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (NonEmpty PostgresSourceConnInfo)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-369"></span><span>      </span><span id="local-6989586621688185324"><span class="annot"><span class="annottext">optimizePermissionFilters :: Bool
</span><a href="#local-6989586621688185324"><span class="hs-identifier hs-var hs-var">optimizePermissionFilters</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExperimentalFeature
</span><a href="Hasura.Server.Types.html#EFOptimizePermissionFilters"><span class="hs-identifier hs-var">EFOptimizePermissionFilters</span></a></span><span> </span><span class="annot"><span class="annottext">ExperimentalFeature -&gt; HashSet ExperimentalFeature -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">HashSet ExperimentalFeature
</span><a href="#local-6989586621688185399"><span class="hs-identifier hs-var">soExperimentalFeatures</span></a></span><span>
</span><span id="line-370"></span><span>      </span><span id="local-6989586621688185321"><span class="annot"><span class="annottext">sqlGenCtx :: SQLGenCtx
</span><a href="#local-6989586621688185321"><span class="hs-identifier hs-var hs-var">sqlGenCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StringifyNumbers -&gt; Bool -&gt; Bool -&gt; SQLGenCtx
</span><a href="Hasura.RQL.Types.Common.html#SQLGenCtx"><span class="hs-identifier hs-var">SQLGenCtx</span></a></span><span> </span><span class="annot"><span class="annottext">StringifyNumbers
</span><a href="#local-6989586621688185417"><span class="hs-identifier hs-var">soStringifyNum</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688185416"><span class="hs-identifier hs-var">soDangerousBooleanCollapse</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688185324"><span class="hs-identifier hs-var">optimizePermissionFilters</span></a></span><span>
</span><span id="line-371"></span><span>
</span><span id="line-372"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688185319"><span class="annot"><span class="annottext">serverConfigCtx :: ServerConfigCtx
</span><a href="#local-6989586621688185319"><span class="hs-identifier hs-var hs-var">serverConfigCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-373"></span><span>        </span><span class="annot"><span class="annottext">FunctionPermissionsCtx
-&gt; RemoteSchemaPermsCtx
-&gt; SQLGenCtx
-&gt; MaintenanceMode
-&gt; HashSet ExperimentalFeature
-&gt; EventingMode
-&gt; ReadOnlyMode
-&gt; ServerConfigCtx
</span><a href="Hasura.Server.Types.html#ServerConfigCtx"><span class="hs-identifier hs-var">ServerConfigCtx</span></a></span><span>
</span><span id="line-374"></span><span>          </span><span class="annot"><span class="annottext">FunctionPermissionsCtx
</span><a href="#local-6989586621688185402"><span class="hs-identifier hs-var">soInferFunctionPermissions</span></a></span><span>
</span><span id="line-375"></span><span>          </span><span class="annot"><span class="annottext">RemoteSchemaPermsCtx
</span><a href="#local-6989586621688185405"><span class="hs-identifier hs-var">soEnableRemoteSchemaPermissions</span></a></span><span>
</span><span id="line-376"></span><span>          </span><span class="annot"><span class="annottext">SQLGenCtx
</span><a href="#local-6989586621688185321"><span class="hs-identifier hs-var">sqlGenCtx</span></a></span><span>
</span><span id="line-377"></span><span>          </span><span class="annot"><span class="annottext">MaintenanceMode
</span><a href="#local-6989586621688185401"><span class="hs-identifier hs-var">soEnableMaintenanceMode</span></a></span><span>
</span><span id="line-378"></span><span>          </span><span class="annot"><span class="annottext">HashSet ExperimentalFeature
</span><a href="#local-6989586621688185399"><span class="hs-identifier hs-var">soExperimentalFeatures</span></a></span><span>
</span><span id="line-379"></span><span>          </span><span class="annot"><span class="annottext">EventingMode
</span><a href="#local-6989586621688185394"><span class="hs-identifier hs-var">soEventingMode</span></a></span><span>
</span><span id="line-380"></span><span>          </span><span class="annot"><span class="annottext">ReadOnlyMode
</span><a href="#local-6989586621688185393"><span class="hs-identifier hs-var">soReadOnlyMode</span></a></span><span>
</span><span id="line-381"></span><span>
</span><span id="line-382"></span><span>  </span><span id="local-6989586621688185317"><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621688185317"><span class="hs-identifier hs-var">schemaCacheHttpManager</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Manager -&gt; ManagedT m Manager
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO Manager -&gt; ManagedT m Manager)
-&gt; IO Manager -&gt; ManagedT m Manager
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ManagerSettings -&gt; IO Manager
</span><span class="hs-identifier hs-var">HTTP.newManager</span></span><span> </span><span class="annot"><span class="annottext">ManagerSettings
</span><span class="hs-identifier hs-var">HTTP.tlsManagerSettings</span></span><span>
</span><span id="line-383"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621688185314"><span class="annot"><span class="annottext">RebuildableSchemaCache
</span><a href="#local-6989586621688185314"><span class="hs-identifier hs-var">rebuildableSchemaCache</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-384"></span><span>    </span><span class="annot"><span class="annottext">m (RebuildableSchemaCache, UTCTime)
-&gt; ManagedT m (RebuildableSchemaCache, UTCTime)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m (RebuildableSchemaCache, UTCTime)
 -&gt; ManagedT m (RebuildableSchemaCache, UTCTime))
-&gt; (m (RebuildableSchemaCache, UTCTime)
    -&gt; m (RebuildableSchemaCache, UTCTime))
-&gt; m (RebuildableSchemaCache, UTCTime)
-&gt; ManagedT m (RebuildableSchemaCache, UTCTime)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(m (RebuildableSchemaCache, UTCTime)
 -&gt; m () -&gt; m (RebuildableSchemaCache, UTCTime))
-&gt; m ()
-&gt; m (RebuildableSchemaCache, UTCTime)
-&gt; m (RebuildableSchemaCache, UTCTime)
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">m (RebuildableSchemaCache, UTCTime)
-&gt; m () -&gt; m (RebuildableSchemaCache, UTCTime)
forall (m :: * -&gt; *) a b. MonadCatch m =&gt; m a -&gt; m b -&gt; m a
</span><span class="hs-identifier hs-var">onException</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoggerCtx Hasura -&gt; m ()
forall (m :: * -&gt; *) impl. MonadIO m =&gt; LoggerCtx impl -&gt; m ()
</span><a href="Hasura.App.html#flushLogger"><span class="hs-identifier hs-var">flushLogger</span></a></span><span> </span><span class="annot"><span class="annottext">LoggerCtx Hasura
</span><a href="#local-6989586621688185351"><span class="hs-identifier hs-var">loggerCtx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m (RebuildableSchemaCache, UTCTime)
 -&gt; ManagedT m (RebuildableSchemaCache, UTCTime))
-&gt; m (RebuildableSchemaCache, UTCTime)
-&gt; ManagedT m (RebuildableSchemaCache, UTCTime)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-385"></span><span>      </span><span class="annot"><span class="annottext">Environment
-&gt; Logger Hasura
-&gt; PGPool
-&gt; Maybe (SourceConnConfiguration ('Postgres 'Vanilla))
-&gt; Manager
-&gt; ServerConfigCtx
-&gt; SourceResolver ('Postgres 'Vanilla)
-&gt; SourceResolver 'MSSQL
-&gt; m (RebuildableSchemaCache, UTCTime)
forall (m :: * -&gt; *).
(MonadIO m, MonadBaseControl IO m) =&gt;
Environment
-&gt; Logger Hasura
-&gt; PGPool
-&gt; Maybe (SourceConnConfiguration ('Postgres 'Vanilla))
-&gt; Manager
-&gt; ServerConfigCtx
-&gt; SourceResolver ('Postgres 'Vanilla)
-&gt; SourceResolver 'MSSQL
-&gt; m (RebuildableSchemaCache, UTCTime)
</span><a href="Hasura.App.html#migrateCatalogSchema"><span class="hs-identifier hs-var">migrateCatalogSchema</span></a></span><span>
</span><span id="line-386"></span><span>        </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688185434"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-387"></span><span>        </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185350"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-388"></span><span>        </span><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621688185345"><span class="hs-identifier hs-var">metadataDbPool</span></a></span><span>
</span><span id="line-389"></span><span>        </span><span class="annot"><span class="annottext">Maybe (SourceConnConfiguration ('Postgres 'Vanilla))
Maybe PostgresConnConfiguration
</span><a href="#local-6989586621688185343"><span class="hs-identifier hs-var">maybeDefaultSourceConfig</span></a></span><span>
</span><span id="line-390"></span><span>        </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621688185317"><span class="hs-identifier hs-var">schemaCacheHttpManager</span></a></span><span>
</span><span id="line-391"></span><span>        </span><span class="annot"><span class="annottext">ServerConfigCtx
</span><a href="#local-6989586621688185319"><span class="hs-identifier hs-var">serverConfigCtx</span></a></span><span>
</span><span id="line-392"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PGLogger -&gt; SourceResolver ('Postgres 'Vanilla)
</span><a href="Hasura.App.html#mkPgSourceResolver"><span class="hs-identifier hs-var">mkPgSourceResolver</span></a></span><span> </span><span class="annot"><span class="annottext">PGLogger
</span><a href="#local-6989586621688185349"><span class="hs-identifier hs-var">pgLogger</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-393"></span><span>        </span><span class="annot"><span class="annottext">SourceResolver 'MSSQL
</span><a href="Hasura.App.html#mkMSSQLSourceResolver"><span class="hs-identifier hs-var">mkMSSQLSourceResolver</span></a></span><span>
</span><span id="line-394"></span><span>
</span><span id="line-395"></span><span>  </span><span class="hs-comment">-- Start a background thread for listening schema sync events from other server instances,</span><span>
</span><span id="line-396"></span><span>  </span><span id="local-6989586621688185311"><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
</span><a href="#local-6989586621688185311"><span class="hs-identifier hs-var">metaVersionRef</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (TMVar MetadataResourceVersion)
-&gt; ManagedT m (TMVar MetadataResourceVersion)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (TMVar MetadataResourceVersion)
 -&gt; ManagedT m (TMVar MetadataResourceVersion))
-&gt; IO (TMVar MetadataResourceVersion)
-&gt; ManagedT m (TMVar MetadataResourceVersion)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (TMVar MetadataResourceVersion)
forall a. IO (TMVar a)
</span><span class="hs-identifier hs-var">STM.newEmptyTMVarIO</span></span><span>
</span><span id="line-397"></span><span>
</span><span id="line-398"></span><span>  </span><span class="hs-comment">-- An interval of 0 indicates that no schema sync is required</span><span>
</span><span id="line-399"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">OptionalInterval
</span><a href="#local-6989586621688185400"><span class="hs-identifier hs-var">soSchemaPollInterval</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-400"></span><span>    </span><span class="annot"><span class="annottext">OptionalInterval
</span><a href="Hasura.Server.Init.Config.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185350"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(StartupLog -&gt; ManagedT m ()) -&gt; StartupLog -&gt; ManagedT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogLevel -&gt; Text -&gt; String -&gt; StartupLog
</span><a href="Hasura.Server.Init.html#mkGenericStrLog"><span class="hs-identifier hs-var">mkGenericStrLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;schema-sync&quot;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Schema sync disabled&quot;</span></span><span>
</span><span id="line-401"></span><span>    </span><span class="annot"><a href="Hasura.Server.Init.Config.html#Interval"><span class="hs-identifier hs-type">Interval</span></a></span><span> </span><span id="local-6989586621688185305"><span class="annot"><span class="annottext">Milliseconds
</span><a href="#local-6989586621688185305"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-402"></span><span>      </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185350"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(StartupLog -&gt; ManagedT m ()) -&gt; StartupLog -&gt; ManagedT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogLevel -&gt; Text -&gt; String -&gt; StartupLog
</span><a href="Hasura.Server.Init.html#mkGenericStrLog"><span class="hs-identifier hs-var">mkGenericStrLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;schema-sync&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Schema sync enabled. Polling at &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Milliseconds -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Milliseconds
</span><a href="#local-6989586621688185305"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-403"></span><span>      </span><span class="annot"><span class="annottext">ManagedT m Thread -&gt; ManagedT m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(ManagedT m Thread -&gt; ManagedT m ())
-&gt; ManagedT m Thread -&gt; ManagedT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; PGPool
-&gt; InstanceId
-&gt; Milliseconds
-&gt; TMVar MetadataResourceVersion
-&gt; ManagedT m Thread
forall (m :: * -&gt; *).
ForkableMonadIO m =&gt;
Logger Hasura
-&gt; PGPool
-&gt; InstanceId
-&gt; Milliseconds
-&gt; TMVar MetadataResourceVersion
-&gt; ManagedT m Thread
</span><a href="Hasura.Server.SchemaUpdate.html#startSchemaSyncListenerThread"><span class="hs-identifier hs-var">startSchemaSyncListenerThread</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185350"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621688185345"><span class="hs-identifier hs-var">metadataDbPool</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621688185355"><span class="hs-identifier hs-var">instanceId</span></a></span><span> </span><span class="annot"><span class="annottext">Milliseconds
</span><a href="#local-6989586621688185305"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
</span><a href="#local-6989586621688185311"><span class="hs-identifier hs-var">metaVersionRef</span></a></span><span>
</span><span id="line-404"></span><span>
</span><span id="line-405"></span><span>  </span><span id="local-6989586621688185301"><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621688185301"><span class="hs-identifier hs-var">schemaCacheRef</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RebuildableSchemaCache -&gt; ManagedT m SchemaCacheRef
forall (m :: * -&gt; *).
MonadIO m =&gt;
RebuildableSchemaCache -&gt; m SchemaCacheRef
</span><a href="Hasura.Server.App.html#initialiseCache"><span class="hs-identifier hs-var">initialiseCache</span></a></span><span> </span><span class="annot"><span class="annottext">RebuildableSchemaCache
</span><a href="#local-6989586621688185314"><span class="hs-identifier hs-var">rebuildableSchemaCache</span></a></span><span>
</span><span id="line-406"></span><span>
</span><span id="line-407"></span><span>  </span><span id="local-6989586621688185299"><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621688185299"><span class="hs-identifier hs-var">srvMgr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Manager -&gt; ManagedT m Manager
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO Manager -&gt; ManagedT m Manager)
-&gt; IO Manager -&gt; ManagedT m Manager
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO [TlsAllow] -&gt; IO Manager
</span><a href="Network.HTTP.Client.DynamicTlsPermissions.html#mkHttpManager"><span class="hs-identifier hs-var">mkHttpManager</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SchemaCacheRef -&gt; IO [TlsAllow]
</span><a href="Hasura.App.html#readTlsAllowlist"><span class="hs-identifier hs-var">readTlsAllowlist</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621688185301"><span class="hs-identifier hs-var">schemaCacheRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-408"></span><span>
</span><span id="line-409"></span><span>  </span><span class="annot"><span class="annottext">ServeCtx -&gt; ManagedT m ServeCtx
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ServeCtx -&gt; ManagedT m ServeCtx)
-&gt; ServeCtx -&gt; ManagedT m ServeCtx
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-410"></span><span>    </span><span class="annot"><span class="annottext">Manager
-&gt; InstanceId
-&gt; Loggers
-&gt; HashSet (EngineLogType Hasura)
-&gt; PGPool
-&gt; ShutdownLatch
-&gt; RebuildableSchemaCache
-&gt; SchemaCacheRef
-&gt; TMVar MetadataResourceVersion
-&gt; ServeCtx
</span><a href="Hasura.App.html#ServeCtx"><span class="hs-identifier hs-var">ServeCtx</span></a></span><span>
</span><span id="line-411"></span><span>      </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621688185299"><span class="hs-identifier hs-var">srvMgr</span></a></span><span>
</span><span id="line-412"></span><span>      </span><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621688185355"><span class="hs-identifier hs-var">instanceId</span></a></span><span>
</span><span id="line-413"></span><span>      </span><span class="annot"><span class="annottext">Loggers
</span><a href="#local-6989586621688185352"><span class="hs-identifier hs-var">loggers</span></a></span><span>
</span><span id="line-414"></span><span>      </span><span class="annot"><span class="annottext">HashSet (EngineLogType Hasura)
</span><a href="#local-6989586621688185412"><span class="hs-identifier hs-var">soEnabledLogTypes</span></a></span><span>
</span><span id="line-415"></span><span>      </span><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621688185345"><span class="hs-identifier hs-var">metadataDbPool</span></a></span><span>
</span><span id="line-416"></span><span>      </span><span class="annot"><span class="annottext">ShutdownLatch
</span><a href="#local-6989586621688185353"><span class="hs-identifier hs-var">latch</span></a></span><span>
</span><span id="line-417"></span><span>      </span><span class="annot"><span class="annottext">RebuildableSchemaCache
</span><a href="#local-6989586621688185314"><span class="hs-identifier hs-var">rebuildableSchemaCache</span></a></span><span>
</span><span id="line-418"></span><span>      </span><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621688185301"><span class="hs-identifier hs-var">schemaCacheRef</span></a></span><span>
</span><span id="line-419"></span><span>      </span><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
</span><a href="#local-6989586621688185311"><span class="hs-identifier hs-var">metaVersionRef</span></a></span><span>
</span><span id="line-420"></span><span>
</span><span id="line-421"></span><span id="local-6989586621688186114"><span class="annot"><a href="Hasura.App.html#mkLoggers"><span class="hs-identifier hs-type">mkLoggers</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-422"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688186114"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688186114"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-423"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">HashSet</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#EngineLogType"><span class="hs-identifier hs-type">EngineLogType</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-424"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#LogLevel"><span class="hs-identifier hs-type">LogLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-425"></span><span>  </span><span class="annot"><a href="Control.Monad.Trans.Managed.html#ManagedT"><span class="hs-identifier hs-type">ManagedT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688186114"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.App.html#Loggers"><span class="hs-identifier hs-type">Loggers</span></a></span></span><span>
</span><span id="line-426"></span><span id="mkLoggers"><span class="annot"><span class="annottext">mkLoggers :: HashSet (EngineLogType Hasura) -&gt; LogLevel -&gt; ManagedT m Loggers
</span><a href="Hasura.App.html#mkLoggers"><span class="hs-identifier hs-var hs-var">mkLoggers</span></a></span></span><span> </span><span id="local-6989586621688185298"><span class="annot"><span class="annottext">HashSet (EngineLogType Hasura)
</span><a href="#local-6989586621688185298"><span class="hs-identifier hs-var">enabledLogs</span></a></span></span><span> </span><span id="local-6989586621688185297"><span class="annot"><span class="annottext">LogLevel
</span><a href="#local-6989586621688185297"><span class="hs-identifier hs-var">logLevel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-427"></span><span>  </span><span id="local-6989586621688185296"><span class="annot"><span class="annottext">LoggerCtx Hasura
</span><a href="#local-6989586621688185296"><span class="hs-identifier hs-var">loggerCtx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LoggerSettings
-&gt; HashSet (EngineLogType Hasura) -&gt; ManagedT m (LoggerCtx Hasura)
forall (io :: * -&gt; *) impl.
(MonadIO io, MonadBaseControl IO io) =&gt;
LoggerSettings
-&gt; HashSet (EngineLogType impl) -&gt; ManagedT io (LoggerCtx impl)
</span><a href="Hasura.Logging.html#mkLoggerCtx"><span class="hs-identifier hs-var">mkLoggerCtx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; LogLevel -&gt; LoggerSettings
</span><a href="Hasura.Logging.html#defaultLoggerSettings"><span class="hs-identifier hs-var">defaultLoggerSettings</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="#local-6989586621688185297"><span class="hs-identifier hs-var">logLevel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashSet (EngineLogType Hasura)
</span><a href="#local-6989586621688185298"><span class="hs-identifier hs-var">enabledLogs</span></a></span><span>
</span><span id="line-428"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688185293"><span class="annot"><span class="annottext">logger :: Logger Hasura
</span><a href="#local-6989586621688185293"><span class="hs-identifier hs-var hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LoggerCtx Hasura -&gt; Logger Hasura
</span><a href="Hasura.Logging.html#mkLogger"><span class="hs-identifier hs-var">mkLogger</span></a></span><span> </span><span class="annot"><span class="annottext">LoggerCtx Hasura
</span><a href="#local-6989586621688185296"><span class="hs-identifier hs-var">loggerCtx</span></a></span><span>
</span><span id="line-429"></span><span>      </span><span id="local-6989586621688185291"><span class="annot"><span class="annottext">pgLogger :: PGLogger
</span><a href="#local-6989586621688185291"><span class="hs-identifier hs-var hs-var">pgLogger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Logger Hasura -&gt; PGLogger
</span><a href="Hasura.App.html#mkPGLogger"><span class="hs-identifier hs-var">mkPGLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185293"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-430"></span><span>  </span><span class="annot"><span class="annottext">Loggers -&gt; ManagedT m Loggers
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Loggers -&gt; ManagedT m Loggers) -&gt; Loggers -&gt; ManagedT m Loggers
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LoggerCtx Hasura -&gt; Logger Hasura -&gt; PGLogger -&gt; Loggers
</span><a href="Hasura.App.html#Loggers"><span class="hs-identifier hs-var">Loggers</span></a></span><span> </span><span class="annot"><span class="annottext">LoggerCtx Hasura
</span><a href="#local-6989586621688185296"><span class="hs-identifier hs-var">loggerCtx</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185293"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">PGLogger
</span><a href="#local-6989586621688185291"><span class="hs-identifier hs-var">pgLogger</span></a></span><span>
</span><span id="line-431"></span><span>
</span><span id="line-432"></span><span class="hs-comment">-- | helper function to initialize or migrate the @hdb_catalog@ schema (used by pro as well)</span><span>
</span><span id="line-433"></span><span id="local-6989586621688186075"><span class="annot"><a href="Hasura.App.html#migrateCatalogSchema"><span class="hs-identifier hs-type">migrateCatalogSchema</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-434"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688186075"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688186075"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-435"></span><span>  </span><span class="annot"><a href="Data.Environment.html#Environment"><span class="hs-identifier hs-type">Env.Environment</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-436"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-437"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Q.PGPool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-438"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#SourceConnConfiguration"><span class="hs-identifier hs-type">SourceConnConfiguration</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#Vanilla"><span class="hs-identifier hs-type">Vanilla</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-439"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">HTTP.Manager</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-440"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#ServerConfigCtx"><span class="hs-identifier hs-type">ServerConfigCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-441"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#SourceResolver"><span class="hs-identifier hs-type">SourceResolver</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#Vanilla"><span class="hs-identifier hs-type">Vanilla</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-442"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#SourceResolver"><span class="hs-identifier hs-type">SourceResolver</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-443"></span><span>  </span><span class="annot"><a href="#local-6989586621688186075"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#RebuildableSchemaCache"><span class="hs-identifier hs-type">RebuildableSchemaCache</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">UTCTime</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-444"></span><span id="migrateCatalogSchema"><span class="annot"><span class="annottext">migrateCatalogSchema :: Environment
-&gt; Logger Hasura
-&gt; PGPool
-&gt; Maybe (SourceConnConfiguration ('Postgres 'Vanilla))
-&gt; Manager
-&gt; ServerConfigCtx
-&gt; SourceResolver ('Postgres 'Vanilla)
-&gt; SourceResolver 'MSSQL
-&gt; m (RebuildableSchemaCache, UTCTime)
</span><a href="Hasura.App.html#migrateCatalogSchema"><span class="hs-identifier hs-var hs-var">migrateCatalogSchema</span></a></span></span><span>
</span><span id="line-445"></span><span>  </span><span id="local-6989586621688185290"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688185290"><span class="hs-identifier hs-var">env</span></a></span></span><span>
</span><span id="line-446"></span><span>  </span><span id="local-6989586621688185289"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185289"><span class="hs-identifier hs-var">logger</span></a></span></span><span>
</span><span id="line-447"></span><span>  </span><span id="local-6989586621688185288"><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621688185288"><span class="hs-identifier hs-var">pool</span></a></span></span><span>
</span><span id="line-448"></span><span>  </span><span id="local-6989586621688185287"><span class="annot"><span class="annottext">Maybe (SourceConnConfiguration ('Postgres 'Vanilla))
</span><a href="#local-6989586621688185287"><span class="hs-identifier hs-var">defaultSourceConfig</span></a></span></span><span>
</span><span id="line-449"></span><span>  </span><span id="local-6989586621688185286"><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621688185286"><span class="hs-identifier hs-var">httpManager</span></a></span></span><span>
</span><span id="line-450"></span><span>  </span><span id="local-6989586621688185285"><span class="annot"><span class="annottext">ServerConfigCtx
</span><a href="#local-6989586621688185285"><span class="hs-identifier hs-var">serverConfigCtx</span></a></span></span><span>
</span><span id="line-451"></span><span>  </span><span id="local-6989586621688185284"><span class="annot"><span class="annottext">SourceResolver ('Postgres 'Vanilla)
</span><a href="#local-6989586621688185284"><span class="hs-identifier hs-var">pgSourceResolver</span></a></span></span><span>
</span><span id="line-452"></span><span>  </span><span id="local-6989586621688185283"><span class="annot"><span class="annottext">SourceResolver 'MSSQL
</span><a href="#local-6989586621688185283"><span class="hs-identifier hs-var">mssqlSourceResolver</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-453"></span><span>    </span><span id="local-6989586621688185282"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688185282"><span class="hs-identifier hs-var">currentTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime -&gt; m UTCTime
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><span class="hs-identifier hs-var">Clock.getCurrentTime</span></span><span>
</span><span id="line-454"></span><span>    </span><span id="local-6989586621688185280"><span class="annot"><span class="annottext">Either QErr (MigrationResult, RebuildableSchemaCache)
</span><a href="#local-6989586621688185280"><span class="hs-identifier hs-var">initialiseResult</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExceptT QErr m (MigrationResult, RebuildableSchemaCache)
-&gt; m (Either QErr (MigrationResult, RebuildableSchemaCache))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT QErr m (MigrationResult, RebuildableSchemaCache)
 -&gt; m (Either QErr (MigrationResult, RebuildableSchemaCache)))
-&gt; ExceptT QErr m (MigrationResult, RebuildableSchemaCache)
-&gt; m (Either QErr (MigrationResult, RebuildableSchemaCache))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-455"></span><span>      </span><span class="hs-comment">-- TODO: should we allow the migration to happen during maintenance mode?</span><span>
</span><span id="line-456"></span><span>      </span><span class="hs-comment">-- Allowing this can be a sanity check, to see if the hdb_catalog in the</span><span>
</span><span id="line-457"></span><span>      </span><span class="hs-comment">-- DB has been set correctly</span><span>
</span><span id="line-458"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621688185278"><span class="annot"><span class="annottext">MigrationResult
</span><a href="#local-6989586621688185278"><span class="hs-identifier hs-var">migrationResult</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688185277"><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621688185277"><span class="hs-identifier hs-var">metadata</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-459"></span><span>        </span><span class="annot"><span class="annottext">PGPool
-&gt; TxMode
-&gt; TxET QErr m (MigrationResult, Metadata)
-&gt; ExceptT QErr m (MigrationResult, Metadata)
forall (m :: * -&gt; *) e a.
(MonadIO m, MonadBaseControl IO m, FromPGTxErr e,
 FromPGConnErr e) =&gt;
PGPool -&gt; TxMode -&gt; TxET e m a -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">Q.runTx</span></span><span> </span><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621688185288"><span class="hs-identifier hs-var">pool</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxIsolation
</span><span class="hs-identifier hs-var">Q.Serializable</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TxAccess -&gt; Maybe TxAccess
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">TxAccess
</span><span class="hs-identifier hs-var">Q.ReadWrite</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TxET QErr m (MigrationResult, Metadata)
 -&gt; ExceptT QErr m (MigrationResult, Metadata))
-&gt; TxET QErr m (MigrationResult, Metadata)
-&gt; ExceptT QErr m (MigrationResult, Metadata)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-460"></span><span>          </span><span class="annot"><span class="annottext">Maybe (SourceConnConfiguration ('Postgres 'Vanilla))
-&gt; MaintenanceMode
-&gt; UTCTime
-&gt; TxET QErr m (MigrationResult, Metadata)
forall (m :: * -&gt; *).
(MonadTx m, MonadIO m, MonadBaseControl IO m) =&gt;
Maybe (SourceConnConfiguration ('Postgres 'Vanilla))
-&gt; MaintenanceMode -&gt; UTCTime -&gt; m (MigrationResult, Metadata)
</span><a href="Hasura.Server.Migrate.html#migrateCatalog"><span class="hs-identifier hs-var">migrateCatalog</span></a></span><span>
</span><span id="line-461"></span><span>            </span><span class="annot"><span class="annottext">Maybe (SourceConnConfiguration ('Postgres 'Vanilla))
</span><a href="#local-6989586621688185287"><span class="hs-identifier hs-var">defaultSourceConfig</span></a></span><span>
</span><span id="line-462"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerConfigCtx -&gt; MaintenanceMode
</span><a href="Hasura.Server.Types.html#_sccMaintenanceMode"><span class="hs-identifier hs-var hs-var">_sccMaintenanceMode</span></a></span><span> </span><span class="annot"><span class="annottext">ServerConfigCtx
</span><a href="#local-6989586621688185285"><span class="hs-identifier hs-var">serverConfigCtx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-463"></span><span>            </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688185282"><span class="hs-identifier hs-var">currentTime</span></a></span><span>
</span><span id="line-464"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688185272"><span class="annot"><span class="annottext">cacheBuildParams :: CacheBuildParams
</span><a href="#local-6989586621688185272"><span class="hs-identifier hs-var hs-var">cacheBuildParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-465"></span><span>            </span><span class="annot"><span class="annottext">Manager
-&gt; SourceResolver ('Postgres 'Vanilla)
-&gt; SourceResolver 'MSSQL
-&gt; ServerConfigCtx
-&gt; CacheBuildParams
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#CacheBuildParams"><span class="hs-identifier hs-var">CacheBuildParams</span></a></span><span> </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621688185286"><span class="hs-identifier hs-var">httpManager</span></a></span><span> </span><span class="annot"><span class="annottext">SourceResolver ('Postgres 'Vanilla)
</span><a href="#local-6989586621688185284"><span class="hs-identifier hs-var">pgSourceResolver</span></a></span><span> </span><span class="annot"><span class="annottext">SourceResolver 'MSSQL
</span><a href="#local-6989586621688185283"><span class="hs-identifier hs-var">mssqlSourceResolver</span></a></span><span> </span><span class="annot"><span class="annottext">ServerConfigCtx
</span><a href="#local-6989586621688185285"><span class="hs-identifier hs-var">serverConfigCtx</span></a></span><span>
</span><span id="line-466"></span><span>          </span><span id="local-6989586621688185270"><span class="annot"><span class="annottext">buildReason :: BuildReason
</span><a href="#local-6989586621688185270"><span class="hs-identifier hs-var hs-var">buildReason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BuildReason
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#CatalogSync"><span class="hs-identifier hs-var">CatalogSync</span></a></span><span>
</span><span id="line-467"></span><span>      </span><span id="local-6989586621688185268"><span class="annot"><span class="annottext">RebuildableSchemaCache
</span><a href="#local-6989586621688185268"><span class="hs-identifier hs-var">schemaCache</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-468"></span><span>        </span><span class="annot"><span class="annottext">CacheBuildParams
-&gt; CacheBuild RebuildableSchemaCache
-&gt; ExceptT QErr m RebuildableSchemaCache
forall (m :: * -&gt; *) a.
(MonadIO m, MonadError QErr m) =&gt;
CacheBuildParams -&gt; CacheBuild a -&gt; m a
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#runCacheBuild"><span class="hs-identifier hs-var">runCacheBuild</span></a></span><span> </span><span class="annot"><span class="annottext">CacheBuildParams
</span><a href="#local-6989586621688185272"><span class="hs-identifier hs-var">cacheBuildParams</span></a></span><span> </span><span class="annot"><span class="annottext">(CacheBuild RebuildableSchemaCache
 -&gt; ExceptT QErr m RebuildableSchemaCache)
-&gt; CacheBuild RebuildableSchemaCache
-&gt; ExceptT QErr m RebuildableSchemaCache
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-469"></span><span>          </span><span class="annot"><span class="annottext">BuildReason
-&gt; Logger Hasura
-&gt; Environment
-&gt; Metadata
-&gt; CacheBuild RebuildableSchemaCache
</span><a href="Hasura.RQL.DDL.Schema.Cache.html#buildRebuildableSchemaCacheWithReason"><span class="hs-identifier hs-var">buildRebuildableSchemaCacheWithReason</span></a></span><span> </span><span class="annot"><span class="annottext">BuildReason
</span><a href="#local-6989586621688185270"><span class="hs-identifier hs-var">buildReason</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185289"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688185290"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Metadata
</span><a href="#local-6989586621688185277"><span class="hs-identifier hs-var">metadata</span></a></span><span>
</span><span id="line-470"></span><span>      </span><span class="annot"><span class="annottext">(MigrationResult, RebuildableSchemaCache)
-&gt; ExceptT QErr m (MigrationResult, RebuildableSchemaCache)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MigrationResult
</span><a href="#local-6989586621688185278"><span class="hs-identifier hs-var">migrationResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RebuildableSchemaCache
</span><a href="#local-6989586621688185268"><span class="hs-identifier hs-var">schemaCache</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-471"></span><span>
</span><span id="line-472"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621688185265"><span class="annot"><span class="annottext">MigrationResult
</span><a href="#local-6989586621688185265"><span class="hs-identifier hs-var">migrationResult</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688185264"><span class="annot"><span class="annottext">RebuildableSchemaCache
</span><a href="#local-6989586621688185264"><span class="hs-identifier hs-var">schemaCache</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-473"></span><span>      </span><span class="annot"><span class="annottext">Either QErr (MigrationResult, RebuildableSchemaCache)
</span><a href="#local-6989586621688185280"><span class="hs-identifier hs-var">initialiseResult</span></a></span><span> </span><span class="annot"><span class="annottext">Either QErr (MigrationResult, RebuildableSchemaCache)
-&gt; (QErr -&gt; m (MigrationResult, RebuildableSchemaCache))
-&gt; m (MigrationResult, RebuildableSchemaCache)
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="Hasura.Prelude.html#onLeft"><span class="hs-operator hs-var">`onLeft`</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688185263"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688185263"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-474"></span><span>        </span><span class="annot"><span class="annottext">Logger Hasura -&gt; StartupLog -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">unLogger</span></a></span><span>
</span><span id="line-475"></span><span>          </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185289"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-476"></span><span>          </span><span class="annot"><span class="annottext">StartupLog :: LogLevel -&gt; Text -&gt; Value -&gt; StartupLog
</span><a href="Hasura.Server.Logging.html#StartupLog"><span class="hs-identifier hs-type">StartupLog</span></a></span><span>
</span><span id="line-477"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">slLogLevel :: LogLevel
</span><a href="Hasura.Server.Logging.html#slLogLevel"><span class="hs-identifier hs-var">slLogLevel</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelError"><span class="hs-identifier hs-var">LevelError</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-478"></span><span>              </span><span class="annot"><span class="annottext">slKind :: Text
</span><a href="Hasura.Server.Logging.html#slKind"><span class="hs-identifier hs-var">slKind</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;catalog_migrate&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-479"></span><span>              </span><span class="annot"><span class="annottext">slInfo :: Value
</span><a href="Hasura.Server.Logging.html#slInfo"><span class="hs-identifier hs-var">slInfo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QErr -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">A.toJSON</span></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688185263"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-480"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-481"></span><span>        </span><span class="annot"><span class="annottext">IO (MigrationResult, RebuildableSchemaCache)
-&gt; m (MigrationResult, RebuildableSchemaCache)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExitCode -&gt; String -&gt; IO (MigrationResult, RebuildableSchemaCache)
forall (m :: * -&gt; *) a. MonadIO m =&gt; ExitCode -&gt; String -&gt; m a
</span><a href="Hasura.App.html#printErrExit"><span class="hs-identifier hs-var">printErrExit</span></a></span><span> </span><span class="annot"><span class="annottext">ExitCode
</span><a href="Hasura.App.html#DatabaseMigrationError"><span class="hs-identifier hs-var">DatabaseMigrationError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; String
</span><span class="hs-identifier hs-var">BLC.unpack</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; String) -&gt; ByteString -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; ByteString
forall a. ToJSON a =&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">A.encode</span></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688185263"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-482"></span><span>    </span><span class="annot"><span class="annottext">Logger Hasura -&gt; MigrationResult -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185289"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">MigrationResult
</span><a href="#local-6989586621688185265"><span class="hs-identifier hs-var">migrationResult</span></a></span><span>
</span><span id="line-483"></span><span>    </span><span class="annot"><span class="annottext">(RebuildableSchemaCache, UTCTime)
-&gt; m (RebuildableSchemaCache, UTCTime)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RebuildableSchemaCache
</span><a href="#local-6989586621688185264"><span class="hs-identifier hs-var">schemaCache</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688185282"><span class="hs-identifier hs-var">currentTime</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-484"></span><span>
</span><span id="line-485"></span><span class="hs-comment">-- | Run a transaction and if an error is encountered, log the error and abort the program</span><span>
</span><span id="line-486"></span><span id="local-6989586621688185950"><span class="annot"><a href="Hasura.App.html#runTxIO"><span class="hs-identifier hs-type">runTxIO</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Q.PGPool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Q.TxMode</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Q.TxE</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185950"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688185950"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-487"></span><span id="runTxIO"><span class="annot"><span class="annottext">runTxIO :: PGPool -&gt; TxMode -&gt; TxE QErr a -&gt; IO a
</span><a href="Hasura.App.html#runTxIO"><span class="hs-identifier hs-var hs-var">runTxIO</span></a></span></span><span> </span><span id="local-6989586621688185255"><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621688185255"><span class="hs-identifier hs-var">pool</span></a></span></span><span> </span><span id="local-6989586621688185254"><span class="annot"><span class="annottext">TxMode
</span><a href="#local-6989586621688185254"><span class="hs-identifier hs-var">isoLevel</span></a></span></span><span> </span><span id="local-6989586621688185253"><span class="annot"><span class="annottext">TxE QErr a
</span><a href="#local-6989586621688185253"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-488"></span><span>  </span><span id="local-6989586621688185252"><span class="annot"><span class="annottext">Either QErr a
</span><a href="#local-6989586621688185252"><span class="hs-identifier hs-var">eVal</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Either QErr a) -&gt; IO (Either QErr a)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr a) -&gt; IO (Either QErr a))
-&gt; IO (Either QErr a) -&gt; IO (Either QErr a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExceptT QErr IO a -&gt; IO (Either QErr a)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT QErr IO a -&gt; IO (Either QErr a))
-&gt; ExceptT QErr IO a -&gt; IO (Either QErr a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PGPool -&gt; TxMode -&gt; TxE QErr a -&gt; ExceptT QErr IO a
forall (m :: * -&gt; *) e a.
(MonadIO m, MonadBaseControl IO m, FromPGTxErr e,
 FromPGConnErr e) =&gt;
PGPool -&gt; TxMode -&gt; TxET e m a -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">Q.runTx</span></span><span> </span><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621688185255"><span class="hs-identifier hs-var">pool</span></a></span><span> </span><span class="annot"><span class="annottext">TxMode
</span><a href="#local-6989586621688185254"><span class="hs-identifier hs-var">isoLevel</span></a></span><span> </span><span class="annot"><span class="annottext">TxE QErr a
</span><a href="#local-6989586621688185253"><span class="hs-identifier hs-var">tx</span></a></span><span>
</span><span id="line-489"></span><span>  </span><span class="annot"><span class="annottext">Either QErr a -&gt; (QErr -&gt; IO a) -&gt; IO a
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="Hasura.Prelude.html#onLeft"><span class="hs-identifier hs-var">onLeft</span></a></span><span> </span><span class="annot"><span class="annottext">Either QErr a
</span><a href="#local-6989586621688185252"><span class="hs-identifier hs-var">eVal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExitCode -&gt; QErr -&gt; IO a
forall a (m :: * -&gt; *) b.
(ToJSON a, MonadIO m) =&gt;
ExitCode -&gt; a -&gt; m b
</span><a href="Hasura.App.html#printErrJExit"><span class="hs-identifier hs-var">printErrJExit</span></a></span><span> </span><span class="annot"><span class="annottext">ExitCode
</span><a href="Hasura.App.html#DatabaseMigrationError"><span class="hs-identifier hs-var">DatabaseMigrationError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-490"></span><span>
</span><span id="line-491"></span><span class="hs-comment">-- | A latch for the graceful shutdown of a server process.</span><span>
</span><span id="line-492"></span><span class="hs-keyword">newtype</span><span> </span><span id="ShutdownLatch"><span class="annot"><a href="Hasura.App.html#ShutdownLatch"><span class="hs-identifier hs-var">ShutdownLatch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ShutdownLatch"><span class="annot"><a href="Hasura.App.html#ShutdownLatch"><span class="hs-identifier hs-var">ShutdownLatch</span></a></span></span><span> </span><span class="hs-special">{</span><span id="unShutdownLatch"><span class="annot"><span class="annottext">ShutdownLatch -&gt; MVar ()
</span><a href="Hasura.App.html#unShutdownLatch"><span class="hs-identifier hs-var hs-var">unShutdownLatch</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.MVar</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">}</span><span>
</span><span id="line-493"></span><span>
</span><span id="line-494"></span><span class="hs-comment">-- | Event triggers live in the user's DB and other events</span><span>
</span><span id="line-495"></span><span class="hs-comment">--  (cron, one-off and async actions)</span><span>
</span><span id="line-496"></span><span class="hs-comment">--   live in the metadata DB, so we need a way to differentiate the</span><span>
</span><span id="line-497"></span><span class="hs-comment">--   type of shutdown action</span><span>
</span><span id="line-498"></span><span class="hs-keyword">data</span><span> </span><span id="ShutdownAction"><span class="annot"><a href="Hasura.App.html#ShutdownAction"><span class="hs-identifier hs-var">ShutdownAction</span></a></span></span><span>
</span><span id="line-499"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="EventTriggerShutdownAction"><span class="annot"><a href="Hasura.App.html#EventTriggerShutdownAction"><span class="hs-identifier hs-var">EventTriggerShutdownAction</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-500"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="MetadataDBShutdownAction"><span class="annot"><a href="Hasura.App.html#MetadataDBShutdownAction"><span class="hs-identifier hs-var">MetadataDBShutdownAction</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Metadata.Class.html#MetadataStorageT"><span class="hs-identifier hs-type">MetadataStorageT</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-501"></span><span>
</span><span id="line-502"></span><span class="annot"><a href="Hasura.App.html#newShutdownLatch"><span class="hs-identifier hs-type">newShutdownLatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Hasura.App.html#ShutdownLatch"><span class="hs-identifier hs-type">ShutdownLatch</span></a></span><span>
</span><span id="line-503"></span><span id="newShutdownLatch"><span class="annot"><span class="annottext">newShutdownLatch :: IO ShutdownLatch
</span><a href="Hasura.App.html#newShutdownLatch"><span class="hs-identifier hs-var hs-var">newShutdownLatch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(MVar () -&gt; ShutdownLatch) -&gt; IO (MVar ()) -&gt; IO ShutdownLatch
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">MVar () -&gt; ShutdownLatch
</span><a href="Hasura.App.html#ShutdownLatch"><span class="hs-identifier hs-var">ShutdownLatch</span></a></span><span> </span><span class="annot"><span class="annottext">IO (MVar ())
forall a. IO (MVar a)
</span><span class="hs-identifier hs-var">C.newEmptyMVar</span></span><span>
</span><span id="line-504"></span><span>
</span><span id="line-505"></span><span class="hs-comment">-- | Block the current thread, waiting on the latch.</span><span>
</span><span id="line-506"></span><span class="annot"><a href="Hasura.App.html#waitForShutdown"><span class="hs-identifier hs-type">waitForShutdown</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.App.html#ShutdownLatch"><span class="hs-identifier hs-type">ShutdownLatch</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-507"></span><span id="waitForShutdown"><span class="annot"><span class="annottext">waitForShutdown :: ShutdownLatch -&gt; IO ()
</span><a href="Hasura.App.html#waitForShutdown"><span class="hs-identifier hs-var hs-var">waitForShutdown</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MVar () -&gt; IO ()
forall a. MVar a -&gt; IO a
</span><span class="hs-identifier hs-var">C.takeMVar</span></span><span> </span><span class="annot"><span class="annottext">(MVar () -&gt; IO ())
-&gt; (ShutdownLatch -&gt; MVar ()) -&gt; ShutdownLatch -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ShutdownLatch -&gt; MVar ()
</span><a href="Hasura.App.html#unShutdownLatch"><span class="hs-identifier hs-var hs-var">unShutdownLatch</span></a></span><span>
</span><span id="line-508"></span><span>
</span><span id="line-509"></span><span class="hs-comment">-- | Initiate a graceful shutdown of the server associated with the provided</span><span>
</span><span id="line-510"></span><span class="hs-comment">-- latch.</span><span>
</span><span id="line-511"></span><span class="annot"><a href="Hasura.App.html#shutdownGracefully"><span class="hs-identifier hs-type">shutdownGracefully</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.App.html#ShutdownLatch"><span class="hs-identifier hs-type">ShutdownLatch</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-512"></span><span id="shutdownGracefully"><span class="annot"><span class="annottext">shutdownGracefully :: ShutdownLatch -&gt; IO ()
</span><a href="Hasura.App.html#shutdownGracefully"><span class="hs-identifier hs-var hs-var">shutdownGracefully</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO Bool -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO Bool -&gt; IO ())
-&gt; (ShutdownLatch -&gt; IO Bool) -&gt; ShutdownLatch -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(MVar () -&gt; () -&gt; IO Bool) -&gt; () -&gt; MVar () -&gt; IO Bool
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">MVar () -&gt; () -&gt; IO Bool
forall a. MVar a -&gt; a -&gt; IO Bool
</span><span class="hs-identifier hs-var">C.tryPutMVar</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(MVar () -&gt; IO Bool)
-&gt; (ShutdownLatch -&gt; MVar ()) -&gt; ShutdownLatch -&gt; IO Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ShutdownLatch -&gt; MVar ()
</span><a href="Hasura.App.html#unShutdownLatch"><span class="hs-identifier hs-var hs-var">unShutdownLatch</span></a></span><span>
</span><span id="line-513"></span><span>
</span><span id="line-514"></span><span class="hs-comment">-- | If an exception is encountered , flush the log buffer and</span><span>
</span><span id="line-515"></span><span class="hs-comment">-- rethrow If we do not flush the log buffer on exception, then log lines</span><span>
</span><span id="line-516"></span><span class="hs-comment">-- may be missed</span><span>
</span><span id="line-517"></span><span class="hs-comment">-- See: https://github.com/hasura/graphql-engine/issues/4772</span><span>
</span><span id="line-518"></span><span id="local-6989586621688186081"><span id="local-6989586621688186082"><span class="annot"><a href="Hasura.App.html#flushLogger"><span class="hs-identifier hs-type">flushLogger</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688186082"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.Logging.html#LoggerCtx"><span class="hs-identifier hs-type">LoggerCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688186081"><span class="hs-identifier hs-type">impl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688186082"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-519"></span><span id="flushLogger"><span class="annot"><span class="annottext">flushLogger :: LoggerCtx impl -&gt; m ()
</span><a href="Hasura.App.html#flushLogger"><span class="hs-identifier hs-var hs-var">flushLogger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ())
-&gt; (LoggerCtx impl -&gt; IO ()) -&gt; LoggerCtx impl -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LoggerSet -&gt; IO ()
</span><span class="hs-identifier hs-var">FL.flushLogStr</span></span><span> </span><span class="annot"><span class="annottext">(LoggerSet -&gt; IO ())
-&gt; (LoggerCtx impl -&gt; LoggerSet) -&gt; LoggerCtx impl -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LoggerCtx impl -&gt; LoggerSet
forall impl. LoggerCtx impl -&gt; LoggerSet
</span><a href="Hasura.Logging.html#_lcLoggerSet"><span class="hs-identifier hs-var hs-var">_lcLoggerSet</span></a></span><span>
</span><span id="line-520"></span><span>
</span><span id="line-521"></span><span class="hs-comment">-- | This function acts as the entrypoint for the graphql-engine webserver.</span><span>
</span><span id="line-522"></span><span class="hs-comment">--</span><span>
</span><span id="line-523"></span><span class="hs-comment">-- Note: at the exit of this function, or in case of a graceful server shutdown</span><span>
</span><span id="line-524"></span><span class="hs-comment">-- (SIGTERM, or more generally, whenever the shutdown latch is set),  we need to</span><span>
</span><span id="line-525"></span><span class="hs-comment">-- make absolutely sure that we clean up any resources which were allocated during</span><span>
</span><span id="line-526"></span><span class="hs-comment">-- server setup. In the case of a multitenant process, failure to do so can lead to</span><span>
</span><span id="line-527"></span><span class="hs-comment">-- resource leaks.</span><span>
</span><span id="line-528"></span><span class="hs-comment">--</span><span>
</span><span id="line-529"></span><span class="hs-comment">-- To track these resources, we use the ManagedT monad, and attach finalizers at</span><span>
</span><span id="line-530"></span><span class="hs-comment">-- the same point in the code where we allocate resources. If you fork a new</span><span>
</span><span id="line-531"></span><span class="hs-comment">-- long-lived thread, or create a connection pool, or allocate any other</span><span>
</span><span id="line-532"></span><span class="hs-comment">-- long-lived resource, make sure to pair the allocator  with its finalizer.</span><span>
</span><span id="line-533"></span><span class="hs-comment">-- There are plenty of examples throughout the code. For example, see</span><span>
</span><span id="line-534"></span><span class="hs-comment">-- 'C.forkManagedT'.</span><span>
</span><span id="line-535"></span><span class="hs-comment">--</span><span>
</span><span id="line-536"></span><span class="hs-comment">-- Note also: the order in which the finalizers run can be important. Specifically,</span><span>
</span><span id="line-537"></span><span class="hs-comment">-- we want the finalizers for the logger threads to run last, so that we retain as</span><span>
</span><span id="line-538"></span><span class="hs-comment">-- many &quot;thread stopping&quot; log messages as possible. The order in which the</span><span>
</span><span id="line-539"></span><span class="hs-comment">-- finalizers is run is determined by the order in which they are introduced in the</span><span>
</span><span id="line-540"></span><span class="hs-comment">-- code.</span><span>
</span><span id="line-541"></span><span>
</span><span id="line-542"></span><span class="hs-comment">{- HLINT ignore runHGEServer &quot;Avoid lambda&quot; -}</span><span>
</span><span id="line-543"></span><span class="annot"><a href="Hasura.App.html#runHGEServer"><span class="hs-identifier hs-type">runHGEServer</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-544"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688185241"><span class="annot"><a href="#local-6989586621688185241"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621688185240"><span class="annot"><a href="#local-6989586621688185240"><span class="hs-identifier hs-type">impl</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-545"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688185241"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-546"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621688185241"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-547"></span><span>    </span><span class="annot"><a href="Control.Monad.Stateless.html#MonadStateless"><span class="hs-identifier hs-type">MonadStateless</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688185241"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-548"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">LA.Forall</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">LA.Pure</span></span><span> </span><span class="annot"><a href="#local-6989586621688185241"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-549"></span><span>    </span><span class="annot"><a href="Hasura.Server.Auth.html#UserAuthentication"><span class="hs-identifier hs-type">UserAuthentication</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Tracing.html#TraceT"><span class="hs-identifier hs-type">Tracing.TraceT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185241"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-550"></span><span>    </span><span class="annot"><a href="Hasura.Server.Logging.html#HttpLog"><span class="hs-identifier hs-type">HttpLog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185241"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-551"></span><span>    </span><span class="annot"><a href="Hasura.Server.App.html#ConsoleRenderer"><span class="hs-identifier hs-type">ConsoleRenderer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185241"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-552"></span><span>    </span><span class="annot"><a href="Hasura.Server.App.html#MonadMetadataApiAuthorization"><span class="hs-identifier hs-type">MonadMetadataApiAuthorization</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185241"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-553"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Common.html#MonadGQLExecutionCheck"><span class="hs-identifier hs-type">MonadGQLExecutionCheck</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185241"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-554"></span><span>    </span><span class="annot"><a href="Hasura.Server.App.html#MonadConfigApiHandler"><span class="hs-identifier hs-type">MonadConfigApiHandler</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185241"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-555"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Logging.html#MonadQueryLog"><span class="hs-identifier hs-type">MonadQueryLog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185241"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-556"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Server.html#MonadWSLog"><span class="hs-identifier hs-type">WS.MonadWSLog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185241"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-557"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.html#MonadExecuteQuery"><span class="hs-identifier hs-type">MonadExecuteQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185241"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-558"></span><span>    </span><span class="annot"><a href="Hasura.Tracing.html#HasReporter"><span class="hs-identifier hs-type">Tracing.HasReporter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185241"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-559"></span><span>    </span><span class="annot"><a href="Hasura.Server.Limits.html#HasResourceLimits"><span class="hs-identifier hs-type">HasResourceLimits</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185241"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-560"></span><span>    </span><span class="annot"><a href="Hasura.Metadata.Class.html#MonadMetadataStorage"><span class="hs-identifier hs-type">MonadMetadataStorage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Metadata.Class.html#MetadataStorageT"><span class="hs-identifier hs-type">MetadataStorageT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185241"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-561"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MonadResolveSource"><span class="hs-identifier hs-type">MonadResolveSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185241"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-562"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Backend.html#MonadQueryTags"><span class="hs-identifier hs-type">EB.MonadQueryTags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185241"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-563"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-564"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.App.html#ServerCtx"><span class="hs-identifier hs-type">ServerCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Spock.SpockT</span></span><span> </span><span class="annot"><a href="#local-6989586621688185241"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-565"></span><span>  </span><span class="annot"><a href="Data.Environment.html#Environment"><span class="hs-identifier hs-type">Env.Environment</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-566"></span><span>  </span><span class="annot"><a href="Hasura.Server.Init.Config.html#ServeOptions"><span class="hs-identifier hs-type">ServeOptions</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185240"><span class="hs-identifier hs-type">impl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-567"></span><span>  </span><span class="annot"><a href="Hasura.App.html#ServeCtx"><span class="hs-identifier hs-type">ServeCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-568"></span><span>  </span><span class="hs-comment">-- and mutations</span><span>
</span><span id="line-569"></span><span>
</span><span id="line-570"></span><span>  </span><span class="hs-comment">-- | start time</span><span>
</span><span id="line-571"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">UTCTime</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-572"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#LiveQueryPostPollHook"><span class="hs-identifier hs-type">EL.LiveQueryPostPollHook</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-573"></span><span>  </span><span class="annot"><a href="Hasura.Server.Metrics.html#ServerMetrics"><span class="hs-identifier hs-type">ServerMetrics</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-574"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">EKG.Store</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">EKG.EmptyMetrics</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-575"></span><span>  </span><span class="annot"><a href="Control.Monad.Trans.Managed.html#ManagedT"><span class="hs-identifier hs-type">ManagedT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185241"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-576"></span><span id="runHGEServer"><span class="annot"><span class="annottext">runHGEServer :: (ServerCtx -&gt; SpockT m ())
-&gt; Environment
-&gt; ServeOptions impl
-&gt; ServeCtx
-&gt; UTCTime
-&gt; Maybe LiveQueryPostPollHook
-&gt; ServerMetrics
-&gt; Store EmptyMetrics
-&gt; ManagedT m ()
</span><a href="Hasura.App.html#runHGEServer"><span class="hs-identifier hs-var hs-var">runHGEServer</span></a></span></span><span> </span><span id="local-6989586621688185239"><span class="annot"><span class="annottext">ServerCtx -&gt; SpockT m ()
</span><a href="#local-6989586621688185239"><span class="hs-identifier hs-var">setupHook</span></a></span></span><span> </span><span id="local-6989586621688185238"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688185238"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621688185237"><span class="annot"><span class="annottext">ServeOptions impl
</span><a href="#local-6989586621688185237"><span class="hs-identifier hs-var">serveOptions</span></a></span></span><span> </span><span id="local-6989586621688185236"><span class="annot"><span class="annottext">ServeCtx
</span><a href="#local-6989586621688185236"><span class="hs-identifier hs-var">serveCtx</span></a></span></span><span> </span><span id="local-6989586621688185235"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688185235"><span class="hs-identifier hs-var">initTime</span></a></span></span><span> </span><span id="local-6989586621688185234"><span class="annot"><span class="annottext">Maybe LiveQueryPostPollHook
</span><a href="#local-6989586621688185234"><span class="hs-identifier hs-var">postPollHook</span></a></span></span><span> </span><span id="local-6989586621688185233"><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688185233"><span class="hs-identifier hs-var">serverMetrics</span></a></span></span><span> </span><span id="local-6989586621688185232"><span class="annot"><span class="annottext">Store EmptyMetrics
</span><a href="#local-6989586621688185232"><span class="hs-identifier hs-var">ekgStore</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-577"></span><span>  </span><span id="local-6989586621688185231"><span class="annot"><span class="annottext">Application
</span><a href="#local-6989586621688185231"><span class="hs-identifier hs-var">waiApplication</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-578"></span><span>    </span><span class="annot"><span class="annottext">(ServerCtx -&gt; SpockT m ())
-&gt; Environment
-&gt; ServeOptions impl
-&gt; ServeCtx
-&gt; UTCTime
-&gt; Maybe LiveQueryPostPollHook
-&gt; ServerMetrics
-&gt; Store EmptyMetrics
-&gt; ManagedT m Application
forall (m :: * -&gt; *) impl.
(MonadIO m, MonadMask m, MonadStateless IO m, Forall (Pure m),
 UserAuthentication (TraceT m), HttpLog m, ConsoleRenderer m,
 MonadMetadataApiAuthorization m, MonadGQLExecutionCheck m,
 MonadConfigApiHandler m, MonadQueryLog m, MonadWSLog m,
 MonadExecuteQuery m, HasReporter m, HasResourceLimits m,
 MonadMetadataStorage (MetadataStorageT m), MonadResolveSource m,
 MonadQueryTags m) =&gt;
(ServerCtx -&gt; SpockT m ())
-&gt; Environment
-&gt; ServeOptions impl
-&gt; ServeCtx
-&gt; UTCTime
-&gt; Maybe LiveQueryPostPollHook
-&gt; ServerMetrics
-&gt; Store EmptyMetrics
-&gt; ManagedT m Application
</span><a href="Hasura.App.html#mkHGEServer"><span class="hs-identifier hs-var">mkHGEServer</span></a></span><span> </span><span class="annot"><span class="annottext">ServerCtx -&gt; SpockT m ()
</span><a href="#local-6989586621688185239"><span class="hs-identifier hs-var">setupHook</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688185238"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">ServeOptions impl
</span><a href="#local-6989586621688185237"><span class="hs-identifier hs-var">serveOptions</span></a></span><span> </span><span class="annot"><span class="annottext">ServeCtx
</span><a href="#local-6989586621688185236"><span class="hs-identifier hs-var">serveCtx</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688185235"><span class="hs-identifier hs-var">initTime</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe LiveQueryPostPollHook
</span><a href="#local-6989586621688185234"><span class="hs-identifier hs-var">postPollHook</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688185233"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span> </span><span class="annot"><span class="annottext">Store EmptyMetrics
</span><a href="#local-6989586621688185232"><span class="hs-identifier hs-var">ekgStore</span></a></span><span>
</span><span id="line-579"></span><span>
</span><span id="line-580"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621688185230"><span class="hs-identifier hs-type">warpSettings</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Warp.Settings</span></span><span>
</span><span id="line-581"></span><span>      </span><span id="local-6989586621688185230"><span class="annot"><span class="annottext">warpSettings :: Settings
</span><a href="#local-6989586621688185230"><span class="hs-identifier hs-var hs-var">warpSettings</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-582"></span><span>        </span><span class="annot"><span class="annottext">Int -&gt; Settings -&gt; Settings
</span><span class="hs-identifier hs-var">Warp.setPort</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServeOptions impl -&gt; Int
forall impl. ServeOptions impl -&gt; Int
</span><a href="Hasura.Server.Init.Config.html#soPort"><span class="hs-identifier hs-var hs-var">soPort</span></a></span><span> </span><span class="annot"><span class="annottext">ServeOptions impl
</span><a href="#local-6989586621688185237"><span class="hs-identifier hs-var">serveOptions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-583"></span><span>          </span><span class="annot"><span class="annottext">(Settings -&gt; Settings)
-&gt; (Settings -&gt; Settings) -&gt; Settings -&gt; Settings
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">HostPreference -&gt; Settings -&gt; Settings
</span><span class="hs-identifier hs-var">Warp.setHost</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServeOptions impl -&gt; HostPreference
forall impl. ServeOptions impl -&gt; HostPreference
</span><a href="Hasura.Server.Init.Config.html#soHost"><span class="hs-identifier hs-var hs-var">soHost</span></a></span><span> </span><span class="annot"><span class="annottext">ServeOptions impl
</span><a href="#local-6989586621688185237"><span class="hs-identifier hs-var">serveOptions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-584"></span><span>          </span><span class="annot"><span class="annottext">(Settings -&gt; Settings)
-&gt; (Settings -&gt; Settings) -&gt; Settings -&gt; Settings
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Maybe Int -&gt; Settings -&gt; Settings
</span><span class="hs-identifier hs-var">Warp.setGracefulShutdownTimeout</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">30</span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- 30s graceful shutdown</span><span>
</span><span id="line-585"></span><span>          </span><span class="annot"><span class="annottext">(Settings -&gt; Settings)
-&gt; (Settings -&gt; Settings) -&gt; Settings -&gt; Settings
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; Settings -&gt; Settings
</span><span class="hs-identifier hs-var">Warp.setInstallShutdownHandler</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
</span><a href="#local-6989586621688185225"><span class="hs-identifier hs-var">shutdownHandler</span></a></span><span>
</span><span id="line-586"></span><span>          </span><span class="annot"><span class="annottext">(Settings -&gt; Settings)
-&gt; (Settings -&gt; Settings) -&gt; Settings -&gt; Settings
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Settings -&gt; Settings
</span><a href="#local-6989586621688185224"><span class="hs-identifier hs-var">setForkIOWithMetrics</span></a></span><span>
</span><span id="line-587"></span><span>          </span><span class="annot"><span class="annottext">(Settings -&gt; Settings) -&gt; Settings -&gt; Settings
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Settings
</span><span class="hs-identifier hs-var">Warp.defaultSettings</span></span><span>
</span><span id="line-588"></span><span>
</span><span id="line-589"></span><span>      </span><span class="annot"><a href="#local-6989586621688185224"><span class="hs-identifier hs-type">setForkIOWithMetrics</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Warp.Settings</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Warp.Settings</span></span><span>
</span><span id="line-590"></span><span>      </span><span id="local-6989586621688185224"><span class="annot"><span class="annottext">setForkIOWithMetrics :: Settings -&gt; Settings
</span><a href="#local-6989586621688185224"><span class="hs-identifier hs-var hs-var">setForkIOWithMetrics</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(((forall a. IO a -&gt; IO a) -&gt; IO ()) -&gt; IO ())
-&gt; Settings -&gt; Settings
</span><span class="hs-identifier hs-var">Warp.setFork</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688185221"><span class="annot"><span class="annottext">(forall a. IO a -&gt; IO a) -&gt; IO ()
</span><a href="#local-6989586621688185221"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-591"></span><span>        </span><span class="annot"><span class="annottext">IO ThreadId -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO ThreadId -&gt; IO ()) -&gt; IO ThreadId -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-592"></span><span>          </span><span class="annot"><span class="annottext">((forall a. IO a -&gt; IO a) -&gt; IO ()) -&gt; IO ThreadId
</span><span class="hs-identifier hs-var">C.forkIOWithUnmask</span></span><span>
</span><span id="line-593"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688185219"><span class="annot"><span class="annottext">forall a. IO a -&gt; IO a
</span><a href="#local-6989586621688185219"><span class="hs-identifier hs-var">unmask</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-594"></span><span>                </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO () -&gt; IO ()
forall a b c. IO a -&gt; IO b -&gt; IO c -&gt; IO c
</span><span class="hs-identifier hs-var">bracket_</span></span><span>
</span><span id="line-595"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><span class="hs-identifier hs-var">EKG.Gauge.inc</span></span><span> </span><span class="annot"><span class="annottext">(Gauge -&gt; IO ()) -&gt; Gauge -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerMetrics -&gt; Gauge
</span><a href="Hasura.Server.Metrics.html#smWarpThreads"><span class="hs-identifier hs-var hs-var">smWarpThreads</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688185233"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-596"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><span class="hs-identifier hs-var">EKG.Gauge.dec</span></span><span> </span><span class="annot"><span class="annottext">(Gauge -&gt; IO ()) -&gt; Gauge -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerMetrics -&gt; Gauge
</span><a href="Hasura.Server.Metrics.html#smWarpThreads"><span class="hs-identifier hs-var hs-var">smWarpThreads</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688185233"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-597"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall a. IO a -&gt; IO a) -&gt; IO ()
</span><a href="#local-6989586621688185221"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. IO a -&gt; IO a
</span><a href="#local-6989586621688185219"><span class="hs-identifier hs-var">unmask</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-598"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-599"></span><span>
</span><span id="line-600"></span><span>      </span><span class="annot"><a href="#local-6989586621688185225"><span class="hs-identifier hs-type">shutdownHandler</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-601"></span><span>      </span><span id="local-6989586621688185225"><span class="annot"><span class="annottext">shutdownHandler :: IO () -&gt; IO ()
</span><a href="#local-6989586621688185225"><span class="hs-identifier hs-var hs-var">shutdownHandler</span></a></span></span><span> </span><span id="local-6989586621688185215"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621688185215"><span class="hs-identifier hs-var">closeSocket</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-602"></span><span>        </span><span class="annot"><span class="annottext">Async () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadBase IO m =&gt; Async a -&gt; m ()
</span><span class="hs-identifier hs-var">LA.link</span></span><span> </span><span class="annot"><span class="annottext">(Async () -&gt; IO ()) -&gt; IO (Async ()) -&gt; IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO (Async ())
forall (m :: * -&gt; *) a.
(MonadBaseControl IO m, Forall (Pure m)) =&gt;
m a -&gt; m (Async a)
</span><span class="hs-identifier hs-var">LA.async</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-603"></span><span>          </span><span class="annot"><span class="annottext">ShutdownLatch -&gt; IO ()
</span><a href="Hasura.App.html#waitForShutdown"><span class="hs-identifier hs-var">waitForShutdown</span></a></span><span> </span><span class="annot"><span class="annottext">(ShutdownLatch -&gt; IO ()) -&gt; ShutdownLatch -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServeCtx -&gt; ShutdownLatch
</span><a href="Hasura.App.html#_scShutdownLatch"><span class="hs-identifier hs-var hs-var">_scShutdownLatch</span></a></span><span> </span><span class="annot"><span class="annottext">ServeCtx
</span><a href="#local-6989586621688185236"><span class="hs-identifier hs-var">serveCtx</span></a></span><span>
</span><span id="line-604"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688185211"><span class="annot"><span class="annottext">logger :: Logger Hasura
</span><a href="#local-6989586621688185211"><span class="hs-identifier hs-var hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Loggers -&gt; Logger Hasura
</span><a href="Hasura.App.html#_lsLogger"><span class="hs-identifier hs-var hs-var">_lsLogger</span></a></span><span> </span><span class="annot"><span class="annottext">(Loggers -&gt; Logger Hasura) -&gt; Loggers -&gt; Logger Hasura
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServeCtx -&gt; Loggers
</span><a href="Hasura.App.html#_scLoggers"><span class="hs-identifier hs-var hs-var">_scLoggers</span></a></span><span> </span><span class="annot"><span class="annottext">ServeCtx
</span><a href="#local-6989586621688185236"><span class="hs-identifier hs-var">serveCtx</span></a></span><span>
</span><span id="line-605"></span><span>          </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185211"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(StartupLog -&gt; IO ()) -&gt; StartupLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogLevel -&gt; Text -&gt; String -&gt; StartupLog
</span><a href="Hasura.Server.Init.html#mkGenericStrLog"><span class="hs-identifier hs-var">mkGenericStrLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;server&quot;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;gracefully shutting down server&quot;</span></span><span>
</span><span id="line-606"></span><span>          </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621688185215"><span class="hs-identifier hs-var">closeSocket</span></a></span><span>
</span><span id="line-607"></span><span>
</span><span id="line-608"></span><span>  </span><span class="hs-comment">-- Here we block until the shutdown latch 'MVar' is filled, and then</span><span>
</span><span id="line-609"></span><span>  </span><span class="hs-comment">-- shut down the server. Once this blocking call returns, we'll tidy up</span><span>
</span><span id="line-610"></span><span>  </span><span class="hs-comment">-- any resources using the finalizers attached using 'ManagedT' above.</span><span>
</span><span id="line-611"></span><span>  </span><span class="hs-comment">-- Structuring things using the shutdown latch in this way lets us decide</span><span>
</span><span id="line-612"></span><span>  </span><span class="hs-comment">-- elsewhere exactly how we want to control shutdown.</span><span>
</span><span id="line-613"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; ManagedT m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; ManagedT m ()) -&gt; IO () -&gt; ManagedT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Settings -&gt; Application -&gt; IO ()
</span><span class="hs-identifier hs-var">Warp.runSettings</span></span><span> </span><span class="annot"><span class="annottext">Settings
</span><a href="#local-6989586621688185230"><span class="hs-identifier hs-var">warpSettings</span></a></span><span> </span><span class="annot"><span class="annottext">Application
</span><a href="#local-6989586621688185231"><span class="hs-identifier hs-var">waiApplication</span></a></span><span>
</span><span id="line-614"></span><span>
</span><span id="line-615"></span><span class="hs-comment">-- | Part of a factorization of 'runHGEServer' to expose the constructed WAI</span><span>
</span><span id="line-616"></span><span class="hs-comment">-- application for testing purposes. See 'runHGEServer' for documentation.</span><span>
</span><span id="line-617"></span><span class="annot"><a href="Hasura.App.html#mkHGEServer"><span class="hs-identifier hs-type">mkHGEServer</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-618"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688186018"><span class="annot"><a href="#local-6989586621688186018"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621688185998"><span class="annot"><a href="#local-6989586621688185998"><span class="hs-identifier hs-type">impl</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-619"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688186018"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-620"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621688186018"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-621"></span><span>    </span><span class="annot"><a href="Control.Monad.Stateless.html#MonadStateless"><span class="hs-identifier hs-type">MonadStateless</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688186018"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-622"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">LA.Forall</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">LA.Pure</span></span><span> </span><span class="annot"><a href="#local-6989586621688186018"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-623"></span><span>    </span><span class="annot"><a href="Hasura.Server.Auth.html#UserAuthentication"><span class="hs-identifier hs-type">UserAuthentication</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Tracing.html#TraceT"><span class="hs-identifier hs-type">Tracing.TraceT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688186018"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-624"></span><span>    </span><span class="annot"><a href="Hasura.Server.Logging.html#HttpLog"><span class="hs-identifier hs-type">HttpLog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688186018"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-625"></span><span>    </span><span class="annot"><a href="Hasura.Server.App.html#ConsoleRenderer"><span class="hs-identifier hs-type">ConsoleRenderer</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688186018"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-626"></span><span>    </span><span class="annot"><a href="Hasura.Server.App.html#MonadMetadataApiAuthorization"><span class="hs-identifier hs-type">MonadMetadataApiAuthorization</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688186018"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-627"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Common.html#MonadGQLExecutionCheck"><span class="hs-identifier hs-type">MonadGQLExecutionCheck</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688186018"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-628"></span><span>    </span><span class="annot"><a href="Hasura.Server.App.html#MonadConfigApiHandler"><span class="hs-identifier hs-type">MonadConfigApiHandler</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688186018"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-629"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Logging.html#MonadQueryLog"><span class="hs-identifier hs-type">MonadQueryLog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688186018"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-630"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Server.html#MonadWSLog"><span class="hs-identifier hs-type">WS.MonadWSLog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688186018"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-631"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.html#MonadExecuteQuery"><span class="hs-identifier hs-type">MonadExecuteQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688186018"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-632"></span><span>    </span><span class="annot"><a href="Hasura.Tracing.html#HasReporter"><span class="hs-identifier hs-type">Tracing.HasReporter</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688186018"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-633"></span><span>    </span><span class="annot"><a href="Hasura.Server.Limits.html#HasResourceLimits"><span class="hs-identifier hs-type">HasResourceLimits</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688186018"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-634"></span><span>    </span><span class="annot"><a href="Hasura.Metadata.Class.html#MonadMetadataStorage"><span class="hs-identifier hs-type">MonadMetadataStorage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Metadata.Class.html#MetadataStorageT"><span class="hs-identifier hs-type">MetadataStorageT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688186018"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-635"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MonadResolveSource"><span class="hs-identifier hs-type">MonadResolveSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688186018"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-636"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.Backend.html#MonadQueryTags"><span class="hs-identifier hs-type">EB.MonadQueryTags</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688186018"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-637"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-638"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.App.html#ServerCtx"><span class="hs-identifier hs-type">ServerCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Spock.SpockT</span></span><span> </span><span class="annot"><a href="#local-6989586621688186018"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-639"></span><span>  </span><span class="annot"><a href="Data.Environment.html#Environment"><span class="hs-identifier hs-type">Env.Environment</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-640"></span><span>  </span><span class="annot"><a href="Hasura.Server.Init.Config.html#ServeOptions"><span class="hs-identifier hs-type">ServeOptions</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185998"><span class="hs-identifier hs-type">impl</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-641"></span><span>  </span><span class="annot"><a href="Hasura.App.html#ServeCtx"><span class="hs-identifier hs-type">ServeCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-642"></span><span>  </span><span class="hs-comment">-- and mutations</span><span>
</span><span id="line-643"></span><span>
</span><span id="line-644"></span><span>  </span><span class="hs-comment">-- | start time</span><span>
</span><span id="line-645"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">UTCTime</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-646"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#LiveQueryPostPollHook"><span class="hs-identifier hs-type">EL.LiveQueryPostPollHook</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-647"></span><span>  </span><span class="annot"><a href="Hasura.Server.Metrics.html#ServerMetrics"><span class="hs-identifier hs-type">ServerMetrics</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-648"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">EKG.Store</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">EKG.EmptyMetrics</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-649"></span><span>  </span><span class="annot"><a href="Control.Monad.Trans.Managed.html#ManagedT"><span class="hs-identifier hs-type">ManagedT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688186018"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Application</span></span><span>
</span><span id="line-650"></span><span id="mkHGEServer"><span class="annot"><span class="annottext">mkHGEServer :: (ServerCtx -&gt; SpockT m ())
-&gt; Environment
-&gt; ServeOptions impl
-&gt; ServeCtx
-&gt; UTCTime
-&gt; Maybe LiveQueryPostPollHook
-&gt; ServerMetrics
-&gt; Store EmptyMetrics
-&gt; ManagedT m Application
</span><a href="Hasura.App.html#mkHGEServer"><span class="hs-identifier hs-var hs-var">mkHGEServer</span></a></span></span><span> </span><span id="local-6989586621688185209"><span class="annot"><span class="annottext">ServerCtx -&gt; SpockT m ()
</span><a href="#local-6989586621688185209"><span class="hs-identifier hs-var">setupHook</span></a></span></span><span> </span><span id="local-6989586621688185208"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688185208"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="annot"><a href="Hasura.Server.Init.Config.html#ServeOptions"><span class="hs-identifier hs-type">ServeOptions</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688185171"><span id="local-6989586621688185172"><span id="local-6989586621688185173"><span id="local-6989586621688185174"><span id="local-6989586621688185175"><span id="local-6989586621688185176"><span id="local-6989586621688185177"><span id="local-6989586621688185178"><span id="local-6989586621688185179"><span id="local-6989586621688185180"><span id="local-6989586621688185181"><span id="local-6989586621688185182"><span id="local-6989586621688185183"><span id="local-6989586621688185184"><span id="local-6989586621688185185"><span id="local-6989586621688185186"><span id="local-6989586621688185187"><span id="local-6989586621688185188"><span id="local-6989586621688185189"><span id="local-6989586621688185190"><span id="local-6989586621688185191"><span id="local-6989586621688185192"><span id="local-6989586621688185193"><span id="local-6989586621688185194"><span id="local-6989586621688185195"><span id="local-6989586621688185196"><span id="local-6989586621688185197"><span id="local-6989586621688185198"><span id="local-6989586621688185199"><span id="local-6989586621688185200"><span id="local-6989586621688185201"><span id="local-6989586621688185202"><span id="local-6989586621688185203"><span id="local-6989586621688185204"><span id="local-6989586621688185205"><span id="local-6989586621688185206"><span id="local-6989586621688185207"><span class="annot"><span class="annottext">Bool
Int
[JWTConfig]
Maybe Int
Maybe Text
Maybe Milliseconds
Maybe RoleName
Maybe AuthHook
HashSet (EngineLogType impl)
HashSet ExperimentalFeature
HashSet AdminSecretHash
HashSet API
Seconds
LogLevel
ConnParams
TxIsolation
CorsConfig
NonNegativeInt
StringifyNumbers
FunctionPermissionsCtx
LiveQueriesOptions
RemoteSchemaPermsCtx
EventingMode
ReadOnlyMode
MaintenanceMode
HostPreference
ConnectionOptions
OptionalInterval
KeepAliveDelay
ResponseInternalErrorsConfig
WSConnectionInitTimeout
soReadOnlyMode :: ReadOnlyMode
soEventingMode :: EventingMode
soWebsocketConnectionInitTimeout :: WSConnectionInitTimeout
soGracefulShutdownTimeout :: Seconds
soDevMode :: Bool
soEventsFetchBatchSize :: NonNegativeInt
soExperimentalFeatures :: HashSet ExperimentalFeature
soSchemaPollInterval :: OptionalInterval
soEnableMaintenanceMode :: MaintenanceMode
soInferFunctionPermissions :: FunctionPermissionsCtx
soWebsocketKeepAlive :: KeepAliveDelay
soConnectionOptions :: ConnectionOptions
soEnableRemoteSchemaPermissions :: RemoteSchemaPermsCtx
soLogHeadersFromEnv :: Bool
soAsyncActionsFetchInterval :: OptionalInterval
soEventsFetchInterval :: Maybe Milliseconds
soEventsHttpPoolSize :: Maybe Int
soResponseInternalErrorsConfig :: ResponseInternalErrorsConfig
soLogLevel :: LogLevel
soEnabledLogTypes :: HashSet (EngineLogType impl)
soEnableAllowlist :: Bool
soLiveQueryOpts :: LiveQueriesOptions
soEnabledAPIs :: HashSet API
soDangerousBooleanCollapse :: Bool
soStringifyNum :: StringifyNumbers
soEnableTelemetry :: Bool
soConsoleAssetsDir :: Maybe Text
soEnableConsole :: Bool
soCorsConfig :: CorsConfig
soUnAuthRole :: Maybe RoleName
soJwtSecret :: [JWTConfig]
soAuthHook :: Maybe AuthHook
soAdminSecret :: HashSet AdminSecretHash
soTxIso :: TxIsolation
soConnParams :: ConnParams
soHost :: HostPreference
soPort :: Int
soReadOnlyMode :: forall impl. ServeOptions impl -&gt; ReadOnlyMode
soEventingMode :: forall impl. ServeOptions impl -&gt; EventingMode
soWebsocketConnectionInitTimeout :: forall impl. ServeOptions impl -&gt; WSConnectionInitTimeout
soGracefulShutdownTimeout :: forall impl. ServeOptions impl -&gt; Seconds
soDevMode :: forall impl. ServeOptions impl -&gt; Bool
soEventsFetchBatchSize :: forall impl. ServeOptions impl -&gt; NonNegativeInt
soExperimentalFeatures :: forall impl. ServeOptions impl -&gt; HashSet ExperimentalFeature
soSchemaPollInterval :: forall impl. ServeOptions impl -&gt; OptionalInterval
soEnableMaintenanceMode :: forall impl. ServeOptions impl -&gt; MaintenanceMode
soInferFunctionPermissions :: forall impl. ServeOptions impl -&gt; FunctionPermissionsCtx
soWebsocketKeepAlive :: forall impl. ServeOptions impl -&gt; KeepAliveDelay
soConnectionOptions :: forall impl. ServeOptions impl -&gt; ConnectionOptions
soEnableRemoteSchemaPermissions :: forall impl. ServeOptions impl -&gt; RemoteSchemaPermsCtx
soLogHeadersFromEnv :: forall impl. ServeOptions impl -&gt; Bool
soAsyncActionsFetchInterval :: forall impl. ServeOptions impl -&gt; OptionalInterval
soEventsFetchInterval :: forall impl. ServeOptions impl -&gt; Maybe Milliseconds
soEventsHttpPoolSize :: forall impl. ServeOptions impl -&gt; Maybe Int
soResponseInternalErrorsConfig :: forall impl. ServeOptions impl -&gt; ResponseInternalErrorsConfig
soLogLevel :: forall impl. ServeOptions impl -&gt; LogLevel
soEnabledLogTypes :: forall impl. ServeOptions impl -&gt; HashSet (EngineLogType impl)
soEnableAllowlist :: forall impl. ServeOptions impl -&gt; Bool
soLiveQueryOpts :: forall impl. ServeOptions impl -&gt; LiveQueriesOptions
soEnabledAPIs :: forall impl. ServeOptions impl -&gt; HashSet API
soDangerousBooleanCollapse :: forall impl. ServeOptions impl -&gt; Bool
soStringifyNum :: forall impl. ServeOptions impl -&gt; StringifyNumbers
soEnableTelemetry :: forall impl. ServeOptions impl -&gt; Bool
soConsoleAssetsDir :: forall impl. ServeOptions impl -&gt; Maybe Text
soEnableConsole :: forall impl. ServeOptions impl -&gt; Bool
soCorsConfig :: forall impl. ServeOptions impl -&gt; CorsConfig
soUnAuthRole :: forall impl. ServeOptions impl -&gt; Maybe RoleName
soJwtSecret :: forall impl. ServeOptions impl -&gt; [JWTConfig]
soAuthHook :: forall impl. ServeOptions impl -&gt; Maybe AuthHook
soAdminSecret :: forall impl. ServeOptions impl -&gt; HashSet AdminSecretHash
soTxIso :: forall impl. ServeOptions impl -&gt; TxIsolation
soConnParams :: forall impl. ServeOptions impl -&gt; ConnParams
soHost :: forall impl. ServeOptions impl -&gt; HostPreference
soPort :: forall impl. ServeOptions impl -&gt; Int
</span><a href="#local-6989586621688185171"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="annot"><a href="Hasura.App.html#ServeCtx"><span class="hs-identifier hs-type">ServeCtx</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688185162"><span id="local-6989586621688185163"><span id="local-6989586621688185164"><span id="local-6989586621688185165"><span id="local-6989586621688185166"><span id="local-6989586621688185167"><span id="local-6989586621688185168"><span id="local-6989586621688185169"><span id="local-6989586621688185170"><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
HashSet (EngineLogType Hasura)
PGPool
Manager
InstanceId
RebuildableSchemaCache
SchemaCacheRef
ShutdownLatch
Loggers
_scMetaVersionRef :: TMVar MetadataResourceVersion
_scSchemaCacheRef :: SchemaCacheRef
_scSchemaCache :: RebuildableSchemaCache
_scShutdownLatch :: ShutdownLatch
_scMetadataDbPool :: PGPool
_scEnabledLogTypes :: HashSet (EngineLogType Hasura)
_scLoggers :: Loggers
_scInstanceId :: InstanceId
_scHttpManager :: Manager
_scMetaVersionRef :: ServeCtx -&gt; TMVar MetadataResourceVersion
_scSchemaCacheRef :: ServeCtx -&gt; SchemaCacheRef
_scSchemaCache :: ServeCtx -&gt; RebuildableSchemaCache
_scEnabledLogTypes :: ServeCtx -&gt; HashSet (EngineLogType Hasura)
_scInstanceId :: ServeCtx -&gt; InstanceId
_scHttpManager :: ServeCtx -&gt; Manager
_scShutdownLatch :: ServeCtx -&gt; ShutdownLatch
_scMetadataDbPool :: ServeCtx -&gt; PGPool
_scLoggers :: ServeCtx -&gt; Loggers
</span><a href="#local-6989586621688185162"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621688185161"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688185161"><span class="hs-identifier hs-var">initTime</span></a></span></span><span> </span><span id="local-6989586621688185160"><span class="annot"><span class="annottext">Maybe LiveQueryPostPollHook
</span><a href="#local-6989586621688185160"><span class="hs-identifier hs-var">postPollHook</span></a></span></span><span> </span><span id="local-6989586621688185159"><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688185159"><span class="hs-identifier hs-var">serverMetrics</span></a></span></span><span> </span><span id="local-6989586621688185158"><span class="annot"><span class="annottext">Store EmptyMetrics
</span><a href="#local-6989586621688185158"><span class="hs-identifier hs-var">ekgStore</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-651"></span><span>  </span><span class="hs-comment">-- Comment this to enable expensive assertions from &quot;GHC.AssertNF&quot;. These</span><span>
</span><span id="line-652"></span><span>  </span><span class="hs-comment">-- will log lines to STDOUT containing &quot;not in normal form&quot;. In the future we</span><span>
</span><span id="line-653"></span><span>  </span><span class="hs-comment">-- could try to integrate this into our tests. For now this is a development</span><span>
</span><span id="line-654"></span><span>  </span><span class="hs-comment">-- tool.</span><span>
</span><span id="line-655"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-656"></span><span>  </span><span class="hs-comment">-- NOTE: be sure to compile WITHOUT code coverage, for this to work properly.</span><span>
</span><span id="line-657"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; ManagedT m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="GHC.AssertNF.CPP.html#disableAssertNF"><span class="hs-identifier hs-var">disableAssertNF</span></a></span><span>
</span><span id="line-658"></span><span>
</span><span id="line-659"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688185156"><span class="annot"><span class="annottext">optimizePermissionFilters :: Bool
</span><a href="#local-6989586621688185156"><span class="hs-identifier hs-var hs-var">optimizePermissionFilters</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExperimentalFeature
</span><a href="Hasura.Server.Types.html#EFOptimizePermissionFilters"><span class="hs-identifier hs-var">EFOptimizePermissionFilters</span></a></span><span> </span><span class="annot"><span class="annottext">ExperimentalFeature -&gt; HashSet ExperimentalFeature -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">HashSet ExperimentalFeature
</span><a href="#local-6989586621688185177"><span class="hs-identifier hs-var">soExperimentalFeatures</span></a></span><span>
</span><span id="line-660"></span><span>      </span><span id="local-6989586621688185155"><span class="annot"><span class="annottext">sqlGenCtx :: SQLGenCtx
</span><a href="#local-6989586621688185155"><span class="hs-identifier hs-var hs-var">sqlGenCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StringifyNumbers -&gt; Bool -&gt; Bool -&gt; SQLGenCtx
</span><a href="Hasura.RQL.Types.Common.html#SQLGenCtx"><span class="hs-identifier hs-var">SQLGenCtx</span></a></span><span> </span><span class="annot"><span class="annottext">StringifyNumbers
</span><a href="#local-6989586621688185195"><span class="hs-identifier hs-var">soStringifyNum</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688185194"><span class="hs-identifier hs-var">soDangerousBooleanCollapse</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688185156"><span class="hs-identifier hs-var">optimizePermissionFilters</span></a></span><span>
</span><span id="line-661"></span><span>      </span><span class="annot"><a href="Hasura.App.html#Loggers"><span class="hs-identifier hs-type">Loggers</span></a></span><span> </span><span id="local-6989586621688185154"><span class="annot"><span class="annottext">LoggerCtx Hasura
</span><a href="#local-6989586621688185154"><span class="hs-identifier hs-var">loggerCtx</span></a></span></span><span> </span><span id="local-6989586621688185153"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185153"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="annot"><span class="annottext">PGLogger
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Loggers
</span><a href="#local-6989586621688185168"><span class="hs-identifier hs-var">_scLoggers</span></a></span><span>
</span><span id="line-662"></span><span>  </span><span class="hs-comment">--SchemaSyncCtx{..} = _scSchemaSyncCtx</span><span>
</span><span id="line-663"></span><span>
</span><span id="line-664"></span><span>  </span><span id="local-6989586621688185152"><span class="annot"><span class="annottext">Either Text AuthMode
</span><a href="#local-6989586621688185152"><span class="hs-identifier hs-var">authModeRes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-665"></span><span>    </span><span class="annot"><span class="annottext">ExceptT Text (ManagedT m) AuthMode
-&gt; ManagedT m (Either Text AuthMode)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT Text (ManagedT m) AuthMode
 -&gt; ManagedT m (Either Text AuthMode))
-&gt; ExceptT Text (ManagedT m) AuthMode
-&gt; ManagedT m (Either Text AuthMode)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-666"></span><span>      </span><span class="annot"><span class="annottext">HashSet AdminSecretHash
-&gt; Maybe AuthHook
-&gt; [JWTConfig]
-&gt; Maybe RoleName
-&gt; Manager
-&gt; Logger Hasura
-&gt; ExceptT Text (ManagedT m) AuthMode
forall (m :: * -&gt; *).
(ForkableMonadIO m, HasReporter m) =&gt;
HashSet AdminSecretHash
-&gt; Maybe AuthHook
-&gt; [JWTConfig]
-&gt; Maybe RoleName
-&gt; Manager
-&gt; Logger Hasura
-&gt; ExceptT Text (ManagedT m) AuthMode
</span><a href="Hasura.Server.Auth.html#setupAuthMode"><span class="hs-identifier hs-var">setupAuthMode</span></a></span><span>
</span><span id="line-667"></span><span>        </span><span class="annot"><span class="annottext">HashSet AdminSecretHash
</span><a href="#local-6989586621688185203"><span class="hs-identifier hs-var">soAdminSecret</span></a></span><span>
</span><span id="line-668"></span><span>        </span><span class="annot"><span class="annottext">Maybe AuthHook
</span><a href="#local-6989586621688185202"><span class="hs-identifier hs-var">soAuthHook</span></a></span><span>
</span><span id="line-669"></span><span>        </span><span class="annot"><span class="annottext">[JWTConfig]
</span><a href="#local-6989586621688185201"><span class="hs-identifier hs-var">soJwtSecret</span></a></span><span>
</span><span id="line-670"></span><span>        </span><span class="annot"><span class="annottext">Maybe RoleName
</span><a href="#local-6989586621688185200"><span class="hs-identifier hs-var">soUnAuthRole</span></a></span><span>
</span><span id="line-671"></span><span>        </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621688185170"><span class="hs-identifier hs-var">_scHttpManager</span></a></span><span>
</span><span id="line-672"></span><span>        </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185153"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-673"></span><span>
</span><span id="line-674"></span><span>  </span><span id="local-6989586621688185150"><span class="annot"><span class="annottext">AuthMode
</span><a href="#local-6989586621688185150"><span class="hs-identifier hs-var">authMode</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either Text AuthMode
-&gt; (Text -&gt; ManagedT m AuthMode) -&gt; ManagedT m AuthMode
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="Hasura.Prelude.html#onLeft"><span class="hs-identifier hs-var">onLeft</span></a></span><span> </span><span class="annot"><span class="annottext">Either Text AuthMode
</span><a href="#local-6989586621688185152"><span class="hs-identifier hs-var">authModeRes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExitCode -&gt; String -&gt; ManagedT m AuthMode
forall (m :: * -&gt; *) a. MonadIO m =&gt; ExitCode -&gt; String -&gt; m a
</span><a href="Hasura.App.html#printErrExit"><span class="hs-identifier hs-var">printErrExit</span></a></span><span> </span><span class="annot"><span class="annottext">ExitCode
</span><a href="Hasura.App.html#AuthConfigurationError"><span class="hs-identifier hs-var">AuthConfigurationError</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ManagedT m AuthMode)
-&gt; (Text -&gt; String) -&gt; Text -&gt; ManagedT m AuthMode
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span class="hs-special">)</span><span>
</span><span id="line-675"></span><span>
</span><span id="line-676"></span><span>  </span><span class="annot"><a href="Hasura.Server.App.html#HasuraApp"><span class="hs-identifier hs-type">HasuraApp</span></a></span><span> </span><span id="local-6989586621688185147"><span class="annot"><span class="annottext">Application
</span><a href="#local-6989586621688185147"><span class="hs-identifier hs-var">app</span></a></span></span><span> </span><span id="local-6989586621688185146"><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621688185146"><span class="hs-identifier hs-var">cacheRef</span></a></span></span><span> </span><span id="local-6989586621688185145"><span class="annot"><span class="annottext">AsyncActionSubscriptionState
</span><a href="#local-6989586621688185145"><span class="hs-identifier hs-var">actionSubState</span></a></span></span><span> </span><span id="local-6989586621688185144"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621688185144"><span class="hs-identifier hs-var">stopWsServer</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-677"></span><span>    </span><span class="annot"><span class="annottext">m HasuraApp -&gt; ManagedT m HasuraApp
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m HasuraApp -&gt; ManagedT m HasuraApp)
-&gt; m HasuraApp -&gt; ManagedT m HasuraApp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-678"></span><span>      </span><span class="annot"><span class="annottext">(m HasuraApp -&gt; m () -&gt; m HasuraApp)
-&gt; m () -&gt; m HasuraApp -&gt; m HasuraApp
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">m HasuraApp -&gt; m () -&gt; m HasuraApp
forall (m :: * -&gt; *) a b. MonadCatch m =&gt; m a -&gt; m b -&gt; m a
</span><span class="hs-identifier hs-var">onException</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoggerCtx Hasura -&gt; m ()
forall (m :: * -&gt; *) impl. MonadIO m =&gt; LoggerCtx impl -&gt; m ()
</span><a href="Hasura.App.html#flushLogger"><span class="hs-identifier hs-var">flushLogger</span></a></span><span> </span><span class="annot"><span class="annottext">LoggerCtx Hasura
</span><a href="#local-6989586621688185154"><span class="hs-identifier hs-var">loggerCtx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m HasuraApp -&gt; m HasuraApp) -&gt; m HasuraApp -&gt; m HasuraApp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-679"></span><span>        </span><span class="annot"><span class="annottext">(ServerCtx -&gt; SpockT m ())
-&gt; Environment
-&gt; Logger Hasura
-&gt; SQLGenCtx
-&gt; Bool
-&gt; Manager
-&gt; AuthMode
-&gt; CorsConfig
-&gt; Bool
-&gt; Maybe Text
-&gt; Bool
-&gt; InstanceId
-&gt; HashSet API
-&gt; LiveQueriesOptions
-&gt; ResponseInternalErrorsConfig
-&gt; Maybe LiveQueryPostPollHook
-&gt; SchemaCacheRef
-&gt; Store EmptyMetrics
-&gt; ServerMetrics
-&gt; RemoteSchemaPermsCtx
-&gt; FunctionPermissionsCtx
-&gt; ConnectionOptions
-&gt; KeepAliveDelay
-&gt; MaintenanceMode
-&gt; EventingMode
-&gt; ReadOnlyMode
-&gt; HashSet ExperimentalFeature
-&gt; HashSet (EngineLogType Hasura)
-&gt; WSConnectionInitTimeout
-&gt; m HasuraApp
forall (m :: * -&gt; *).
(MonadIO m, MonadStateless IO m, Forall (Pure m),
 ConsoleRenderer m, HttpLog m, UserAuthentication (TraceT m),
 MonadMetadataApiAuthorization m, MonadGQLExecutionCheck m,
 MonadConfigApiHandler m, MonadQueryLog m, MonadWSLog m,
 HasReporter m, MonadExecuteQuery m, HasResourceLimits m,
 MonadMetadataStorage (MetadataStorageT m), MonadResolveSource m,
 MonadQueryTags m) =&gt;
(ServerCtx -&gt; SpockT m ())
-&gt; Environment
-&gt; Logger Hasura
-&gt; SQLGenCtx
-&gt; Bool
-&gt; Manager
-&gt; AuthMode
-&gt; CorsConfig
-&gt; Bool
-&gt; Maybe Text
-&gt; Bool
-&gt; InstanceId
-&gt; HashSet API
-&gt; LiveQueriesOptions
-&gt; ResponseInternalErrorsConfig
-&gt; Maybe LiveQueryPostPollHook
-&gt; SchemaCacheRef
-&gt; Store EmptyMetrics
-&gt; ServerMetrics
-&gt; RemoteSchemaPermsCtx
-&gt; FunctionPermissionsCtx
-&gt; ConnectionOptions
-&gt; KeepAliveDelay
-&gt; MaintenanceMode
-&gt; EventingMode
-&gt; ReadOnlyMode
-&gt; HashSet ExperimentalFeature
-&gt; HashSet (EngineLogType Hasura)
-&gt; WSConnectionInitTimeout
-&gt; m HasuraApp
</span><a href="Hasura.Server.App.html#mkWaiApp"><span class="hs-identifier hs-var">mkWaiApp</span></a></span><span>
</span><span id="line-680"></span><span>          </span><span class="annot"><span class="annottext">ServerCtx -&gt; SpockT m ()
</span><a href="#local-6989586621688185209"><span class="hs-identifier hs-var">setupHook</span></a></span><span>
</span><span id="line-681"></span><span>          </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688185208"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-682"></span><span>          </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185153"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-683"></span><span>          </span><span class="annot"><span class="annottext">SQLGenCtx
</span><a href="#local-6989586621688185155"><span class="hs-identifier hs-var">sqlGenCtx</span></a></span><span>
</span><span id="line-684"></span><span>          </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688185191"><span class="hs-identifier hs-var">soEnableAllowlist</span></a></span><span>
</span><span id="line-685"></span><span>          </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621688185170"><span class="hs-identifier hs-var">_scHttpManager</span></a></span><span>
</span><span id="line-686"></span><span>          </span><span class="annot"><span class="annottext">AuthMode
</span><a href="#local-6989586621688185150"><span class="hs-identifier hs-var">authMode</span></a></span><span>
</span><span id="line-687"></span><span>          </span><span class="annot"><span class="annottext">CorsConfig
</span><a href="#local-6989586621688185199"><span class="hs-identifier hs-var">soCorsConfig</span></a></span><span>
</span><span id="line-688"></span><span>          </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688185198"><span class="hs-identifier hs-var">soEnableConsole</span></a></span><span>
</span><span id="line-689"></span><span>          </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621688185197"><span class="hs-identifier hs-var">soConsoleAssetsDir</span></a></span><span>
</span><span id="line-690"></span><span>          </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688185196"><span class="hs-identifier hs-var">soEnableTelemetry</span></a></span><span>
</span><span id="line-691"></span><span>          </span><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621688185169"><span class="hs-identifier hs-var">_scInstanceId</span></a></span><span>
</span><span id="line-692"></span><span>          </span><span class="annot"><span class="annottext">HashSet API
</span><a href="#local-6989586621688185193"><span class="hs-identifier hs-var">soEnabledAPIs</span></a></span><span>
</span><span id="line-693"></span><span>          </span><span class="annot"><span class="annottext">LiveQueriesOptions
</span><a href="#local-6989586621688185192"><span class="hs-identifier hs-var">soLiveQueryOpts</span></a></span><span>
</span><span id="line-694"></span><span>          </span><span class="annot"><span class="annottext">ResponseInternalErrorsConfig
</span><a href="#local-6989586621688185188"><span class="hs-identifier hs-var">soResponseInternalErrorsConfig</span></a></span><span>
</span><span id="line-695"></span><span>          </span><span class="annot"><span class="annottext">Maybe LiveQueryPostPollHook
</span><a href="#local-6989586621688185160"><span class="hs-identifier hs-var">postPollHook</span></a></span><span>
</span><span id="line-696"></span><span>          </span><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621688185163"><span class="hs-identifier hs-var">_scSchemaCacheRef</span></a></span><span>
</span><span id="line-697"></span><span>          </span><span class="annot"><span class="annottext">Store EmptyMetrics
</span><a href="#local-6989586621688185158"><span class="hs-identifier hs-var">ekgStore</span></a></span><span>
</span><span id="line-698"></span><span>          </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688185159"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span>
</span><span id="line-699"></span><span>          </span><span class="annot"><span class="annottext">RemoteSchemaPermsCtx
</span><a href="#local-6989586621688185183"><span class="hs-identifier hs-var">soEnableRemoteSchemaPermissions</span></a></span><span>
</span><span id="line-700"></span><span>          </span><span class="annot"><span class="annottext">FunctionPermissionsCtx
</span><a href="#local-6989586621688185180"><span class="hs-identifier hs-var">soInferFunctionPermissions</span></a></span><span>
</span><span id="line-701"></span><span>          </span><span class="annot"><span class="annottext">ConnectionOptions
</span><a href="#local-6989586621688185182"><span class="hs-identifier hs-var">soConnectionOptions</span></a></span><span>
</span><span id="line-702"></span><span>          </span><span class="annot"><span class="annottext">KeepAliveDelay
</span><a href="#local-6989586621688185181"><span class="hs-identifier hs-var">soWebsocketKeepAlive</span></a></span><span>
</span><span id="line-703"></span><span>          </span><span class="annot"><span class="annottext">MaintenanceMode
</span><a href="#local-6989586621688185179"><span class="hs-identifier hs-var">soEnableMaintenanceMode</span></a></span><span>
</span><span id="line-704"></span><span>          </span><span class="annot"><span class="annottext">EventingMode
</span><a href="#local-6989586621688185172"><span class="hs-identifier hs-var">soEventingMode</span></a></span><span>
</span><span id="line-705"></span><span>          </span><span class="annot"><span class="annottext">ReadOnlyMode
</span><a href="#local-6989586621688185171"><span class="hs-identifier hs-var">soReadOnlyMode</span></a></span><span>
</span><span id="line-706"></span><span>          </span><span class="annot"><span class="annottext">HashSet ExperimentalFeature
</span><a href="#local-6989586621688185177"><span class="hs-identifier hs-var">soExperimentalFeatures</span></a></span><span>
</span><span id="line-707"></span><span>          </span><span class="annot"><span class="annottext">HashSet (EngineLogType Hasura)
</span><a href="#local-6989586621688185167"><span class="hs-identifier hs-var">_scEnabledLogTypes</span></a></span><span>
</span><span id="line-708"></span><span>          </span><span class="annot"><span class="annottext">WSConnectionInitTimeout
</span><a href="#local-6989586621688185173"><span class="hs-identifier hs-var">soWebsocketConnectionInitTimeout</span></a></span><span>
</span><span id="line-709"></span><span>
</span><span id="line-710"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688185142"><span class="annot"><span class="annottext">serverConfigCtx :: ServerConfigCtx
</span><a href="#local-6989586621688185142"><span class="hs-identifier hs-var hs-var">serverConfigCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-711"></span><span>        </span><span class="annot"><span class="annottext">FunctionPermissionsCtx
-&gt; RemoteSchemaPermsCtx
-&gt; SQLGenCtx
-&gt; MaintenanceMode
-&gt; HashSet ExperimentalFeature
-&gt; EventingMode
-&gt; ReadOnlyMode
-&gt; ServerConfigCtx
</span><a href="Hasura.Server.Types.html#ServerConfigCtx"><span class="hs-identifier hs-var">ServerConfigCtx</span></a></span><span>
</span><span id="line-712"></span><span>          </span><span class="annot"><span class="annottext">FunctionPermissionsCtx
</span><a href="#local-6989586621688185180"><span class="hs-identifier hs-var">soInferFunctionPermissions</span></a></span><span>
</span><span id="line-713"></span><span>          </span><span class="annot"><span class="annottext">RemoteSchemaPermsCtx
</span><a href="#local-6989586621688185183"><span class="hs-identifier hs-var">soEnableRemoteSchemaPermissions</span></a></span><span>
</span><span id="line-714"></span><span>          </span><span class="annot"><span class="annottext">SQLGenCtx
</span><a href="#local-6989586621688185155"><span class="hs-identifier hs-var">sqlGenCtx</span></a></span><span>
</span><span id="line-715"></span><span>          </span><span class="annot"><span class="annottext">MaintenanceMode
</span><a href="#local-6989586621688185179"><span class="hs-identifier hs-var">soEnableMaintenanceMode</span></a></span><span>
</span><span id="line-716"></span><span>          </span><span class="annot"><span class="annottext">HashSet ExperimentalFeature
</span><a href="#local-6989586621688185177"><span class="hs-identifier hs-var">soExperimentalFeatures</span></a></span><span>
</span><span id="line-717"></span><span>          </span><span class="annot"><span class="annottext">EventingMode
</span><a href="#local-6989586621688185172"><span class="hs-identifier hs-var">soEventingMode</span></a></span><span>
</span><span id="line-718"></span><span>          </span><span class="annot"><span class="annottext">ReadOnlyMode
</span><a href="#local-6989586621688185171"><span class="hs-identifier hs-var">soReadOnlyMode</span></a></span><span>
</span><span id="line-719"></span><span>
</span><span id="line-720"></span><span>  </span><span class="hs-comment">-- Log Warning if deprecated environment variables are used</span><span>
</span><span id="line-721"></span><span>  </span><span id="local-6989586621688185141"><span class="annot"><span class="annottext">SourceCache
</span><a href="#local-6989586621688185141"><span class="hs-identifier hs-var">sources</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; SourceCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#scSources"><span class="hs-identifier hs-var hs-var">scSources</span></a></span><span> </span><span class="annot"><span class="annottext">(SchemaCache -&gt; SourceCache)
-&gt; ManagedT m SchemaCache -&gt; ManagedT m SourceCache
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO SchemaCache -&gt; ManagedT m SchemaCache
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SchemaCacheRef -&gt; IO SchemaCache
forall (m :: * -&gt; *). MonadIO m =&gt; SchemaCacheRef -&gt; m SchemaCache
</span><a href="Hasura.Server.App.html#getSCFromRef"><span class="hs-identifier hs-var">getSCFromRef</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621688185146"><span class="hs-identifier hs-var">cacheRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-722"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; ManagedT m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; ManagedT m ()) -&gt; IO () -&gt; ManagedT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura -&gt; Environment -&gt; SourceCache -&gt; IO ()
</span><a href="Hasura.Server.Logging.html#logDeprecatedEnvVars"><span class="hs-identifier hs-var">logDeprecatedEnvVars</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185153"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688185208"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">SourceCache
</span><a href="#local-6989586621688185141"><span class="hs-identifier hs-var">sources</span></a></span><span>
</span><span id="line-723"></span><span>
</span><span id="line-724"></span><span>  </span><span class="hs-comment">-- log inconsistent schema objects</span><span>
</span><span id="line-725"></span><span>  </span><span id="local-6989586621688185137"><span class="annot"><span class="annottext">[InconsistentMetadata]
</span><a href="#local-6989586621688185137"><span class="hs-identifier hs-var">inconsObjs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; [InconsistentMetadata]
</span><a href="Hasura.RQL.Types.SchemaCache.html#scInconsistentObjs"><span class="hs-identifier hs-var hs-var">scInconsistentObjs</span></a></span><span> </span><span class="annot"><span class="annottext">(SchemaCache -&gt; [InconsistentMetadata])
-&gt; ManagedT m SchemaCache -&gt; ManagedT m [InconsistentMetadata]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO SchemaCache -&gt; ManagedT m SchemaCache
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SchemaCacheRef -&gt; IO SchemaCache
forall (m :: * -&gt; *). MonadIO m =&gt; SchemaCacheRef -&gt; m SchemaCache
</span><a href="Hasura.Server.App.html#getSCFromRef"><span class="hs-identifier hs-var">getSCFromRef</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621688185146"><span class="hs-identifier hs-var">cacheRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-726"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; ManagedT m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; ManagedT m ()) -&gt; IO () -&gt; ManagedT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura -&gt; [InconsistentMetadata] -&gt; IO ()
</span><a href="Hasura.Server.App.html#logInconsObjs"><span class="hs-identifier hs-var">logInconsObjs</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185153"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">[InconsistentMetadata]
</span><a href="#local-6989586621688185137"><span class="hs-identifier hs-var">inconsObjs</span></a></span><span>
</span><span id="line-727"></span><span>
</span><span id="line-728"></span><span>  </span><span class="hs-comment">-- NOTE: `newLogTVar` is being used to make sure that the metadata logger runs only once</span><span>
</span><span id="line-729"></span><span>  </span><span class="hs-comment">--       while logging errors or any `inconsistent_metadata` logs.</span><span>
</span><span id="line-730"></span><span>  </span><span id="local-6989586621688185134"><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621688185134"><span class="hs-identifier hs-var">newLogTVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (TVar Bool) -&gt; ManagedT m (TVar Bool)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (TVar Bool) -&gt; ManagedT m (TVar Bool))
-&gt; IO (TVar Bool) -&gt; ManagedT m (TVar Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO (TVar Bool)
forall a. a -&gt; IO (TVar a)
</span><span class="hs-identifier hs-var">STM.newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-731"></span><span>
</span><span id="line-732"></span><span>  </span><span class="hs-comment">-- Start a background thread for processing schema sync event present in the '_sscSyncEventRef'</span><span>
</span><span id="line-733"></span><span>  </span><span class="annot"><span class="annottext">Thread
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-734"></span><span>    </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; Manager
-&gt; TMVar MetadataResourceVersion
-&gt; SchemaCacheRef
-&gt; InstanceId
-&gt; ServerConfigCtx
-&gt; TVar Bool
-&gt; ManagedT m Thread
forall (m :: * -&gt; *).
(ForkableMonadIO m, MonadMetadataStorage (MetadataStorageT m),
 MonadResolveSource m) =&gt;
Logger Hasura
-&gt; Manager
-&gt; TMVar MetadataResourceVersion
-&gt; SchemaCacheRef
-&gt; InstanceId
-&gt; ServerConfigCtx
-&gt; TVar Bool
-&gt; ManagedT m Thread
</span><a href="Hasura.Server.SchemaUpdate.html#startSchemaSyncProcessorThread"><span class="hs-identifier hs-var">startSchemaSyncProcessorThread</span></a></span><span>
</span><span id="line-735"></span><span>      </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185153"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-736"></span><span>      </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621688185170"><span class="hs-identifier hs-var">_scHttpManager</span></a></span><span>
</span><span id="line-737"></span><span>      </span><span class="annot"><span class="annottext">TMVar MetadataResourceVersion
</span><a href="#local-6989586621688185162"><span class="hs-identifier hs-var">_scMetaVersionRef</span></a></span><span>
</span><span id="line-738"></span><span>      </span><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621688185146"><span class="hs-identifier hs-var">cacheRef</span></a></span><span>
</span><span id="line-739"></span><span>      </span><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621688185169"><span class="hs-identifier hs-var">_scInstanceId</span></a></span><span>
</span><span id="line-740"></span><span>      </span><span class="annot"><span class="annottext">ServerConfigCtx
</span><a href="#local-6989586621688185142"><span class="hs-identifier hs-var">serverConfigCtx</span></a></span><span>
</span><span id="line-741"></span><span>      </span><span class="annot"><span class="annottext">TVar Bool
</span><a href="#local-6989586621688185134"><span class="hs-identifier hs-var">newLogTVar</span></a></span><span>
</span><span id="line-742"></span><span>
</span><span id="line-743"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688185131"><span class="annot"><span class="annottext">eventLogBehavior :: LogBehavior
</span><a href="#local-6989586621688185131"><span class="hs-identifier hs-var hs-var">eventLogBehavior</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-744"></span><span>        </span><span class="annot"><span class="annottext">LogBehavior :: HeaderLogBehavior -&gt; ResponseLogBehavior -&gt; LogBehavior
</span><a href="Hasura.Eventing.HTTP.html#LogBehavior"><span class="hs-identifier hs-type">LogBehavior</span></a></span><span>
</span><span id="line-745"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_lbHeader :: HeaderLogBehavior
</span><a href="Hasura.Eventing.HTTP.html#_lbHeader"><span class="hs-identifier hs-var">_lbHeader</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688185184"><span class="hs-identifier hs-var">soLogHeadersFromEnv</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">HeaderLogBehavior
</span><a href="Hasura.Eventing.HTTP.html#LogEnvValue"><span class="hs-identifier hs-var">LogEnvValue</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">HeaderLogBehavior
</span><a href="Hasura.Eventing.HTTP.html#LogEnvVarname"><span class="hs-identifier hs-var">LogEnvVarname</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-746"></span><span>            </span><span class="annot"><span class="annottext">_lbResponse :: ResponseLogBehavior
</span><a href="Hasura.Eventing.HTTP.html#_lbResponse"><span class="hs-identifier hs-var">_lbResponse</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688185175"><span class="hs-identifier hs-var">soDevMode</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">ResponseLogBehavior
</span><a href="Hasura.Eventing.HTTP.html#LogEntireResponse"><span class="hs-identifier hs-var">LogEntireResponse</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">ResponseLogBehavior
</span><a href="Hasura.Eventing.HTTP.html#LogSanitisedResponse"><span class="hs-identifier hs-var">LogSanitisedResponse</span></a></span><span>
</span><span id="line-747"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-748"></span><span>
</span><span id="line-749"></span><span>  </span><span id="local-6989586621688185123"><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688185123"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-750"></span><span>    </span><span class="annot"><span class="annottext">IO LockedEventsCtx -&gt; ManagedT m LockedEventsCtx
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO LockedEventsCtx -&gt; ManagedT m LockedEventsCtx)
-&gt; IO LockedEventsCtx -&gt; ManagedT m LockedEventsCtx
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-751"></span><span>      </span><span class="annot"><span class="annottext">TVar (Set CronEventId)
-&gt; TVar (Set CronEventId)
-&gt; TVar (HashMap SourceName (Set CronEventId))
-&gt; TVar (Set CronEventId)
-&gt; LockedEventsCtx
</span><a href="Hasura.Eventing.Common.html#LockedEventsCtx"><span class="hs-identifier hs-var">LockedEventsCtx</span></a></span><span>
</span><span id="line-752"></span><span>        </span><span class="annot"><span class="annottext">(TVar (Set CronEventId)
 -&gt; TVar (Set CronEventId)
 -&gt; TVar (HashMap SourceName (Set CronEventId))
 -&gt; TVar (Set CronEventId)
 -&gt; LockedEventsCtx)
-&gt; IO (TVar (Set CronEventId))
-&gt; IO
     (TVar (Set CronEventId)
      -&gt; TVar (HashMap SourceName (Set CronEventId))
      -&gt; TVar (Set CronEventId)
      -&gt; LockedEventsCtx)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Set CronEventId -&gt; IO (TVar (Set CronEventId))
forall a. a -&gt; IO (TVar a)
</span><span class="hs-identifier hs-var">STM.newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">Set CronEventId
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-753"></span><span>        </span><span class="annot"><span class="annottext">IO
  (TVar (Set CronEventId)
   -&gt; TVar (HashMap SourceName (Set CronEventId))
   -&gt; TVar (Set CronEventId)
   -&gt; LockedEventsCtx)
-&gt; IO (TVar (Set CronEventId))
-&gt; IO
     (TVar (HashMap SourceName (Set CronEventId))
      -&gt; TVar (Set CronEventId) -&gt; LockedEventsCtx)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Set CronEventId -&gt; IO (TVar (Set CronEventId))
forall a. a -&gt; IO (TVar a)
</span><span class="hs-identifier hs-var">STM.newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">Set CronEventId
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-754"></span><span>        </span><span class="annot"><span class="annottext">IO
  (TVar (HashMap SourceName (Set CronEventId))
   -&gt; TVar (Set CronEventId) -&gt; LockedEventsCtx)
-&gt; IO (TVar (HashMap SourceName (Set CronEventId)))
-&gt; IO (TVar (Set CronEventId) -&gt; LockedEventsCtx)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">HashMap SourceName (Set CronEventId)
-&gt; IO (TVar (HashMap SourceName (Set CronEventId)))
forall a. a -&gt; IO (TVar a)
</span><span class="hs-identifier hs-var">STM.newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">HashMap SourceName (Set CronEventId)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-755"></span><span>        </span><span class="annot"><span class="annottext">IO (TVar (Set CronEventId) -&gt; LockedEventsCtx)
-&gt; IO (TVar (Set CronEventId)) -&gt; IO LockedEventsCtx
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Set CronEventId -&gt; IO (TVar (Set CronEventId))
forall a. a -&gt; IO (TVar a)
</span><span class="hs-identifier hs-var">STM.newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">Set CronEventId
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-756"></span><span>
</span><span id="line-757"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">EventingMode
</span><a href="#local-6989586621688185172"><span class="hs-identifier hs-var">soEventingMode</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-758"></span><span>    </span><span class="annot"><span class="annottext">EventingMode
</span><a href="Hasura.Server.Types.html#EventingEnabled"><span class="hs-identifier hs-var">EventingEnabled</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-759"></span><span>      </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; LogBehavior
-&gt; LockedEventsCtx
-&gt; SchemaCacheRef
-&gt; ManagedT m ()
</span><a href="#local-6989586621688185120"><span class="hs-identifier hs-var">startEventTriggerPollerThread</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185153"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">LogBehavior
</span><a href="#local-6989586621688185131"><span class="hs-identifier hs-var">eventLogBehavior</span></a></span><span> </span><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688185123"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621688185146"><span class="hs-identifier hs-var">cacheRef</span></a></span><span>
</span><span id="line-760"></span><span>      </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; LockedEventsCtx
-&gt; SchemaCacheRef
-&gt; AsyncActionSubscriptionState
-&gt; ManagedT m ()
</span><a href="#local-6989586621688185119"><span class="hs-identifier hs-var">startAsyncActionsPollerThread</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185153"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688185123"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621688185146"><span class="hs-identifier hs-var">cacheRef</span></a></span><span> </span><span class="annot"><span class="annottext">AsyncActionSubscriptionState
</span><a href="#local-6989586621688185145"><span class="hs-identifier hs-var">actionSubState</span></a></span><span>
</span><span id="line-761"></span><span>
</span><span id="line-762"></span><span>      </span><span class="hs-comment">-- start a background thread to create new cron events</span><span>
</span><span id="line-763"></span><span>      </span><span id="local-6989586621688185118"><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621688185118"><span class="hs-identifier hs-var">_cronEventsThread</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-764"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; Logger Hasura -&gt; m Void -&gt; ManagedT m Thread
forall (m :: * -&gt; *).
ForkableMonadIO m =&gt;
String -&gt; Logger Hasura -&gt; m Void -&gt; ManagedT m Thread
</span><a href="Control.Concurrent.Extended.html#forkManagedT"><span class="hs-identifier hs-var">C.forkManagedT</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;runCronEventsGenerator&quot;</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185153"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(m Void -&gt; ManagedT m Thread) -&gt; m Void -&gt; ManagedT m Thread
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-765"></span><span>          </span><span class="annot"><span class="annottext">Logger Hasura -&gt; IO SchemaCache -&gt; m Void
forall (m :: * -&gt; *) void.
(MonadIO m, MonadMetadataStorage (MetadataStorageT m)) =&gt;
Logger Hasura -&gt; IO SchemaCache -&gt; m void
</span><a href="Hasura.Eventing.ScheduledTrigger.html#runCronEventsGenerator"><span class="hs-identifier hs-var">runCronEventsGenerator</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185153"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SchemaCacheRef -&gt; IO SchemaCache
forall (m :: * -&gt; *). MonadIO m =&gt; SchemaCacheRef -&gt; m SchemaCache
</span><a href="Hasura.Server.App.html#getSCFromRef"><span class="hs-identifier hs-var">getSCFromRef</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621688185146"><span class="hs-identifier hs-var">cacheRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-766"></span><span>
</span><span id="line-767"></span><span>      </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; LogBehavior
-&gt; LockedEventsCtx
-&gt; SchemaCacheRef
-&gt; ManagedT m ()
</span><a href="#local-6989586621688185115"><span class="hs-identifier hs-var">startScheduledEventsPollerThread</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185153"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">LogBehavior
</span><a href="#local-6989586621688185131"><span class="hs-identifier hs-var">eventLogBehavior</span></a></span><span> </span><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688185123"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621688185146"><span class="hs-identifier hs-var">cacheRef</span></a></span><span>
</span><span id="line-768"></span><span>    </span><span class="annot"><span class="annottext">EventingMode
</span><a href="Hasura.Server.Types.html#EventingDisabled"><span class="hs-identifier hs-var">EventingDisabled</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-769"></span><span>      </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185153"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(StartupLog -&gt; ManagedT m ()) -&gt; StartupLog -&gt; ManagedT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogLevel -&gt; Text -&gt; String -&gt; StartupLog
</span><a href="Hasura.Server.Init.html#mkGenericStrLog"><span class="hs-identifier hs-var">mkGenericStrLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;server&quot;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;starting in eventing disabled mode&quot;</span></span><span>
</span><span id="line-770"></span><span>
</span><span id="line-771"></span><span>  </span><span class="hs-comment">-- start a background thread to check for updates</span><span>
</span><span id="line-772"></span><span>  </span><span id="local-6989586621688185113"><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621688185113"><span class="hs-identifier hs-var">_updateThread</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-773"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Logger Hasura -&gt; m Void -&gt; ManagedT m Thread
forall (m :: * -&gt; *).
ForkableMonadIO m =&gt;
String -&gt; Logger Hasura -&gt; m Void -&gt; ManagedT m Thread
</span><a href="Control.Concurrent.Extended.html#forkManagedT"><span class="hs-identifier hs-var">C.forkManagedT</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;checkForUpdates&quot;</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185153"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(m Void -&gt; ManagedT m Thread) -&gt; m Void -&gt; ManagedT m Thread
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-774"></span><span>      </span><span class="annot"><span class="annottext">IO Void -&gt; m Void
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO Void -&gt; m Void) -&gt; IO Void -&gt; m Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LoggerCtx Hasura -&gt; Manager -&gt; IO Void
forall a void. LoggerCtx a -&gt; Manager -&gt; IO void
</span><a href="Hasura.Server.CheckUpdates.html#checkForUpdates"><span class="hs-identifier hs-var">checkForUpdates</span></a></span><span> </span><span class="annot"><span class="annottext">LoggerCtx Hasura
</span><a href="#local-6989586621688185154"><span class="hs-identifier hs-var">loggerCtx</span></a></span><span> </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621688185170"><span class="hs-identifier hs-var">_scHttpManager</span></a></span><span>
</span><span id="line-775"></span><span>
</span><span id="line-776"></span><span>  </span><span class="hs-comment">-- start a background thread for telemetry</span><span>
</span><span id="line-777"></span><span>  </span><span id="local-6989586621688185112"><span class="annot"><span class="annottext">Either QErr Text
</span><a href="#local-6989586621688185112"><span class="hs-identifier hs-var">dbUidE</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MetadataStorageT (ManagedT m) Text -&gt; ManagedT m (Either QErr Text)
forall (m :: * -&gt; *) a. MetadataStorageT m a -&gt; m (Either QErr a)
</span><a href="Hasura.Metadata.Class.html#runMetadataStorageT"><span class="hs-identifier hs-var">runMetadataStorageT</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataStorageT (ManagedT m) Text
forall (m :: * -&gt; *). MonadMetadataStorage m =&gt; m Text
</span><a href="Hasura.Metadata.Class.html#getDatabaseUid"><span class="hs-identifier hs-var">getDatabaseUid</span></a></span><span>
</span><span id="line-778"></span><span>  </span><span id="local-6989586621688185109"><span class="annot"><span class="annottext">Maybe Thread
</span><a href="#local-6989586621688185109"><span class="hs-identifier hs-var">_telemetryThread</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-779"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688185196"><span class="hs-identifier hs-var">soEnableTelemetry</span></a></span><span>
</span><span id="line-780"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-781"></span><span>        </span><span class="annot"><span class="annottext">m () -&gt; ManagedT m ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; ManagedT m ())
-&gt; (StartupLog -&gt; m ()) -&gt; StartupLog -&gt; ManagedT m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185153"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(StartupLog -&gt; ManagedT m ()) -&gt; StartupLog -&gt; ManagedT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogLevel -&gt; Text -&gt; String -&gt; StartupLog
</span><a href="Hasura.Server.Init.html#mkGenericStrLog"><span class="hs-identifier hs-var">mkGenericStrLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;telemetry&quot;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="Hasura.App.html#telemetryNotice"><span class="hs-identifier hs-var">telemetryNotice</span></a></span><span>
</span><span id="line-782"></span><span>
</span><span id="line-783"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621688185107"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688185107"><span class="hs-identifier hs-var">dbId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688185106"><span class="annot"><span class="annottext">PGVersion
</span><a href="#local-6989586621688185106"><span class="hs-identifier hs-var">pgVersion</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-784"></span><span>          </span><span class="annot"><span class="annottext">IO (Text, PGVersion) -&gt; ManagedT m (Text, PGVersion)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Text, PGVersion) -&gt; ManagedT m (Text, PGVersion))
-&gt; IO (Text, PGVersion) -&gt; ManagedT m (Text, PGVersion)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-785"></span><span>            </span><span class="annot"><span class="annottext">PGPool
-&gt; TxMode -&gt; TxE QErr (Text, PGVersion) -&gt; IO (Text, PGVersion)
forall a. PGPool -&gt; TxMode -&gt; TxE QErr a -&gt; IO a
</span><a href="Hasura.App.html#runTxIO"><span class="hs-identifier hs-var">runTxIO</span></a></span><span> </span><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621688185166"><span class="hs-identifier hs-var">_scMetadataDbPool</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxIsolation
</span><span class="hs-identifier hs-var">Q.ReadCommitted</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe TxAccess
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TxE QErr (Text, PGVersion) -&gt; IO (Text, PGVersion))
-&gt; TxE QErr (Text, PGVersion) -&gt; IO (Text, PGVersion)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-786"></span><span>              </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Text -&gt; PGVersion -&gt; (Text, PGVersion))
-&gt; TxET QErr IO Text
-&gt; TxET QErr IO (PGVersion -&gt; (Text, PGVersion))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Either QErr Text -&gt; TxET QErr IO Text
forall e (m :: * -&gt; *) a. MonadError e m =&gt; Either e a -&gt; m a
</span><span class="hs-identifier hs-var">liftEither</span></span><span> </span><span class="annot"><span class="annottext">Either QErr Text
</span><a href="#local-6989586621688185112"><span class="hs-identifier hs-var">dbUidE</span></a></span><span> </span><span class="annot"><span class="annottext">TxET QErr IO (PGVersion -&gt; (Text, PGVersion))
-&gt; TxET QErr IO PGVersion -&gt; TxE QErr (Text, PGVersion)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">TxET QErr IO PGVersion
</span><a href="Hasura.Server.Init.html#getPgVersion"><span class="hs-identifier hs-var">getPgVersion</span></a></span><span>
</span><span id="line-787"></span><span>
</span><span id="line-788"></span><span>        </span><span id="local-6989586621688185102"><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621688185102"><span class="hs-identifier hs-var">telemetryThread</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-789"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; Logger Hasura -&gt; m Void -&gt; ManagedT m Thread
forall (m :: * -&gt; *).
ForkableMonadIO m =&gt;
String -&gt; Logger Hasura -&gt; m Void -&gt; ManagedT m Thread
</span><a href="Control.Concurrent.Extended.html#forkManagedT"><span class="hs-identifier hs-var">C.forkManagedT</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;runTelemetry&quot;</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185153"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(m Void -&gt; ManagedT m Thread) -&gt; m Void -&gt; ManagedT m Thread
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-790"></span><span>            </span><span class="annot"><span class="annottext">IO Void -&gt; m Void
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO Void -&gt; m Void) -&gt; IO Void -&gt; m Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; Manager
-&gt; IO SchemaCache
-&gt; Text
-&gt; InstanceId
-&gt; PGVersion
-&gt; IO Void
forall void.
Logger Hasura
-&gt; Manager
-&gt; IO SchemaCache
-&gt; Text
-&gt; InstanceId
-&gt; PGVersion
-&gt; IO void
</span><a href="Hasura.Server.Telemetry.html#runTelemetry"><span class="hs-identifier hs-var">runTelemetry</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185153"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621688185170"><span class="hs-identifier hs-var">_scHttpManager</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SchemaCacheRef -&gt; IO SchemaCache
forall (m :: * -&gt; *). MonadIO m =&gt; SchemaCacheRef -&gt; m SchemaCache
</span><a href="Hasura.Server.App.html#getSCFromRef"><span class="hs-identifier hs-var">getSCFromRef</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621688185146"><span class="hs-identifier hs-var">cacheRef</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688185107"><span class="hs-identifier hs-var">dbId</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621688185169"><span class="hs-identifier hs-var">_scInstanceId</span></a></span><span> </span><span class="annot"><span class="annottext">PGVersion
</span><a href="#local-6989586621688185106"><span class="hs-identifier hs-var">pgVersion</span></a></span><span>
</span><span id="line-791"></span><span>        </span><span class="annot"><span class="annottext">Maybe Thread -&gt; ManagedT m (Maybe Thread)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Thread -&gt; ManagedT m (Maybe Thread))
-&gt; Maybe Thread -&gt; ManagedT m (Maybe Thread)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Thread -&gt; Maybe Thread
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621688185102"><span class="hs-identifier hs-var">telemetryThread</span></a></span><span>
</span><span id="line-792"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe Thread -&gt; ManagedT m (Maybe Thread)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe Thread
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-793"></span><span>
</span><span id="line-794"></span><span>  </span><span id="local-6989586621688185100"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688185100"><span class="hs-identifier hs-var">finishTime</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime -&gt; ManagedT m UTCTime
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO UTCTime
</span><span class="hs-identifier hs-var">Clock.getCurrentTime</span></span><span>
</span><span id="line-795"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688185099"><span class="annot"><span class="annottext">apiInitTime :: Double
</span><a href="#local-6989586621688185099"><span class="hs-identifier hs-var hs-var">apiInitTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NominalDiffTime -&gt; Double
forall a b. (Real a, Fractional b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">realToFrac</span></span><span> </span><span class="annot"><span class="annottext">(NominalDiffTime -&gt; Double) -&gt; NominalDiffTime -&gt; Double
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; UTCTime -&gt; NominalDiffTime
</span><span class="hs-identifier hs-var">Clock.diffUTCTime</span></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688185100"><span class="hs-identifier hs-var">finishTime</span></a></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621688185161"><span class="hs-identifier hs-var">initTime</span></a></span><span>
</span><span id="line-796"></span><span>  </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185153"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(StartupLog -&gt; ManagedT m ()) -&gt; StartupLog -&gt; ManagedT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-797"></span><span>    </span><span class="annot"><span class="annottext">LogLevel -&gt; Text -&gt; StartupTimeInfo -&gt; StartupLog
forall a. ToJSON a =&gt; LogLevel -&gt; Text -&gt; a -&gt; StartupLog
</span><a href="Hasura.Server.Init.html#mkGenericLog"><span class="hs-identifier hs-var">mkGenericLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;server&quot;</span></span><span> </span><span class="annot"><span class="annottext">(StartupTimeInfo -&gt; StartupLog) -&gt; StartupTimeInfo -&gt; StartupLog
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Double -&gt; StartupTimeInfo
</span><a href="Hasura.Server.Init.html#StartupTimeInfo"><span class="hs-identifier hs-var">StartupTimeInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;starting API server&quot;</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621688185099"><span class="hs-identifier hs-var">apiInitTime</span></a></span><span>
</span><span id="line-798"></span><span>
</span><span id="line-799"></span><span>  </span><span class="hs-comment">-- These cleanup actions are not directly associated with any</span><span>
</span><span id="line-800"></span><span>  </span><span class="hs-comment">-- resource, but we still need to make sure we clean them up here.</span><span>
</span><span id="line-801"></span><span>  </span><span class="annot"><span class="annottext">m () -&gt; m () -&gt; ManagedT m ()
forall (m :: * -&gt; *) a b.
MonadBaseControl IO m =&gt;
m a -&gt; m b -&gt; ManagedT m ()
</span><a href="Control.Monad.Trans.Managed.html#allocate_"><span class="hs-identifier hs-var">allocate_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621688185144"><span class="hs-identifier hs-var">stopWsServer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-802"></span><span>
</span><span id="line-803"></span><span>  </span><span class="annot"><span class="annottext">Application -&gt; ManagedT m Application
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Application
</span><a href="#local-6989586621688185147"><span class="hs-identifier hs-var">app</span></a></span><span>
</span><span id="line-804"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-805"></span><span>    </span><span id="local-6989586621688185095"><span class="annot"><span class="annottext">prepareScheduledEvents :: Logger impl -&gt; m ()
</span><a href="#local-6989586621688185095"><span class="hs-identifier hs-var hs-var">prepareScheduledEvents</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span id="local-6989586621688185094"><span class="annot"><span class="annottext">forall a (m :: * -&gt; *).
(ToEngineLog a impl, MonadIO m) =&gt;
a -&gt; m ()
</span><a href="#local-6989586621688185094"><span class="hs-identifier hs-var">logger</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-806"></span><span>      </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StartupLog -&gt; IO ()
forall a (m :: * -&gt; *).
(ToEngineLog a impl, MonadIO m) =&gt;
a -&gt; m ()
</span><a href="#local-6989586621688185094"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(StartupLog -&gt; IO ()) -&gt; StartupLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogLevel -&gt; Text -&gt; String -&gt; StartupLog
</span><a href="Hasura.Server.Init.html#mkGenericStrLog"><span class="hs-identifier hs-var">mkGenericStrLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;scheduled_triggers&quot;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;preparing data&quot;</span></span><span>
</span><span id="line-807"></span><span>      </span><span id="local-6989586621688185093"><span class="annot"><span class="annottext">Either QErr ()
</span><a href="#local-6989586621688185093"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MetadataStorageT m () -&gt; m (Either QErr ())
forall (m :: * -&gt; *) a. MetadataStorageT m a -&gt; m (Either QErr a)
</span><a href="Hasura.Metadata.Class.html#runMetadataStorageT"><span class="hs-identifier hs-var">runMetadataStorageT</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataStorageT m ()
forall (m :: * -&gt; *). MonadMetadataStorage m =&gt; m ()
</span><a href="Hasura.Metadata.Class.html#unlockAllLockedScheduledEvents"><span class="hs-identifier hs-var">unlockAllLockedScheduledEvents</span></a></span><span>
</span><span id="line-808"></span><span>      </span><span class="annot"><span class="annottext">Either QErr () -&gt; (QErr -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) e a.
Applicative m =&gt;
Either e a -&gt; (e -&gt; m a) -&gt; m a
</span><a href="Hasura.Prelude.html#onLeft"><span class="hs-identifier hs-var">onLeft</span></a></span><span> </span><span class="annot"><span class="annottext">Either QErr ()
</span><a href="#local-6989586621688185093"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">((QErr -&gt; m ()) -&gt; m ()) -&gt; (QErr -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExitCode -&gt; QErr -&gt; m ()
forall a (m :: * -&gt; *) b.
(ToJSON a, MonadIO m) =&gt;
ExitCode -&gt; a -&gt; m b
</span><a href="Hasura.App.html#printErrJExit"><span class="hs-identifier hs-var">printErrJExit</span></a></span><span> </span><span class="annot"><span class="annottext">ExitCode
</span><a href="Hasura.App.html#EventSubSystemError"><span class="hs-identifier hs-var">EventSubSystemError</span></a></span><span>
</span><span id="line-809"></span><span>
</span><span id="line-810"></span><span>    </span><span class="annot"><a href="#local-6989586621688185091"><span class="hs-identifier hs-type">getProcessingScheduledEventsCount</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Eventing.Common.html#LockedEventsCtx"><span class="hs-identifier hs-type">LockedEventsCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-811"></span><span>    </span><span id="local-6989586621688185091"><span class="annot"><span class="annottext">getProcessingScheduledEventsCount :: LockedEventsCtx -&gt; IO Int
</span><a href="#local-6989586621688185091"><span class="hs-identifier hs-var hs-var">getProcessingScheduledEventsCount</span></a></span></span><span> </span><span class="annot"><a href="Hasura.Eventing.Common.html#LockedEventsCtx"><span class="hs-identifier hs-type">LockedEventsCtx</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688185087"><span id="local-6989586621688185088"><span id="local-6989586621688185089"><span id="local-6989586621688185090"><span class="annot"><span class="annottext">TVar (Set CronEventId)
TVar (HashMap SourceName (Set CronEventId))
leActionEvents :: LockedEventsCtx -&gt; TVar (Set CronEventId)
leEvents :: LockedEventsCtx -&gt; TVar (HashMap SourceName (Set CronEventId))
leOneOffEvents :: LockedEventsCtx -&gt; TVar (Set CronEventId)
leCronEvents :: LockedEventsCtx -&gt; TVar (Set CronEventId)
leActionEvents :: TVar (Set CronEventId)
leEvents :: TVar (HashMap SourceName (Set CronEventId))
leOneOffEvents :: TVar (Set CronEventId)
leCronEvents :: TVar (Set CronEventId)
</span><a href="Hasura.Eventing.Common.html#leActionEvents"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-812"></span><span>      </span><span id="local-6989586621688185082"><span class="annot"><span class="annottext">Set CronEventId
</span><a href="#local-6989586621688185082"><span class="hs-identifier hs-var">processingCronEvents</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar (Set CronEventId) -&gt; IO (Set CronEventId)
forall a. TVar a -&gt; IO a
</span><span class="hs-identifier hs-var">readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">TVar (Set CronEventId)
</span><a href="#local-6989586621688185090"><span class="hs-identifier hs-var">leCronEvents</span></a></span><span>
</span><span id="line-813"></span><span>      </span><span id="local-6989586621688185081"><span class="annot"><span class="annottext">Set CronEventId
</span><a href="#local-6989586621688185081"><span class="hs-identifier hs-var">processingOneOffEvents</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar (Set CronEventId) -&gt; IO (Set CronEventId)
forall a. TVar a -&gt; IO a
</span><span class="hs-identifier hs-var">readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">TVar (Set CronEventId)
</span><a href="#local-6989586621688185089"><span class="hs-identifier hs-var">leOneOffEvents</span></a></span><span>
</span><span id="line-814"></span><span>      </span><span class="annot"><span class="annottext">Int -&gt; IO Int
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; IO Int) -&gt; Int -&gt; IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Set CronEventId -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">Set CronEventId
</span><a href="#local-6989586621688185081"><span class="hs-identifier hs-var">processingOneOffEvents</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Set CronEventId -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">Set CronEventId
</span><a href="#local-6989586621688185082"><span class="hs-identifier hs-var">processingCronEvents</span></a></span><span>
</span><span id="line-815"></span><span>
</span><span id="line-816"></span><span>    </span><span class="annot"><a href="#local-6989586621688185078"><span class="hs-identifier hs-type">shutdownEventTriggerEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-817"></span><span>      </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.Types.Source.html#BackendSourceInfo"><span class="hs-identifier hs-type">BackendSourceInfo</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-818"></span><span>      </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-819"></span><span>      </span><span class="annot"><a href="Hasura.Eventing.Common.html#LockedEventsCtx"><span class="hs-identifier hs-type">LockedEventsCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-820"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-821"></span><span>    </span><span id="local-6989586621688185078"><span class="annot"><span class="annottext">shutdownEventTriggerEvents :: [BackendSourceInfo] -&gt; Logger Hasura -&gt; LockedEventsCtx -&gt; IO ()
</span><a href="#local-6989586621688185078"><span class="hs-identifier hs-var hs-var">shutdownEventTriggerEvents</span></a></span></span><span> </span><span id="local-6989586621688185077"><span class="annot"><span class="annottext">[BackendSourceInfo]
</span><a href="#local-6989586621688185077"><span class="hs-identifier hs-var">sources</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span id="local-6989586621688185076"><span class="annot"><span class="annottext">forall a (m :: * -&gt; *).
(ToEngineLog a Hasura, MonadIO m) =&gt;
a -&gt; m ()
</span><a href="#local-6989586621688185076"><span class="hs-identifier hs-var">logger</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Hasura.Eventing.Common.html#LockedEventsCtx"><span class="hs-identifier hs-type">LockedEventsCtx</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688185072"><span id="local-6989586621688185073"><span id="local-6989586621688185074"><span id="local-6989586621688185075"><span class="annot"><span class="annottext">TVar (Set CronEventId)
TVar (HashMap SourceName (Set CronEventId))
leActionEvents :: TVar (Set CronEventId)
leEvents :: TVar (HashMap SourceName (Set CronEventId))
leOneOffEvents :: TVar (Set CronEventId)
leCronEvents :: TVar (Set CronEventId)
leActionEvents :: LockedEventsCtx -&gt; TVar (Set CronEventId)
leEvents :: LockedEventsCtx -&gt; TVar (HashMap SourceName (Set CronEventId))
leOneOffEvents :: LockedEventsCtx -&gt; TVar (Set CronEventId)
leCronEvents :: LockedEventsCtx -&gt; TVar (Set CronEventId)
</span><a href="#local-6989586621688185072"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-822"></span><span>      </span><span class="hs-comment">-- TODO: is this correct?</span><span>
</span><span id="line-823"></span><span>      </span><span class="hs-comment">-- event triggers should be tied to the life cycle of a source</span><span>
</span><span id="line-824"></span><span>      </span><span id="local-6989586621688185071"><span class="annot"><span class="annottext">HashMap SourceName (Set CronEventId)
</span><a href="#local-6989586621688185071"><span class="hs-identifier hs-var">lockedEvents</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set CronEventId))
-&gt; IO (HashMap SourceName (Set CronEventId))
forall a. TVar a -&gt; IO a
</span><span class="hs-identifier hs-var">readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set CronEventId))
</span><a href="#local-6989586621688185073"><span class="hs-identifier hs-var">leEvents</span></a></span><span>
</span><span id="line-825"></span><span>      </span><span class="annot"><span class="annottext">[BackendSourceInfo] -&gt; (BackendSourceInfo -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[BackendSourceInfo]
</span><a href="#local-6989586621688185077"><span class="hs-identifier hs-var">sources</span></a></span><span> </span><span class="annot"><span class="annottext">((BackendSourceInfo -&gt; IO ()) -&gt; IO ())
-&gt; (BackendSourceInfo -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688185069"><span class="annot"><span class="annottext">BackendSourceInfo
</span><a href="#local-6989586621688185069"><span class="hs-identifier hs-var">backendSourceInfo</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-826"></span><span>        </span><span class="annot"><span class="annottext">BackendSourceInfo
-&gt; (forall (b :: BackendType).
    BackendEventTrigger b =&gt;
    SourceInfo b -&gt; IO ())
-&gt; IO ()
forall (c :: BackendType -&gt; Constraint) (i :: BackendType -&gt; *) r.
AllBackendsSatisfy c =&gt;
AnyBackend i -&gt; (forall (b :: BackendType). c b =&gt; i b -&gt; r) -&gt; r
</span><a href="Hasura.SQL.AnyBackend.html#dispatchAnyBackend"><span class="hs-identifier hs-var">AB.dispatchAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.RQL.Types.Eventing.Backend.html#BackendEventTrigger"><span class="hs-identifier hs-type">BackendEventTrigger</span></a></span><span> </span><span class="annot"><span class="annottext">BackendSourceInfo
</span><a href="#local-6989586621688185069"><span class="hs-identifier hs-var">backendSourceInfo</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621688185067"><span class="annot"><a href="Hasura.RQL.Types.Source.html#SourceInfo"><span class="hs-identifier hs-type">SourceInfo</span></a></span><span> </span><span id="local-6989586621688185065"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688185065"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span> </span><span class="annot"><span class="annottext">TableCache b
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">FunctionCache b
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688185064"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688185064"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe QueryTagsConfig
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SourceCustomization
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#SourceInfo"><span class="hs-identifier hs-type">SourceInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185067"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-827"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688185063"><span class="annot"><span class="annottext">sourceNameString :: String
</span><a href="#local-6989586621688185063"><span class="hs-identifier hs-var hs-var">sourceNameString</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; String) -&gt; Text -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; Text
</span><a href="Hasura.RQL.Types.Common.html#sourceNameToText"><span class="hs-identifier hs-var">sourceNameToText</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688185065"><span class="hs-identifier hs-var">sourceName</span></a></span><span>
</span><span id="line-828"></span><span>          </span><span class="annot"><span class="annottext">StartupLog -&gt; IO ()
forall a (m :: * -&gt; *).
(ToEngineLog a Hasura, MonadIO m) =&gt;
a -&gt; m ()
</span><a href="#local-6989586621688185076"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(StartupLog -&gt; IO ()) -&gt; StartupLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogLevel -&gt; Text -&gt; String -&gt; StartupLog
</span><a href="Hasura.Server.Init.html#mkGenericStrLog"><span class="hs-identifier hs-var">mkGenericStrLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;event_triggers&quot;</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; StartupLog) -&gt; String -&gt; StartupLog
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;unlocking events of source: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688185063"><span class="hs-identifier hs-var">sourceNameString</span></a></span><span>
</span><span id="line-829"></span><span>          </span><span class="annot"><span class="annottext">Maybe (Set CronEventId) -&gt; (Set CronEventId -&gt; IO ()) -&gt; IO ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="Hasura.Prelude.html#onJust"><span class="hs-identifier hs-var">onJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceName
-&gt; HashMap SourceName (Set CronEventId) -&gt; Maybe (Set CronEventId)
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">HM.lookup</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688185065"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap SourceName (Set CronEventId)
</span><a href="#local-6989586621688185071"><span class="hs-identifier hs-var">lockedEvents</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Set CronEventId -&gt; IO ()) -&gt; IO ())
-&gt; (Set CronEventId -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688185059"><span class="annot"><span class="annottext">Set CronEventId
</span><a href="#local-6989586621688185059"><span class="hs-identifier hs-var">sourceLockedEvents</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-830"></span><span>            </span><span class="annot"><span class="annottext">SourceConfig b -&gt; Set CronEventId -&gt; IO (Either QErr Int)
forall (b :: BackendType) (m :: * -&gt; *).
(BackendEventTrigger b, MonadIO m) =&gt;
SourceConfig b -&gt; Set CronEventId -&gt; m (Either QErr Int)
</span><a href="Hasura.RQL.Types.Eventing.Backend.html#unlockEventsInSource"><span class="hs-identifier hs-var">unlockEventsInSource</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688185067"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688185064"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Set CronEventId
</span><a href="#local-6989586621688185059"><span class="hs-identifier hs-var">sourceLockedEvents</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr Int) -&gt; (Either QErr Int -&gt; IO ()) -&gt; IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-831"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621688185057"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688185057"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-832"></span><span>                </span><span class="annot"><span class="annottext">StartupLog -&gt; IO ()
forall a (m :: * -&gt; *).
(ToEngineLog a Hasura, MonadIO m) =&gt;
a -&gt; m ()
</span><a href="#local-6989586621688185076"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(StartupLog -&gt; IO ()) -&gt; StartupLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-833"></span><span>                  </span><span class="annot"><span class="annottext">LogLevel -&gt; Text -&gt; String -&gt; StartupLog
</span><a href="Hasura.Server.Init.html#mkGenericStrLog"><span class="hs-identifier hs-var">mkGenericStrLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelWarn"><span class="hs-identifier hs-var">LevelWarn</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;event_trigger&quot;</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; StartupLog) -&gt; String -&gt; StartupLog
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-834"></span><span>                    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Error while unlocking event trigger events of source: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688185063"><span class="hs-identifier hs-var">sourceNameString</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; error:&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688185057"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-835"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621688185056"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688185056"><span class="hs-identifier hs-var">count</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-836"></span><span>                </span><span class="annot"><span class="annottext">StartupLog -&gt; IO ()
forall a (m :: * -&gt; *).
(ToEngineLog a Hasura, MonadIO m) =&gt;
a -&gt; m ()
</span><a href="#local-6989586621688185076"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(StartupLog -&gt; IO ()) -&gt; StartupLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-837"></span><span>                  </span><span class="annot"><span class="annottext">LogLevel -&gt; Text -&gt; String -&gt; StartupLog
</span><a href="Hasura.Server.Init.html#mkGenericStrLog"><span class="hs-identifier hs-var">mkGenericStrLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;event_trigger&quot;</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; StartupLog) -&gt; String -&gt; StartupLog
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-838"></span><span>                    </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688185056"><span class="hs-identifier hs-var">count</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; events of source &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688185063"><span class="hs-identifier hs-var">sourceNameString</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; were successfully unlocked&quot;</span></span><span>
</span><span id="line-839"></span><span>
</span><span id="line-840"></span><span>    </span><span class="annot"><a href="#local-6989586621688185055"><span class="hs-identifier hs-type">shutdownAsyncActions</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-841"></span><span>      </span><span class="annot"><a href="Hasura.Eventing.Common.html#LockedEventsCtx"><span class="hs-identifier hs-type">LockedEventsCtx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-842"></span><span>      </span><span class="annot"><a href="Hasura.Metadata.Class.html#MetadataStorageT"><span class="hs-identifier hs-type">MetadataStorageT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688186018"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-843"></span><span>    </span><span id="local-6989586621688185055"><span class="annot"><span class="annottext">shutdownAsyncActions :: LockedEventsCtx -&gt; MetadataStorageT m ()
</span><a href="#local-6989586621688185055"><span class="hs-identifier hs-var hs-var">shutdownAsyncActions</span></a></span></span><span> </span><span id="local-6989586621688185054"><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688185054"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-844"></span><span>      </span><span id="local-6989586621688185053"><span class="annot"><span class="annottext">Set CronEventId
</span><a href="#local-6989586621688185053"><span class="hs-identifier hs-var">lockedActionEvents</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Set CronEventId) -&gt; MetadataStorageT m (Set CronEventId)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Set CronEventId) -&gt; MetadataStorageT m (Set CronEventId))
-&gt; IO (Set CronEventId) -&gt; MetadataStorageT m (Set CronEventId)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TVar (Set CronEventId) -&gt; IO (Set CronEventId)
forall a. TVar a -&gt; IO a
</span><span class="hs-identifier hs-var">readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">(TVar (Set CronEventId) -&gt; IO (Set CronEventId))
-&gt; TVar (Set CronEventId) -&gt; IO (Set CronEventId)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LockedEventsCtx -&gt; TVar (Set CronEventId)
</span><a href="Hasura.Eventing.Common.html#leActionEvents"><span class="hs-identifier hs-var hs-var">leActionEvents</span></a></span><span> </span><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688185054"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span><span>
</span><span id="line-845"></span><span>      </span><span class="annot"><span class="annottext">LockedActionIdArray -&gt; MetadataStorageT m ()
forall (m :: * -&gt; *).
MonadMetadataStorage m =&gt;
LockedActionIdArray -&gt; m ()
</span><a href="Hasura.Metadata.Class.html#setProcessingActionLogsToPending"><span class="hs-identifier hs-var">setProcessingActionLogsToPending</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CronEventId] -&gt; LockedActionIdArray
</span><a href="Hasura.RQL.Types.Action.html#LockedActionIdArray"><span class="hs-identifier hs-var">LockedActionIdArray</span></a></span><span> </span><span class="annot"><span class="annottext">([CronEventId] -&gt; LockedActionIdArray)
-&gt; [CronEventId] -&gt; LockedActionIdArray
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Set CronEventId -&gt; [CronEventId]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">Set CronEventId
</span><a href="#local-6989586621688185053"><span class="hs-identifier hs-var">lockedActionEvents</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-846"></span><span>
</span><span id="line-847"></span><span>    </span><span class="hs-comment">-- This function is a helper function to do couple of things:</span><span>
</span><span id="line-848"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-849"></span><span>    </span><span class="hs-comment">-- 1. When the value of the `graceful-shutdown-timeout` &gt; 0, we poll</span><span>
</span><span id="line-850"></span><span>    </span><span class="hs-comment">--    the in-flight events queue we maintain using the `processingEventsCountAction`</span><span>
</span><span id="line-851"></span><span>    </span><span class="hs-comment">--    number of in-flight processing events, in case of actions it is the</span><span>
</span><span id="line-852"></span><span>    </span><span class="hs-comment">--    actions which are in 'processing' state and in scheduled events</span><span>
</span><span id="line-853"></span><span>    </span><span class="hs-comment">--    it is the events which are in 'locked' state. The in-flight events queue is polled</span><span>
</span><span id="line-854"></span><span>    </span><span class="hs-comment">--    every 5 seconds until either the graceful shutdown time is exhausted</span><span>
</span><span id="line-855"></span><span>    </span><span class="hs-comment">--    or the number of in-flight processing events is 0.</span><span>
</span><span id="line-856"></span><span>    </span><span class="hs-comment">-- 2. After step 1, we unlock all the events which were attempted to process by the current</span><span>
</span><span id="line-857"></span><span>    </span><span class="hs-comment">--    graphql-engine instance that are still in the processing</span><span>
</span><span id="line-858"></span><span>    </span><span class="hs-comment">--    state. In actions, it means to set the status of such actions to 'pending'</span><span>
</span><span id="line-859"></span><span>    </span><span class="hs-comment">--    and in scheduled events, the status will be set to 'unlocked'.</span><span>
</span><span id="line-860"></span><span>    </span><span class="annot"><a href="#local-6989586621688185049"><span class="hs-identifier hs-type">waitForProcessingAction</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-861"></span><span>      </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-862"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-863"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-864"></span><span>      </span><span class="annot"><a href="Hasura.App.html#ShutdownAction"><span class="hs-identifier hs-type">ShutdownAction</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-865"></span><span>      </span><span class="annot"><a href="Data.Time.Clock.Units.html#Seconds"><span class="hs-identifier hs-type">Seconds</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-866"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-867"></span><span>    </span><span id="local-6989586621688185049"><span class="annot"><span class="annottext">waitForProcessingAction :: Logger Hasura
-&gt; String -&gt; IO Int -&gt; ShutdownAction -&gt; Seconds -&gt; IO ()
</span><a href="#local-6989586621688185049"><span class="hs-identifier hs-var hs-var">waitForProcessingAction</span></a></span></span><span> </span><span id="local-6989586621688185048"><span class="annot"><span class="annottext">l :: Logger Hasura
</span><a href="#local-6989586621688185048"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">Logger</span></a></span><span> </span><span id="local-6989586621688185047"><span class="annot"><span class="annottext">forall a (m :: * -&gt; *).
(ToEngineLog a Hasura, MonadIO m) =&gt;
a -&gt; m ()
</span><a href="#local-6989586621688185047"><span class="hs-identifier hs-var">logger</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621688185046"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688185046"><span class="hs-identifier hs-var">actionType</span></a></span></span><span> </span><span id="local-6989586621688185045"><span class="annot"><span class="annottext">IO Int
</span><a href="#local-6989586621688185045"><span class="hs-identifier hs-var">processingEventsCountAction'</span></a></span></span><span> </span><span id="local-6989586621688185044"><span class="annot"><span class="annottext">ShutdownAction
</span><a href="#local-6989586621688185044"><span class="hs-identifier hs-var">shutdownAction</span></a></span></span><span> </span><span id="local-6989586621688185043"><span class="annot"><span class="annottext">Seconds
</span><a href="#local-6989586621688185043"><span class="hs-identifier hs-var">maxTimeout</span></a></span></span><span>
</span><span id="line-868"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Seconds
</span><a href="#local-6989586621688185043"><span class="hs-identifier hs-var">maxTimeout</span></a></span><span> </span><span class="annot"><span class="annottext">Seconds -&gt; Seconds -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Seconds
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-869"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ShutdownAction
</span><a href="#local-6989586621688185044"><span class="hs-identifier hs-var">shutdownAction</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-870"></span><span>          </span><span class="annot"><a href="Hasura.App.html#EventTriggerShutdownAction"><span class="hs-identifier hs-type">EventTriggerShutdownAction</span></a></span><span> </span><span id="local-6989586621688185041"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621688185041"><span class="hs-identifier hs-var">userDBShutdownAction</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621688185041"><span class="hs-identifier hs-var">userDBShutdownAction</span></a></span><span>
</span><span id="line-871"></span><span>          </span><span class="annot"><a href="Hasura.App.html#MetadataDBShutdownAction"><span class="hs-identifier hs-type">MetadataDBShutdownAction</span></a></span><span> </span><span id="local-6989586621688185040"><span class="annot"><span class="annottext">MetadataStorageT IO ()
</span><a href="#local-6989586621688185040"><span class="hs-identifier hs-var">metadataDBShutdownAction</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-872"></span><span>            </span><span class="annot"><span class="annottext">MetadataStorageT IO () -&gt; IO (Either QErr ())
forall (m :: * -&gt; *) a. MetadataStorageT m a -&gt; m (Either QErr a)
</span><a href="Hasura.Metadata.Class.html#runMetadataStorageT"><span class="hs-identifier hs-var">runMetadataStorageT</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataStorageT IO ()
</span><a href="#local-6989586621688185040"><span class="hs-identifier hs-var">metadataDBShutdownAction</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr ()) -&gt; (Either QErr () -&gt; IO ()) -&gt; IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-873"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621688185039"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688185039"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-874"></span><span>                </span><span class="annot"><span class="annottext">StartupLog -&gt; IO ()
forall a (m :: * -&gt; *).
(ToEngineLog a Hasura, MonadIO m) =&gt;
a -&gt; m ()
</span><a href="#local-6989586621688185047"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(StartupLog -&gt; IO ()) -&gt; StartupLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-875"></span><span>                  </span><span class="annot"><span class="annottext">LogLevel -&gt; Text -&gt; String -&gt; StartupLog
</span><a href="Hasura.Server.Init.html#mkGenericStrLog"><span class="hs-identifier hs-var">mkGenericStrLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelWarn"><span class="hs-identifier hs-var">LevelWarn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688185046"><span class="hs-identifier hs-var">actionType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(String -&gt; StartupLog) -&gt; String -&gt; StartupLog
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-876"></span><span>                    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Error while unlocking the processing  &quot;</span></span><span>
</span><span id="line-877"></span><span>                      </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">ShowS
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688185046"><span class="hs-identifier hs-var">actionType</span></a></span><span>
</span><span id="line-878"></span><span>                      </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; err - &quot;</span></span><span>
</span><span id="line-879"></span><span>                      </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688185039"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-880"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-881"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-882"></span><span>        </span><span id="local-6989586621688185038"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688185038"><span class="hs-identifier hs-var">processingEventsCount</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Int
</span><a href="#local-6989586621688185045"><span class="hs-identifier hs-var">processingEventsCountAction'</span></a></span><span>
</span><span id="line-883"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688185038"><span class="hs-identifier hs-var">processingEventsCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-884"></span><span>          </span><span class="hs-keyword">then</span><span>
</span><span id="line-885"></span><span>            </span><span class="annot"><span class="annottext">StartupLog -&gt; IO ()
forall a (m :: * -&gt; *).
(ToEngineLog a Hasura, MonadIO m) =&gt;
a -&gt; m ()
</span><a href="#local-6989586621688185047"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(StartupLog -&gt; IO ()) -&gt; StartupLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-886"></span><span>              </span><span class="annot"><span class="annottext">LogLevel -&gt; Text -&gt; String -&gt; StartupLog
</span><a href="Hasura.Server.Init.html#mkGenericStrLog"><span class="hs-identifier hs-var">mkGenericStrLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688185046"><span class="hs-identifier hs-var">actionType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(String -&gt; StartupLog) -&gt; String -&gt; StartupLog
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-887"></span><span>                </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;All in-flight events have finished processing&quot;</span></span><span>
</span><span id="line-888"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688185038"><span class="hs-identifier hs-var">processingEventsCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-889"></span><span>            </span><span class="annot"><span class="annottext">DiffTime -&gt; IO ()
</span><a href="Control.Concurrent.Extended.html#sleep"><span class="hs-identifier hs-var">C.sleep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">5</span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- sleep for 5 seconds and then repeat</span><span>
</span><span id="line-890"></span><span>            </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; String -&gt; IO Int -&gt; ShutdownAction -&gt; Seconds -&gt; IO ()
</span><a href="#local-6989586621688185049"><span class="hs-identifier hs-var">waitForProcessingAction</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185048"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688185046"><span class="hs-identifier hs-var">actionType</span></a></span><span> </span><span class="annot"><span class="annottext">IO Int
</span><a href="#local-6989586621688185045"><span class="hs-identifier hs-var">processingEventsCountAction'</span></a></span><span> </span><span class="annot"><span class="annottext">ShutdownAction
</span><a href="#local-6989586621688185044"><span class="hs-identifier hs-var">shutdownAction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Seconds
</span><a href="#local-6989586621688185043"><span class="hs-identifier hs-var">maxTimeout</span></a></span><span> </span><span class="annot"><span class="annottext">Seconds -&gt; Seconds -&gt; Seconds
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffTime -&gt; Seconds
</span><a href="Data.Time.Clock.Units.html#Seconds"><span class="hs-identifier hs-var">Seconds</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">5</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-891"></span><span>
</span><span id="line-892"></span><span>    </span><span id="local-6989586621688185120"><span class="annot"><span class="annottext">startEventTriggerPollerThread :: Logger Hasura
-&gt; LogBehavior
-&gt; LockedEventsCtx
-&gt; SchemaCacheRef
-&gt; ManagedT m ()
</span><a href="#local-6989586621688185120"><span class="hs-identifier hs-var hs-var">startEventTriggerPollerThread</span></a></span></span><span> </span><span id="local-6989586621688185034"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185034"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621688185033"><span class="annot"><span class="annottext">LogBehavior
</span><a href="#local-6989586621688185033"><span class="hs-identifier hs-var">eventLogBehavior</span></a></span></span><span> </span><span id="local-6989586621688185032"><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688185032"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span></span><span> </span><span id="local-6989586621688185031"><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621688185031"><span class="hs-identifier hs-var">cacheRef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-893"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688185030"><span class="annot"><span class="annottext">maxEvThrds :: Int
</span><a href="#local-6989586621688185030"><span class="hs-identifier hs-var hs-var">maxEvThrds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int -&gt; Int
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Hasura.Eventing.EventTrigger.html#defaultMaxEventThreads"><span class="hs-identifier hs-var">defaultMaxEventThreads</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621688185187"><span class="hs-identifier hs-var">soEventsHttpPoolSize</span></a></span><span>
</span><span id="line-894"></span><span>          </span><span id="local-6989586621688185028"><span class="annot"><span class="annottext">fetchI :: DiffTime
</span><a href="#local-6989586621688185028"><span class="hs-identifier hs-var hs-var">fetchI</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Milliseconds -&gt; DiffTime
</span><a href="Data.Time.Clock.Units.html#milliseconds"><span class="hs-identifier hs-var hs-var">milliseconds</span></a></span><span> </span><span class="annot"><span class="annottext">(Milliseconds -&gt; DiffTime) -&gt; Milliseconds -&gt; DiffTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Milliseconds -&gt; Maybe Milliseconds -&gt; Milliseconds
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffTime -&gt; Milliseconds
</span><a href="Data.Time.Clock.Units.html#Milliseconds"><span class="hs-identifier hs-var">Milliseconds</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="Hasura.Eventing.EventTrigger.html#defaultFetchInterval"><span class="hs-identifier hs-var">defaultFetchInterval</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Milliseconds
</span><a href="#local-6989586621688185186"><span class="hs-identifier hs-var">soEventsFetchInterval</span></a></span><span>
</span><span id="line-895"></span><span>          </span><span id="local-6989586621688185024"><span class="annot"><span class="annottext">allSources :: [BackendSourceInfo]
</span><a href="#local-6989586621688185024"><span class="hs-identifier hs-var hs-var">allSources</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceCache -&gt; [BackendSourceInfo]
forall k v. HashMap k v -&gt; [v]
</span><span class="hs-identifier hs-var">HM.elems</span></span><span> </span><span class="annot"><span class="annottext">(SourceCache -&gt; [BackendSourceInfo])
-&gt; SourceCache -&gt; [BackendSourceInfo]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; SourceCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#scSources"><span class="hs-identifier hs-var hs-var">scSources</span></a></span><span> </span><span class="annot"><span class="annottext">(SchemaCache -&gt; SourceCache) -&gt; SchemaCache -&gt; SourceCache
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RebuildableSchemaCache -&gt; SchemaCache
</span><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#lastBuiltSchemaCache"><span class="hs-identifier hs-var hs-var">lastBuiltSchemaCache</span></a></span><span> </span><span class="annot"><span class="annottext">RebuildableSchemaCache
</span><a href="#local-6989586621688185164"><span class="hs-identifier hs-var">_scSchemaCache</span></a></span><span>
</span><span id="line-896"></span><span>
</span><span id="line-897"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; ManagedT m () -&gt; ManagedT m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonNegativeInt -&gt; Int
</span><a href="Hasura.RQL.Types.Common.html#getNonNegativeInt"><span class="hs-identifier hs-var hs-var">getNonNegativeInt</span></a></span><span> </span><span class="annot"><span class="annottext">NonNegativeInt
</span><a href="#local-6989586621688185176"><span class="hs-identifier hs-var">soEventsFetchBatchSize</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Maybe Milliseconds
</span><a href="#local-6989586621688185186"><span class="hs-identifier hs-var">soEventsFetchInterval</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Milliseconds -&gt; Maybe Milliseconds -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Milliseconds -&gt; Maybe Milliseconds
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Milliseconds
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ManagedT m () -&gt; ManagedT m ()) -&gt; ManagedT m () -&gt; ManagedT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-898"></span><span>        </span><span class="hs-comment">-- Don't start the events poller thread when fetchBatchSize or fetchInterval is 0</span><span>
</span><span id="line-899"></span><span>        </span><span class="hs-comment">-- prepare event triggers data</span><span>
</span><span id="line-900"></span><span>        </span><span id="local-6989586621688185020"><span class="annot"><span class="annottext">EventEngineCtx
</span><a href="#local-6989586621688185020"><span class="hs-identifier hs-var">eventEngineCtx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO EventEngineCtx -&gt; ManagedT m EventEngineCtx
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO EventEngineCtx -&gt; ManagedT m EventEngineCtx)
-&gt; IO EventEngineCtx -&gt; ManagedT m EventEngineCtx
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">STM EventEngineCtx -&gt; IO EventEngineCtx
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM EventEngineCtx -&gt; IO EventEngineCtx)
-&gt; STM EventEngineCtx -&gt; IO EventEngineCtx
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; DiffTime -&gt; NonNegativeInt -&gt; STM EventEngineCtx
</span><a href="Hasura.Eventing.EventTrigger.html#initEventEngineCtx"><span class="hs-identifier hs-var">initEventEngineCtx</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688185030"><span class="hs-identifier hs-var">maxEvThrds</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621688185028"><span class="hs-identifier hs-var">fetchI</span></a></span><span> </span><span class="annot"><span class="annottext">NonNegativeInt
</span><a href="#local-6989586621688185176"><span class="hs-identifier hs-var">soEventsFetchBatchSize</span></a></span><span>
</span><span id="line-901"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688185018"><span class="annot"><span class="annottext">eventsGracefulShutdownAction :: IO ()
</span><a href="#local-6989586621688185018"><span class="hs-identifier hs-var hs-var">eventsGracefulShutdownAction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-902"></span><span>              </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; String -&gt; IO Int -&gt; ShutdownAction -&gt; Seconds -&gt; IO ()
</span><a href="#local-6989586621688185049"><span class="hs-identifier hs-var">waitForProcessingAction</span></a></span><span>
</span><span id="line-903"></span><span>                </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185034"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-904"></span><span>                </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;event_triggers&quot;</span></span><span>
</span><span id="line-905"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap SourceName (Set CronEventId) -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">(HashMap SourceName (Set CronEventId) -&gt; Int)
-&gt; IO (HashMap SourceName (Set CronEventId)) -&gt; IO Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TVar (HashMap SourceName (Set CronEventId))
-&gt; IO (HashMap SourceName (Set CronEventId))
forall a. TVar a -&gt; IO a
</span><span class="hs-identifier hs-var">readTVarIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LockedEventsCtx -&gt; TVar (HashMap SourceName (Set CronEventId))
</span><a href="Hasura.Eventing.Common.html#leEvents"><span class="hs-identifier hs-var hs-var">leEvents</span></a></span><span> </span><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688185032"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-906"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO () -&gt; ShutdownAction
</span><a href="Hasura.App.html#EventTriggerShutdownAction"><span class="hs-identifier hs-var">EventTriggerShutdownAction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[BackendSourceInfo] -&gt; Logger Hasura -&gt; LockedEventsCtx -&gt; IO ()
</span><a href="#local-6989586621688185078"><span class="hs-identifier hs-var">shutdownEventTriggerEvents</span></a></span><span> </span><span class="annot"><span class="annottext">[BackendSourceInfo]
</span><a href="#local-6989586621688185024"><span class="hs-identifier hs-var">allSources</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185034"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688185032"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-907"></span><span>                </span><span class="annot"><span class="annottext">Seconds
</span><a href="#local-6989586621688185174"><span class="hs-identifier hs-var">soGracefulShutdownTimeout</span></a></span><span>
</span><span id="line-908"></span><span>        </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185034"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(StartupLog -&gt; ManagedT m ()) -&gt; StartupLog -&gt; ManagedT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogLevel -&gt; Text -&gt; String -&gt; StartupLog
</span><a href="Hasura.Server.Init.html#mkGenericStrLog"><span class="hs-identifier hs-var">mkGenericStrLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">LevelInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;event_triggers&quot;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;starting workers&quot;</span></span><span>
</span><span id="line-909"></span><span>        </span><span class="annot"><span class="annottext">ManagedT m Thread -&gt; ManagedT m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(ManagedT m Thread -&gt; ManagedT m ())
-&gt; ManagedT m Thread -&gt; ManagedT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-910"></span><span>          </span><span class="annot"><span class="annottext">String
-&gt; Logger Hasura
-&gt; ThreadShutdown m
-&gt; m (Forever m)
-&gt; ManagedT m Thread
forall (m :: * -&gt; *).
ForkableMonadIO m =&gt;
String
-&gt; Logger Hasura
-&gt; ThreadShutdown m
-&gt; m (Forever m)
-&gt; ManagedT m Thread
</span><a href="Control.Concurrent.Extended.html#forkManagedTWithGracefulShutdown"><span class="hs-identifier hs-var">C.forkManagedTWithGracefulShutdown</span></a></span><span>
</span><span id="line-911"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;processEventQueue&quot;</span></span><span>
</span><span id="line-912"></span><span>            </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185034"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-913"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m () -&gt; ThreadShutdown m
forall (m :: * -&gt; *). m () -&gt; ThreadShutdown m
</span><a href="Control.Concurrent.Extended.html#ThreadShutdown"><span class="hs-identifier hs-var">C.ThreadShutdown</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621688185018"><span class="hs-identifier hs-var">eventsGracefulShutdownAction</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-914"></span><span>            </span><span class="annot"><span class="annottext">(m (Forever m) -&gt; ManagedT m Thread)
-&gt; m (Forever m) -&gt; ManagedT m Thread
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; LogBehavior
-&gt; Manager
-&gt; IO SchemaCache
-&gt; EventEngineCtx
-&gt; LockedEventsCtx
-&gt; ServerMetrics
-&gt; MaintenanceMode
-&gt; m (Forever m)
forall (m :: * -&gt; *).
(MonadIO m, HasReporter m, MonadBaseControl IO m, Forall (Pure m),
 MonadMask m) =&gt;
Logger Hasura
-&gt; LogBehavior
-&gt; Manager
-&gt; IO SchemaCache
-&gt; EventEngineCtx
-&gt; LockedEventsCtx
-&gt; ServerMetrics
-&gt; MaintenanceMode
-&gt; m (Forever m)
</span><a href="Hasura.Eventing.EventTrigger.html#processEventQueue"><span class="hs-identifier hs-var">processEventQueue</span></a></span><span>
</span><span id="line-915"></span><span>              </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185034"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-916"></span><span>              </span><span class="annot"><span class="annottext">LogBehavior
</span><a href="#local-6989586621688185033"><span class="hs-identifier hs-var">eventLogBehavior</span></a></span><span>
</span><span id="line-917"></span><span>              </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621688185170"><span class="hs-identifier hs-var">_scHttpManager</span></a></span><span>
</span><span id="line-918"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SchemaCacheRef -&gt; IO SchemaCache
forall (m :: * -&gt; *). MonadIO m =&gt; SchemaCacheRef -&gt; m SchemaCache
</span><a href="Hasura.Server.App.html#getSCFromRef"><span class="hs-identifier hs-var">getSCFromRef</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621688185031"><span class="hs-identifier hs-var">cacheRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-919"></span><span>              </span><span class="annot"><span class="annottext">EventEngineCtx
</span><a href="#local-6989586621688185020"><span class="hs-identifier hs-var">eventEngineCtx</span></a></span><span>
</span><span id="line-920"></span><span>              </span><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688185032"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span><span>
</span><span id="line-921"></span><span>              </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688185159"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span>
</span><span id="line-922"></span><span>              </span><span class="annot"><span class="annottext">MaintenanceMode
</span><a href="#local-6989586621688185179"><span class="hs-identifier hs-var">soEnableMaintenanceMode</span></a></span><span>
</span><span id="line-923"></span><span>
</span><span id="line-924"></span><span>    </span><span id="local-6989586621688185119"><span class="annot"><span class="annottext">startAsyncActionsPollerThread :: Logger Hasura
-&gt; LockedEventsCtx
-&gt; SchemaCacheRef
-&gt; AsyncActionSubscriptionState
-&gt; ManagedT m ()
</span><a href="#local-6989586621688185119"><span class="hs-identifier hs-var hs-var">startAsyncActionsPollerThread</span></a></span></span><span> </span><span id="local-6989586621688185014"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185014"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621688185013"><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688185013"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span></span><span> </span><span id="local-6989586621688185012"><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621688185012"><span class="hs-identifier hs-var">cacheRef</span></a></span></span><span> </span><span id="local-6989586621688185011"><span class="annot"><span class="annottext">AsyncActionSubscriptionState
</span><a href="#local-6989586621688185011"><span class="hs-identifier hs-var">actionSubState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-925"></span><span>      </span><span class="hs-comment">-- start a background thread to handle async actions</span><span>
</span><span id="line-926"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">OptionalInterval
</span><a href="#local-6989586621688185185"><span class="hs-identifier hs-var">soAsyncActionsFetchInterval</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-927"></span><span>        </span><span class="annot"><span class="annottext">OptionalInterval
</span><a href="Hasura.Server.Init.Config.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; ManagedT m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Don't start the poller thread</span><span>
</span><span id="line-928"></span><span>        </span><span class="annot"><a href="Hasura.Server.Init.Config.html#Interval"><span class="hs-identifier hs-type">Interval</span></a></span><span> </span><span id="local-6989586621688185010"><span class="annot"><span class="annottext">Milliseconds
</span><a href="#local-6989586621688185010"><span class="hs-identifier hs-var">sleepTime</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-929"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688185009"><span class="annot"><span class="annottext">label :: String
</span><a href="#local-6989586621688185009"><span class="hs-keyword hs-var hs-var">label</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;asyncActionsProcessor&quot;</span></span><span>
</span><span id="line-930"></span><span>              </span><span id="local-6989586621688185008"><span class="annot"><span class="annottext">asyncActionGracefulShutdownAction :: m ()
</span><a href="#local-6989586621688185008"><span class="hs-identifier hs-var hs-var">asyncActionGracefulShutdownAction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-931"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">((forall a. m a -&gt; IO a) -&gt; IO ()) -&gt; m ()
forall (b :: * -&gt; *) (m :: * -&gt; *) c.
MonadStateless b m =&gt;
((forall a. m a -&gt; b a) -&gt; b c) -&gt; m c
</span><a href="Control.Monad.Stateless.html#liftWithStateless"><span class="hs-identifier hs-var">liftWithStateless</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688185006"><span class="annot"><span class="annottext">forall a. m a -&gt; IO a
</span><a href="#local-6989586621688185006"><span class="hs-identifier hs-var">lowerIO</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-932"></span><span>                    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; String -&gt; IO Int -&gt; ShutdownAction -&gt; Seconds -&gt; IO ()
</span><a href="#local-6989586621688185049"><span class="hs-identifier hs-var">waitForProcessingAction</span></a></span><span>
</span><span id="line-933"></span><span>                        </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185014"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-934"></span><span>                        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;async_actions&quot;</span></span><span>
</span><span id="line-935"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set CronEventId -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">(Set CronEventId -&gt; Int) -&gt; IO (Set CronEventId) -&gt; IO Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TVar (Set CronEventId) -&gt; IO (Set CronEventId)
forall a. TVar a -&gt; IO a
</span><span class="hs-identifier hs-var">readTVarIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LockedEventsCtx -&gt; TVar (Set CronEventId)
</span><a href="Hasura.Eventing.Common.html#leActionEvents"><span class="hs-identifier hs-var hs-var">leActionEvents</span></a></span><span> </span><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688185013"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-936"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetadataStorageT IO () -&gt; ShutdownAction
</span><a href="Hasura.App.html#MetadataDBShutdownAction"><span class="hs-identifier hs-var">MetadataDBShutdownAction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall a. m a -&gt; IO a)
-&gt; MetadataStorageT m () -&gt; MetadataStorageT IO ()
forall k (t :: (* -&gt; *) -&gt; k -&gt; *) (m :: * -&gt; *) (n :: * -&gt; *)
       (b :: k).
(MFunctor t, Monad m) =&gt;
(forall a. m a -&gt; n a) -&gt; t m b -&gt; t n b
</span><span class="hs-identifier hs-var">hoist</span></span><span> </span><span class="annot"><span class="annottext">forall a. m a -&gt; IO a
</span><a href="#local-6989586621688185006"><span class="hs-identifier hs-var">lowerIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LockedEventsCtx -&gt; MetadataStorageT m ()
</span><a href="#local-6989586621688185055"><span class="hs-identifier hs-var">shutdownAsyncActions</span></a></span><span> </span><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688185013"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-937"></span><span>                        </span><span class="annot"><span class="annottext">Seconds
</span><a href="#local-6989586621688185174"><span class="hs-identifier hs-var">soGracefulShutdownTimeout</span></a></span><span>
</span><span id="line-938"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-939"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-940"></span><span>
</span><span id="line-941"></span><span>          </span><span class="annot"><span class="annottext">ManagedT m Thread -&gt; ManagedT m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(ManagedT m Thread -&gt; ManagedT m ())
-&gt; ManagedT m Thread -&gt; ManagedT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-942"></span><span>            </span><span class="annot"><span class="annottext">String
-&gt; Logger Hasura
-&gt; ThreadShutdown m
-&gt; m (Forever m)
-&gt; ManagedT m Thread
forall (m :: * -&gt; *).
ForkableMonadIO m =&gt;
String
-&gt; Logger Hasura
-&gt; ThreadShutdown m
-&gt; m (Forever m)
-&gt; ManagedT m Thread
</span><a href="Control.Concurrent.Extended.html#forkManagedTWithGracefulShutdown"><span class="hs-identifier hs-var">C.forkManagedTWithGracefulShutdown</span></a></span><span>
</span><span id="line-943"></span><span>              </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621688185009"><span class="hs-keyword hs-var">label</span></a></span><span>
</span><span id="line-944"></span><span>              </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185014"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-945"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m () -&gt; ThreadShutdown m
forall (m :: * -&gt; *). m () -&gt; ThreadShutdown m
</span><a href="Control.Concurrent.Extended.html#ThreadShutdown"><span class="hs-identifier hs-var">C.ThreadShutdown</span></a></span><span> </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621688185008"><span class="hs-identifier hs-var">asyncActionGracefulShutdownAction</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-946"></span><span>              </span><span class="annot"><span class="annottext">(m (Forever m) -&gt; ManagedT m Thread)
-&gt; m (Forever m) -&gt; ManagedT m Thread
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Environment
-&gt; Logger Hasura
-&gt; IORef (RebuildableSchemaCache, SchemaCacheVer)
-&gt; TVar (Set CronEventId)
-&gt; Manager
-&gt; Milliseconds
-&gt; Maybe GQLQueryText
-&gt; m (Forever m)
forall (m :: * -&gt; *).
(MonadIO m, MonadBaseControl IO m, Forall (Pure m), HasReporter m,
 MonadMetadataStorage (MetadataStorageT m)) =&gt;
Environment
-&gt; Logger Hasura
-&gt; IORef (RebuildableSchemaCache, SchemaCacheVer)
-&gt; TVar (Set CronEventId)
-&gt; Manager
-&gt; Milliseconds
-&gt; Maybe GQLQueryText
-&gt; m (Forever m)
</span><a href="Hasura.GraphQL.Execute.Action.html#asyncActionsProcessor"><span class="hs-identifier hs-var">asyncActionsProcessor</span></a></span><span>
</span><span id="line-947"></span><span>                </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688185208"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-948"></span><span>                </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185014"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-949"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SchemaCacheRef -&gt; IORef (RebuildableSchemaCache, SchemaCacheVer)
</span><a href="Hasura.Server.App.html#_scrCache"><span class="hs-identifier hs-var hs-var">_scrCache</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621688185012"><span class="hs-identifier hs-var">cacheRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-950"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LockedEventsCtx -&gt; TVar (Set CronEventId)
</span><a href="Hasura.Eventing.Common.html#leActionEvents"><span class="hs-identifier hs-var hs-var">leActionEvents</span></a></span><span> </span><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688185013"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-951"></span><span>                </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621688185170"><span class="hs-identifier hs-var">_scHttpManager</span></a></span><span>
</span><span id="line-952"></span><span>                </span><span class="annot"><span class="annottext">Milliseconds
</span><a href="#local-6989586621688185010"><span class="hs-identifier hs-var">sleepTime</span></a></span><span>
</span><span id="line-953"></span><span>                </span><span class="annot"><span class="annottext">Maybe GQLQueryText
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-954"></span><span>
</span><span id="line-955"></span><span>      </span><span class="hs-comment">-- start a background thread to handle async action live queries</span><span>
</span><span id="line-956"></span><span>      </span><span class="annot"><span class="annottext">ManagedT m Thread -&gt; ManagedT m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(ManagedT m Thread -&gt; ManagedT m ())
-&gt; ManagedT m Thread -&gt; ManagedT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-957"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; Logger Hasura -&gt; m Void -&gt; ManagedT m Thread
forall (m :: * -&gt; *).
ForkableMonadIO m =&gt;
String -&gt; Logger Hasura -&gt; m Void -&gt; ManagedT m Thread
</span><a href="Control.Concurrent.Extended.html#forkManagedT"><span class="hs-identifier hs-var">C.forkManagedT</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;asyncActionSubscriptionsProcessor&quot;</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185014"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(m Void -&gt; ManagedT m Thread) -&gt; m Void -&gt; ManagedT m Thread
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-958"></span><span>          </span><span class="annot"><span class="annottext">AsyncActionSubscriptionState -&gt; m Void
forall (m :: * -&gt; *) void.
(MonadIO m, MonadMetadataStorage (MetadataStorageT m)) =&gt;
AsyncActionSubscriptionState -&gt; m void
</span><a href="Hasura.GraphQL.Execute.Action.Subscription.html#asyncActionSubscriptionsProcessor"><span class="hs-identifier hs-var">asyncActionSubscriptionsProcessor</span></a></span><span> </span><span class="annot"><span class="annottext">AsyncActionSubscriptionState
</span><a href="#local-6989586621688185011"><span class="hs-identifier hs-var">actionSubState</span></a></span><span>
</span><span id="line-959"></span><span>
</span><span id="line-960"></span><span>    </span><span id="local-6989586621688185115"><span class="annot"><span class="annottext">startScheduledEventsPollerThread :: Logger Hasura
-&gt; LogBehavior
-&gt; LockedEventsCtx
-&gt; SchemaCacheRef
-&gt; ManagedT m ()
</span><a href="#local-6989586621688185115"><span class="hs-identifier hs-var hs-var">startScheduledEventsPollerThread</span></a></span></span><span> </span><span id="local-6989586621688185003"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185003"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621688185002"><span class="annot"><span class="annottext">LogBehavior
</span><a href="#local-6989586621688185002"><span class="hs-identifier hs-var">eventLogBehavior</span></a></span></span><span> </span><span id="local-6989586621688185001"><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688185001"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span></span><span> </span><span id="local-6989586621688185000"><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621688185000"><span class="hs-identifier hs-var">cacheRef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-961"></span><span>      </span><span class="hs-comment">-- prepare scheduled triggers</span><span>
</span><span id="line-962"></span><span>      </span><span class="annot"><span class="annottext">m () -&gt; ManagedT m ()
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; ManagedT m ()) -&gt; m () -&gt; ManagedT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura -&gt; m ()
forall (m :: * -&gt; *) impl.
(MonadIO m, ToEngineLog StartupLog impl,
 MonadMetadataStorage (MetadataStorageT m)) =&gt;
Logger impl -&gt; m ()
</span><a href="#local-6989586621688185095"><span class="hs-identifier hs-var">prepareScheduledEvents</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185003"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-963"></span><span>
</span><span id="line-964"></span><span>      </span><span class="hs-comment">-- start a background thread to deliver the scheduled events</span><span>
</span><span id="line-965"></span><span>      </span><span class="hs-comment">-- _scheduledEventsThread &lt;- do</span><span>
</span><span id="line-966"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688184999"><span class="annot"><span class="annottext">scheduledEventsGracefulShutdownAction :: m ()
</span><a href="#local-6989586621688184999"><span class="hs-identifier hs-var hs-var">scheduledEventsGracefulShutdownAction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-967"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">((forall a. m a -&gt; IO a) -&gt; IO ()) -&gt; m ()
forall (b :: * -&gt; *) (m :: * -&gt; *) c.
MonadStateless b m =&gt;
((forall a. m a -&gt; b a) -&gt; b c) -&gt; m c
</span><a href="Control.Monad.Stateless.html#liftWithStateless"><span class="hs-identifier hs-var">liftWithStateless</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688184998"><span class="annot"><span class="annottext">forall a. m a -&gt; IO a
</span><a href="#local-6989586621688184998"><span class="hs-identifier hs-var">lowerIO</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-968"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; String -&gt; IO Int -&gt; ShutdownAction -&gt; Seconds -&gt; IO ()
</span><a href="#local-6989586621688185049"><span class="hs-identifier hs-var">waitForProcessingAction</span></a></span><span>
</span><span id="line-969"></span><span>                    </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185003"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-970"></span><span>                    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;scheduled_events&quot;</span></span><span>
</span><span id="line-971"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LockedEventsCtx -&gt; IO Int
</span><a href="#local-6989586621688185091"><span class="hs-identifier hs-var">getProcessingScheduledEventsCount</span></a></span><span> </span><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688185001"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-972"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MetadataStorageT IO () -&gt; ShutdownAction
</span><a href="Hasura.App.html#MetadataDBShutdownAction"><span class="hs-identifier hs-var">MetadataDBShutdownAction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall a. m a -&gt; IO a)
-&gt; MetadataStorageT m () -&gt; MetadataStorageT IO ()
forall k (t :: (* -&gt; *) -&gt; k -&gt; *) (m :: * -&gt; *) (n :: * -&gt; *)
       (b :: k).
(MFunctor t, Monad m) =&gt;
(forall a. m a -&gt; n a) -&gt; t m b -&gt; t n b
</span><span class="hs-identifier hs-var">hoist</span></span><span> </span><span class="annot"><span class="annottext">forall a. m a -&gt; IO a
</span><a href="#local-6989586621688184998"><span class="hs-identifier hs-var">lowerIO</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataStorageT m ()
forall (m :: * -&gt; *). MonadMetadataStorage m =&gt; m ()
</span><a href="Hasura.Metadata.Class.html#unlockAllLockedScheduledEvents"><span class="hs-identifier hs-var">unlockAllLockedScheduledEvents</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-973"></span><span>                    </span><span class="annot"><span class="annottext">Seconds
</span><a href="#local-6989586621688185174"><span class="hs-identifier hs-var">soGracefulShutdownTimeout</span></a></span><span>
</span><span id="line-974"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-975"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-976"></span><span>
</span><span id="line-977"></span><span>      </span><span class="annot"><span class="annottext">ManagedT m Thread -&gt; ManagedT m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(ManagedT m Thread -&gt; ManagedT m ())
-&gt; ManagedT m Thread -&gt; ManagedT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-978"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; Logger Hasura
-&gt; ThreadShutdown m
-&gt; m (Forever m)
-&gt; ManagedT m Thread
forall (m :: * -&gt; *).
ForkableMonadIO m =&gt;
String
-&gt; Logger Hasura
-&gt; ThreadShutdown m
-&gt; m (Forever m)
-&gt; ManagedT m Thread
</span><a href="Control.Concurrent.Extended.html#forkManagedTWithGracefulShutdown"><span class="hs-identifier hs-var">C.forkManagedTWithGracefulShutdown</span></a></span><span>
</span><span id="line-979"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;processScheduledTriggers&quot;</span></span><span>
</span><span id="line-980"></span><span>          </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185003"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-981"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m () -&gt; ThreadShutdown m
forall (m :: * -&gt; *). m () -&gt; ThreadShutdown m
</span><a href="Control.Concurrent.Extended.html#ThreadShutdown"><span class="hs-identifier hs-var">C.ThreadShutdown</span></a></span><span> </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621688184999"><span class="hs-identifier hs-var">scheduledEventsGracefulShutdownAction</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-982"></span><span>          </span><span class="annot"><span class="annottext">(m (Forever m) -&gt; ManagedT m Thread)
-&gt; m (Forever m) -&gt; ManagedT m Thread
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Environment
-&gt; Logger Hasura
-&gt; LogBehavior
-&gt; Manager
-&gt; IO SchemaCache
-&gt; LockedEventsCtx
-&gt; m (Forever m)
forall (m :: * -&gt; *).
(MonadIO m, HasReporter m,
 MonadMetadataStorage (MetadataStorageT m)) =&gt;
Environment
-&gt; Logger Hasura
-&gt; LogBehavior
-&gt; Manager
-&gt; IO SchemaCache
-&gt; LockedEventsCtx
-&gt; m (Forever m)
</span><a href="Hasura.Eventing.ScheduledTrigger.html#processScheduledTriggers"><span class="hs-identifier hs-var">processScheduledTriggers</span></a></span><span>
</span><span id="line-983"></span><span>            </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688185208"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-984"></span><span>            </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688185003"><span class="hs-identifier hs-var">logger</span></a></span><span>
</span><span id="line-985"></span><span>            </span><span class="annot"><span class="annottext">LogBehavior
</span><a href="#local-6989586621688185002"><span class="hs-identifier hs-var">eventLogBehavior</span></a></span><span>
</span><span id="line-986"></span><span>            </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621688185170"><span class="hs-identifier hs-var">_scHttpManager</span></a></span><span>
</span><span id="line-987"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SchemaCacheRef -&gt; IO SchemaCache
forall (m :: * -&gt; *). MonadIO m =&gt; SchemaCacheRef -&gt; m SchemaCache
</span><a href="Hasura.Server.App.html#getSCFromRef"><span class="hs-identifier hs-var">getSCFromRef</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCacheRef
</span><a href="#local-6989586621688185000"><span class="hs-identifier hs-var">cacheRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-988"></span><span>            </span><span class="annot"><span class="annottext">LockedEventsCtx
</span><a href="#local-6989586621688185001"><span class="hs-identifier hs-var">lockedEventsCtx</span></a></span><span>
</span><span id="line-989"></span><span>
</span><span id="line-990"></span><span id="local-6989586621688184996"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621688184993"><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621688184996"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.Tracing.html#HasReporter"><span class="hs-identifier hs-type">Tracing.HasReporter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#PGMetadataStorageAppT"><span class="hs-identifier hs-type">PGMetadataStorageAppT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688184996"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-991"></span><span>
</span><span id="line-992"></span><span id="local-6989586621688184991"><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621688184991"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.Limits.html#HasResourceLimits"><span class="hs-identifier hs-type">HasResourceLimits</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#PGMetadataStorageAppT"><span class="hs-identifier hs-type">PGMetadataStorageAppT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688184991"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-993"></span><span>  </span><span id="local-6989586621688184986"><span class="annot"><span class="annottext">askHTTPHandlerLimit :: PGMetadataStorageAppT m ResourceLimits
</span><a href="Hasura.Server.Limits.html#askHTTPHandlerLimit"><span class="hs-identifier hs-var hs-var hs-var hs-var">askHTTPHandlerLimit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ResourceLimits -&gt; PGMetadataStorageAppT m ResourceLimits
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ResourceLimits -&gt; PGMetadataStorageAppT m ResourceLimits)
-&gt; ResourceLimits -&gt; PGMetadataStorageAppT m ResourceLimits
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(forall (m :: * -&gt; *) a.
 (MonadBaseControl IO m, MonadError QErr m) =&gt;
 m a -&gt; m a)
-&gt; ResourceLimits
</span><a href="Hasura.Server.Limits.html#ResourceLimits"><span class="hs-identifier hs-var">ResourceLimits</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; a
forall (m :: * -&gt; *) a.
(MonadBaseControl IO m, MonadError QErr m) =&gt;
m a -&gt; m a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-994"></span><span>  </span><span id="local-6989586621688184982"><span class="annot"><span class="annottext">askGraphqlOperationLimit :: PGMetadataStorageAppT m (UserInfo -&gt; ApiLimit -&gt; ResourceLimits)
</span><a href="Hasura.Server.Limits.html#askGraphqlOperationLimit"><span class="hs-identifier hs-var hs-var hs-var hs-var">askGraphqlOperationLimit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(UserInfo -&gt; ApiLimit -&gt; ResourceLimits)
-&gt; PGMetadataStorageAppT m (UserInfo -&gt; ApiLimit -&gt; ResourceLimits)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">((UserInfo -&gt; ApiLimit -&gt; ResourceLimits)
 -&gt; PGMetadataStorageAppT
      m (UserInfo -&gt; ApiLimit -&gt; ResourceLimits))
-&gt; (UserInfo -&gt; ApiLimit -&gt; ResourceLimits)
-&gt; PGMetadataStorageAppT m (UserInfo -&gt; ApiLimit -&gt; ResourceLimits)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">UserInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ApiLimit
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(forall (m :: * -&gt; *) a.
 (MonadBaseControl IO m, MonadError QErr m) =&gt;
 m a -&gt; m a)
-&gt; ResourceLimits
</span><a href="Hasura.Server.Limits.html#ResourceLimits"><span class="hs-identifier hs-var">ResourceLimits</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; a
forall (m :: * -&gt; *) a.
(MonadBaseControl IO m, MonadError QErr m) =&gt;
m a -&gt; m a
</span><span class="hs-identifier hs-var">id</span></span></span><span>
</span><span id="line-995"></span><span>
</span><span id="line-996"></span><span id="local-6989586621688184980"><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688184980"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.Logging.html#HttpLog"><span class="hs-identifier hs-type">HttpLog</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#PGMetadataStorageAppT"><span class="hs-identifier hs-type">PGMetadataStorageAppT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688184980"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-997"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="ExtraHttpLogMetadata"><span class="annot"><a href="Hasura.Server.Logging.html#ExtraHttpLogMetadata"><span class="hs-identifier hs-var">ExtraHttpLogMetadata</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#PGMetadataStorageAppT"><span class="hs-identifier hs-type">PGMetadataStorageAppT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688184980"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-998"></span><span>
</span><span id="line-999"></span><span>  </span><span id="local-6989586621688184973"><span class="annot"><span class="annottext">emptyExtraHttpLogMetadata :: ExtraHttpLogMetadata (PGMetadataStorageAppT m)
</span><a href="Hasura.Server.Logging.html#emptyExtraHttpLogMetadata"><span class="hs-identifier hs-var hs-var hs-var hs-var">emptyExtraHttpLogMetadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1000"></span><span>
</span><span id="line-1001"></span><span>  </span><span id="local-6989586621688184971"><span class="annot"><span class="annottext">buildExtraHttpLogMetadata :: ParameterizedQueryHashList
-&gt; ExtraHttpLogMetadata (PGMetadataStorageAppT m)
</span><a href="Hasura.Server.Logging.html#buildExtraHttpLogMetadata"><span class="hs-identifier hs-var hs-var hs-var hs-var">buildExtraHttpLogMetadata</span></a></span></span><span> </span><span class="annot"><span class="annottext">ParameterizedQueryHashList
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1002"></span><span>
</span><span id="line-1003"></span><span>  </span><span id="local-6989586621688184969"><span class="annot"><span class="annottext">logHttpError :: Logger Hasura
-&gt; HashSet (EngineLogType Hasura)
-&gt; Maybe UserInfo
-&gt; RequestId
-&gt; Request
-&gt; (ByteString, Maybe Value)
-&gt; QErr
-&gt; [Header]
-&gt; PGMetadataStorageAppT m ()
</span><a href="Hasura.Server.Logging.html#logHttpError"><span class="hs-identifier hs-var hs-var hs-var hs-var">logHttpError</span></a></span></span><span> </span><span id="local-6989586621688184967"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688184967"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621688184966"><span class="annot"><span class="annottext">HashSet (EngineLogType Hasura)
</span><a href="#local-6989586621688184966"><span class="hs-identifier hs-var">enabledLogTypes</span></a></span></span><span> </span><span id="local-6989586621688184965"><span class="annot"><span class="annottext">Maybe UserInfo
</span><a href="#local-6989586621688184965"><span class="hs-identifier hs-var">userInfoM</span></a></span></span><span> </span><span id="local-6989586621688184964"><span class="annot"><span class="annottext">RequestId
</span><a href="#local-6989586621688184964"><span class="hs-identifier hs-var">reqId</span></a></span></span><span> </span><span id="local-6989586621688184963"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621688184963"><span class="hs-identifier hs-var">waiReq</span></a></span></span><span> </span><span id="local-6989586621688184962"><span class="annot"><span class="annottext">(ByteString, Maybe Value)
</span><a href="#local-6989586621688184962"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span id="local-6989586621688184961"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688184961"><span class="hs-identifier hs-var">qErr</span></a></span></span><span> </span><span id="local-6989586621688184960"><span class="annot"><span class="annottext">[Header]
</span><a href="#local-6989586621688184960"><span class="hs-identifier hs-var">headers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1004"></span><span>    </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688184967"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(HttpLogLine -&gt; PGMetadataStorageAppT m ())
-&gt; HttpLogLine -&gt; PGMetadataStorageAppT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1005"></span><span>      </span><span class="annot"><span class="annottext">HttpLogContext -&gt; HttpLogLine
</span><a href="Hasura.Server.Logging.html#mkHttpLog"><span class="hs-identifier hs-var">mkHttpLog</span></a></span><span> </span><span class="annot"><span class="annottext">(HttpLogContext -&gt; HttpLogLine) -&gt; HttpLogContext -&gt; HttpLogLine
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1006"></span><span>        </span><span class="annot"><span class="annottext">Maybe UserInfo
-&gt; HashSet (EngineLogType Hasura)
-&gt; RequestId
-&gt; Request
-&gt; (ByteString, Maybe Value)
-&gt; QErr
-&gt; Maybe (DiffTime, DiffTime)
-&gt; Maybe CompressionType
-&gt; [Header]
-&gt; HttpLogContext
</span><a href="Hasura.Server.Logging.html#mkHttpErrorLogContext"><span class="hs-identifier hs-var">mkHttpErrorLogContext</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe UserInfo
</span><a href="#local-6989586621688184965"><span class="hs-identifier hs-var">userInfoM</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (EngineLogType Hasura)
</span><a href="#local-6989586621688184966"><span class="hs-identifier hs-var">enabledLogTypes</span></a></span><span> </span><span class="annot"><span class="annottext">RequestId
</span><a href="#local-6989586621688184964"><span class="hs-identifier hs-var">reqId</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621688184963"><span class="hs-identifier hs-var">waiReq</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString, Maybe Value)
</span><a href="#local-6989586621688184962"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688184961"><span class="hs-identifier hs-var">qErr</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (DiffTime, DiffTime)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe CompressionType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">[Header]
</span><a href="#local-6989586621688184960"><span class="hs-identifier hs-var">headers</span></a></span><span>
</span><span id="line-1007"></span><span>
</span><span id="line-1008"></span><span>  </span><span id="local-6989586621688184957"><span class="annot"><span class="annottext">logHttpSuccess :: Logger Hasura
-&gt; HashSet (EngineLogType Hasura)
-&gt; Maybe UserInfo
-&gt; RequestId
-&gt; Request
-&gt; (ByteString, Maybe Value)
-&gt; ByteString
-&gt; ByteString
-&gt; Maybe (DiffTime, DiffTime)
-&gt; Maybe CompressionType
-&gt; [Header]
-&gt; HttpLogMetadata (PGMetadataStorageAppT m)
-&gt; PGMetadataStorageAppT m ()
</span><a href="Hasura.Server.Logging.html#logHttpSuccess"><span class="hs-identifier hs-var hs-var hs-var hs-var">logHttpSuccess</span></a></span></span><span> </span><span id="local-6989586621688184955"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688184955"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621688184954"><span class="annot"><span class="annottext">HashSet (EngineLogType Hasura)
</span><a href="#local-6989586621688184954"><span class="hs-identifier hs-var">enabledLogTypes</span></a></span></span><span> </span><span id="local-6989586621688184953"><span class="annot"><span class="annottext">Maybe UserInfo
</span><a href="#local-6989586621688184953"><span class="hs-identifier hs-var">userInfoM</span></a></span></span><span> </span><span id="local-6989586621688184952"><span class="annot"><span class="annottext">RequestId
</span><a href="#local-6989586621688184952"><span class="hs-identifier hs-var">reqId</span></a></span></span><span> </span><span id="local-6989586621688184951"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621688184951"><span class="hs-identifier hs-var">waiReq</span></a></span></span><span> </span><span id="local-6989586621688184950"><span class="annot"><span class="annottext">(ByteString, Maybe Value)
</span><a href="#local-6989586621688184950"><span class="hs-identifier hs-var">reqBody</span></a></span></span><span> </span><span id="local-6989586621688184949"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621688184949"><span class="hs-identifier hs-var">_response</span></a></span></span><span> </span><span id="local-6989586621688184948"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621688184948"><span class="hs-identifier hs-var">compressedResponse</span></a></span></span><span> </span><span id="local-6989586621688184947"><span class="annot"><span class="annottext">Maybe (DiffTime, DiffTime)
</span><a href="#local-6989586621688184947"><span class="hs-identifier hs-var">qTime</span></a></span></span><span> </span><span id="local-6989586621688184946"><span class="annot"><span class="annottext">Maybe CompressionType
</span><a href="#local-6989586621688184946"><span class="hs-identifier hs-var">cType</span></a></span></span><span> </span><span id="local-6989586621688184945"><span class="annot"><span class="annottext">[Header]
</span><a href="#local-6989586621688184945"><span class="hs-identifier hs-var">headers</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Logging.html#CommonHttpLogMetadata"><span class="hs-identifier hs-type">CommonHttpLogMetadata</span></a></span><span> </span><span id="local-6989586621688184943"><span class="annot"><span class="annottext">RequestMode
</span><a href="#local-6989586621688184943"><span class="hs-identifier hs-var">rb</span></a></span></span><span> </span><span id="local-6989586621688184942"><span class="annot"><span class="annottext">Maybe (GQLBatchedReqs GQLBatchQueryOperationLog)
</span><a href="#local-6989586621688184942"><span class="hs-identifier hs-var">batchQueryOpLogs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1009"></span><span>    </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688184955"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(HttpLogLine -&gt; PGMetadataStorageAppT m ())
-&gt; HttpLogLine -&gt; PGMetadataStorageAppT m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1010"></span><span>      </span><span class="annot"><span class="annottext">HttpLogContext -&gt; HttpLogLine
</span><a href="Hasura.Server.Logging.html#mkHttpLog"><span class="hs-identifier hs-var">mkHttpLog</span></a></span><span> </span><span class="annot"><span class="annottext">(HttpLogContext -&gt; HttpLogLine) -&gt; HttpLogContext -&gt; HttpLogLine
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1011"></span><span>        </span><span class="annot"><span class="annottext">Maybe UserInfo
-&gt; HashSet (EngineLogType Hasura)
-&gt; RequestId
-&gt; Request
-&gt; (ByteString, Maybe Value)
-&gt; ByteString
-&gt; Maybe (DiffTime, DiffTime)
-&gt; Maybe CompressionType
-&gt; [Header]
-&gt; RequestMode
-&gt; Maybe (GQLBatchedReqs GQLBatchQueryOperationLog)
-&gt; HttpLogContext
</span><a href="Hasura.Server.Logging.html#mkHttpAccessLogContext"><span class="hs-identifier hs-var">mkHttpAccessLogContext</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe UserInfo
</span><a href="#local-6989586621688184953"><span class="hs-identifier hs-var">userInfoM</span></a></span><span> </span><span class="annot"><span class="annottext">HashSet (EngineLogType Hasura)
</span><a href="#local-6989586621688184954"><span class="hs-identifier hs-var">enabledLogTypes</span></a></span><span> </span><span class="annot"><span class="annottext">RequestId
</span><a href="#local-6989586621688184952"><span class="hs-identifier hs-var">reqId</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621688184951"><span class="hs-identifier hs-var">waiReq</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString, Maybe Value)
</span><a href="#local-6989586621688184950"><span class="hs-identifier hs-var">reqBody</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621688184948"><span class="hs-identifier hs-var">compressedResponse</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (DiffTime, DiffTime)
</span><a href="#local-6989586621688184947"><span class="hs-identifier hs-var">qTime</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe CompressionType
</span><a href="#local-6989586621688184946"><span class="hs-identifier hs-var">cType</span></a></span><span> </span><span class="annot"><span class="annottext">[Header]
</span><a href="#local-6989586621688184945"><span class="hs-identifier hs-var">headers</span></a></span><span> </span><span class="annot"><span class="annottext">RequestMode
</span><a href="#local-6989586621688184943"><span class="hs-identifier hs-var">rb</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (GQLBatchedReqs GQLBatchQueryOperationLog)
</span><a href="#local-6989586621688184942"><span class="hs-identifier hs-var">batchQueryOpLogs</span></a></span></span><span>
</span><span id="line-1012"></span><span>
</span><span id="line-1013"></span><span id="local-6989586621688184940"><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621688184940"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.html#MonadExecuteQuery"><span class="hs-identifier hs-type">MonadExecuteQuery</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#PGMetadataStorageAppT"><span class="hs-identifier hs-type">PGMetadataStorageAppT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688184940"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1014"></span><span>  </span><span id="local-6989586621688184935"><span class="annot"><span class="annottext">cacheLookup :: [RemoteSchemaInfo]
-&gt; [ActionsInfo]
-&gt; QueryCacheKey
-&gt; Maybe CachedDirective
-&gt; TraceT
     (ExceptT QErr (PGMetadataStorageAppT m)) ([Header], Maybe EncJSON)
</span><a href="Hasura.GraphQL.Transport.HTTP.html#cacheLookup"><span class="hs-identifier hs-var hs-var hs-var hs-var">cacheLookup</span></a></span></span><span> </span><span class="annot"><span class="annottext">[RemoteSchemaInfo]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[ActionsInfo]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">QueryCacheKey
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe CachedDirective
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([Header], Maybe EncJSON)
-&gt; TraceT
     (ExceptT QErr (PGMetadataStorageAppT m)) ([Header], Maybe EncJSON)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe EncJSON
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-1015"></span><span>  </span><span id="local-6989586621688184933"><span class="annot"><span class="annottext">cacheStore :: QueryCacheKey
-&gt; Maybe CachedDirective
-&gt; EncJSON
-&gt; TraceT
     (ExceptT QErr (PGMetadataStorageAppT m)) CacheStoreResponse
</span><a href="Hasura.GraphQL.Transport.HTTP.html#cacheStore"><span class="hs-identifier hs-var hs-var hs-var hs-var">cacheStore</span></a></span></span><span> </span><span class="annot"><span class="annottext">QueryCacheKey
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe CachedDirective
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">EncJSON
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CacheStoreResponse
-&gt; TraceT
     (ExceptT QErr (PGMetadataStorageAppT m)) CacheStoreResponse
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CacheStoreSuccess -&gt; CacheStoreResponse
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">CacheStoreSuccess
</span><a href="Hasura.GraphQL.Transport.HTTP.html#CacheStoreSkipped"><span class="hs-identifier hs-var">CacheStoreSkipped</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-1016"></span><span>
</span><span id="line-1017"></span><span id="local-6989586621688184931"><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688184931"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688184931"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.Auth.html#UserAuthentication"><span class="hs-identifier hs-type">UserAuthentication</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Tracing.html#TraceT"><span class="hs-identifier hs-type">Tracing.TraceT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#PGMetadataStorageAppT"><span class="hs-identifier hs-type">PGMetadataStorageAppT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688184931"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1018"></span><span>  </span><span id="local-6989586621688184927"><span class="annot"><span class="annottext">resolveUserInfo :: Logger Hasura
-&gt; Manager
-&gt; [Header]
-&gt; AuthMode
-&gt; Maybe ReqsText
-&gt; TraceT
     (PGMetadataStorageAppT m)
     (Either QErr (UserInfo, Maybe UTCTime, [Header]))
</span><a href="Hasura.Server.Auth.html#resolveUserInfo"><span class="hs-identifier hs-var hs-var hs-var hs-var">resolveUserInfo</span></a></span></span><span> </span><span id="local-6989586621688184925"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688184925"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621688184924"><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621688184924"><span class="hs-identifier hs-var">manager</span></a></span></span><span> </span><span id="local-6989586621688184923"><span class="annot"><span class="annottext">[Header]
</span><a href="#local-6989586621688184923"><span class="hs-identifier hs-var">headers</span></a></span></span><span> </span><span id="local-6989586621688184922"><span class="annot"><span class="annottext">AuthMode
</span><a href="#local-6989586621688184922"><span class="hs-identifier hs-var">authMode</span></a></span></span><span> </span><span id="local-6989586621688184921"><span class="annot"><span class="annottext">Maybe ReqsText
</span><a href="#local-6989586621688184921"><span class="hs-identifier hs-var">reqs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1019"></span><span>    </span><span class="annot"><span class="annottext">ExceptT
  QErr
  (TraceT (PGMetadataStorageAppT m))
  (UserInfo, Maybe UTCTime, [Header])
-&gt; TraceT
     (PGMetadataStorageAppT m)
     (Either QErr (UserInfo, Maybe UTCTime, [Header]))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT
   QErr
   (TraceT (PGMetadataStorageAppT m))
   (UserInfo, Maybe UTCTime, [Header])
 -&gt; TraceT
      (PGMetadataStorageAppT m)
      (Either QErr (UserInfo, Maybe UTCTime, [Header])))
-&gt; ExceptT
     QErr
     (TraceT (PGMetadataStorageAppT m))
     (UserInfo, Maybe UTCTime, [Header])
-&gt; TraceT
     (PGMetadataStorageAppT m)
     (Either QErr (UserInfo, Maybe UTCTime, [Header]))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; Manager
-&gt; [Header]
-&gt; AuthMode
-&gt; Maybe ReqsText
-&gt; ExceptT
     QErr
     (TraceT (PGMetadataStorageAppT m))
     (UserInfo, Maybe UTCTime, [Header])
forall (m :: * -&gt; *).
(MonadIO m, MonadBaseControl IO m, MonadError QErr m,
 MonadTrace m) =&gt;
Logger Hasura
-&gt; Manager
-&gt; [Header]
-&gt; AuthMode
-&gt; Maybe ReqsText
-&gt; m (UserInfo, Maybe UTCTime, [Header])
</span><a href="Hasura.Server.Auth.html#getUserInfoWithExpTime"><span class="hs-identifier hs-var">getUserInfoWithExpTime</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688184925"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">Manager
</span><a href="#local-6989586621688184924"><span class="hs-identifier hs-var">manager</span></a></span><span> </span><span class="annot"><span class="annottext">[Header]
</span><a href="#local-6989586621688184923"><span class="hs-identifier hs-var">headers</span></a></span><span> </span><span class="annot"><span class="annottext">AuthMode
</span><a href="#local-6989586621688184922"><span class="hs-identifier hs-var">authMode</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ReqsText
</span><a href="#local-6989586621688184921"><span class="hs-identifier hs-var">reqs</span></a></span></span><span>
</span><span id="line-1020"></span><span>
</span><span id="line-1021"></span><span class="annot"><a href="Hasura.App.html#accessDeniedErrMsg"><span class="hs-identifier hs-type">accessDeniedErrMsg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-1022"></span><span id="accessDeniedErrMsg"><span class="annot"><span class="annottext">accessDeniedErrMsg :: Text
</span><a href="Hasura.App.html#accessDeniedErrMsg"><span class="hs-identifier hs-var hs-var">accessDeniedErrMsg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1023"></span><span>  </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;restricted access : admin only&quot;</span></span><span>
</span><span id="line-1024"></span><span>
</span><span id="line-1025"></span><span id="local-6989586621688184919"><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621688184919"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.App.html#MonadMetadataApiAuthorization"><span class="hs-identifier hs-type">MonadMetadataApiAuthorization</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#PGMetadataStorageAppT"><span class="hs-identifier hs-type">PGMetadataStorageAppT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688184919"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1026"></span><span>  </span><span id="local-6989586621688184913"><span class="annot"><span class="annottext">authorizeV1QueryApi :: RQLQuery -&gt; HandlerCtx -&gt; PGMetadataStorageAppT m (Either QErr ())
</span><a href="Hasura.Server.App.html#authorizeV1QueryApi"><span class="hs-identifier hs-var hs-var hs-var hs-var">authorizeV1QueryApi</span></a></span></span><span> </span><span id="local-6989586621688184911"><span class="annot"><span class="annottext">RQLQuery
</span><a href="#local-6989586621688184911"><span class="hs-identifier hs-var">query</span></a></span></span><span> </span><span id="local-6989586621688184910"><span class="annot"><span class="annottext">HandlerCtx
</span><a href="#local-6989586621688184910"><span class="hs-identifier hs-var">handlerCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT QErr (PGMetadataStorageAppT m) ()
-&gt; PGMetadataStorageAppT m (Either QErr ())
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1027"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688184909"><span class="annot"><span class="annottext">currRole :: RoleName
</span><a href="#local-6989586621688184909"><span class="hs-identifier hs-var hs-var">currRole</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UserInfo -&gt; RoleName
</span><a href="Hasura.Session.html#_uiRole"><span class="hs-identifier hs-var hs-var">_uiRole</span></a></span><span> </span><span class="annot"><span class="annottext">(UserInfo -&gt; RoleName) -&gt; UserInfo -&gt; RoleName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HandlerCtx -&gt; UserInfo
</span><a href="Hasura.Server.App.html#hcUser"><span class="hs-identifier hs-var hs-var">hcUser</span></a></span><span> </span><span class="annot"><span class="annottext">HandlerCtx
</span><a href="#local-6989586621688184910"><span class="hs-identifier hs-var">handlerCtx</span></a></span><span>
</span><span id="line-1028"></span><span>    </span><span class="annot"><span class="annottext">Bool
-&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
-&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RQLQuery -&gt; Bool
</span><a href="Hasura.Server.API.Query.html#requiresAdmin"><span class="hs-identifier hs-var">requiresAdmin</span></a></span><span> </span><span class="annot"><span class="annottext">RQLQuery
</span><a href="#local-6989586621688184911"><span class="hs-identifier hs-var">query</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688184909"><span class="hs-identifier hs-var">currRole</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; RoleName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="Hasura.Session.html#adminRoleName"><span class="hs-identifier hs-var">adminRoleName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ExceptT QErr (PGMetadataStorageAppT m) ()
 -&gt; ExceptT QErr (PGMetadataStorageAppT m) ())
-&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
-&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1029"></span><span>      </span><span class="annot"><span class="annottext">Text
-&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
-&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a -&gt; m a
</span><a href="Hasura.Base.Error.html#withPathK"><span class="hs-identifier hs-var">withPathK</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;args&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT QErr (PGMetadataStorageAppT m) ()
 -&gt; ExceptT QErr (PGMetadataStorageAppT m) ())
-&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
-&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#AccessDenied"><span class="hs-identifier hs-var">AccessDenied</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="Hasura.App.html#accessDeniedErrMsg"><span class="hs-identifier hs-var">accessDeniedErrMsg</span></a></span><span>
</span><span id="line-1030"></span><span>
</span><span id="line-1031"></span><span>  </span><span id="local-6989586621688184899"><span class="annot"><span class="annottext">authorizeV1MetadataApi :: RQLMetadata
-&gt; HandlerCtx -&gt; PGMetadataStorageAppT m (Either QErr ())
</span><a href="Hasura.Server.App.html#authorizeV1MetadataApi"><span class="hs-identifier hs-var hs-var hs-var hs-var">authorizeV1MetadataApi</span></a></span></span><span> </span><span class="annot"><span class="annottext">RQLMetadata
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688184897"><span class="annot"><span class="annottext">HandlerCtx
</span><a href="#local-6989586621688184897"><span class="hs-identifier hs-var">handlerCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT QErr (PGMetadataStorageAppT m) ()
-&gt; PGMetadataStorageAppT m (Either QErr ())
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1032"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688184896"><span class="annot"><span class="annottext">currRole :: RoleName
</span><a href="#local-6989586621688184896"><span class="hs-identifier hs-var hs-var">currRole</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UserInfo -&gt; RoleName
</span><a href="Hasura.Session.html#_uiRole"><span class="hs-identifier hs-var hs-var">_uiRole</span></a></span><span> </span><span class="annot"><span class="annottext">(UserInfo -&gt; RoleName) -&gt; UserInfo -&gt; RoleName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HandlerCtx -&gt; UserInfo
</span><a href="Hasura.Server.App.html#hcUser"><span class="hs-identifier hs-var hs-var">hcUser</span></a></span><span> </span><span class="annot"><span class="annottext">HandlerCtx
</span><a href="#local-6989586621688184897"><span class="hs-identifier hs-var">handlerCtx</span></a></span><span>
</span><span id="line-1033"></span><span>    </span><span class="annot"><span class="annottext">Bool
-&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
-&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688184896"><span class="hs-identifier hs-var">currRole</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; RoleName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="Hasura.Session.html#adminRoleName"><span class="hs-identifier hs-var">adminRoleName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ExceptT QErr (PGMetadataStorageAppT m) ()
 -&gt; ExceptT QErr (PGMetadataStorageAppT m) ())
-&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
-&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1034"></span><span>      </span><span class="annot"><span class="annottext">Text
-&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
-&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a -&gt; m a
</span><a href="Hasura.Base.Error.html#withPathK"><span class="hs-identifier hs-var">withPathK</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;args&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT QErr (PGMetadataStorageAppT m) ()
 -&gt; ExceptT QErr (PGMetadataStorageAppT m) ())
-&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
-&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#AccessDenied"><span class="hs-identifier hs-var">AccessDenied</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="Hasura.App.html#accessDeniedErrMsg"><span class="hs-identifier hs-var">accessDeniedErrMsg</span></a></span><span>
</span><span id="line-1035"></span><span>
</span><span id="line-1036"></span><span>  </span><span id="local-6989586621688184895"><span class="annot"><span class="annottext">authorizeV2QueryApi :: RQLQuery -&gt; HandlerCtx -&gt; PGMetadataStorageAppT m (Either QErr ())
</span><a href="Hasura.Server.App.html#authorizeV2QueryApi"><span class="hs-identifier hs-var hs-var hs-var hs-var">authorizeV2QueryApi</span></a></span></span><span> </span><span class="annot"><span class="annottext">RQLQuery
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688184893"><span class="annot"><span class="annottext">HandlerCtx
</span><a href="#local-6989586621688184893"><span class="hs-identifier hs-var">handlerCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT QErr (PGMetadataStorageAppT m) ()
-&gt; PGMetadataStorageAppT m (Either QErr ())
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1037"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688184892"><span class="annot"><span class="annottext">currRole :: RoleName
</span><a href="#local-6989586621688184892"><span class="hs-identifier hs-var hs-var">currRole</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UserInfo -&gt; RoleName
</span><a href="Hasura.Session.html#_uiRole"><span class="hs-identifier hs-var hs-var">_uiRole</span></a></span><span> </span><span class="annot"><span class="annottext">(UserInfo -&gt; RoleName) -&gt; UserInfo -&gt; RoleName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HandlerCtx -&gt; UserInfo
</span><a href="Hasura.Server.App.html#hcUser"><span class="hs-identifier hs-var hs-var">hcUser</span></a></span><span> </span><span class="annot"><span class="annottext">HandlerCtx
</span><a href="#local-6989586621688184893"><span class="hs-identifier hs-var">handlerCtx</span></a></span><span>
</span><span id="line-1038"></span><span>    </span><span class="annot"><span class="annottext">Bool
-&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
-&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688184892"><span class="hs-identifier hs-var">currRole</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName -&gt; RoleName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="Hasura.Session.html#adminRoleName"><span class="hs-identifier hs-var">adminRoleName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ExceptT QErr (PGMetadataStorageAppT m) ()
 -&gt; ExceptT QErr (PGMetadataStorageAppT m) ())
-&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
-&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1039"></span><span>      </span><span class="annot"><span class="annottext">Text
-&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
-&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Text -&gt; m a -&gt; m a
</span><a href="Hasura.Base.Error.html#withPathK"><span class="hs-identifier hs-var">withPathK</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;args&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT QErr (PGMetadataStorageAppT m) ()
 -&gt; ExceptT QErr (PGMetadataStorageAppT m) ())
-&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
-&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#AccessDenied"><span class="hs-identifier hs-var">AccessDenied</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="Hasura.App.html#accessDeniedErrMsg"><span class="hs-identifier hs-var">accessDeniedErrMsg</span></a></span></span><span>
</span><span id="line-1040"></span><span>
</span><span id="line-1041"></span><span id="local-6989586621688184891"><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621688184891"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.App.html#ConsoleRenderer"><span class="hs-identifier hs-type">ConsoleRenderer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#PGMetadataStorageAppT"><span class="hs-identifier hs-type">PGMetadataStorageAppT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688184891"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1042"></span><span>  </span><span id="local-6989586621688184887"><span class="annot"><span class="annottext">renderConsole :: Text
-&gt; AuthMode
-&gt; Bool
-&gt; Maybe Text
-&gt; PGMetadataStorageAppT m (Either String Text)
</span><a href="Hasura.Server.App.html#renderConsole"><span class="hs-identifier hs-var hs-var hs-var hs-var">renderConsole</span></a></span></span><span> </span><span id="local-6989586621688184885"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688184885"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span id="local-6989586621688184884"><span class="annot"><span class="annottext">AuthMode
</span><a href="#local-6989586621688184884"><span class="hs-identifier hs-var">authMode</span></a></span></span><span> </span><span id="local-6989586621688184883"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688184883"><span class="hs-identifier hs-var">enableTelemetry</span></a></span></span><span> </span><span id="local-6989586621688184882"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621688184882"><span class="hs-identifier hs-var">consoleAssetsDir</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1043"></span><span>    </span><span class="annot"><span class="annottext">Either String Text -&gt; PGMetadataStorageAppT m (Either String Text)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Either String Text
 -&gt; PGMetadataStorageAppT m (Either String Text))
-&gt; Either String Text
-&gt; PGMetadataStorageAppT m (Either String Text)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; AuthMode -&gt; Bool -&gt; Maybe Text -&gt; Either String Text
</span><a href="Hasura.App.html#mkConsoleHTML"><span class="hs-identifier hs-var">mkConsoleHTML</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688184885"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">AuthMode
</span><a href="#local-6989586621688184884"><span class="hs-identifier hs-var">authMode</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688184883"><span class="hs-identifier hs-var">enableTelemetry</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621688184882"><span class="hs-identifier hs-var">consoleAssetsDir</span></a></span></span><span>
</span><span id="line-1044"></span><span>
</span><span id="line-1045"></span><span id="local-6989586621688184880"><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621688184880"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Common.html#MonadGQLExecutionCheck"><span class="hs-identifier hs-type">MonadGQLExecutionCheck</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#PGMetadataStorageAppT"><span class="hs-identifier hs-type">PGMetadataStorageAppT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688184880"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1046"></span><span>  </span><span id="local-6989586621688184875"><span class="annot"><span class="annottext">checkGQLExecution :: UserInfo
-&gt; ([Header], IpAddress)
-&gt; Bool
-&gt; SchemaCache
-&gt; GQLReqUnparsed
-&gt; PGMetadataStorageAppT m (Either QErr GQLReqParsed)
</span><a href="Hasura.GraphQL.Execute.Common.html#checkGQLExecution"><span class="hs-identifier hs-var hs-var hs-var hs-var">checkGQLExecution</span></a></span></span><span> </span><span id="local-6989586621688184873"><span class="annot"><span class="annottext">UserInfo
</span><a href="#local-6989586621688184873"><span class="hs-identifier hs-var">userInfo</span></a></span></span><span> </span><span class="annot"><span class="annottext">([Header], IpAddress)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688184872"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688184872"><span class="hs-identifier hs-var">enableAL</span></a></span></span><span> </span><span id="local-6989586621688184871"><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621688184871"><span class="hs-identifier hs-var">sc</span></a></span></span><span> </span><span id="local-6989586621688184870"><span class="annot"><span class="annottext">GQLReqUnparsed
</span><a href="#local-6989586621688184870"><span class="hs-identifier hs-var">query</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT QErr (PGMetadataStorageAppT m) GQLReqParsed
-&gt; PGMetadataStorageAppT m (Either QErr GQLReqParsed)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT QErr (PGMetadataStorageAppT m) GQLReqParsed
 -&gt; PGMetadataStorageAppT m (Either QErr GQLReqParsed))
-&gt; ExceptT QErr (PGMetadataStorageAppT m) GQLReqParsed
-&gt; PGMetadataStorageAppT m (Either QErr GQLReqParsed)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1047"></span><span>    </span><span id="local-6989586621688184869"><span class="annot"><span class="annottext">GQLReqParsed
</span><a href="#local-6989586621688184869"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">GQLReqUnparsed
-&gt; ExceptT QErr (PGMetadataStorageAppT m) GQLReqParsed
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
GQLReqUnparsed -&gt; m GQLReqParsed
</span><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#toParsed"><span class="hs-identifier hs-var">toParsed</span></a></span><span> </span><span class="annot"><span class="annottext">GQLReqUnparsed
</span><a href="#local-6989586621688184870"><span class="hs-identifier hs-var">query</span></a></span><span>
</span><span id="line-1048"></span><span>    </span><span class="annot"><span class="annottext">Bool
-&gt; AllowlistMode
-&gt; UserInfo
-&gt; GQLReqParsed
-&gt; SchemaCache
-&gt; ExceptT QErr (PGMetadataStorageAppT m) ()
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
Bool
-&gt; AllowlistMode -&gt; UserInfo -&gt; GQLReqParsed -&gt; SchemaCache -&gt; m ()
</span><a href="Hasura.GraphQL.Execute.html#checkQueryInAllowlist"><span class="hs-identifier hs-var">checkQueryInAllowlist</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688184872"><span class="hs-identifier hs-var">enableAL</span></a></span><span> </span><span class="annot"><span class="annottext">AllowlistMode
</span><a href="Hasura.RQL.Types.Allowlist.html#AllowlistModeGlobalOnly"><span class="hs-identifier hs-var">AllowlistModeGlobalOnly</span></a></span><span> </span><span class="annot"><span class="annottext">UserInfo
</span><a href="#local-6989586621688184873"><span class="hs-identifier hs-var">userInfo</span></a></span><span> </span><span class="annot"><span class="annottext">GQLReqParsed
</span><a href="#local-6989586621688184869"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621688184871"><span class="hs-identifier hs-var">sc</span></a></span><span>
</span><span id="line-1049"></span><span>    </span><span class="annot"><span class="annottext">GQLReqParsed -&gt; ExceptT QErr (PGMetadataStorageAppT m) GQLReqParsed
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">GQLReqParsed
</span><a href="#local-6989586621688184869"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-1050"></span><span>
</span><span id="line-1051"></span><span>  </span><span id="local-6989586621688184867"><span class="annot"><span class="annottext">executeIntrospection :: UserInfo
-&gt; Value
-&gt; SetGraphqlIntrospectionOptions
-&gt; PGMetadataStorageAppT m (Either QErr ExecutionStep)
</span><a href="Hasura.GraphQL.Execute.Common.html#executeIntrospection"><span class="hs-identifier hs-var hs-var hs-var hs-var">executeIntrospection</span></a></span></span><span> </span><span class="annot"><span class="annottext">UserInfo
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688184865"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688184865"><span class="hs-identifier hs-var">introspectionQuery</span></a></span></span><span> </span><span class="annot"><span class="annottext">SetGraphqlIntrospectionOptions
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1052"></span><span>    </span><span class="annot"><span class="annottext">Either QErr ExecutionStep
-&gt; PGMetadataStorageAppT m (Either QErr ExecutionStep)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either QErr ExecutionStep
 -&gt; PGMetadataStorageAppT m (Either QErr ExecutionStep))
-&gt; Either QErr ExecutionStep
-&gt; PGMetadataStorageAppT m (Either QErr ExecutionStep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExecutionStep -&gt; Either QErr ExecutionStep
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(ExecutionStep -&gt; Either QErr ExecutionStep)
-&gt; ExecutionStep -&gt; Either QErr ExecutionStep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Value -&gt; ExecutionStep
</span><a href="Hasura.GraphQL.Execute.Backend.html#ExecStepRaw"><span class="hs-identifier hs-var">ExecStepRaw</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688184865"><span class="hs-identifier hs-var">introspectionQuery</span></a></span></span><span>
</span><span id="line-1053"></span><span>
</span><span id="line-1054"></span><span id="local-6989586621688184863"><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688184863"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688184863"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.App.html#MonadConfigApiHandler"><span class="hs-identifier hs-type">MonadConfigApiHandler</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#PGMetadataStorageAppT"><span class="hs-identifier hs-type">PGMetadataStorageAppT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688184863"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1055"></span><span>  </span><span id="local-6989586621688184859"><span class="annot"><span class="annottext">runConfigApiHandler :: ServerCtx
-&gt; Maybe Text -&gt; SpockCtxT () (PGMetadataStorageAppT m) ()
</span><a href="Hasura.Server.App.html#runConfigApiHandler"><span class="hs-identifier hs-var hs-var hs-var hs-var">runConfigApiHandler</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerCtx
-&gt; Maybe Text -&gt; SpockCtxT () (PGMetadataStorageAppT m) ()
forall (m :: * -&gt; *).
(MonadIO m, MonadBaseControl IO m, UserAuthentication (TraceT m),
 HttpLog m, HasReporter m, HasResourceLimits m) =&gt;
ServerCtx -&gt; Maybe Text -&gt; SpockCtxT () m ()
</span><a href="Hasura.Server.App.html#configApiGetHandler"><span class="hs-identifier hs-var">configApiGetHandler</span></a></span></span><span>
</span><span id="line-1056"></span><span>
</span><span id="line-1057"></span><span id="local-6989586621688184856"><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688184856"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Logging.html#MonadQueryLog"><span class="hs-identifier hs-type">MonadQueryLog</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#PGMetadataStorageAppT"><span class="hs-identifier hs-type">PGMetadataStorageAppT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688184856"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1058"></span><span>  </span><span id="local-6989586621688184852"><span class="annot"><span class="annottext">logQueryLog :: Logger Hasura -&gt; QueryLog -&gt; PGMetadataStorageAppT m ()
</span><a href="Hasura.GraphQL.Logging.html#logQueryLog"><span class="hs-identifier hs-var hs-var hs-var hs-var">logQueryLog</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Logger Hasura -&gt; QueryLog -&gt; PGMetadataStorageAppT m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">unLogger</span></a></span></span><span>
</span><span id="line-1059"></span><span>
</span><span id="line-1060"></span><span id="local-6989586621688184850"><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688184850"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Server.html#MonadWSLog"><span class="hs-identifier hs-type">WS.MonadWSLog</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#PGMetadataStorageAppT"><span class="hs-identifier hs-type">PGMetadataStorageAppT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688184850"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1061"></span><span>  </span><span id="local-6989586621688184846"><span class="annot"><span class="annottext">logWSLog :: Logger Hasura -&gt; WSLog -&gt; PGMetadataStorageAppT m ()
</span><a href="Hasura.GraphQL.Transport.WebSocket.Server.html#logWSLog"><span class="hs-identifier hs-var hs-var hs-var hs-var">logWSLog</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Logger Hasura -&gt; WSLog -&gt; PGMetadataStorageAppT m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">unLogger</span></a></span></span><span>
</span><span id="line-1062"></span><span>
</span><span id="line-1063"></span><span id="local-6989586621688184844"><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621688184844"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#MonadResolveSource"><span class="hs-identifier hs-type">MonadResolveSource</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#PGMetadataStorageAppT"><span class="hs-identifier hs-type">PGMetadataStorageAppT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688184844"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1064"></span><span>  </span><span id="local-6989586621688184839"><span class="annot"><span class="annottext">getPGSourceResolver :: PGMetadataStorageAppT m (SourceResolver ('Postgres 'Vanilla))
</span><a href="Hasura.RQL.Types.Source.html#getPGSourceResolver"><span class="hs-identifier hs-var hs-var hs-var hs-var">getPGSourceResolver</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PGLogger -&gt; SourceResolver ('Postgres 'Vanilla)
PGLogger
-&gt; SourceName
-&gt; PostgresConnConfiguration
-&gt; IO (Either QErr PGSourceConfig)
</span><a href="Hasura.App.html#mkPgSourceResolver"><span class="hs-identifier hs-var">mkPgSourceResolver</span></a></span><span> </span><span class="annot"><span class="annottext">(PGLogger
 -&gt; SourceName
 -&gt; PostgresConnConfiguration
 -&gt; IO (Either QErr PGSourceConfig))
-&gt; PGMetadataStorageAppT m PGLogger
-&gt; PGMetadataStorageAppT
     m
     (SourceName
      -&gt; PostgresConnConfiguration -&gt; IO (Either QErr PGSourceConfig))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">((PGPool, PGLogger) -&gt; PGLogger)
-&gt; PGMetadataStorageAppT m PGLogger
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">(PGPool, PGLogger) -&gt; PGLogger
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span>
</span><span id="line-1065"></span><span>  </span><span id="local-6989586621688184836"><span class="annot"><span class="annottext">getMSSQLSourceResolver :: PGMetadataStorageAppT m (SourceResolver 'MSSQL)
</span><a href="Hasura.RQL.Types.Source.html#getMSSQLSourceResolver"><span class="hs-identifier hs-var hs-var hs-var hs-var">getMSSQLSourceResolver</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SourceName
 -&gt; MSSQLConnConfiguration -&gt; IO (Either QErr MSSQLSourceConfig))
-&gt; PGMetadataStorageAppT
     m
     (SourceName
      -&gt; MSSQLConnConfiguration -&gt; IO (Either QErr MSSQLSourceConfig))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">SourceResolver 'MSSQL
SourceName
-&gt; MSSQLConnConfiguration -&gt; IO (Either QErr MSSQLSourceConfig)
</span><a href="Hasura.App.html#mkMSSQLSourceResolver"><span class="hs-identifier hs-var">mkMSSQLSourceResolver</span></a></span></span><span>
</span><span id="line-1066"></span><span>
</span><span id="line-1067"></span><span id="local-6989586621688184834"><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621688184834"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Backend.html#MonadQueryTags"><span class="hs-identifier hs-type">EB.MonadQueryTags</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#PGMetadataStorageAppT"><span class="hs-identifier hs-type">PGMetadataStorageAppT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688184834"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1068"></span><span>  </span><span id="local-6989586621688184830"><span class="annot"><span class="annottext">createQueryTags :: QueryTagsAttributes
-&gt; Maybe QueryTagsConfig
-&gt; Tagged (PGMetadataStorageAppT m) QueryTagsComment
</span><a href="Hasura.GraphQL.Execute.Backend.html#createQueryTags"><span class="hs-identifier hs-var hs-var hs-var hs-var">createQueryTags</span></a></span></span><span> </span><span id="local-6989586621688184828"><span class="annot"><span class="annottext">QueryTagsAttributes
</span><a href="#local-6989586621688184828"><span class="hs-identifier hs-var">_attributes</span></a></span></span><span> </span><span id="local-6989586621688184827"><span class="annot"><span class="annottext">Maybe QueryTagsConfig
</span><a href="#local-6989586621688184827"><span class="hs-identifier hs-var">_qtSourceConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QueryTagsComment
-&gt; Tagged (PGMetadataStorageAppT m) QueryTagsComment
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(QueryTagsComment
 -&gt; Tagged (PGMetadataStorageAppT m) QueryTagsComment)
-&gt; QueryTagsComment
-&gt; Tagged (PGMetadataStorageAppT m) QueryTagsComment
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QueryTagsComment
</span><a href="Hasura.QueryTags.html#emptyQueryTagsComment"><span class="hs-identifier hs-var">emptyQueryTagsComment</span></a></span></span><span>
</span><span id="line-1069"></span><span>
</span><span id="line-1070"></span><span id="local-6989586621688185730"><span id="local-6989586621688185731"><span class="annot"><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-type">runInSeparateTx</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1071"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688185731"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1072"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Q.TxE</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185730"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1073"></span><span>  </span><span class="annot"><a href="Hasura.Metadata.Class.html#MetadataStorageT"><span class="hs-identifier hs-type">MetadataStorageT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#PGMetadataStorageAppT"><span class="hs-identifier hs-type">PGMetadataStorageAppT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688185731"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621688185730"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-1074"></span><span id="runInSeparateTx"><span class="annot"><span class="annottext">runInSeparateTx :: TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var hs-var">runInSeparateTx</span></a></span></span><span> </span><span id="local-6989586621688184824"><span class="annot"><span class="annottext">TxE QErr a
</span><a href="#local-6989586621688184824"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1075"></span><span>  </span><span id="local-6989586621688184823"><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621688184823"><span class="hs-identifier hs-var">pool</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PGMetadataStorageAppT m PGPool
-&gt; MetadataStorageT (PGMetadataStorageAppT m) PGPool
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(PGMetadataStorageAppT m PGPool
 -&gt; MetadataStorageT (PGMetadataStorageAppT m) PGPool)
-&gt; PGMetadataStorageAppT m PGPool
-&gt; MetadataStorageT (PGMetadataStorageAppT m) PGPool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((PGPool, PGLogger) -&gt; PGPool) -&gt; PGMetadataStorageAppT m PGPool
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">(PGPool, PGLogger) -&gt; PGPool
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span>
</span><span id="line-1076"></span><span>  </span><span class="annot"><span class="annottext">MetadataStorageT (PGMetadataStorageAppT m) (Either QErr a)
-&gt; MetadataStorageT (PGMetadataStorageAppT m) a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(MetadataStorageT (PGMetadataStorageAppT m) (Either QErr a)
 -&gt; MetadataStorageT (PGMetadataStorageAppT m) a)
-&gt; MetadataStorageT (PGMetadataStorageAppT m) (Either QErr a)
-&gt; MetadataStorageT (PGMetadataStorageAppT m) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either QErr a)
-&gt; MetadataStorageT (PGMetadataStorageAppT m) (Either QErr a)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either QErr a)
 -&gt; MetadataStorageT (PGMetadataStorageAppT m) (Either QErr a))
-&gt; IO (Either QErr a)
-&gt; MetadataStorageT (PGMetadataStorageAppT m) (Either QErr a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExceptT QErr IO a -&gt; IO (Either QErr a)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT QErr IO a -&gt; IO (Either QErr a))
-&gt; ExceptT QErr IO a -&gt; IO (Either QErr a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PGPool -&gt; TxMode -&gt; TxE QErr a -&gt; ExceptT QErr IO a
forall (m :: * -&gt; *) e a.
(MonadIO m, MonadBaseControl IO m, FromPGTxErr e,
 FromPGConnErr e) =&gt;
PGPool -&gt; TxMode -&gt; TxET e m a -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">Q.runTx</span></span><span> </span><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621688184823"><span class="hs-identifier hs-var">pool</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxIsolation
</span><span class="hs-identifier hs-var">Q.RepeatableRead</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe TxAccess
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TxE QErr a
</span><a href="#local-6989586621688184824"><span class="hs-identifier hs-var">tx</span></a></span><span>
</span><span id="line-1077"></span><span>
</span><span id="line-1078"></span><span class="annot"><a href="Hasura.App.html#notifySchemaCacheSyncTx"><span class="hs-identifier hs-type">notifySchemaCacheSyncTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataResourceVersion"><span class="hs-identifier hs-type">MetadataResourceVersion</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html#InstanceId"><span class="hs-identifier hs-type">InstanceId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CacheInvalidations"><span class="hs-identifier hs-type">CacheInvalidations</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Q.TxE</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1079"></span><span id="notifySchemaCacheSyncTx"><span class="annot"><span class="annottext">notifySchemaCacheSyncTx :: MetadataResourceVersion
-&gt; InstanceId -&gt; CacheInvalidations -&gt; TxE QErr ()
</span><a href="Hasura.App.html#notifySchemaCacheSyncTx"><span class="hs-identifier hs-var hs-var">notifySchemaCacheSyncTx</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.html#MetadataResourceVersion"><span class="hs-identifier hs-type">MetadataResourceVersion</span></a></span><span> </span><span id="local-6989586621688184819"><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621688184819"><span class="hs-identifier hs-var">resourceVersion</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621688184818"><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621688184818"><span class="hs-identifier hs-var">instanceId</span></a></span></span><span> </span><span id="local-6989586621688184817"><span class="annot"><span class="annottext">CacheInvalidations
</span><a href="#local-6989586621688184817"><span class="hs-identifier hs-var">invalidations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1080"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Q.Discard</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1081"></span><span>    </span><span class="annot"><span class="annottext">(PGTxErr -&gt; QErr)
-&gt; Query
-&gt; (AltJ CacheInvalidations, Int64, InstanceId)
-&gt; Bool
-&gt; TxET QErr IO Discard
forall (m :: * -&gt; *) a r e.
(MonadIO m, FromRes a, ToPrepArgs r) =&gt;
(PGTxErr -&gt; e) -&gt; Query -&gt; r -&gt; Bool -&gt; TxET e m a
</span><span class="hs-identifier hs-var">Q.withQE</span></span><span>
</span><span id="line-1082"></span><span>      </span><span class="annot"><span class="annottext">PGTxErr -&gt; QErr
</span><a href="Hasura.Backends.Postgres.Execute.Types.html#defaultTxErrorHandler"><span class="hs-identifier hs-var">defaultTxErrorHandler</span></a></span><span>
</span><span id="line-1083"></span><span>      </span><span class="annot"><span class="">[Q.sql|
      INSERT INTO hdb_catalog.hdb_schema_notifications(id, notification, resource_version, instance_id)
      VALUES (1, $1::json, $2, $3::uuid)
      ON CONFLICT (id) DO UPDATE SET
        notification = $1::json,
        resource_version = $2,
        instance_id = $3::uuid
    |]</span></span><span>
</span><span id="line-1091"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CacheInvalidations -&gt; AltJ CacheInvalidations
forall a. a -&gt; AltJ a
</span><span class="hs-identifier hs-var">Q.AltJ</span></span><span> </span><span class="annot"><span class="annottext">CacheInvalidations
</span><a href="#local-6989586621688184817"><span class="hs-identifier hs-var">invalidations</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621688184819"><span class="hs-identifier hs-var">resourceVersion</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621688184818"><span class="hs-identifier hs-var">instanceId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1092"></span><span>      </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1093"></span><span>  </span><span class="annot"><span class="annottext">() -&gt; TxE QErr ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1094"></span><span>
</span><span id="line-1095"></span><span class="annot"><a href="Hasura.App.html#getCatalogStateTx"><span class="hs-identifier hs-type">getCatalogStateTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Q.TxE</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#CatalogState"><span class="hs-identifier hs-type">CatalogState</span></a></span><span>
</span><span id="line-1096"></span><span id="getCatalogStateTx"><span class="annot"><span class="annottext">getCatalogStateTx :: TxE QErr CatalogState
</span><a href="Hasura.App.html#getCatalogStateTx"><span class="hs-identifier hs-var hs-var">getCatalogStateTx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1097"></span><span>  </span><span class="annot"><span class="annottext">(Text, AltJ Value, AltJ Value) -&gt; CatalogState
</span><a href="#local-6989586621688184812"><span class="hs-identifier hs-var">mkCatalogState</span></a></span><span> </span><span class="annot"><span class="annottext">((Text, AltJ Value, AltJ Value) -&gt; CatalogState)
-&gt; (SingleRow (Text, AltJ Value, AltJ Value)
    -&gt; (Text, AltJ Value, AltJ Value))
-&gt; SingleRow (Text, AltJ Value, AltJ Value)
-&gt; CatalogState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SingleRow (Text, AltJ Value, AltJ Value)
-&gt; (Text, AltJ Value, AltJ Value)
forall a. SingleRow a -&gt; a
</span><span class="hs-identifier hs-var hs-var">Q.getRow</span></span><span>
</span><span id="line-1098"></span><span>    </span><span class="annot"><span class="annottext">(SingleRow (Text, AltJ Value, AltJ Value) -&gt; CatalogState)
-&gt; TxET QErr IO (SingleRow (Text, AltJ Value, AltJ Value))
-&gt; TxE QErr CatalogState
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(PGTxErr -&gt; QErr)
-&gt; Query
-&gt; ()
-&gt; Bool
-&gt; TxET QErr IO (SingleRow (Text, AltJ Value, AltJ Value))
forall (m :: * -&gt; *) a r e.
(MonadIO m, FromRes a, ToPrepArgs r) =&gt;
(PGTxErr -&gt; e) -&gt; Query -&gt; r -&gt; Bool -&gt; TxET e m a
</span><span class="hs-identifier hs-var">Q.withQE</span></span><span>
</span><span id="line-1099"></span><span>      </span><span class="annot"><span class="annottext">PGTxErr -&gt; QErr
</span><a href="Hasura.Backends.Postgres.Execute.Types.html#defaultTxErrorHandler"><span class="hs-identifier hs-var">defaultTxErrorHandler</span></a></span><span>
</span><span id="line-1100"></span><span>      </span><span class="annot"><span class="">[Q.sql|
    SELECT hasura_uuid::text, cli_state::json, console_state::json
      FROM hdb_catalog.hdb_version
  |]</span></span><span>
</span><span id="line-1104"></span><span>      </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1105"></span><span>      </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1106"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1107"></span><span>    </span><span id="local-6989586621688184812"><span class="annot"><span class="annottext">mkCatalogState :: (Text, AltJ Value, AltJ Value) -&gt; CatalogState
</span><a href="#local-6989586621688184812"><span class="hs-identifier hs-var hs-var">mkCatalogState</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621688184810"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688184810"><span class="hs-identifier hs-var">dbId</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Q.AltJ</span></span><span> </span><span id="local-6989586621688184809"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688184809"><span class="hs-identifier hs-var">cliState</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Q.AltJ</span></span><span> </span><span id="local-6989586621688184808"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688184808"><span class="hs-identifier hs-var">consoleState</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1108"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; Value -&gt; Value -&gt; CatalogState
</span><a href="Hasura.RQL.Types.Metadata.html#CatalogState"><span class="hs-identifier hs-var">CatalogState</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688184810"><span class="hs-identifier hs-var">dbId</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688184809"><span class="hs-identifier hs-var">cliState</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688184808"><span class="hs-identifier hs-var">consoleState</span></a></span><span>
</span><span id="line-1109"></span><span>
</span><span id="line-1110"></span><span class="annot"><a href="Hasura.App.html#setCatalogStateTx"><span class="hs-identifier hs-type">setCatalogStateTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#CatalogStateType"><span class="hs-identifier hs-type">CatalogStateType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">A.Value</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Q.TxE</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1111"></span><span id="setCatalogStateTx"><span class="annot"><span class="annottext">setCatalogStateTx :: CatalogStateType -&gt; Value -&gt; TxE QErr ()
</span><a href="Hasura.App.html#setCatalogStateTx"><span class="hs-identifier hs-var hs-var">setCatalogStateTx</span></a></span></span><span> </span><span id="local-6989586621688184806"><span class="annot"><span class="annottext">CatalogStateType
</span><a href="#local-6989586621688184806"><span class="hs-identifier hs-var">stateTy</span></a></span></span><span> </span><span id="local-6989586621688184805"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688184805"><span class="hs-identifier hs-var">stateValue</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1112"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CatalogStateType
</span><a href="#local-6989586621688184806"><span class="hs-identifier hs-var">stateTy</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1113"></span><span>    </span><span class="annot"><span class="annottext">CatalogStateType
</span><a href="Hasura.RQL.Types.Metadata.html#CSTCli"><span class="hs-identifier hs-var">CSTCli</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1114"></span><span>      </span><span class="annot"><span class="annottext">(PGTxErr -&gt; QErr)
-&gt; Query -&gt; Identity (AltJ Value) -&gt; Bool -&gt; TxE QErr ()
forall (m :: * -&gt; *) r e.
(MonadIO m, ToPrepArgs r) =&gt;
(PGTxErr -&gt; e) -&gt; Query -&gt; r -&gt; Bool -&gt; TxET e m ()
</span><span class="hs-identifier hs-var">Q.unitQE</span></span><span>
</span><span id="line-1115"></span><span>        </span><span class="annot"><span class="annottext">PGTxErr -&gt; QErr
</span><a href="Hasura.Backends.Postgres.Execute.Types.html#defaultTxErrorHandler"><span class="hs-identifier hs-var">defaultTxErrorHandler</span></a></span><span>
</span><span id="line-1116"></span><span>        </span><span class="annot"><span class="">[Q.sql|
        UPDATE hdb_catalog.hdb_version
           SET cli_state = $1
      |]</span></span><span>
</span><span id="line-1120"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AltJ Value -&gt; Identity (AltJ Value)
forall a. a -&gt; Identity a
</span><span class="hs-identifier hs-var">Identity</span></span><span> </span><span class="annot"><span class="annottext">(AltJ Value -&gt; Identity (AltJ Value))
-&gt; AltJ Value -&gt; Identity (AltJ Value)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Value -&gt; AltJ Value
forall a. a -&gt; AltJ a
</span><span class="hs-identifier hs-var">Q.AltJ</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688184805"><span class="hs-identifier hs-var">stateValue</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1121"></span><span>        </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1122"></span><span>    </span><span class="annot"><span class="annottext">CatalogStateType
</span><a href="Hasura.RQL.Types.Metadata.html#CSTConsole"><span class="hs-identifier hs-var">CSTConsole</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1123"></span><span>      </span><span class="annot"><span class="annottext">(PGTxErr -&gt; QErr)
-&gt; Query -&gt; Identity (AltJ Value) -&gt; Bool -&gt; TxE QErr ()
forall (m :: * -&gt; *) r e.
(MonadIO m, ToPrepArgs r) =&gt;
(PGTxErr -&gt; e) -&gt; Query -&gt; r -&gt; Bool -&gt; TxET e m ()
</span><span class="hs-identifier hs-var">Q.unitQE</span></span><span>
</span><span id="line-1124"></span><span>        </span><span class="annot"><span class="annottext">PGTxErr -&gt; QErr
</span><a href="Hasura.Backends.Postgres.Execute.Types.html#defaultTxErrorHandler"><span class="hs-identifier hs-var">defaultTxErrorHandler</span></a></span><span>
</span><span id="line-1125"></span><span>        </span><span class="annot"><span class="">[Q.sql|
        UPDATE hdb_catalog.hdb_version
           SET console_state = $1
      |]</span></span><span>
</span><span id="line-1129"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AltJ Value -&gt; Identity (AltJ Value)
forall a. a -&gt; Identity a
</span><span class="hs-identifier hs-var">Identity</span></span><span> </span><span class="annot"><span class="annottext">(AltJ Value -&gt; Identity (AltJ Value))
-&gt; AltJ Value -&gt; Identity (AltJ Value)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Value -&gt; AltJ Value
forall a. a -&gt; AltJ a
</span><span class="hs-identifier hs-var">Q.AltJ</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688184805"><span class="hs-identifier hs-var">stateValue</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1130"></span><span>        </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1131"></span><span>
</span><span id="line-1132"></span><span class="hs-comment">-- | Each of the function in the type class is executed in a totally separate transaction.</span><span>
</span><span id="line-1133"></span><span class="hs-comment">--</span><span>
</span><span id="line-1134"></span><span class="hs-comment">-- To learn more about why the instance is derived as following, see Note [Generic MetadataStorageT transformer]</span><span>
</span><span id="line-1135"></span><span id="local-6989586621688184800"><span class="hs-keyword">instance</span><span> </span><span class="hs-pragma">{-# OVERLAPPING</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688184800"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Hasura.Metadata.Class.html#MonadMetadataStorage"><span class="hs-identifier hs-type">MonadMetadataStorage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Metadata.Class.html#MetadataStorageT"><span class="hs-identifier hs-type">MetadataStorageT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#PGMetadataStorageAppT"><span class="hs-identifier hs-type">PGMetadataStorageAppT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688184800"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1136"></span><span>  </span><span id="local-6989586621688184769"><span class="annot"><span class="annottext">fetchMetadataResourceVersion :: MetadataStorageT (PGMetadataStorageAppT m) MetadataResourceVersion
</span><a href="Hasura.Metadata.Class.html#fetchMetadataResourceVersion"><span class="hs-identifier hs-var hs-var hs-var hs-var">fetchMetadataResourceVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr MetadataResourceVersion
-&gt; MetadataStorageT
     (PGMetadataStorageAppT m) MetadataResourceVersion
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">TxE QErr MetadataResourceVersion
</span><a href="Hasura.RQL.DDL.Schema.Catalog.html#fetchMetadataResourceVersionFromCatalog"><span class="hs-identifier hs-var">fetchMetadataResourceVersionFromCatalog</span></a></span><span>
</span><span id="line-1137"></span><span>  </span><span id="local-6989586621688184766"><span class="annot"><span class="annottext">fetchMetadata :: MetadataStorageT
  (PGMetadataStorageAppT m) (Metadata, MetadataResourceVersion)
</span><a href="Hasura.Metadata.Class.html#fetchMetadata"><span class="hs-identifier hs-var hs-var hs-var hs-var">fetchMetadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr (Metadata, MetadataResourceVersion)
-&gt; MetadataStorageT
     (PGMetadataStorageAppT m) (Metadata, MetadataResourceVersion)
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">TxE QErr (Metadata, MetadataResourceVersion)
</span><a href="Hasura.RQL.DDL.Schema.Catalog.html#fetchMetadataAndResourceVersionFromCatalog"><span class="hs-identifier hs-var">fetchMetadataAndResourceVersionFromCatalog</span></a></span><span>
</span><span id="line-1138"></span><span>  </span><span id="local-6989586621688184763"><span class="annot"><span class="annottext">fetchMetadataNotifications :: MetadataResourceVersion
-&gt; InstanceId
-&gt; MetadataStorageT
     (PGMetadataStorageAppT m)
     [(MetadataResourceVersion, CacheInvalidations)]
</span><a href="Hasura.Metadata.Class.html#fetchMetadataNotifications"><span class="hs-identifier hs-var hs-var hs-var hs-var">fetchMetadataNotifications</span></a></span></span><span> </span><span id="local-6989586621688184761"><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621688184761"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621688184760"><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621688184760"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr [(MetadataResourceVersion, CacheInvalidations)]
-&gt; MetadataStorageT
     (PGMetadataStorageAppT m)
     [(MetadataResourceVersion, CacheInvalidations)]
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr [(MetadataResourceVersion, CacheInvalidations)]
 -&gt; MetadataStorageT
      (PGMetadataStorageAppT m)
      [(MetadataResourceVersion, CacheInvalidations)])
-&gt; TxE QErr [(MetadataResourceVersion, CacheInvalidations)]
-&gt; MetadataStorageT
     (PGMetadataStorageAppT m)
     [(MetadataResourceVersion, CacheInvalidations)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
-&gt; InstanceId
-&gt; TxE QErr [(MetadataResourceVersion, CacheInvalidations)]
</span><a href="Hasura.RQL.DDL.Schema.Catalog.html#fetchMetadataNotificationsFromCatalog"><span class="hs-identifier hs-var">fetchMetadataNotificationsFromCatalog</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621688184761"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621688184760"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1139"></span><span>  </span><span id="local-6989586621688184758"><span class="annot"><span class="annottext">setMetadata :: MetadataResourceVersion
-&gt; Metadata
-&gt; MetadataStorageT
     (PGMetadataStorageAppT m) MetadataResourceVersion
</span><a href="Hasura.Metadata.Class.html#setMetadata"><span class="hs-identifier hs-var hs-var hs-var hs-var">setMetadata</span></a></span></span><span> </span><span id="local-6989586621688184756"><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621688184756"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr MetadataResourceVersion
-&gt; MetadataStorageT
     (PGMetadataStorageAppT m) MetadataResourceVersion
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr MetadataResourceVersion
 -&gt; MetadataStorageT
      (PGMetadataStorageAppT m) MetadataResourceVersion)
-&gt; (Metadata -&gt; TxE QErr MetadataResourceVersion)
-&gt; Metadata
-&gt; MetadataStorageT
     (PGMetadataStorageAppT m) MetadataResourceVersion
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
-&gt; Metadata -&gt; TxE QErr MetadataResourceVersion
</span><a href="Hasura.RQL.DDL.Schema.Catalog.html#setMetadataInCatalog"><span class="hs-identifier hs-var">setMetadataInCatalog</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621688184756"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1140"></span><span>  </span><span id="local-6989586621688184754"><span class="annot"><span class="annottext">notifySchemaCacheSync :: MetadataResourceVersion
-&gt; InstanceId
-&gt; CacheInvalidations
-&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
</span><a href="Hasura.Metadata.Class.html#notifySchemaCacheSync"><span class="hs-identifier hs-var hs-var hs-var hs-var">notifySchemaCacheSync</span></a></span></span><span> </span><span id="local-6989586621688184752"><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621688184752"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621688184751"><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621688184751"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621688184750"><span class="annot"><span class="annottext">CacheInvalidations
</span><a href="#local-6989586621688184750"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ())
-&gt; TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
-&gt; InstanceId -&gt; CacheInvalidations -&gt; TxE QErr ()
</span><a href="Hasura.App.html#notifySchemaCacheSyncTx"><span class="hs-identifier hs-var">notifySchemaCacheSyncTx</span></a></span><span> </span><span class="annot"><span class="annottext">MetadataResourceVersion
</span><a href="#local-6989586621688184752"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceId
</span><a href="#local-6989586621688184751"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">CacheInvalidations
</span><a href="#local-6989586621688184750"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-1141"></span><span>  </span><span id="local-6989586621688184749"><span class="annot"><span class="annottext">getCatalogState :: MetadataStorageT (PGMetadataStorageAppT m) CatalogState
</span><a href="Hasura.Metadata.Class.html#getCatalogState"><span class="hs-identifier hs-var hs-var hs-var hs-var">getCatalogState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr CatalogState
-&gt; MetadataStorageT (PGMetadataStorageAppT m) CatalogState
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">TxE QErr CatalogState
</span><a href="Hasura.App.html#getCatalogStateTx"><span class="hs-identifier hs-var">getCatalogStateTx</span></a></span><span>
</span><span id="line-1142"></span><span>  </span><span id="local-6989586621688184747"><span class="annot"><span class="annottext">setCatalogState :: CatalogStateType
-&gt; Value -&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
</span><a href="Hasura.Metadata.Class.html#setCatalogState"><span class="hs-identifier hs-var hs-var hs-var hs-var">setCatalogState</span></a></span></span><span> </span><span id="local-6989586621688184745"><span class="annot"><span class="annottext">CatalogStateType
</span><a href="#local-6989586621688184745"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621688184744"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688184744"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ())
-&gt; TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CatalogStateType -&gt; Value -&gt; TxE QErr ()
</span><a href="Hasura.App.html#setCatalogStateTx"><span class="hs-identifier hs-var">setCatalogStateTx</span></a></span><span> </span><span class="annot"><span class="annottext">CatalogStateType
</span><a href="#local-6989586621688184745"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688184744"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1143"></span><span>
</span><span id="line-1144"></span><span>  </span><span id="local-6989586621688184743"><span class="annot"><span class="annottext">getDatabaseUid :: MetadataStorageT (PGMetadataStorageAppT m) Text
</span><a href="#local-6989586621688184743"><span class="hs-identifier hs-var hs-var hs-var hs-var">getDatabaseUid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxET QErr IO Text
-&gt; MetadataStorageT (PGMetadataStorageAppT m) Text
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">TxET QErr IO Text
</span><a href="Hasura.Server.Init.html#getDbId"><span class="hs-identifier hs-var">getDbId</span></a></span><span>
</span><span id="line-1145"></span><span>  </span><span id="local-6989586621688184741"><span class="annot"><span class="annottext">checkMetadataStorageHealth :: MetadataStorageT (PGMetadataStorageAppT m) Bool
</span><a href="Hasura.Metadata.Class.html#checkMetadataStorageHealth"><span class="hs-identifier hs-var hs-var hs-var hs-var">checkMetadataStorageHealth</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PGMetadataStorageAppT m PGPool
-&gt; MetadataStorageT (PGMetadataStorageAppT m) PGPool
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((PGPool, PGLogger) -&gt; PGPool) -&gt; PGMetadataStorageAppT m PGPool
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">(PGPool, PGLogger) -&gt; PGPool
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MetadataStorageT (PGMetadataStorageAppT m) PGPool
-&gt; (PGPool -&gt; MetadataStorageT (PGMetadataStorageAppT m) Bool)
-&gt; MetadataStorageT (PGMetadataStorageAppT m) Bool
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">PGPool -&gt; MetadataStorageT (PGMetadataStorageAppT m) Bool
forall (m :: * -&gt; *). MonadIO m =&gt; PGPool -&gt; m Bool
</span><a href="Hasura.Backends.Postgres.Connection.html#checkDbConnection"><span class="hs-identifier hs-var">checkDbConnection</span></a></span><span>
</span><span id="line-1146"></span><span>
</span><span id="line-1147"></span><span>  </span><span id="local-6989586621688184738"><span class="annot"><span class="annottext">getDeprivedCronTriggerStats :: [TriggerName]
-&gt; MetadataStorageT (PGMetadataStorageAppT m) [CronTriggerStats]
</span><a href="Hasura.Metadata.Class.html#getDeprivedCronTriggerStats"><span class="hs-identifier hs-var hs-var hs-var hs-var">getDeprivedCronTriggerStats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr [CronTriggerStats]
-&gt; MetadataStorageT (PGMetadataStorageAppT m) [CronTriggerStats]
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr [CronTriggerStats]
 -&gt; MetadataStorageT (PGMetadataStorageAppT m) [CronTriggerStats])
-&gt; ([TriggerName] -&gt; TxE QErr [CronTriggerStats])
-&gt; [TriggerName]
-&gt; MetadataStorageT (PGMetadataStorageAppT m) [CronTriggerStats]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[TriggerName] -&gt; TxE QErr [CronTriggerStats]
</span><a href="Hasura.Eventing.ScheduledTrigger.html#getDeprivedCronTriggerStatsTx"><span class="hs-identifier hs-var">getDeprivedCronTriggerStatsTx</span></a></span><span>
</span><span id="line-1148"></span><span>  </span><span id="local-6989586621688184735"><span class="annot"><span class="annottext">getScheduledEventsForDelivery :: MetadataStorageT
  (PGMetadataStorageAppT m) ([CronEvent], [OneOffScheduledEvent])
</span><a href="Hasura.Metadata.Class.html#getScheduledEventsForDelivery"><span class="hs-identifier hs-var hs-var hs-var hs-var">getScheduledEventsForDelivery</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr ([CronEvent], [OneOffScheduledEvent])
-&gt; MetadataStorageT
     (PGMetadataStorageAppT m) ([CronEvent], [OneOffScheduledEvent])
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">TxE QErr ([CronEvent], [OneOffScheduledEvent])
</span><a href="Hasura.Eventing.ScheduledTrigger.html#getScheduledEventsForDeliveryTx"><span class="hs-identifier hs-var">getScheduledEventsForDeliveryTx</span></a></span><span>
</span><span id="line-1149"></span><span>  </span><span id="local-6989586621688184732"><span class="annot"><span class="annottext">insertCronEvents :: [CronEventSeed] -&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
</span><a href="Hasura.Metadata.Class.html#insertCronEvents"><span class="hs-identifier hs-var hs-var hs-var hs-var">insertCronEvents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ())
-&gt; ([CronEventSeed] -&gt; TxE QErr ())
-&gt; [CronEventSeed]
-&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[CronEventSeed] -&gt; TxE QErr ()
</span><a href="Hasura.Eventing.ScheduledTrigger.html#insertCronEventsTx"><span class="hs-identifier hs-var">insertCronEventsTx</span></a></span><span>
</span><span id="line-1150"></span><span>  </span><span id="local-6989586621688184729"><span class="annot"><span class="annottext">insertOneOffScheduledEvent :: OneOffEvent
-&gt; MetadataStorageT (PGMetadataStorageAppT m) CronEventId
</span><a href="Hasura.Metadata.Class.html#insertOneOffScheduledEvent"><span class="hs-identifier hs-var hs-var hs-var hs-var">insertOneOffScheduledEvent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr CronEventId
-&gt; MetadataStorageT (PGMetadataStorageAppT m) CronEventId
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr CronEventId
 -&gt; MetadataStorageT (PGMetadataStorageAppT m) CronEventId)
-&gt; (OneOffEvent -&gt; TxE QErr CronEventId)
-&gt; OneOffEvent
-&gt; MetadataStorageT (PGMetadataStorageAppT m) CronEventId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">OneOffEvent -&gt; TxE QErr CronEventId
</span><a href="Hasura.Eventing.ScheduledTrigger.html#insertOneOffScheduledEventTx"><span class="hs-identifier hs-var">insertOneOffScheduledEventTx</span></a></span><span>
</span><span id="line-1151"></span><span>  </span><span id="local-6989586621688184726"><span class="annot"><span class="annottext">insertScheduledEventInvocation :: Invocation 'ScheduledType
-&gt; ScheduledEventType
-&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
</span><a href="Hasura.Metadata.Class.html#insertScheduledEventInvocation"><span class="hs-identifier hs-var hs-var hs-var hs-var">insertScheduledEventInvocation</span></a></span></span><span> </span><span id="local-6989586621688184724"><span class="annot"><span class="annottext">Invocation 'ScheduledType
</span><a href="#local-6989586621688184724"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621688184723"><span class="annot"><span class="annottext">ScheduledEventType
</span><a href="#local-6989586621688184723"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ())
-&gt; TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Invocation 'ScheduledType -&gt; ScheduledEventType -&gt; TxE QErr ()
</span><a href="Hasura.Eventing.ScheduledTrigger.html#insertInvocationTx"><span class="hs-identifier hs-var">insertInvocationTx</span></a></span><span> </span><span class="annot"><span class="annottext">Invocation 'ScheduledType
</span><a href="#local-6989586621688184724"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">ScheduledEventType
</span><a href="#local-6989586621688184723"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1152"></span><span>  </span><span id="local-6989586621688184721"><span class="annot"><span class="annottext">setScheduledEventOp :: CronEventId
-&gt; ScheduledEventOp
-&gt; ScheduledEventType
-&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
</span><a href="Hasura.Metadata.Class.html#setScheduledEventOp"><span class="hs-identifier hs-var hs-var hs-var hs-var">setScheduledEventOp</span></a></span></span><span> </span><span id="local-6989586621688184719"><span class="annot"><span class="annottext">CronEventId
</span><a href="#local-6989586621688184719"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621688184718"><span class="annot"><span class="annottext">ScheduledEventOp
</span><a href="#local-6989586621688184718"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621688184717"><span class="annot"><span class="annottext">ScheduledEventType
</span><a href="#local-6989586621688184717"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ())
-&gt; TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CronEventId
-&gt; ScheduledEventOp -&gt; ScheduledEventType -&gt; TxE QErr ()
</span><a href="Hasura.Eventing.ScheduledTrigger.html#setScheduledEventOpTx"><span class="hs-identifier hs-var">setScheduledEventOpTx</span></a></span><span> </span><span class="annot"><span class="annottext">CronEventId
</span><a href="#local-6989586621688184719"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">ScheduledEventOp
</span><a href="#local-6989586621688184718"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">ScheduledEventType
</span><a href="#local-6989586621688184717"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-1153"></span><span>  </span><span id="local-6989586621688184715"><span class="annot"><span class="annottext">unlockScheduledEvents :: ScheduledEventType
-&gt; [CronEventId] -&gt; MetadataStorageT (PGMetadataStorageAppT m) Int
</span><a href="Hasura.Metadata.Class.html#unlockScheduledEvents"><span class="hs-identifier hs-var hs-var hs-var hs-var">unlockScheduledEvents</span></a></span></span><span> </span><span id="local-6989586621688184713"><span class="annot"><span class="annottext">ScheduledEventType
</span><a href="#local-6989586621688184713"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621688184712"><span class="annot"><span class="annottext">[CronEventId]
</span><a href="#local-6989586621688184712"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr Int -&gt; MetadataStorageT (PGMetadataStorageAppT m) Int
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr Int -&gt; MetadataStorageT (PGMetadataStorageAppT m) Int)
-&gt; TxE QErr Int -&gt; MetadataStorageT (PGMetadataStorageAppT m) Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScheduledEventType -&gt; [CronEventId] -&gt; TxE QErr Int
</span><a href="Hasura.Eventing.ScheduledTrigger.html#unlockScheduledEventsTx"><span class="hs-identifier hs-var">unlockScheduledEventsTx</span></a></span><span> </span><span class="annot"><span class="annottext">ScheduledEventType
</span><a href="#local-6989586621688184713"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">[CronEventId]
</span><a href="#local-6989586621688184712"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1154"></span><span>  </span><span id="local-6989586621688184710"><span class="annot"><span class="annottext">unlockAllLockedScheduledEvents :: MetadataStorageT (PGMetadataStorageAppT m) ()
</span><a href="#local-6989586621688184710"><span class="hs-identifier hs-var hs-var hs-var hs-var">unlockAllLockedScheduledEvents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">TxE QErr ()
</span><a href="Hasura.Eventing.ScheduledTrigger.html#unlockAllLockedScheduledEventsTx"><span class="hs-identifier hs-var">unlockAllLockedScheduledEventsTx</span></a></span><span>
</span><span id="line-1155"></span><span>  </span><span id="local-6989586621688184708"><span class="annot"><span class="annottext">clearFutureCronEvents :: ClearCronEvents -&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
</span><a href="Hasura.Metadata.Class.html#clearFutureCronEvents"><span class="hs-identifier hs-var hs-var hs-var hs-var">clearFutureCronEvents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ())
-&gt; (ClearCronEvents -&gt; TxE QErr ())
-&gt; ClearCronEvents
-&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ClearCronEvents -&gt; TxE QErr ()
</span><a href="Hasura.Eventing.ScheduledTrigger.html#dropFutureCronEventsTx"><span class="hs-identifier hs-var">dropFutureCronEventsTx</span></a></span><span>
</span><span id="line-1156"></span><span>  </span><span id="local-6989586621688184705"><span class="annot"><span class="annottext">getOneOffScheduledEvents :: ScheduledEventPagination
-&gt; [ScheduledEventStatus]
-&gt; MetadataStorageT
     (PGMetadataStorageAppT m) (WithTotalCount [OneOffScheduledEvent])
</span><a href="Hasura.Metadata.Class.html#getOneOffScheduledEvents"><span class="hs-identifier hs-var hs-var hs-var hs-var">getOneOffScheduledEvents</span></a></span></span><span> </span><span id="local-6989586621688184703"><span class="annot"><span class="annottext">ScheduledEventPagination
</span><a href="#local-6989586621688184703"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621688184702"><span class="annot"><span class="annottext">[ScheduledEventStatus]
</span><a href="#local-6989586621688184702"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr (WithTotalCount [OneOffScheduledEvent])
-&gt; MetadataStorageT
     (PGMetadataStorageAppT m) (WithTotalCount [OneOffScheduledEvent])
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr (WithTotalCount [OneOffScheduledEvent])
 -&gt; MetadataStorageT
      (PGMetadataStorageAppT m) (WithTotalCount [OneOffScheduledEvent]))
-&gt; TxE QErr (WithTotalCount [OneOffScheduledEvent])
-&gt; MetadataStorageT
     (PGMetadataStorageAppT m) (WithTotalCount [OneOffScheduledEvent])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScheduledEventPagination
-&gt; [ScheduledEventStatus]
-&gt; TxE QErr (WithTotalCount [OneOffScheduledEvent])
</span><a href="Hasura.Eventing.ScheduledTrigger.html#getOneOffScheduledEventsTx"><span class="hs-identifier hs-var">getOneOffScheduledEventsTx</span></a></span><span> </span><span class="annot"><span class="annottext">ScheduledEventPagination
</span><a href="#local-6989586621688184703"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">[ScheduledEventStatus]
</span><a href="#local-6989586621688184702"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1157"></span><span>  </span><span id="local-6989586621688184700"><span class="annot"><span class="annottext">getCronEvents :: TriggerName
-&gt; ScheduledEventPagination
-&gt; [ScheduledEventStatus]
-&gt; MetadataStorageT
     (PGMetadataStorageAppT m) (WithTotalCount [CronEvent])
</span><a href="Hasura.Metadata.Class.html#getCronEvents"><span class="hs-identifier hs-var hs-var hs-var hs-var">getCronEvents</span></a></span></span><span> </span><span id="local-6989586621688184698"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621688184698"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621688184697"><span class="annot"><span class="annottext">ScheduledEventPagination
</span><a href="#local-6989586621688184697"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621688184696"><span class="annot"><span class="annottext">[ScheduledEventStatus]
</span><a href="#local-6989586621688184696"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr (WithTotalCount [CronEvent])
-&gt; MetadataStorageT
     (PGMetadataStorageAppT m) (WithTotalCount [CronEvent])
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr (WithTotalCount [CronEvent])
 -&gt; MetadataStorageT
      (PGMetadataStorageAppT m) (WithTotalCount [CronEvent]))
-&gt; TxE QErr (WithTotalCount [CronEvent])
-&gt; MetadataStorageT
     (PGMetadataStorageAppT m) (WithTotalCount [CronEvent])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TriggerName
-&gt; ScheduledEventPagination
-&gt; [ScheduledEventStatus]
-&gt; TxE QErr (WithTotalCount [CronEvent])
</span><a href="Hasura.Eventing.ScheduledTrigger.html#getCronEventsTx"><span class="hs-identifier hs-var">getCronEventsTx</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621688184698"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">ScheduledEventPagination
</span><a href="#local-6989586621688184697"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">[ScheduledEventStatus]
</span><a href="#local-6989586621688184696"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-1158"></span><span>  </span><span id="local-6989586621688184694"><span class="annot"><span class="annottext">getInvocations :: GetInvocationsBy
-&gt; ScheduledEventPagination
-&gt; MetadataStorageT
     (PGMetadataStorageAppT m)
     (WithTotalCount [ScheduledEventInvocation])
</span><a href="Hasura.Metadata.Class.html#getInvocations"><span class="hs-identifier hs-var hs-var hs-var hs-var">getInvocations</span></a></span></span><span> </span><span id="local-6989586621688184692"><span class="annot"><span class="annottext">GetInvocationsBy
</span><a href="#local-6989586621688184692"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621688184691"><span class="annot"><span class="annottext">ScheduledEventPagination
</span><a href="#local-6989586621688184691"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr (WithTotalCount [ScheduledEventInvocation])
-&gt; MetadataStorageT
     (PGMetadataStorageAppT m)
     (WithTotalCount [ScheduledEventInvocation])
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr (WithTotalCount [ScheduledEventInvocation])
 -&gt; MetadataStorageT
      (PGMetadataStorageAppT m)
      (WithTotalCount [ScheduledEventInvocation]))
-&gt; TxE QErr (WithTotalCount [ScheduledEventInvocation])
-&gt; MetadataStorageT
     (PGMetadataStorageAppT m)
     (WithTotalCount [ScheduledEventInvocation])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GetInvocationsBy
-&gt; ScheduledEventPagination
-&gt; TxE QErr (WithTotalCount [ScheduledEventInvocation])
</span><a href="Hasura.Eventing.ScheduledTrigger.html#getInvocationsTx"><span class="hs-identifier hs-var">getInvocationsTx</span></a></span><span> </span><span class="annot"><span class="annottext">GetInvocationsBy
</span><a href="#local-6989586621688184692"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">ScheduledEventPagination
</span><a href="#local-6989586621688184691"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1159"></span><span>  </span><span id="local-6989586621688184689"><span class="annot"><span class="annottext">deleteScheduledEvent :: CronEventId
-&gt; ScheduledEventType
-&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
</span><a href="Hasura.Metadata.Class.html#deleteScheduledEvent"><span class="hs-identifier hs-var hs-var hs-var hs-var">deleteScheduledEvent</span></a></span></span><span> </span><span id="local-6989586621688184687"><span class="annot"><span class="annottext">CronEventId
</span><a href="#local-6989586621688184687"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621688184686"><span class="annot"><span class="annottext">ScheduledEventType
</span><a href="#local-6989586621688184686"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ())
-&gt; TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CronEventId -&gt; ScheduledEventType -&gt; TxE QErr ()
</span><a href="Hasura.Eventing.ScheduledTrigger.html#deleteScheduledEventTx"><span class="hs-identifier hs-var">deleteScheduledEventTx</span></a></span><span> </span><span class="annot"><span class="annottext">CronEventId
</span><a href="#local-6989586621688184687"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">ScheduledEventType
</span><a href="#local-6989586621688184686"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1160"></span><span>
</span><span id="line-1161"></span><span>  </span><span id="local-6989586621688184684"><span class="annot"><span class="annottext">insertAction :: ActionName
-&gt; SessionVariables
-&gt; [Header]
-&gt; Value
-&gt; MetadataStorageT (PGMetadataStorageAppT m) ActionId
</span><a href="Hasura.Metadata.Class.html#insertAction"><span class="hs-identifier hs-var hs-var hs-var hs-var">insertAction</span></a></span></span><span> </span><span id="local-6989586621688184682"><span class="annot"><span class="annottext">ActionName
</span><a href="#local-6989586621688184682"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621688184681"><span class="annot"><span class="annottext">SessionVariables
</span><a href="#local-6989586621688184681"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621688184680"><span class="annot"><span class="annottext">[Header]
</span><a href="#local-6989586621688184680"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621688184679"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688184679"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr ActionId
-&gt; MetadataStorageT (PGMetadataStorageAppT m) ActionId
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr ActionId
 -&gt; MetadataStorageT (PGMetadataStorageAppT m) ActionId)
-&gt; TxE QErr ActionId
-&gt; MetadataStorageT (PGMetadataStorageAppT m) ActionId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ActionName
-&gt; SessionVariables -&gt; [Header] -&gt; Value -&gt; TxE QErr ActionId
</span><a href="Hasura.GraphQL.Execute.Action.html#insertActionTx"><span class="hs-identifier hs-var">insertActionTx</span></a></span><span> </span><span class="annot"><span class="annottext">ActionName
</span><a href="#local-6989586621688184682"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">SessionVariables
</span><a href="#local-6989586621688184681"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">[Header]
</span><a href="#local-6989586621688184680"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688184679"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-1162"></span><span>  </span><span id="local-6989586621688184677"><span class="annot"><span class="annottext">fetchUndeliveredActionEvents :: MetadataStorageT (PGMetadataStorageAppT m) [ActionLogItem]
</span><a href="Hasura.Metadata.Class.html#fetchUndeliveredActionEvents"><span class="hs-identifier hs-var hs-var hs-var hs-var">fetchUndeliveredActionEvents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr [ActionLogItem]
-&gt; MetadataStorageT (PGMetadataStorageAppT m) [ActionLogItem]
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">TxE QErr [ActionLogItem]
</span><a href="Hasura.GraphQL.Execute.Action.html#fetchUndeliveredActionEventsTx"><span class="hs-identifier hs-var">fetchUndeliveredActionEventsTx</span></a></span><span>
</span><span id="line-1163"></span><span>  </span><span id="local-6989586621688184674"><span class="annot"><span class="annottext">setActionStatus :: ActionId
-&gt; AsyncActionStatus
-&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
</span><a href="Hasura.Metadata.Class.html#setActionStatus"><span class="hs-identifier hs-var hs-var hs-var hs-var">setActionStatus</span></a></span></span><span> </span><span id="local-6989586621688184672"><span class="annot"><span class="annottext">ActionId
</span><a href="#local-6989586621688184672"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621688184671"><span class="annot"><span class="annottext">AsyncActionStatus
</span><a href="#local-6989586621688184671"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ())
-&gt; TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ActionId -&gt; AsyncActionStatus -&gt; TxE QErr ()
</span><a href="Hasura.GraphQL.Execute.Action.html#setActionStatusTx"><span class="hs-identifier hs-var">setActionStatusTx</span></a></span><span> </span><span class="annot"><span class="annottext">ActionId
</span><a href="#local-6989586621688184672"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">AsyncActionStatus
</span><a href="#local-6989586621688184671"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-1164"></span><span>  </span><span id="local-6989586621688184669"><span class="annot"><span class="annottext">fetchActionResponse :: ActionId
-&gt; MetadataStorageT (PGMetadataStorageAppT m) ActionLogResponse
</span><a href="Hasura.Metadata.Class.html#fetchActionResponse"><span class="hs-identifier hs-var hs-var hs-var hs-var">fetchActionResponse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr ActionLogResponse
-&gt; MetadataStorageT (PGMetadataStorageAppT m) ActionLogResponse
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr ActionLogResponse
 -&gt; MetadataStorageT (PGMetadataStorageAppT m) ActionLogResponse)
-&gt; (ActionId -&gt; TxE QErr ActionLogResponse)
-&gt; ActionId
-&gt; MetadataStorageT (PGMetadataStorageAppT m) ActionLogResponse
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ActionId -&gt; TxE QErr ActionLogResponse
</span><a href="Hasura.GraphQL.Execute.Action.html#fetchActionResponseTx"><span class="hs-identifier hs-var">fetchActionResponseTx</span></a></span><span>
</span><span id="line-1165"></span><span>  </span><span id="local-6989586621688184666"><span class="annot"><span class="annottext">clearActionData :: ActionName -&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
</span><a href="Hasura.Metadata.Class.html#clearActionData"><span class="hs-identifier hs-var hs-var hs-var hs-var">clearActionData</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ())
-&gt; (ActionName -&gt; TxE QErr ())
-&gt; ActionName
-&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ActionName -&gt; TxE QErr ()
</span><a href="Hasura.GraphQL.Execute.Action.html#clearActionDataTx"><span class="hs-identifier hs-var">clearActionDataTx</span></a></span><span>
</span><span id="line-1166"></span><span>  </span><span id="local-6989586621688184663"><span class="annot"><span class="annottext">setProcessingActionLogsToPending :: LockedActionIdArray
-&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
</span><a href="#local-6989586621688184663"><span class="hs-identifier hs-var hs-var hs-var hs-var">setProcessingActionLogsToPending</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TxE QErr a -&gt; MetadataStorageT (PGMetadataStorageAppT m) a
</span><a href="Hasura.App.html#runInSeparateTx"><span class="hs-identifier hs-var">runInSeparateTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; MetadataStorageT (PGMetadataStorageAppT m) ())
-&gt; (LockedActionIdArray -&gt; TxE QErr ())
-&gt; LockedActionIdArray
-&gt; MetadataStorageT (PGMetadataStorageAppT m) ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LockedActionIdArray -&gt; TxE QErr ()
</span><a href="Hasura.GraphQL.Execute.Action.html#setProcessingActionLogsToPendingTx"><span class="hs-identifier hs-var">setProcessingActionLogsToPendingTx</span></a></span></span><span>
</span><span id="line-1167"></span><span>
</span><span id="line-1168"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621688184643"><span id="local-6989586621688184645"><span id="local-6989586621688184647"><span id="local-6989586621688184649"><span id="local-6989586621688184651"><span id="local-6989586621688184653"><span id="local-6989586621688184655"><span id="local-6989586621688184657"><span id="local-6989586621688184659"><span class="annot"><a href="Hasura.Metadata.Class.html#MonadMetadataStorageQueryAPI"><span class="hs-identifier hs-type">MonadMetadataStorageQueryAPI</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Metadata.Class.html#MetadataStorageT"><span class="hs-identifier hs-type">MetadataStorageT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.App.html#PGMetadataStorageAppT"><span class="hs-identifier hs-type">PGMetadataStorageAppT</span></a></span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Cache.Common.html#CacheBuild"><span class="hs-identifier hs-type">CacheBuild</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span></span></span></span></span></span></span><span>
</span><span id="line-1169"></span><span>
</span><span id="line-1170"></span><span class="hs-comment">--- helper functions ---</span><span>
</span><span id="line-1171"></span><span>
</span><span id="line-1172"></span><span class="annot"><a href="Hasura.App.html#mkConsoleHTML"><span class="hs-identifier hs-type">mkConsoleHTML</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.Auth.html#AuthMode"><span class="hs-identifier hs-type">AuthMode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-1173"></span><span id="mkConsoleHTML"><span class="annot"><span class="annottext">mkConsoleHTML :: Text -&gt; AuthMode -&gt; Bool -&gt; Maybe Text -&gt; Either String Text
</span><a href="Hasura.App.html#mkConsoleHTML"><span class="hs-identifier hs-var hs-var">mkConsoleHTML</span></a></span></span><span> </span><span id="local-6989586621688184641"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688184641"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span id="local-6989586621688184640"><span class="annot"><span class="annottext">AuthMode
</span><a href="#local-6989586621688184640"><span class="hs-identifier hs-var">authMode</span></a></span></span><span> </span><span id="local-6989586621688184639"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688184639"><span class="hs-identifier hs-var">enableTelemetry</span></a></span></span><span> </span><span id="local-6989586621688184638"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621688184638"><span class="hs-identifier hs-var">consoleAssetsDir</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1174"></span><span>  </span><span class="annot"><span class="annottext">Template -&gt; Value -&gt; Either String Text
</span><a href="Hasura.Server.App.html#renderHtmlTemplate"><span class="hs-identifier hs-var">renderHtmlTemplate</span></a></span><span> </span><span class="annot"><span class="annottext">Template
</span><a href="#local-6989586621688184636"><span class="hs-identifier hs-var">consoleTmplt</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; Either String Text) -&gt; Value -&gt; Either String Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1175"></span><span>    </span><span class="hs-comment">-- variables required to render the template</span><span>
</span><span id="line-1176"></span><span>    </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">A.object</span></span><span>
</span><span id="line-1177"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;isAdminSecretSet&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">A..=</span></span><span> </span><span class="annot"><span class="annottext">AuthMode -&gt; Text
</span><a href="Hasura.Server.App.html#isAdminSecretSet"><span class="hs-identifier hs-var">isAdminSecretSet</span></a></span><span> </span><span class="annot"><span class="annottext">AuthMode
</span><a href="#local-6989586621688184640"><span class="hs-identifier hs-var">authMode</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1178"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;consolePath&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">A..=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688184632"><span class="hs-identifier hs-var">consolePath</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1179"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;enableTelemetry&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">A..=</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Text
</span><a href="Hasura.Server.App.html#boolToText"><span class="hs-identifier hs-var">boolToText</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688184639"><span class="hs-identifier hs-var">enableTelemetry</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1180"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;cdnAssets&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">A..=</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Text
</span><a href="Hasura.Server.App.html#boolToText"><span class="hs-identifier hs-var">boolToText</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Text -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isNothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621688184638"><span class="hs-identifier hs-var">consoleAssetsDir</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1181"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;assetsVersion&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">A..=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="Hasura.Server.Version.html#consoleAssetsVersion"><span class="hs-identifier hs-var">consoleAssetsVersion</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1182"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;serverVersion&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Version -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">A..=</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Hasura.Server.Version.html#currentVersion"><span class="hs-identifier hs-var">currentVersion</span></a></span><span>
</span><span id="line-1183"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-1184"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1185"></span><span>    </span><span id="local-6989586621688184632"><span class="annot"><span class="annottext">consolePath :: Text
</span><a href="#local-6989586621688184632"><span class="hs-identifier hs-var hs-var">consolePath</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688184641"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1186"></span><span>      </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;/console&quot;</span></span><span>
</span><span id="line-1187"></span><span>      </span><span id="local-6989586621688184627"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688184627"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;/console/&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688184627"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-1188"></span><span>
</span><span id="line-1189"></span><span>    </span><span id="local-6989586621688184636"><span class="annot"><span class="annottext">consoleTmplt :: Template
</span><a href="#local-6989586621688184636"><span class="hs-identifier hs-var hs-var">consoleTmplt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$(</span><span class="hs-identifier">makeRelativeToProject</span><span> </span><span class="hs-string">&quot;src-rsr/console.html&quot;</span><span> </span><span class="hs-operator">&gt;&gt;=</span><span> </span><span class="hs-identifier">M.embedSingleTemplate</span><span class="hs-special">)</span><span>
</span><span id="line-1190"></span><span>
</span><span id="line-1191"></span><span class="annot"><a href="Hasura.App.html#telemetryNotice"><span class="hs-identifier hs-type">telemetryNotice</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-1192"></span><span id="telemetryNotice"><span class="annot"><span class="annottext">telemetryNotice :: String
</span><a href="Hasura.App.html#telemetryNotice"><span class="hs-identifier hs-var hs-var">telemetryNotice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1193"></span><span>  </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Help us improve Hasura! The graphql-engine server collects anonymized &quot;</span></span><span>
</span><span id="line-1194"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;usage stats which allows us to keep improving Hasura at warp speed. &quot;</span></span><span>
</span><span id="line-1195"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;To read more or opt-out, visit https://hasura.io/docs/latest/graphql/core/guides/telemetry.html&quot;</span></span><span>
</span><span id="line-1196"></span><span>
</span><span id="line-1197"></span><span class="annot"><a href="Hasura.App.html#mkPgSourceResolver"><span class="hs-identifier hs-type">mkPgSourceResolver</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Q.PGLogger</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#SourceResolver"><span class="hs-identifier hs-type">SourceResolver</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#Vanilla"><span class="hs-identifier hs-type">Vanilla</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1198"></span><span id="mkPgSourceResolver"><span class="annot"><span class="annottext">mkPgSourceResolver :: PGLogger -&gt; SourceResolver ('Postgres 'Vanilla)
</span><a href="Hasura.App.html#mkPgSourceResolver"><span class="hs-identifier hs-var hs-var">mkPgSourceResolver</span></a></span></span><span> </span><span id="local-6989586621688184621"><span class="annot"><span class="annottext">PGLogger
</span><a href="#local-6989586621688184621"><span class="hs-identifier hs-var">pgLogger</span></a></span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688184620"><span class="annot"><span class="annottext">SourceConnConfiguration ('Postgres 'Vanilla)
</span><a href="#local-6989586621688184620"><span class="hs-identifier hs-var">config</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT QErr IO PGSourceConfig -&gt; IO (Either QErr PGSourceConfig)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1199"></span><span>  </span><span id="local-6989586621688184619"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688184619"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Environment -&gt; ExceptT QErr IO Environment
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">IO Environment
</span><a href="Data.Environment.html#getEnvironment"><span class="hs-identifier hs-var">Env.getEnvironment</span></a></span><span>
</span><span id="line-1200"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.html#PostgresSourceConnInfo"><span class="hs-identifier hs-type">PostgresSourceConnInfo</span></a></span><span> </span><span id="local-6989586621688184617"><span class="annot"><span class="annottext">UrlConf
</span><a href="#local-6989586621688184617"><span class="hs-identifier hs-var">urlConf</span></a></span></span><span> </span><span id="local-6989586621688184616"><span class="annot"><span class="annottext">Maybe PostgresPoolSettings
</span><a href="#local-6989586621688184616"><span class="hs-identifier hs-var">poolSettings</span></a></span></span><span> </span><span id="local-6989586621688184615"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688184615"><span class="hs-identifier hs-var">allowPrepare</span></a></span></span><span> </span><span id="local-6989586621688184614"><span class="annot"><span class="annottext">TxIsolation
</span><a href="#local-6989586621688184614"><span class="hs-identifier hs-var">isoLevel</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe (PGClientCerts CertVar CertVar)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PostgresConnConfiguration -&gt; PostgresSourceConnInfo
</span><a href="Hasura.Backends.Postgres.Connection.html#_pccConnectionInfo"><span class="hs-identifier hs-var hs-var">_pccConnectionInfo</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConnConfiguration ('Postgres 'Vanilla)
PostgresConnConfiguration
</span><a href="#local-6989586621688184620"><span class="hs-identifier hs-var">config</span></a></span><span>
</span><span id="line-1201"></span><span>  </span><span class="hs-comment">-- If the user does not provide values for the pool settings, then use the default values</span><span>
</span><span id="line-1202"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688184612"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688184612"><span class="hs-identifier hs-var">maxConns</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688184611"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688184611"><span class="hs-identifier hs-var">idleTimeout</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688184610"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688184610"><span class="hs-identifier hs-var">retries</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe PostgresPoolSettings
-&gt; DefaultPostgresPoolSettings -&gt; (Int, Int, Int)
</span><a href="Hasura.Backends.Postgres.Connection.html#getDefaultPGPoolSettingIfNotExists"><span class="hs-identifier hs-var">getDefaultPGPoolSettingIfNotExists</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe PostgresPoolSettings
</span><a href="#local-6989586621688184616"><span class="hs-identifier hs-var">poolSettings</span></a></span><span> </span><span class="annot"><span class="annottext">DefaultPostgresPoolSettings
</span><a href="Hasura.Backends.Postgres.Connection.html#defaultPostgresPoolSettings"><span class="hs-identifier hs-var">defaultPostgresPoolSettings</span></a></span><span>
</span><span id="line-1203"></span><span>  </span><span id="local-6989586621688184607"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688184607"><span class="hs-identifier hs-var">urlText</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Environment -&gt; UrlConf -&gt; ExceptT QErr IO Text
forall (m :: * -&gt; *).
MonadError QErr m =&gt;
Environment -&gt; UrlConf -&gt; m Text
</span><a href="Hasura.RQL.Types.Common.html#resolveUrlConf"><span class="hs-identifier hs-var">resolveUrlConf</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688184619"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">UrlConf
</span><a href="#local-6989586621688184617"><span class="hs-identifier hs-var">urlConf</span></a></span><span>
</span><span id="line-1204"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688184606"><span class="annot"><span class="annottext">connInfo :: ConnInfo
</span><a href="#local-6989586621688184606"><span class="hs-identifier hs-var hs-var">connInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ConnDetails -&gt; ConnInfo
</span><span class="hs-identifier hs-var">Q.ConnInfo</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688184610"><span class="hs-identifier hs-var">retries</span></a></span><span> </span><span class="annot"><span class="annottext">(ConnDetails -&gt; ConnInfo) -&gt; ConnDetails -&gt; ConnInfo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ConnDetails
</span><span class="hs-identifier hs-var">Q.CDDatabaseURI</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ConnDetails) -&gt; ByteString -&gt; ConnDetails
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; ByteString
</span><a href="Hasura.Prelude.html#txtToBs"><span class="hs-identifier hs-var">txtToBs</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688184607"><span class="hs-identifier hs-var">urlText</span></a></span><span>
</span><span id="line-1205"></span><span>      </span><span id="local-6989586621688184605"><span class="annot"><span class="annottext">connParams :: ConnParams
</span><a href="#local-6989586621688184605"><span class="hs-identifier hs-var hs-var">connParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1206"></span><span>        </span><span class="annot"><span class="annottext">ConnParams
</span><span class="hs-identifier hs-var">Q.defaultConnParams</span></span><span>
</span><span id="line-1207"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">cpIdleTime :: Int
</span><span class="hs-identifier hs-var">Q.cpIdleTime</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688184611"><span class="hs-identifier hs-var">idleTimeout</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1208"></span><span>            </span><span class="annot"><span class="annottext">cpConns :: Int
</span><span class="hs-identifier hs-var">Q.cpConns</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688184612"><span class="hs-identifier hs-var">maxConns</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1209"></span><span>            </span><span class="annot"><span class="annottext">cpAllowPrepare :: Bool
</span><span class="hs-identifier hs-var">Q.cpAllowPrepare</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688184615"><span class="hs-identifier hs-var">allowPrepare</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1210"></span><span>            </span><span class="annot"><span class="annottext">cpMbLifetime :: Maybe NominalDiffTime
</span><span class="hs-identifier hs-var">Q.cpMbLifetime</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PostgresPoolSettings -&gt; Maybe NominalDiffTime
</span><a href="Hasura.Backends.Postgres.Connection.html#_ppsConnectionLifetime"><span class="hs-identifier hs-var hs-var">_ppsConnectionLifetime</span></a></span><span> </span><span class="annot"><span class="annottext">(PostgresPoolSettings -&gt; Maybe NominalDiffTime)
-&gt; Maybe PostgresPoolSettings -&gt; Maybe NominalDiffTime
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe PostgresPoolSettings
</span><a href="#local-6989586621688184616"><span class="hs-identifier hs-var">poolSettings</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1211"></span><span>            </span><span class="annot"><span class="annottext">cpTimeout :: Maybe NominalDiffTime
</span><span class="hs-identifier hs-var">Q.cpTimeout</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PostgresPoolSettings -&gt; Maybe NominalDiffTime
</span><a href="Hasura.Backends.Postgres.Connection.html#_ppsPoolTimeout"><span class="hs-identifier hs-var hs-var">_ppsPoolTimeout</span></a></span><span> </span><span class="annot"><span class="annottext">(PostgresPoolSettings -&gt; Maybe NominalDiffTime)
-&gt; Maybe PostgresPoolSettings -&gt; Maybe NominalDiffTime
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe PostgresPoolSettings
</span><a href="#local-6989586621688184616"><span class="hs-identifier hs-var">poolSettings</span></a></span><span>
</span><span id="line-1212"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-1213"></span><span>  </span><span id="local-6989586621688184603"><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621688184603"><span class="hs-identifier hs-var">pgPool</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO PGPool -&gt; ExceptT QErr IO PGPool
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO PGPool -&gt; ExceptT QErr IO PGPool)
-&gt; IO PGPool -&gt; ExceptT QErr IO PGPool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConnInfo -&gt; ConnParams -&gt; PGLogger -&gt; IO PGPool
</span><span class="hs-identifier hs-var">Q.initPGPool</span></span><span> </span><span class="annot"><span class="annottext">ConnInfo
</span><a href="#local-6989586621688184606"><span class="hs-identifier hs-var">connInfo</span></a></span><span> </span><span class="annot"><span class="annottext">ConnParams
</span><a href="#local-6989586621688184605"><span class="hs-identifier hs-var">connParams</span></a></span><span> </span><span class="annot"><span class="annottext">PGLogger
</span><a href="#local-6989586621688184621"><span class="hs-identifier hs-var">pgLogger</span></a></span><span>
</span><span id="line-1214"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688184602"><span class="annot"><span class="annottext">pgExecCtx :: PGExecCtx
</span><a href="#local-6989586621688184602"><span class="hs-identifier hs-var hs-var">pgExecCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxIsolation -&gt; PGPool -&gt; PGExecCtx
</span><a href="Hasura.Backends.Postgres.Execute.Types.html#mkPGExecCtx"><span class="hs-identifier hs-var">mkPGExecCtx</span></a></span><span> </span><span class="annot"><span class="annottext">TxIsolation
</span><a href="#local-6989586621688184614"><span class="hs-identifier hs-var">isoLevel</span></a></span><span> </span><span class="annot"><span class="annottext">PGPool
</span><a href="#local-6989586621688184603"><span class="hs-identifier hs-var">pgPool</span></a></span><span>
</span><span id="line-1215"></span><span>  </span><span class="annot"><span class="annottext">PGSourceConfig -&gt; ExceptT QErr IO PGSourceConfig
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(PGSourceConfig -&gt; ExceptT QErr IO PGSourceConfig)
-&gt; PGSourceConfig -&gt; ExceptT QErr IO PGSourceConfig
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PGExecCtx
-&gt; ConnInfo -&gt; Maybe (NonEmpty ConnInfo) -&gt; IO () -&gt; PGSourceConfig
</span><a href="Hasura.Backends.Postgres.Execute.Types.html#PGSourceConfig"><span class="hs-identifier hs-var">PGSourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">PGExecCtx
</span><a href="#local-6989586621688184602"><span class="hs-identifier hs-var">pgExecCtx</span></a></span><span> </span><span class="annot"><span class="annottext">ConnInfo
</span><a href="#local-6989586621688184606"><span class="hs-identifier hs-var">connInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (NonEmpty ConnInfo)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">IO ()
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-1216"></span><span>
</span><span id="line-1217"></span><span class="annot"><a href="Hasura.App.html#mkMSSQLSourceResolver"><span class="hs-identifier hs-type">mkMSSQLSourceResolver</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#SourceResolver"><span class="hs-identifier hs-type">SourceResolver</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#MSSQL"><span class="hs-identifier hs-type">MSSQL</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1218"></span><span id="mkMSSQLSourceResolver"><span class="annot"><span class="annottext">mkMSSQLSourceResolver :: SourceResolver 'MSSQL
</span><a href="Hasura.App.html#mkMSSQLSourceResolver"><span class="hs-identifier hs-var hs-var">mkMSSQLSourceResolver</span></a></span></span><span> </span><span id="local-6989586621688184599"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688184599"><span class="hs-identifier hs-var">_name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLConnConfiguration"><span class="hs-identifier hs-type">MSSQLConnConfiguration</span></a></span><span> </span><span id="local-6989586621688184597"><span class="annot"><a href="#local-6989586621688184597"><span class="hs-identifier hs-var">connInfo</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT QErr IO MSSQLSourceConfig
-&gt; IO (Either QErr MSSQLSourceConfig)
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1219"></span><span>  </span><span id="local-6989586621688184596"><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688184596"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Environment -&gt; ExceptT QErr IO Environment
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">IO Environment
</span><a href="Data.Environment.html#getEnvironment"><span class="hs-identifier hs-var">Env.getEnvironment</span></a></span><span>
</span><span id="line-1220"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621688184595"><span class="annot"><span class="annottext">ConnectionString
</span><a href="#local-6989586621688184595"><span class="hs-identifier hs-var">connString</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688184594"><span class="annot"><span class="annottext">MSSQLPool
</span><a href="#local-6989586621688184594"><span class="hs-identifier hs-var">mssqlPool</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MSSQLConnectionInfo
-&gt; Environment -&gt; ExceptT QErr IO (ConnectionString, MSSQLPool)
forall (m :: * -&gt; *).
(MonadIO m, QErrM m) =&gt;
MSSQLConnectionInfo
-&gt; Environment -&gt; m (ConnectionString, MSSQLPool)
</span><a href="Hasura.Backends.MSSQL.Connection.html#createMSSQLPool"><span class="hs-identifier hs-var">createMSSQLPool</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLConnectionInfo
</span><a href="#local-6989586621688184597"><span class="hs-identifier hs-var">connInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Environment
</span><a href="#local-6989586621688184596"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1221"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688184592"><span class="annot"><span class="annottext">mssqlExecCtx :: MSSQLExecCtx
</span><a href="#local-6989586621688184592"><span class="hs-identifier hs-var hs-var">mssqlExecCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MSSQLPool -&gt; MSSQLExecCtx
</span><a href="Hasura.Backends.MSSQL.Connection.html#mkMSSQLExecCtx"><span class="hs-identifier hs-var">mkMSSQLExecCtx</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLPool
</span><a href="#local-6989586621688184594"><span class="hs-identifier hs-var">mssqlPool</span></a></span><span>
</span><span id="line-1222"></span><span>  </span><span class="annot"><span class="annottext">MSSQLSourceConfig -&gt; ExceptT QErr IO MSSQLSourceConfig
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(MSSQLSourceConfig -&gt; ExceptT QErr IO MSSQLSourceConfig)
-&gt; MSSQLSourceConfig -&gt; ExceptT QErr IO MSSQLSourceConfig
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConnectionString -&gt; MSSQLExecCtx -&gt; MSSQLSourceConfig
</span><a href="Hasura.Backends.MSSQL.Connection.html#MSSQLSourceConfig"><span class="hs-identifier hs-var">MSSQLSourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">ConnectionString
</span><a href="#local-6989586621688184595"><span class="hs-identifier hs-var">connString</span></a></span><span> </span><span class="annot"><span class="annottext">MSSQLExecCtx
</span><a href="#local-6989586621688184592"><span class="hs-identifier hs-var">mssqlExecCtx</span></a></span><span>
</span><span id="line-1223"></span></pre></body></html>