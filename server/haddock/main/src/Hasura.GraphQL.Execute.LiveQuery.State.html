<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | Top-level management of live query poller threads. The implementation of the polling itself is</span><span>
</span><span id="line-2"></span><span class="hs-comment">-- in &quot;Hasura.GraphQL.Execute.LiveQuery.Poll&quot;. See &quot;Hasura.GraphQL.Execute.LiveQuery&quot; for high-level</span><span>
</span><span id="line-3"></span><span class="hs-comment">-- details.</span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hasura.GraphQL.Execute.LiveQuery.State</span><span>
</span><span id="line-5"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveQueriesState"><span class="hs-identifier">LiveQueriesState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#initLiveQueriesState"><span class="hs-identifier">initLiveQueriesState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#dumpLiveQueriesState"><span class="hs-identifier">dumpLiveQueriesState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveQueryId"><span class="hs-identifier">LiveQueryId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#LiveQueryPostPollHook"><span class="hs-identifier">LiveQueryPostPollHook</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#addLiveQuery"><span class="hs-identifier">addLiveQuery</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#removeLiveQuery"><span class="hs-identifier">removeLiveQuery</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveAsyncActionQueryOnSource"><span class="hs-identifier">LiveAsyncActionQueryOnSource</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveAsyncActionQueryWithNoRelationships"><span class="hs-identifier">LiveAsyncActionQueryWithNoRelationships</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveAsyncActionQuery"><span class="hs-identifier">LiveAsyncActionQuery</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#AsyncActionQueryLive"><span class="hs-identifier">AsyncActionQueryLive</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#AsyncActionSubscriptionState"><span class="hs-identifier">AsyncActionSubscriptionState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#addAsyncActionLiveQuery"><span class="hs-identifier">addAsyncActionLiveQuery</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#removeAsyncActionLiveQuery"><span class="hs-identifier">removeAsyncActionLiveQuery</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">where</span><span>
</span><span id="line-21"></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Control.Concurrent.Extended.html"><span class="hs-identifier">Control.Concurrent.Extended</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Control.Concurrent.Extended.html#forkImmortal"><span class="hs-identifier">forkImmortal</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.Concurrent.Extended.html#sleep"><span class="hs-identifier">sleep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">STM</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">mask_</span></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Immortal</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Immortal</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Aeson.Extended.html"><span class="hs-identifier">Data.Aeson.Extended</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">J</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.String</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Text.Extended.html"><span class="hs-identifier">Data.Text.Extended</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.UUID.V4</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">UUID</span></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.AssertNF.CPP.html"><span class="hs-identifier">GHC.AssertNF.CPP</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Backend.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Backend</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Options.html"><span class="hs-identifier">Hasura.GraphQL.Execute.LiveQuery.Options</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Plan.html"><span class="hs-identifier">Hasura.GraphQL.Execute.LiveQuery.Plan</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html"><span class="hs-identifier">Hasura.GraphQL.Execute.LiveQuery.Poll</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html"><span class="hs-identifier">Hasura.GraphQL.Execute.LiveQuery.TMap</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TMap</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.ParameterizedQueryHash.html"><span class="hs-identifier">Hasura.GraphQL.ParameterizedQueryHash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.ParameterizedQueryHash.html#ParameterizedQueryHash"><span class="hs-identifier">ParameterizedQueryHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.Backend.html"><span class="hs-identifier">Hasura.GraphQL.Transport.Backend</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html"><span class="hs-identifier">Hasura.GraphQL.Transport.HTTP.Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#OperationName"><span class="hs-identifier">OperationName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html"><span class="hs-identifier">Hasura.GraphQL.Transport.WebSocket.Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#OperationId"><span class="hs-identifier">OperationId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Logging.html"><span class="hs-identifier">Hasura.Logging</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">L</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Prelude.html"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Action.html"><span class="hs-identifier">Hasura.RQL.Types.Action</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html"><span class="hs-identifier">Hasura.RQL.Types.Common</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier">SourceName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#unNonNegativeDiffTime"><span class="hs-identifier">unNonNegativeDiffTime</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Metrics.html"><span class="hs-identifier">Hasura.Server.Metrics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Metrics.html#ServerMetrics"><span class="hs-identifier">ServerMetrics</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html"><span class="hs-identifier">Hasura.Server.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#RequestId"><span class="hs-identifier">RequestId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">StmContainers.Map</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">STMMap</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Metrics.Gauge</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">EKG.Gauge</span></span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="hs-comment">-- | The top-level datatype that holds the state for all active live queries.</span><span>
</span><span id="line-51"></span><span class="hs-comment">--</span><span>
</span><span id="line-52"></span><span class="hs-comment">-- NOTE!: This must be kept consistent with a websocket connection's</span><span>
</span><span id="line-53"></span><span class="hs-comment">-- 'OperationMap', in 'onClose' and 'onStart'.</span><span>
</span><span id="line-54"></span><span class="hs-keyword">data</span><span> </span><span id="LiveQueriesState"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveQueriesState"><span class="hs-identifier hs-var">LiveQueriesState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="LiveQueriesState"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveQueriesState"><span class="hs-identifier hs-var">LiveQueriesState</span></a></span></span><span>
</span><span id="line-55"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_lqsOptions"><span class="annot"><span class="annottext">LiveQueriesState -&gt; LiveQueriesOptions
</span><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#_lqsOptions"><span class="hs-identifier hs-var hs-var">_lqsOptions</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Options.html#LiveQueriesOptions"><span class="hs-identifier hs-type">LiveQueriesOptions</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-56"></span><span>    </span><span id="_lqsLiveQueryMap"><span class="annot"><span class="annottext">LiveQueriesState -&gt; PollerMap
</span><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#_lqsLiveQueryMap"><span class="hs-identifier hs-var hs-var">_lqsLiveQueryMap</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerMap"><span class="hs-identifier hs-type">PollerMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-comment">-- | A hook function which is run after each fetch cycle</span><span>
</span><span id="line-58"></span><span>    </span><span id="_lqsPostPollHook"><span class="annot"><span class="annottext">LiveQueriesState -&gt; LiveQueryPostPollHook
</span><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#_lqsPostPollHook"><span class="hs-identifier hs-var hs-var">_lqsPostPollHook</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#LiveQueryPostPollHook"><span class="hs-identifier hs-type">LiveQueryPostPollHook</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-59"></span><span>    </span><span id="_lqsAsyncActions"><span class="annot"><span class="annottext">LiveQueriesState -&gt; AsyncActionSubscriptionState
</span><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#_lqsAsyncActions"><span class="hs-identifier hs-var hs-var">_lqsAsyncActions</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#AsyncActionSubscriptionState"><span class="hs-identifier hs-type">AsyncActionSubscriptionState</span></a></span><span>
</span><span id="line-60"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#initLiveQueriesState"><span class="hs-identifier hs-type">initLiveQueriesState</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-63"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Options.html#LiveQueriesOptions"><span class="hs-identifier hs-type">LiveQueriesOptions</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#LiveQueryPostPollHook"><span class="hs-identifier hs-type">LiveQueryPostPollHook</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveQueriesState"><span class="hs-identifier hs-type">LiveQueriesState</span></a></span><span>
</span><span id="line-64"></span><span id="initLiveQueriesState"><span class="annot"><span class="annottext">initLiveQueriesState :: LiveQueriesOptions -&gt; LiveQueryPostPollHook -&gt; IO LiveQueriesState
</span><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#initLiveQueriesState"><span class="hs-identifier hs-var hs-var">initLiveQueriesState</span></a></span></span><span> </span><span id="local-6989586621688119785"><span class="annot"><span class="annottext">LiveQueriesOptions
</span><a href="#local-6989586621688119785"><span class="hs-identifier hs-var">options</span></a></span></span><span> </span><span id="local-6989586621688119784"><span class="annot"><span class="annottext">LiveQueryPostPollHook
</span><a href="#local-6989586621688119784"><span class="hs-identifier hs-var">pollHook</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-65"></span><span>  </span><span class="annot"><span class="annottext">STM LiveQueriesState -&gt; IO LiveQueriesState
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM LiveQueriesState -&gt; IO LiveQueriesState)
-&gt; STM LiveQueriesState -&gt; IO LiveQueriesState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-66"></span><span>    </span><span class="annot"><span class="annottext">LiveQueriesOptions
-&gt; PollerMap
-&gt; LiveQueryPostPollHook
-&gt; AsyncActionSubscriptionState
-&gt; LiveQueriesState
</span><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveQueriesState"><span class="hs-identifier hs-var">LiveQueriesState</span></a></span><span> </span><span class="annot"><span class="annottext">LiveQueriesOptions
</span><a href="#local-6989586621688119785"><span class="hs-identifier hs-var">options</span></a></span><span> </span><span class="annot"><span class="annottext">(PollerMap
 -&gt; LiveQueryPostPollHook
 -&gt; AsyncActionSubscriptionState
 -&gt; LiveQueriesState)
-&gt; STM PollerMap
-&gt; STM
     (LiveQueryPostPollHook
      -&gt; AsyncActionSubscriptionState -&gt; LiveQueriesState)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">STM PollerMap
forall key value. STM (Map key value)
</span><span class="hs-identifier hs-var">STMMap.new</span></span><span> </span><span class="annot"><span class="annottext">STM
  (LiveQueryPostPollHook
   -&gt; AsyncActionSubscriptionState -&gt; LiveQueriesState)
-&gt; STM LiveQueryPostPollHook
-&gt; STM (AsyncActionSubscriptionState -&gt; LiveQueriesState)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">LiveQueryPostPollHook -&gt; STM LiveQueryPostPollHook
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">LiveQueryPostPollHook
</span><a href="#local-6989586621688119784"><span class="hs-identifier hs-var">pollHook</span></a></span><span> </span><span class="annot"><span class="annottext">STM (AsyncActionSubscriptionState -&gt; LiveQueriesState)
-&gt; STM AsyncActionSubscriptionState -&gt; STM LiveQueriesState
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">STM AsyncActionSubscriptionState
forall k v. STM (TMap k v)
</span><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#new"><span class="hs-identifier hs-var">TMap.new</span></a></span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#dumpLiveQueriesState"><span class="hs-identifier hs-type">dumpLiveQueriesState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveQueriesState"><span class="hs-identifier hs-type">LiveQueriesState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span>
</span><span id="line-69"></span><span id="dumpLiveQueriesState"><span class="annot"><span class="annottext">dumpLiveQueriesState :: Bool -&gt; LiveQueriesState -&gt; IO Value
</span><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#dumpLiveQueriesState"><span class="hs-identifier hs-var hs-var">dumpLiveQueriesState</span></a></span></span><span> </span><span id="local-6989586621688119779"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688119779"><span class="hs-identifier hs-var">extended</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveQueriesState"><span class="hs-identifier hs-type">LiveQueriesState</span></a></span><span> </span><span id="local-6989586621688119778"><span class="annot"><span class="annottext">LiveQueriesOptions
</span><a href="#local-6989586621688119778"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621688119777"><span class="annot"><span class="annottext">PollerMap
</span><a href="#local-6989586621688119777"><span class="hs-identifier hs-var">lqMap</span></a></span></span><span> </span><span class="annot"><span class="annottext">LiveQueryPostPollHook
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">AsyncActionSubscriptionState
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-70"></span><span>  </span><span id="local-6989586621688119776"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688119776"><span class="hs-identifier hs-var">lqMapJ</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; PollerMap -&gt; IO Value
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#dumpPollerMap"><span class="hs-identifier hs-var">dumpPollerMap</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688119779"><span class="hs-identifier hs-var">extended</span></a></span><span> </span><span class="annot"><span class="annottext">PollerMap
</span><a href="#local-6989586621688119777"><span class="hs-identifier hs-var">lqMap</span></a></span><span>
</span><span id="line-71"></span><span>  </span><span class="annot"><span class="annottext">Value -&gt; IO Value
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; IO Value) -&gt; Value -&gt; IO Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-72"></span><span>    </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">J.object</span></span><span>
</span><span id="line-73"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;options&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; LiveQueriesOptions -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">LiveQueriesOptions
</span><a href="#local-6989586621688119778"><span class="hs-identifier hs-var">opts</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-74"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;live_queries_map&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Value -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688119776"><span class="hs-identifier hs-var">lqMapJ</span></a></span><span>
</span><span id="line-75"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span class="hs-keyword">data</span><span> </span><span id="LiveQueryId"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveQueryId"><span class="hs-identifier hs-var">LiveQueryId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="LiveQueryId"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveQueryId"><span class="hs-identifier hs-var">LiveQueryId</span></a></span></span><span>
</span><span id="line-78"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_lqiPoller"><span class="annot"><span class="annottext">LiveQueryId -&gt; PollerKey
</span><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#_lqiPoller"><span class="hs-identifier hs-var hs-var">_lqiPoller</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerKey"><span class="hs-identifier hs-type">PollerKey</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-79"></span><span>    </span><span id="_lqiCohort"><span class="annot"><span class="annottext">LiveQueryId -&gt; CohortKey
</span><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#_lqiCohort"><span class="hs-identifier hs-var hs-var">_lqiCohort</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#CohortKey"><span class="hs-identifier hs-type">CohortKey</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-80"></span><span>    </span><span id="_lqiSubscriber"><span class="annot"><span class="annottext">LiveQueryId -&gt; SubscriberId
</span><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#_lqiSubscriber"><span class="hs-identifier hs-var hs-var">_lqiSubscriber</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberId"><span class="hs-identifier hs-type">SubscriberId</span></a></span><span>
</span><span id="line-81"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-82"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688119763"><span id="local-6989586621688119765"><span id="local-6989586621688119767"><span class="annot"><span class="annottext">Int -&gt; LiveQueryId -&gt; ShowS
[LiveQueryId] -&gt; ShowS
LiveQueryId -&gt; String
(Int -&gt; LiveQueryId -&gt; ShowS)
-&gt; (LiveQueryId -&gt; String)
-&gt; ([LiveQueryId] -&gt; ShowS)
-&gt; Show LiveQueryId
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [LiveQueryId] -&gt; ShowS
$cshowList :: [LiveQueryId] -&gt; ShowS
show :: LiveQueryId -&gt; String
$cshow :: LiveQueryId -&gt; String
showsPrec :: Int -&gt; LiveQueryId -&gt; ShowS
$cshowsPrec :: Int -&gt; LiveQueryId -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#addLiveQuery"><span class="hs-identifier hs-type">addLiveQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688119761"><span class="annot"><a href="#local-6989586621688119761"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-86"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Transport.Backend.html#BackendTransport"><span class="hs-identifier hs-type">BackendTransport</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688119761"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-87"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">L.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-88"></span><span>  </span><span class="annot"><a href="Hasura.Server.Metrics.html#ServerMetrics"><span class="hs-identifier hs-type">ServerMetrics</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-89"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberMetadata"><span class="hs-identifier hs-type">SubscriberMetadata</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-90"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveQueriesState"><span class="hs-identifier hs-type">LiveQueriesState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-91"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-92"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.ParameterizedQueryHash.html#ParameterizedQueryHash"><span class="hs-identifier hs-type">ParameterizedQueryHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-comment">-- | operation name of the query</span><span>
</span><span id="line-94"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#OperationName"><span class="hs-identifier hs-type">OperationName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-95"></span><span>  </span><span class="annot"><a href="Hasura.Server.Types.html#RequestId"><span class="hs-identifier hs-type">RequestId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-96"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Plan.html#LiveQueryPlan"><span class="hs-identifier hs-type">LiveQueryPlan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688119761"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.Backend.html#MultiplexedQuery"><span class="hs-identifier hs-type">MultiplexedQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688119761"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-97"></span><span>  </span><span class="hs-comment">-- | the action to be executed when result changes</span><span>
</span><span id="line-98"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#OnChange"><span class="hs-identifier hs-type">OnChange</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-99"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveQueryId"><span class="hs-identifier hs-type">LiveQueryId</span></a></span><span>
</span><span id="line-100"></span><span id="addLiveQuery"><span class="annot"><span class="annottext">addLiveQuery :: Logger Hasura
-&gt; ServerMetrics
-&gt; SubscriberMetadata
-&gt; LiveQueriesState
-&gt; SourceName
-&gt; ParameterizedQueryHash
-&gt; Maybe OperationName
-&gt; RequestId
-&gt; LiveQueryPlan b (MultiplexedQuery b)
-&gt; OnChange
-&gt; IO LiveQueryId
</span><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#addLiveQuery"><span class="hs-identifier hs-var hs-var">addLiveQuery</span></a></span></span><span>
</span><span id="line-101"></span><span>  </span><span id="local-6989586621688119760"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688119760"><span class="hs-identifier hs-var">logger</span></a></span></span><span>
</span><span id="line-102"></span><span>  </span><span id="local-6989586621688119759"><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688119759"><span class="hs-identifier hs-var">serverMetrics</span></a></span></span><span>
</span><span id="line-103"></span><span>  </span><span id="local-6989586621688119758"><span class="annot"><span class="annottext">SubscriberMetadata
</span><a href="#local-6989586621688119758"><span class="hs-identifier hs-var">subscriberMetadata</span></a></span></span><span>
</span><span id="line-104"></span><span>  </span><span id="local-6989586621688119757"><span class="annot"><span class="annottext">LiveQueriesState
</span><a href="#local-6989586621688119757"><span class="hs-identifier hs-var">lqState</span></a></span></span><span>
</span><span id="line-105"></span><span>  </span><span id="local-6989586621688119756"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688119756"><span class="hs-identifier hs-var">source</span></a></span></span><span>
</span><span id="line-106"></span><span>  </span><span id="local-6989586621688119755"><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621688119755"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span></span><span>
</span><span id="line-107"></span><span>  </span><span id="local-6989586621688119754"><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688119754"><span class="hs-identifier hs-var">operationName</span></a></span></span><span>
</span><span id="line-108"></span><span>  </span><span id="local-6989586621688119753"><span class="annot"><span class="annottext">RequestId
</span><a href="#local-6989586621688119753"><span class="hs-identifier hs-var">requestId</span></a></span></span><span>
</span><span id="line-109"></span><span>  </span><span id="local-6989586621688119752"><span class="annot"><span class="annottext">LiveQueryPlan b (MultiplexedQuery b)
</span><a href="#local-6989586621688119752"><span class="hs-identifier hs-var">plan</span></a></span></span><span>
</span><span id="line-110"></span><span>  </span><span id="local-6989586621688119751"><span class="annot"><span class="annottext">OnChange
</span><a href="#local-6989586621688119751"><span class="hs-identifier hs-var">onResultAction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-111"></span><span>    </span><span class="hs-comment">-- CAREFUL!: It's absolutely crucial that we can't throw any exceptions here!</span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span>    </span><span class="hs-comment">-- disposable UUIDs:</span><span>
</span><span id="line-114"></span><span>    </span><span id="local-6989586621688119750"><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621688119750"><span class="hs-identifier hs-var">cohortId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO CohortId
forall (m :: * -&gt; *). MonadIO m =&gt; m CohortId
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Plan.html#newCohortId"><span class="hs-identifier hs-var">newCohortId</span></a></span><span>
</span><span id="line-115"></span><span>    </span><span id="local-6989586621688119748"><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621688119748"><span class="hs-identifier hs-var">subscriberId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO SubscriberId
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#newSubscriberId"><span class="hs-identifier hs-var">newSubscriberId</span></a></span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621688119746"><span class="annot"><span class="annottext">subscriber :: Subscriber
</span><a href="#local-6989586621688119746"><span class="hs-identifier hs-var hs-var">subscriber</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubscriberId
-&gt; SubscriberMetadata
-&gt; RequestId
-&gt; Maybe OperationName
-&gt; OnChange
-&gt; Subscriber
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#Subscriber"><span class="hs-identifier hs-var">Subscriber</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621688119748"><span class="hs-identifier hs-var">subscriberId</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberMetadata
</span><a href="#local-6989586621688119758"><span class="hs-identifier hs-var">subscriberMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">RequestId
</span><a href="#local-6989586621688119753"><span class="hs-identifier hs-var">requestId</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688119754"><span class="hs-identifier hs-var">operationName</span></a></span><span> </span><span class="annot"><span class="annottext">OnChange
</span><a href="#local-6989586621688119751"><span class="hs-identifier hs-var">onResultAction</span></a></span><span>
</span><span id="line-118"></span><span>
</span><span id="line-119"></span><span>    </span><span class="annot"><span class="annottext">String
String -&gt; Subscriber -&gt; IO ()
forall a. String -&gt; a -&gt; IO ()
</span><span class="hs-var">$assertNFHere</span></span><span> </span><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688119746"><span class="hs-identifier hs-var">subscriber</span></a></span><span> </span><span class="hs-comment">-- so we don't write thunks to mutable vars</span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span>    </span><span class="hs-comment">-- a handler is returned only when it is newly created</span><span>
</span><span id="line-122"></span><span>    </span><span id="local-6989586621688119743"><span class="annot"><span class="annottext">Maybe Poller
</span><a href="#local-6989586621688119743"><span class="hs-identifier hs-var">handlerM</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-123"></span><span>      </span><span class="annot"><span class="annottext">STM (Maybe Poller) -&gt; IO (Maybe Poller)
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM (Maybe Poller) -&gt; IO (Maybe Poller))
-&gt; STM (Maybe Poller) -&gt; IO (Maybe Poller)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-124"></span><span>        </span><span class="annot"><span class="annottext">PollerKey -&gt; PollerMap -&gt; STM (Maybe Poller)
forall key value.
(Eq key, Hashable key) =&gt;
key -&gt; Map key value -&gt; STM (Maybe value)
</span><span class="hs-identifier hs-var">STMMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">PollerKey
</span><a href="#local-6989586621688119741"><span class="hs-identifier hs-var">handlerId</span></a></span><span> </span><span class="annot"><span class="annottext">PollerMap
</span><a href="#local-6989586621688119740"><span class="hs-identifier hs-var">lqMap</span></a></span><span> </span><span class="annot"><span class="annottext">STM (Maybe Poller)
-&gt; (Maybe Poller -&gt; STM (Maybe Poller)) -&gt; STM (Maybe Poller)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-125"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621688119739"><span class="annot"><span class="annottext">Poller
</span><a href="#local-6989586621688119739"><span class="hs-identifier hs-var">handler</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-126"></span><span>            </span><span class="annot"><span class="annottext">CohortKey -&gt; TMap CohortKey Cohort -&gt; STM (Maybe Cohort)
forall k v. (Eq k, Hashable k) =&gt; k -&gt; TMap k v -&gt; STM (Maybe v)
</span><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#lookup"><span class="hs-identifier hs-var">TMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">CohortKey
</span><a href="#local-6989586621688119737"><span class="hs-identifier hs-var">cohortKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Poller -&gt; TMap CohortKey Cohort
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pCohorts"><span class="hs-identifier hs-var hs-var">_pCohorts</span></a></span><span> </span><span class="annot"><span class="annottext">Poller
</span><a href="#local-6989586621688119739"><span class="hs-identifier hs-var">handler</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">STM (Maybe Cohort) -&gt; (Maybe Cohort -&gt; STM ()) -&gt; STM ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-127"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621688119735"><span class="annot"><span class="annottext">Cohort
</span><a href="#local-6989586621688119735"><span class="hs-identifier hs-var">cohort</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Subscriber -&gt; Cohort -&gt; STM ()
</span><a href="#local-6989586621688119734"><span class="hs-identifier hs-var">addToCohort</span></a></span><span> </span><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688119746"><span class="hs-identifier hs-var">subscriber</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort
</span><a href="#local-6989586621688119735"><span class="hs-identifier hs-var">cohort</span></a></span><span>
</span><span id="line-128"></span><span>              </span><span class="annot"><span class="annottext">Maybe Cohort
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Subscriber -&gt; CohortId -&gt; Poller -&gt; STM ()
</span><a href="#local-6989586621688119733"><span class="hs-identifier hs-var">addToPoller</span></a></span><span> </span><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688119746"><span class="hs-identifier hs-var">subscriber</span></a></span><span> </span><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621688119750"><span class="hs-identifier hs-var">cohortId</span></a></span><span> </span><span class="annot"><span class="annottext">Poller
</span><a href="#local-6989586621688119739"><span class="hs-identifier hs-var">handler</span></a></span><span>
</span><span id="line-129"></span><span>            </span><span class="annot"><span class="annottext">Maybe Poller -&gt; STM (Maybe Poller)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe Poller
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-130"></span><span>          </span><span class="annot"><span class="annottext">Maybe Poller
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-131"></span><span>            </span><span class="hs-glyph">!</span><span id="local-6989586621688119732"><span class="annot"><span class="annottext">Poller
</span><a href="#local-6989586621688119732"><span class="hs-identifier hs-var">poller</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM Poller
</span><a href="#local-6989586621688119731"><span class="hs-identifier hs-var">newPoller</span></a></span><span>
</span><span id="line-132"></span><span>            </span><span class="annot"><span class="annottext">Subscriber -&gt; CohortId -&gt; Poller -&gt; STM ()
</span><a href="#local-6989586621688119733"><span class="hs-identifier hs-var">addToPoller</span></a></span><span> </span><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688119746"><span class="hs-identifier hs-var">subscriber</span></a></span><span> </span><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621688119750"><span class="hs-identifier hs-var">cohortId</span></a></span><span> </span><span class="annot"><span class="annottext">Poller
</span><a href="#local-6989586621688119732"><span class="hs-identifier hs-var">poller</span></a></span><span>
</span><span id="line-133"></span><span>            </span><span class="annot"><span class="annottext">Poller -&gt; PollerKey -&gt; PollerMap -&gt; STM ()
forall key value.
(Eq key, Hashable key) =&gt;
value -&gt; key -&gt; Map key value -&gt; STM ()
</span><span class="hs-identifier hs-var">STMMap.insert</span></span><span> </span><span class="annot"><span class="annottext">Poller
</span><a href="#local-6989586621688119732"><span class="hs-identifier hs-var">poller</span></a></span><span> </span><span class="annot"><span class="annottext">PollerKey
</span><a href="#local-6989586621688119741"><span class="hs-identifier hs-var">handlerId</span></a></span><span> </span><span class="annot"><span class="annottext">PollerMap
</span><a href="#local-6989586621688119740"><span class="hs-identifier hs-var">lqMap</span></a></span><span>
</span><span id="line-134"></span><span>            </span><span class="annot"><span class="annottext">Maybe Poller -&gt; STM (Maybe Poller)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Poller -&gt; STM (Maybe Poller))
-&gt; Maybe Poller -&gt; STM (Maybe Poller)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Poller -&gt; Maybe Poller
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Poller
</span><a href="#local-6989586621688119732"><span class="hs-identifier hs-var">poller</span></a></span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span>    </span><span class="hs-comment">-- we can then attach a polling thread if it is new the livequery can only be</span><span>
</span><span id="line-137"></span><span>    </span><span class="hs-comment">-- cancelled after putTMVar</span><span>
</span><span id="line-138"></span><span>    </span><span class="annot"><span class="annottext">Maybe Poller -&gt; (Poller -&gt; IO ()) -&gt; IO ()
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Maybe a -&gt; (a -&gt; m ()) -&gt; m ()
</span><a href="Hasura.Prelude.html#onJust"><span class="hs-identifier hs-var">onJust</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Poller
</span><a href="#local-6989586621688119743"><span class="hs-identifier hs-var">handlerM</span></a></span><span> </span><span class="annot"><span class="annottext">((Poller -&gt; IO ()) -&gt; IO ()) -&gt; (Poller -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688119728"><span class="annot"><span class="annottext">Poller
</span><a href="#local-6989586621688119728"><span class="hs-identifier hs-var">handler</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-139"></span><span>      </span><span id="local-6989586621688119727"><span class="annot"><span class="annottext">PollerId
</span><a href="#local-6989586621688119727"><span class="hs-identifier hs-var">pollerId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UUID -&gt; PollerId
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerId"><span class="hs-identifier hs-var">PollerId</span></a></span><span> </span><span class="annot"><span class="annottext">(UUID -&gt; PollerId) -&gt; IO UUID -&gt; IO PollerId
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO UUID
</span><span class="hs-identifier hs-var">UUID.nextRandom</span></span><span>
</span><span id="line-140"></span><span>      </span><span id="local-6989586621688119724"><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621688119724"><span class="hs-identifier hs-var">threadRef</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Logger Hasura -&gt; IO Void -&gt; IO Thread
forall (m :: * -&gt; *).
ForkableMonadIO m =&gt;
String -&gt; Logger Hasura -&gt; m Void -&gt; m Thread
</span><a href="Control.Concurrent.Extended.html#forkImmortal"><span class="hs-identifier hs-var">forkImmortal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;pollQuery.&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">PollerId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">PollerId
</span><a href="#local-6989586621688119727"><span class="hs-identifier hs-var">pollerId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688119760"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(IO Void -&gt; IO Thread) -&gt; IO Void -&gt; IO Thread
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-141"></span><span>        </span><span class="annot"><span class="annottext">IO () -&gt; IO Void
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">forever</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO Void) -&gt; IO () -&gt; IO Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-142"></span><span>          </span><span class="annot"><span class="annottext">PollerId
-&gt; LiveQueriesOptions
-&gt; (SourceName, SourceConfig b)
-&gt; RoleName
-&gt; ParameterizedQueryHash
-&gt; MultiplexedQuery b
-&gt; TMap CohortKey Cohort
-&gt; LiveQueryPostPollHook
-&gt; IO ()
forall (b :: BackendType).
BackendTransport b =&gt;
PollerId
-&gt; LiveQueriesOptions
-&gt; (SourceName, SourceConfig b)
-&gt; RoleName
-&gt; ParameterizedQueryHash
-&gt; MultiplexedQuery b
-&gt; TMap CohortKey Cohort
-&gt; LiveQueryPostPollHook
-&gt; IO ()
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#pollQuery"><span class="hs-identifier hs-var">pollQuery</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688119761"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">PollerId
</span><a href="#local-6989586621688119727"><span class="hs-identifier hs-var">pollerId</span></a></span><span> </span><span class="annot"><span class="annottext">LiveQueriesOptions
</span><a href="#local-6989586621688119720"><span class="hs-identifier hs-var">lqOpts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688119756"><span class="hs-identifier hs-var">source</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688119719"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688119718"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621688119755"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span><span> </span><span class="annot"><span class="annottext">MultiplexedQuery b
</span><a href="#local-6989586621688119717"><span class="hs-identifier hs-var">query</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Poller -&gt; TMap CohortKey Cohort
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pCohorts"><span class="hs-identifier hs-var hs-var">_pCohorts</span></a></span><span> </span><span class="annot"><span class="annottext">Poller
</span><a href="#local-6989586621688119728"><span class="hs-identifier hs-var">handler</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LiveQueryPostPollHook
</span><a href="#local-6989586621688119716"><span class="hs-identifier hs-var">postPollHook</span></a></span><span>
</span><span id="line-143"></span><span>          </span><span class="annot"><span class="annottext">DiffTime -&gt; IO ()
</span><a href="Control.Concurrent.Extended.html#sleep"><span class="hs-identifier hs-var">sleep</span></a></span><span> </span><span class="annot"><span class="annottext">(DiffTime -&gt; IO ()) -&gt; DiffTime -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NonNegativeDiffTime -&gt; DiffTime
</span><a href="Hasura.RQL.Types.Common.html#unNonNegativeDiffTime"><span class="hs-identifier hs-var hs-var">unNonNegativeDiffTime</span></a></span><span> </span><span class="annot"><span class="annottext">(NonNegativeDiffTime -&gt; DiffTime)
-&gt; NonNegativeDiffTime -&gt; DiffTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RefetchInterval -&gt; NonNegativeDiffTime
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Options.html#unRefetchInterval"><span class="hs-identifier hs-var hs-var">unRefetchInterval</span></a></span><span> </span><span class="annot"><span class="annottext">RefetchInterval
</span><a href="#local-6989586621688119714"><span class="hs-identifier hs-var">refetchInterval</span></a></span><span>
</span><span id="line-144"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621688119713"><span class="annot"><span class="annottext">pState :: PollerIOState
</span><a href="#local-6989586621688119713"><span class="hs-identifier hs-var hs-var">pState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Thread -&gt; PollerId -&gt; PollerIOState
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerIOState"><span class="hs-identifier hs-var">PollerIOState</span></a></span><span> </span><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621688119724"><span class="hs-identifier hs-var">threadRef</span></a></span><span> </span><span class="annot"><span class="annottext">PollerId
</span><a href="#local-6989586621688119727"><span class="hs-identifier hs-var">pollerId</span></a></span><span>
</span><span id="line-145"></span><span>      </span><span class="annot"><span class="annottext">String
String -&gt; PollerIOState -&gt; IO ()
forall a. String -&gt; a -&gt; IO ()
</span><span class="hs-var">$assertNFHere</span></span><span> </span><span class="annot"><span class="annottext">PollerIOState
</span><a href="#local-6989586621688119713"><span class="hs-identifier hs-var">pState</span></a></span><span> </span><span class="hs-comment">-- so we don't write thunks to mutable vars</span><span>
</span><span id="line-146"></span><span>      </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar PollerIOState -&gt; PollerIOState -&gt; STM ()
forall a. TMVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">STM.putTMVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Poller -&gt; TMVar PollerIOState
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pIOState"><span class="hs-identifier hs-var hs-var">_pIOState</span></a></span><span> </span><span class="annot"><span class="annottext">Poller
</span><a href="#local-6989586621688119728"><span class="hs-identifier hs-var">handler</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PollerIOState
</span><a href="#local-6989586621688119713"><span class="hs-identifier hs-var">pState</span></a></span><span>
</span><span id="line-147"></span><span>
</span><span id="line-148"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><span class="hs-identifier hs-var">EKG.Gauge.inc</span></span><span> </span><span class="annot"><span class="annottext">(Gauge -&gt; IO ()) -&gt; Gauge -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerMetrics -&gt; Gauge
</span><a href="Hasura.Server.Metrics.html#smActiveSubscriptions"><span class="hs-identifier hs-var hs-var">smActiveSubscriptions</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688119759"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span>
</span><span id="line-149"></span><span>
</span><span id="line-150"></span><span>    </span><span class="annot"><span class="annottext">LiveQueryId -&gt; IO LiveQueryId
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(LiveQueryId -&gt; IO LiveQueryId) -&gt; LiveQueryId -&gt; IO LiveQueryId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PollerKey -&gt; CohortKey -&gt; SubscriberId -&gt; LiveQueryId
</span><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveQueryId"><span class="hs-identifier hs-var">LiveQueryId</span></a></span><span> </span><span class="annot"><span class="annottext">PollerKey
</span><a href="#local-6989586621688119741"><span class="hs-identifier hs-var">handlerId</span></a></span><span> </span><span class="annot"><span class="annottext">CohortKey
</span><a href="#local-6989586621688119737"><span class="hs-identifier hs-var">cohortKey</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621688119748"><span class="hs-identifier hs-var">subscriberId</span></a></span><span>
</span><span id="line-151"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-152"></span><span>      </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveQueriesState"><span class="hs-identifier hs-type">LiveQueriesState</span></a></span><span> </span><span id="local-6989586621688119720"><span class="annot"><span class="annottext">LiveQueriesOptions
</span><a href="#local-6989586621688119720"><span class="hs-identifier hs-var">lqOpts</span></a></span></span><span> </span><span id="local-6989586621688119740"><span class="annot"><span class="annottext">PollerMap
</span><a href="#local-6989586621688119740"><span class="hs-identifier hs-var">lqMap</span></a></span></span><span> </span><span id="local-6989586621688119716"><span class="annot"><span class="annottext">LiveQueryPostPollHook
</span><a href="#local-6989586621688119716"><span class="hs-identifier hs-var">postPollHook</span></a></span></span><span> </span><span class="annot"><span class="annottext">AsyncActionSubscriptionState
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiveQueriesState
</span><a href="#local-6989586621688119757"><span class="hs-identifier hs-var">lqState</span></a></span><span>
</span><span id="line-153"></span><span>      </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Options.html#LiveQueriesOptions"><span class="hs-identifier hs-type">LiveQueriesOptions</span></a></span><span> </span><span class="annot"><span class="annottext">BatchSize
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688119714"><span class="annot"><span class="annottext">RefetchInterval
</span><a href="#local-6989586621688119714"><span class="hs-identifier hs-var">refetchInterval</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiveQueriesOptions
</span><a href="#local-6989586621688119720"><span class="hs-identifier hs-var">lqOpts</span></a></span><span>
</span><span id="line-154"></span><span>      </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Plan.html#LiveQueryPlan"><span class="hs-identifier hs-type">LiveQueryPlan</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Plan.html#ParameterizedLiveQueryPlan"><span class="hs-identifier hs-type">ParameterizedLiveQueryPlan</span></a></span><span> </span><span id="local-6989586621688119718"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688119718"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span id="local-6989586621688119717"><span class="annot"><span class="annottext">MultiplexedQuery b
</span><a href="#local-6989586621688119717"><span class="hs-identifier hs-var">query</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621688119719"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688119719"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span id="local-6989586621688119737"><span class="annot"><span class="annottext">CohortKey
</span><a href="#local-6989586621688119737"><span class="hs-identifier hs-var">cohortKey</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe Name
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiveQueryPlan b (MultiplexedQuery b)
</span><a href="#local-6989586621688119752"><span class="hs-identifier hs-var">plan</span></a></span><span>
</span><span id="line-155"></span><span>
</span><span id="line-156"></span><span>      </span><span id="local-6989586621688119741"><span class="annot"><span class="annottext">handlerId :: PollerKey
</span><a href="#local-6989586621688119741"><span class="hs-identifier hs-var hs-var">handlerId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; RoleName -&gt; Text -&gt; PollerKey
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerKey"><span class="hs-identifier hs-var">PollerKey</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688119756"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688119718"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; PollerKey) -&gt; Text -&gt; PollerKey
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MultiplexedQuery b -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">MultiplexedQuery b
</span><a href="#local-6989586621688119717"><span class="hs-identifier hs-var">query</span></a></span><span>
</span><span id="line-157"></span><span>
</span><span id="line-158"></span><span>      </span><span id="local-6989586621688119734"><span class="annot"><span class="annottext">addToCohort :: Subscriber -&gt; Cohort -&gt; STM ()
</span><a href="#local-6989586621688119734"><span class="hs-identifier hs-var hs-var">addToCohort</span></a></span></span><span> </span><span id="local-6989586621688119701"><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688119701"><span class="hs-identifier hs-var">subscriber</span></a></span></span><span> </span><span id="local-6989586621688119700"><span class="annot"><span class="annottext">Cohort
</span><a href="#local-6989586621688119700"><span class="hs-identifier hs-var">handlerC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-159"></span><span>        </span><span class="annot"><span class="annottext">Subscriber
-&gt; SubscriberId -&gt; TMap SubscriberId Subscriber -&gt; STM ()
forall k v. (Eq k, Hashable k) =&gt; v -&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#insert"><span class="hs-identifier hs-var">TMap.insert</span></a></span><span> </span><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688119701"><span class="hs-identifier hs-var">subscriber</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Subscriber -&gt; SubscriberId
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_sId"><span class="hs-identifier hs-var hs-var">_sId</span></a></span><span> </span><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688119701"><span class="hs-identifier hs-var">subscriber</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TMap SubscriberId Subscriber -&gt; STM ())
-&gt; TMap SubscriberId Subscriber -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Cohort -&gt; TMap SubscriberId Subscriber
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_cNewSubscribers"><span class="hs-identifier hs-var hs-var">_cNewSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort
</span><a href="#local-6989586621688119700"><span class="hs-identifier hs-var">handlerC</span></a></span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span>      </span><span id="local-6989586621688119733"><span class="annot"><span class="annottext">addToPoller :: Subscriber -&gt; CohortId -&gt; Poller -&gt; STM ()
</span><a href="#local-6989586621688119733"><span class="hs-identifier hs-var hs-var">addToPoller</span></a></span></span><span> </span><span id="local-6989586621688119696"><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688119696"><span class="hs-identifier hs-var">subscriber</span></a></span></span><span> </span><span id="local-6989586621688119695"><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621688119695"><span class="hs-identifier hs-var">cohortId</span></a></span></span><span> </span><span id="local-6989586621688119694"><span class="annot"><span class="annottext">Poller
</span><a href="#local-6989586621688119694"><span class="hs-identifier hs-var">handler</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-162"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621688119693"><span class="annot"><span class="annottext">Cohort
</span><a href="#local-6989586621688119693"><span class="hs-identifier hs-var">newCohort</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CohortId
-&gt; TVar (Maybe ResponseHash)
-&gt; TMap SubscriberId Subscriber
-&gt; TMap SubscriberId Subscriber
-&gt; Cohort
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#Cohort"><span class="hs-identifier hs-var">Cohort</span></a></span><span> </span><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621688119695"><span class="hs-identifier hs-var">cohortId</span></a></span><span> </span><span class="annot"><span class="annottext">(TVar (Maybe ResponseHash)
 -&gt; TMap SubscriberId Subscriber
 -&gt; TMap SubscriberId Subscriber
 -&gt; Cohort)
-&gt; STM (TVar (Maybe ResponseHash))
-&gt; STM
     (TMap SubscriberId Subscriber
      -&gt; TMap SubscriberId Subscriber -&gt; Cohort)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash -&gt; STM (TVar (Maybe ResponseHash))
forall a. a -&gt; STM (TVar a)
</span><span class="hs-identifier hs-var">STM.newTVar</span></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">STM
  (TMap SubscriberId Subscriber
   -&gt; TMap SubscriberId Subscriber -&gt; Cohort)
-&gt; STM (TMap SubscriberId Subscriber)
-&gt; STM (TMap SubscriberId Subscriber -&gt; Cohort)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">STM (TMap SubscriberId Subscriber)
forall k v. STM (TMap k v)
</span><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#new"><span class="hs-identifier hs-var">TMap.new</span></a></span><span> </span><span class="annot"><span class="annottext">STM (TMap SubscriberId Subscriber -&gt; Cohort)
-&gt; STM (TMap SubscriberId Subscriber) -&gt; STM Cohort
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">STM (TMap SubscriberId Subscriber)
forall k v. STM (TMap k v)
</span><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#new"><span class="hs-identifier hs-var">TMap.new</span></a></span><span>
</span><span id="line-163"></span><span>        </span><span class="annot"><span class="annottext">Subscriber -&gt; Cohort -&gt; STM ()
</span><a href="#local-6989586621688119734"><span class="hs-identifier hs-var">addToCohort</span></a></span><span> </span><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688119696"><span class="hs-identifier hs-var">subscriber</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort
</span><a href="#local-6989586621688119693"><span class="hs-identifier hs-var">newCohort</span></a></span><span>
</span><span id="line-164"></span><span>        </span><span class="annot"><span class="annottext">Cohort -&gt; CohortKey -&gt; TMap CohortKey Cohort -&gt; STM ()
forall k v. (Eq k, Hashable k) =&gt; v -&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#insert"><span class="hs-identifier hs-var">TMap.insert</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort
</span><a href="#local-6989586621688119693"><span class="hs-identifier hs-var">newCohort</span></a></span><span> </span><span class="annot"><span class="annottext">CohortKey
</span><a href="#local-6989586621688119737"><span class="hs-identifier hs-var">cohortKey</span></a></span><span> </span><span class="annot"><span class="annottext">(TMap CohortKey Cohort -&gt; STM ())
-&gt; TMap CohortKey Cohort -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Poller -&gt; TMap CohortKey Cohort
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pCohorts"><span class="hs-identifier hs-var hs-var">_pCohorts</span></a></span><span> </span><span class="annot"><span class="annottext">Poller
</span><a href="#local-6989586621688119694"><span class="hs-identifier hs-var">handler</span></a></span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span>      </span><span id="local-6989586621688119731"><span class="annot"><span class="annottext">newPoller :: STM Poller
</span><a href="#local-6989586621688119731"><span class="hs-identifier hs-var hs-var">newPoller</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TMap CohortKey Cohort -&gt; TMVar PollerIOState -&gt; Poller
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#Poller"><span class="hs-identifier hs-var">Poller</span></a></span><span> </span><span class="annot"><span class="annottext">(TMap CohortKey Cohort -&gt; TMVar PollerIOState -&gt; Poller)
-&gt; STM (TMap CohortKey Cohort)
-&gt; STM (TMVar PollerIOState -&gt; Poller)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">STM (TMap CohortKey Cohort)
forall k v. STM (TMap k v)
</span><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#new"><span class="hs-identifier hs-var">TMap.new</span></a></span><span> </span><span class="annot"><span class="annottext">STM (TMVar PollerIOState -&gt; Poller)
-&gt; STM (TMVar PollerIOState) -&gt; STM Poller
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">STM (TMVar PollerIOState)
forall a. STM (TMVar a)
</span><span class="hs-identifier hs-var">STM.newEmptyTMVar</span></span><span>
</span><span id="line-167"></span><span>
</span><span id="line-168"></span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#removeLiveQuery"><span class="hs-identifier hs-type">removeLiveQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-169"></span><span>  </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">L.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-170"></span><span>  </span><span class="annot"><a href="Hasura.Server.Metrics.html#ServerMetrics"><span class="hs-identifier hs-type">ServerMetrics</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-171"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveQueriesState"><span class="hs-identifier hs-type">LiveQueriesState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-172"></span><span>  </span><span class="hs-comment">-- the query and the associated operation</span><span>
</span><span id="line-173"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveQueryId"><span class="hs-identifier hs-type">LiveQueryId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-174"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-175"></span><span id="removeLiveQuery"><span class="annot"><span class="annottext">removeLiveQuery :: Logger Hasura
-&gt; ServerMetrics -&gt; LiveQueriesState -&gt; LiveQueryId -&gt; IO ()
</span><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#removeLiveQuery"><span class="hs-identifier hs-var hs-var">removeLiveQuery</span></a></span></span><span> </span><span id="local-6989586621688119688"><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688119688"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621688119687"><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688119687"><span class="hs-identifier hs-var">serverMetrics</span></a></span></span><span> </span><span id="local-6989586621688119686"><span class="annot"><span class="annottext">LiveQueriesState
</span><a href="#local-6989586621688119686"><span class="hs-identifier hs-var">lqState</span></a></span></span><span> </span><span id="local-6989586621688119685"><span class="annot"><span class="annottext">lqId :: LiveQueryId
</span><a href="#local-6989586621688119685"><span class="hs-identifier hs-var">lqId</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveQueryId"><span class="hs-identifier hs-type">LiveQueryId</span></a></span><span> </span><span id="local-6989586621688119684"><span class="annot"><span class="annottext">PollerKey
</span><a href="#local-6989586621688119684"><span class="hs-identifier hs-var">handlerId</span></a></span></span><span> </span><span id="local-6989586621688119683"><span class="annot"><span class="annottext">CohortKey
</span><a href="#local-6989586621688119683"><span class="hs-identifier hs-var">cohortId</span></a></span></span><span> </span><span id="local-6989586621688119682"><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621688119682"><span class="hs-identifier hs-var">sinkId</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
</span><span class="hs-identifier hs-var">mask_</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-176"></span><span>  </span><span id="local-6989586621688119681"><span class="annot"><span class="annottext">Maybe (IO ())
</span><a href="#local-6989586621688119681"><span class="hs-identifier hs-var">mbCleanupIO</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (Maybe (IO ())) -&gt; IO (Maybe (IO ()))
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM (Maybe (IO ())) -&gt; IO (Maybe (IO ())))
-&gt; STM (Maybe (IO ())) -&gt; IO (Maybe (IO ()))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-177"></span><span>    </span><span id="local-6989586621688119680"><span class="annot"><span class="annottext">Maybe (Poller, Cohort)
</span><a href="#local-6989586621688119680"><span class="hs-identifier hs-var">detM</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (Maybe (Poller, Cohort))
</span><a href="#local-6989586621688119679"><span class="hs-identifier hs-var">getQueryDet</span></a></span><span>
</span><span id="line-178"></span><span>    </span><span class="annot"><span class="annottext">(Maybe (Maybe (IO ())) -&gt; Maybe (IO ()))
-&gt; STM (Maybe (Maybe (IO ()))) -&gt; STM (Maybe (IO ()))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Maybe (IO ())) -&gt; Maybe (IO ())
forall (m :: * -&gt; *) a. Monad m =&gt; m (m a) -&gt; m a
</span><span class="hs-identifier hs-var">join</span></span><span> </span><span class="annot"><span class="annottext">(STM (Maybe (Maybe (IO ()))) -&gt; STM (Maybe (IO ())))
-&gt; STM (Maybe (Maybe (IO ()))) -&gt; STM (Maybe (IO ()))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-179"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Poller, Cohort)
-&gt; ((Poller, Cohort) -&gt; STM (Maybe (IO ())))
-&gt; STM (Maybe (Maybe (IO ())))
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Poller, Cohort)
</span><a href="#local-6989586621688119680"><span class="hs-identifier hs-var">detM</span></a></span><span> </span><span class="annot"><span class="annottext">(((Poller, Cohort) -&gt; STM (Maybe (IO ())))
 -&gt; STM (Maybe (Maybe (IO ()))))
-&gt; ((Poller, Cohort) -&gt; STM (Maybe (IO ())))
-&gt; STM (Maybe (Maybe (IO ())))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#Poller"><span class="hs-identifier hs-type">Poller</span></a></span><span> </span><span id="local-6989586621688119677"><span class="annot"><span class="annottext">TMap CohortKey Cohort
</span><a href="#local-6989586621688119677"><span class="hs-identifier hs-var">cohorts</span></a></span></span><span> </span><span id="local-6989586621688119676"><span class="annot"><span class="annottext">TMVar PollerIOState
</span><a href="#local-6989586621688119676"><span class="hs-identifier hs-var">ioState</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688119675"><span class="annot"><span class="annottext">Cohort
</span><a href="#local-6989586621688119675"><span class="hs-identifier hs-var">cohort</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-180"></span><span>        </span><span class="annot"><span class="annottext">TMap CohortKey Cohort
-&gt; TMVar PollerIOState -&gt; Cohort -&gt; STM (Maybe (IO ()))
</span><a href="#local-6989586621688119674"><span class="hs-identifier hs-var">cleanHandlerC</span></a></span><span> </span><span class="annot"><span class="annottext">TMap CohortKey Cohort
</span><a href="#local-6989586621688119677"><span class="hs-identifier hs-var">cohorts</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar PollerIOState
</span><a href="#local-6989586621688119676"><span class="hs-identifier hs-var">ioState</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort
</span><a href="#local-6989586621688119675"><span class="hs-identifier hs-var">cohort</span></a></span><span>
</span><span id="line-181"></span><span>  </span><span class="annot"><span class="annottext">Maybe (IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Foldable t, Monad m) =&gt;
t (m a) -&gt; m ()
</span><span class="hs-identifier hs-var">sequence_</span></span><span> </span><span class="annot"><span class="annottext">Maybe (IO ())
</span><a href="#local-6989586621688119681"><span class="hs-identifier hs-var">mbCleanupIO</span></a></span><span>
</span><span id="line-182"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Gauge -&gt; IO ()
</span><span class="hs-identifier hs-var">EKG.Gauge.dec</span></span><span> </span><span class="annot"><span class="annottext">(Gauge -&gt; IO ()) -&gt; Gauge -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerMetrics -&gt; Gauge
</span><a href="Hasura.Server.Metrics.html#smActiveSubscriptions"><span class="hs-identifier hs-var hs-var">smActiveSubscriptions</span></a></span><span> </span><span class="annot"><span class="annottext">ServerMetrics
</span><a href="#local-6989586621688119687"><span class="hs-identifier hs-var">serverMetrics</span></a></span><span>
</span><span id="line-183"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-184"></span><span>    </span><span id="local-6989586621688119671"><span class="annot"><span class="annottext">lqMap :: PollerMap
</span><a href="#local-6989586621688119671"><span class="hs-identifier hs-var hs-var">lqMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiveQueriesState -&gt; PollerMap
</span><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#_lqsLiveQueryMap"><span class="hs-identifier hs-var hs-var">_lqsLiveQueryMap</span></a></span><span> </span><span class="annot"><span class="annottext">LiveQueriesState
</span><a href="#local-6989586621688119686"><span class="hs-identifier hs-var">lqState</span></a></span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span>    </span><span id="local-6989586621688119679"><span class="annot"><span class="annottext">getQueryDet :: STM (Maybe (Poller, Cohort))
</span><a href="#local-6989586621688119679"><span class="hs-identifier hs-var hs-var">getQueryDet</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-187"></span><span>      </span><span id="local-6989586621688119670"><span class="annot"><span class="annottext">Maybe Poller
</span><a href="#local-6989586621688119670"><span class="hs-identifier hs-var">pollerM</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PollerKey -&gt; PollerMap -&gt; STM (Maybe Poller)
forall key value.
(Eq key, Hashable key) =&gt;
key -&gt; Map key value -&gt; STM (Maybe value)
</span><span class="hs-identifier hs-var">STMMap.lookup</span></span><span> </span><span class="annot"><span class="annottext">PollerKey
</span><a href="#local-6989586621688119684"><span class="hs-identifier hs-var">handlerId</span></a></span><span> </span><span class="annot"><span class="annottext">PollerMap
</span><a href="#local-6989586621688119671"><span class="hs-identifier hs-var">lqMap</span></a></span><span>
</span><span id="line-188"></span><span>      </span><span class="annot"><span class="annottext">(Maybe (Maybe (Poller, Cohort)) -&gt; Maybe (Poller, Cohort))
-&gt; STM (Maybe (Maybe (Poller, Cohort)))
-&gt; STM (Maybe (Poller, Cohort))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Maybe (Poller, Cohort)) -&gt; Maybe (Poller, Cohort)
forall (m :: * -&gt; *) a. Monad m =&gt; m (m a) -&gt; m a
</span><span class="hs-identifier hs-var">join</span></span><span> </span><span class="annot"><span class="annottext">(STM (Maybe (Maybe (Poller, Cohort)))
 -&gt; STM (Maybe (Poller, Cohort)))
-&gt; STM (Maybe (Maybe (Poller, Cohort)))
-&gt; STM (Maybe (Poller, Cohort))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-189"></span><span>        </span><span class="annot"><span class="annottext">Maybe Poller
-&gt; (Poller -&gt; STM (Maybe (Poller, Cohort)))
-&gt; STM (Maybe (Maybe (Poller, Cohort)))
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">Maybe Poller
</span><a href="#local-6989586621688119670"><span class="hs-identifier hs-var">pollerM</span></a></span><span> </span><span class="annot"><span class="annottext">((Poller -&gt; STM (Maybe (Poller, Cohort)))
 -&gt; STM (Maybe (Maybe (Poller, Cohort))))
-&gt; (Poller -&gt; STM (Maybe (Poller, Cohort)))
-&gt; STM (Maybe (Maybe (Poller, Cohort)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688119669"><span class="annot"><span class="annottext">Poller
</span><a href="#local-6989586621688119669"><span class="hs-identifier hs-var">poller</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-190"></span><span>          </span><span id="local-6989586621688119668"><span class="annot"><span class="annottext">Maybe Cohort
</span><a href="#local-6989586621688119668"><span class="hs-identifier hs-var">cohortM</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CohortKey -&gt; TMap CohortKey Cohort -&gt; STM (Maybe Cohort)
forall k v. (Eq k, Hashable k) =&gt; k -&gt; TMap k v -&gt; STM (Maybe v)
</span><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#lookup"><span class="hs-identifier hs-var">TMap.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">CohortKey
</span><a href="#local-6989586621688119683"><span class="hs-identifier hs-var">cohortId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Poller -&gt; TMap CohortKey Cohort
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pCohorts"><span class="hs-identifier hs-var hs-var">_pCohorts</span></a></span><span> </span><span class="annot"><span class="annottext">Poller
</span><a href="#local-6989586621688119669"><span class="hs-identifier hs-var">poller</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>          </span><span class="annot"><span class="annottext">Maybe (Poller, Cohort) -&gt; STM (Maybe (Poller, Cohort))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (Poller, Cohort) -&gt; STM (Maybe (Poller, Cohort)))
-&gt; Maybe (Poller, Cohort) -&gt; STM (Maybe (Poller, Cohort))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Poller
</span><a href="#local-6989586621688119669"><span class="hs-identifier hs-var">poller</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Cohort -&gt; (Poller, Cohort))
-&gt; Maybe Cohort -&gt; Maybe (Poller, Cohort)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Cohort
</span><a href="#local-6989586621688119668"><span class="hs-identifier hs-var">cohortM</span></a></span><span>
</span><span id="line-192"></span><span>
</span><span id="line-193"></span><span>    </span><span id="local-6989586621688119674"><span class="annot"><span class="annottext">cleanHandlerC :: TMap CohortKey Cohort
-&gt; TMVar PollerIOState -&gt; Cohort -&gt; STM (Maybe (IO ()))
</span><a href="#local-6989586621688119674"><span class="hs-identifier hs-var hs-var">cleanHandlerC</span></a></span></span><span> </span><span id="local-6989586621688119667"><span class="annot"><span class="annottext">TMap CohortKey Cohort
</span><a href="#local-6989586621688119667"><span class="hs-identifier hs-var">cohortMap</span></a></span></span><span> </span><span id="local-6989586621688119666"><span class="annot"><span class="annottext">TMVar PollerIOState
</span><a href="#local-6989586621688119666"><span class="hs-identifier hs-var">ioState</span></a></span></span><span> </span><span id="local-6989586621688119665"><span class="annot"><span class="annottext">Cohort
</span><a href="#local-6989586621688119665"><span class="hs-identifier hs-var">handlerC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-194"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688119664"><span class="annot"><span class="annottext">curOps :: TMap SubscriberId Subscriber
</span><a href="#local-6989586621688119664"><span class="hs-identifier hs-var hs-var">curOps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cohort -&gt; TMap SubscriberId Subscriber
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_cExistingSubscribers"><span class="hs-identifier hs-var hs-var">_cExistingSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort
</span><a href="#local-6989586621688119665"><span class="hs-identifier hs-var">handlerC</span></a></span><span>
</span><span id="line-195"></span><span>          </span><span id="local-6989586621688119662"><span class="annot"><span class="annottext">newOps :: TMap SubscriberId Subscriber
</span><a href="#local-6989586621688119662"><span class="hs-identifier hs-var hs-var">newOps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cohort -&gt; TMap SubscriberId Subscriber
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_cNewSubscribers"><span class="hs-identifier hs-var hs-var">_cNewSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort
</span><a href="#local-6989586621688119665"><span class="hs-identifier hs-var">handlerC</span></a></span><span>
</span><span id="line-196"></span><span>      </span><span class="annot"><span class="annottext">SubscriberId -&gt; TMap SubscriberId Subscriber -&gt; STM ()
forall k v. (Eq k, Hashable k) =&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#delete"><span class="hs-identifier hs-var">TMap.delete</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621688119682"><span class="hs-identifier hs-var">sinkId</span></a></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621688119664"><span class="hs-identifier hs-var">curOps</span></a></span><span>
</span><span id="line-197"></span><span>      </span><span class="annot"><span class="annottext">SubscriberId -&gt; TMap SubscriberId Subscriber -&gt; STM ()
forall k v. (Eq k, Hashable k) =&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#delete"><span class="hs-identifier hs-var">TMap.delete</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621688119682"><span class="hs-identifier hs-var">sinkId</span></a></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621688119662"><span class="hs-identifier hs-var">newOps</span></a></span><span>
</span><span id="line-198"></span><span>      </span><span id="local-6989586621688119660"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688119660"><span class="hs-identifier hs-var">cohortIsEmpty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-199"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">(&amp;&amp;)</span></span><span>
</span><span id="line-200"></span><span>          </span><span class="annot"><span class="annottext">(Bool -&gt; Bool -&gt; Bool) -&gt; STM Bool -&gt; STM (Bool -&gt; Bool)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber -&gt; STM Bool
forall k v. TMap k v -&gt; STM Bool
</span><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#null"><span class="hs-identifier hs-var">TMap.null</span></a></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621688119664"><span class="hs-identifier hs-var">curOps</span></a></span><span>
</span><span id="line-201"></span><span>          </span><span class="annot"><span class="annottext">STM (Bool -&gt; Bool) -&gt; STM Bool -&gt; STM Bool
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber -&gt; STM Bool
forall k v. TMap k v -&gt; STM Bool
</span><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#null"><span class="hs-identifier hs-var">TMap.null</span></a></span><span> </span><span class="annot"><span class="annottext">TMap SubscriberId Subscriber
</span><a href="#local-6989586621688119662"><span class="hs-identifier hs-var">newOps</span></a></span><span>
</span><span id="line-202"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; STM () -&gt; STM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688119660"><span class="hs-identifier hs-var">cohortIsEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; STM ()) -&gt; STM () -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CohortKey -&gt; TMap CohortKey Cohort -&gt; STM ()
forall k v. (Eq k, Hashable k) =&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#delete"><span class="hs-identifier hs-var">TMap.delete</span></a></span><span> </span><span class="annot"><span class="annottext">CohortKey
</span><a href="#local-6989586621688119683"><span class="hs-identifier hs-var">cohortId</span></a></span><span> </span><span class="annot"><span class="annottext">TMap CohortKey Cohort
</span><a href="#local-6989586621688119667"><span class="hs-identifier hs-var">cohortMap</span></a></span><span>
</span><span id="line-203"></span><span>      </span><span id="local-6989586621688119656"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688119656"><span class="hs-identifier hs-var">handlerIsEmpty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TMap CohortKey Cohort -&gt; STM Bool
forall k v. TMap k v -&gt; STM Bool
</span><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#null"><span class="hs-identifier hs-var">TMap.null</span></a></span><span> </span><span class="annot"><span class="annottext">TMap CohortKey Cohort
</span><a href="#local-6989586621688119667"><span class="hs-identifier hs-var">cohortMap</span></a></span><span>
</span><span id="line-204"></span><span>      </span><span class="hs-comment">-- when there is no need for handler i.e, this happens to be the last</span><span>
</span><span id="line-205"></span><span>      </span><span class="hs-comment">-- operation, take the ref for the polling thread to cancel it</span><span>
</span><span id="line-206"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688119656"><span class="hs-identifier hs-var">handlerIsEmpty</span></a></span><span>
</span><span id="line-207"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-208"></span><span>          </span><span class="annot"><span class="annottext">PollerKey -&gt; PollerMap -&gt; STM ()
forall key value.
(Eq key, Hashable key) =&gt;
key -&gt; Map key value -&gt; STM ()
</span><span class="hs-identifier hs-var">STMMap.delete</span></span><span> </span><span class="annot"><span class="annottext">PollerKey
</span><a href="#local-6989586621688119684"><span class="hs-identifier hs-var">handlerId</span></a></span><span> </span><span class="annot"><span class="annottext">PollerMap
</span><a href="#local-6989586621688119671"><span class="hs-identifier hs-var">lqMap</span></a></span><span>
</span><span id="line-209"></span><span>          </span><span id="local-6989586621688119654"><span class="annot"><span class="annottext">Maybe Thread
</span><a href="#local-6989586621688119654"><span class="hs-identifier hs-var">threadRefM</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(PollerIOState -&gt; Thread) -&gt; Maybe PollerIOState -&gt; Maybe Thread
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">PollerIOState -&gt; Thread
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pThread"><span class="hs-identifier hs-var hs-var">_pThread</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe PollerIOState -&gt; Maybe Thread)
-&gt; STM (Maybe PollerIOState) -&gt; STM (Maybe Thread)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TMVar PollerIOState -&gt; STM (Maybe PollerIOState)
forall a. TMVar a -&gt; STM (Maybe a)
</span><span class="hs-identifier hs-var">STM.tryReadTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar PollerIOState
</span><a href="#local-6989586621688119666"><span class="hs-identifier hs-var">ioState</span></a></span><span>
</span><span id="line-210"></span><span>          </span><span class="annot"><span class="annottext">Maybe (IO ()) -&gt; STM (Maybe (IO ()))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (IO ()) -&gt; STM (Maybe (IO ())))
-&gt; Maybe (IO ()) -&gt; STM (Maybe (IO ()))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-211"></span><span>            </span><span class="annot"><span class="annottext">IO () -&gt; Maybe (IO ())
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; Maybe (IO ())) -&gt; IO () -&gt; Maybe (IO ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-comment">-- deferred IO:</span><span>
</span><span id="line-212"></span><span>              </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Thread
</span><a href="#local-6989586621688119654"><span class="hs-identifier hs-var">threadRefM</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-213"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621688119651"><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621688119651"><span class="hs-identifier hs-var">threadRef</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Thread -&gt; IO ()
</span><span class="hs-identifier hs-var">Immortal.stop</span></span><span> </span><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621688119651"><span class="hs-identifier hs-var">threadRef</span></a></span><span>
</span><span id="line-214"></span><span>                </span><span class="hs-comment">-- This would seem to imply addLiveQuery broke or a bug</span><span>
</span><span id="line-215"></span><span>                </span><span class="hs-comment">-- elsewhere. Be paranoid and log:</span><span>
</span><span id="line-216"></span><span>                </span><span class="annot"><span class="annottext">Maybe Thread
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-217"></span><span>                  </span><span class="annot"><span class="annottext">Logger Hasura
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a Hasura, MonadIO m) =&gt;
   a -&gt; m ()
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">L.unLogger</span></a></span><span> </span><span class="annot"><span class="annottext">Logger Hasura
</span><a href="#local-6989586621688119688"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">(UnstructuredLog -&gt; IO ()) -&gt; UnstructuredLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-218"></span><span>                    </span><span class="annot"><span class="annottext">LogLevel -&gt; TByteString -&gt; UnstructuredLog
</span><a href="Hasura.Logging.html#UnstructuredLog"><span class="hs-identifier hs-var">L.UnstructuredLog</span></a></span><span> </span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelError"><span class="hs-identifier hs-var">L.LevelError</span></a></span><span> </span><span class="annot"><span class="annottext">(TByteString -&gt; UnstructuredLog) -&gt; TByteString -&gt; UnstructuredLog
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-219"></span><span>                      </span><span class="annot"><span class="annottext">String -&gt; TByteString
forall a. IsString a =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; TByteString) -&gt; String -&gt; TByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-220"></span><span>                        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;In removeLiveQuery no worker thread installed. Please report this as a bug: &quot;</span></span><span>
</span><span id="line-221"></span><span>                          </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">LiveQueryId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">LiveQueryId
</span><a href="#local-6989586621688119685"><span class="hs-identifier hs-var">lqId</span></a></span><span>
</span><span id="line-222"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe (IO ()) -&gt; STM (Maybe (IO ()))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (IO ())
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-223"></span><span>
</span><span id="line-224"></span><span class="hs-comment">-- | An async action query whose relationships are refered to table in a source.</span><span>
</span><span id="line-225"></span><span class="hs-comment">-- We need to generate an SQL statement with the action response and execute it</span><span>
</span><span id="line-226"></span><span class="hs-comment">-- in the source database so as to fetch response joined with relationship rows.</span><span>
</span><span id="line-227"></span><span class="hs-comment">-- For more details see Note [Resolving async action query]</span><span>
</span><span id="line-228"></span><span class="hs-keyword">data</span><span> </span><span id="LiveAsyncActionQueryOnSource"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveAsyncActionQueryOnSource"><span class="hs-identifier hs-var">LiveAsyncActionQueryOnSource</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="LiveAsyncActionQueryOnSource"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveAsyncActionQueryOnSource"><span class="hs-identifier hs-var">LiveAsyncActionQueryOnSource</span></a></span></span><span>
</span><span id="line-229"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_laaqpCurrentLqId"><span class="annot"><span class="annottext">LiveAsyncActionQueryOnSource -&gt; LiveQueryId
</span><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#_laaqpCurrentLqId"><span class="hs-identifier hs-var hs-var">_laaqpCurrentLqId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveQueryId"><span class="hs-identifier hs-type">LiveQueryId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-230"></span><span>    </span><span id="_laaqpPrevActionLogMap"><span class="annot"><span class="annottext">LiveAsyncActionQueryOnSource -&gt; ActionLogResponseMap
</span><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#_laaqpPrevActionLogMap"><span class="hs-identifier hs-var hs-var">_laaqpPrevActionLogMap</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.RQL.Types.Action.html#ActionLogResponseMap"><span class="hs-identifier hs-type">ActionLogResponseMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-231"></span><span>    </span><span class="hs-comment">-- | An IO action to restart the live query poller with updated action log responses fetched from metadata storage</span><span>
</span><span id="line-232"></span><span>    </span><span class="hs-comment">-- Restarting a live query re-generates the SQL statement with new action log responses to send latest action</span><span>
</span><span id="line-233"></span><span>    </span><span class="hs-comment">-- response to the client.</span><span>
</span><span id="line-234"></span><span>    </span><span id="_laaqpRestartLq"><span class="annot"><span class="annottext">LiveAsyncActionQueryOnSource
-&gt; LiveQueryId -&gt; ActionLogResponseMap -&gt; IO (Maybe LiveQueryId)
</span><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#_laaqpRestartLq"><span class="hs-identifier hs-var hs-var">_laaqpRestartLq</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveQueryId"><span class="hs-identifier hs-type">LiveQueryId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Action.html#ActionLogResponseMap"><span class="hs-identifier hs-type">ActionLogResponseMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveQueryId"><span class="hs-identifier hs-type">LiveQueryId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-235"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-236"></span><span>
</span><span id="line-237"></span><span class="hs-keyword">data</span><span> </span><span id="LiveAsyncActionQueryWithNoRelationships"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveAsyncActionQueryWithNoRelationships"><span class="hs-identifier hs-var">LiveAsyncActionQueryWithNoRelationships</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="LiveAsyncActionQueryWithNoRelationships"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveAsyncActionQueryWithNoRelationships"><span class="hs-identifier hs-var">LiveAsyncActionQueryWithNoRelationships</span></a></span></span><span>
</span><span id="line-238"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | An IO action to send response to the websocket client</span><span>
</span><span id="line-239"></span><span>    </span><span id="_laaqwnrSendResponse"><span class="annot"><span class="annottext">LiveAsyncActionQueryWithNoRelationships
-&gt; ActionLogResponseMap -&gt; IO ()
</span><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#_laaqwnrSendResponse"><span class="hs-identifier hs-var hs-var">_laaqwnrSendResponse</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Action.html#ActionLogResponseMap"><span class="hs-identifier hs-type">ActionLogResponseMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-240"></span><span>    </span><span class="hs-comment">-- | An IO action to send &quot;completed&quot; message to the websocket client</span><span>
</span><span id="line-241"></span><span>    </span><span id="_laaqwnrSendCompleted"><span class="annot"><span class="annottext">LiveAsyncActionQueryWithNoRelationships -&gt; IO ()
</span><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#_laaqwnrSendCompleted"><span class="hs-identifier hs-var hs-var">_laaqwnrSendCompleted</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-243"></span><span>
</span><span id="line-244"></span><span class="hs-keyword">data</span><span> </span><span id="LiveAsyncActionQuery"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveAsyncActionQuery"><span class="hs-identifier hs-var">LiveAsyncActionQuery</span></a></span></span><span>
</span><span id="line-245"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="LAAQNoRelationships"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LAAQNoRelationships"><span class="hs-identifier hs-var">LAAQNoRelationships</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveAsyncActionQueryWithNoRelationships"><span class="hs-identifier hs-type">LiveAsyncActionQueryWithNoRelationships</span></a></span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="LAAQOnSourceDB"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LAAQOnSourceDB"><span class="hs-identifier hs-var">LAAQOnSourceDB</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveAsyncActionQueryOnSource"><span class="hs-identifier hs-type">LiveAsyncActionQueryOnSource</span></a></span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span class="hs-keyword">data</span><span> </span><span id="AsyncActionQueryLive"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#AsyncActionQueryLive"><span class="hs-identifier hs-var">AsyncActionQueryLive</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="AsyncActionQueryLive"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#AsyncActionQueryLive"><span class="hs-identifier hs-var">AsyncActionQueryLive</span></a></span></span><span>
</span><span id="line-249"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_aaqlActionIds"><span class="annot"><span class="annottext">AsyncActionQueryLive -&gt; NonEmpty ActionId
</span><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#_aaqlActionIds"><span class="hs-identifier hs-var hs-var">_aaqlActionIds</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">NonEmpty</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Action.html#ActionId"><span class="hs-identifier hs-type">ActionId</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-250"></span><span>    </span><span class="hs-comment">-- | An IO action to send error message (in case of any exception) to the websocket client</span><span>
</span><span id="line-251"></span><span>    </span><span id="_aaqlOnException"><span class="annot"><span class="annottext">AsyncActionQueryLive -&gt; QErr -&gt; IO ()
</span><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#_aaqlOnException"><span class="hs-identifier hs-var hs-var">_aaqlOnException</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-252"></span><span>    </span><span id="_aaqlLiveExecution"><span class="annot"><span class="annottext">AsyncActionQueryLive -&gt; LiveAsyncActionQuery
</span><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#_aaqlLiveExecution"><span class="hs-identifier hs-var hs-var">_aaqlLiveExecution</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveAsyncActionQuery"><span class="hs-identifier hs-type">LiveAsyncActionQuery</span></a></span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-254"></span><span>
</span><span id="line-255"></span><span class="hs-comment">-- | A share-able state map which stores an async action live query with it's subscription operation id</span><span>
</span><span id="line-256"></span><span class="hs-keyword">type</span><span> </span><span id="AsyncActionSubscriptionState"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#AsyncActionSubscriptionState"><span class="hs-identifier hs-var">AsyncActionSubscriptionState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#TMap"><span class="hs-identifier hs-type">TMap.TMap</span></a></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#OperationId"><span class="hs-identifier hs-type">OperationId</span></a></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#AsyncActionQueryLive"><span class="hs-identifier hs-type">AsyncActionQueryLive</span></a></span><span>
</span><span id="line-257"></span><span>
</span><span id="line-258"></span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#addAsyncActionLiveQuery"><span class="hs-identifier hs-type">addAsyncActionLiveQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-259"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#AsyncActionSubscriptionState"><span class="hs-identifier hs-type">AsyncActionSubscriptionState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-260"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#OperationId"><span class="hs-identifier hs-type">OperationId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-261"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">NonEmpty</span></span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Action.html#ActionId"><span class="hs-identifier hs-type">ActionId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-262"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-263"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#LiveAsyncActionQuery"><span class="hs-identifier hs-type">LiveAsyncActionQuery</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-264"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span id="addAsyncActionLiveQuery"><span class="annot"><span class="annottext">addAsyncActionLiveQuery :: AsyncActionSubscriptionState
-&gt; OperationId
-&gt; NonEmpty ActionId
-&gt; (QErr -&gt; IO ())
-&gt; LiveAsyncActionQuery
-&gt; IO ()
</span><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#addAsyncActionLiveQuery"><span class="hs-identifier hs-var hs-var">addAsyncActionLiveQuery</span></a></span></span><span> </span><span id="local-6989586621688119633"><span class="annot"><span class="annottext">AsyncActionSubscriptionState
</span><a href="#local-6989586621688119633"><span class="hs-identifier hs-var">queriesState</span></a></span></span><span> </span><span id="local-6989586621688119632"><span class="annot"><span class="annottext">OperationId
</span><a href="#local-6989586621688119632"><span class="hs-identifier hs-var">opId</span></a></span></span><span> </span><span id="local-6989586621688119631"><span class="annot"><span class="annottext">NonEmpty ActionId
</span><a href="#local-6989586621688119631"><span class="hs-identifier hs-var">actionIds</span></a></span></span><span> </span><span id="local-6989586621688119630"><span class="annot"><span class="annottext">QErr -&gt; IO ()
</span><a href="#local-6989586621688119630"><span class="hs-identifier hs-var">onException</span></a></span></span><span> </span><span id="local-6989586621688119629"><span class="annot"><span class="annottext">LiveAsyncActionQuery
</span><a href="#local-6989586621688119629"><span class="hs-identifier hs-var">liveQuery</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-266"></span><span>  </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-267"></span><span>    </span><span class="annot"><span class="annottext">AsyncActionQueryLive
-&gt; OperationId -&gt; AsyncActionSubscriptionState -&gt; STM ()
forall k v. (Eq k, Hashable k) =&gt; v -&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#insert"><span class="hs-identifier hs-var">TMap.insert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty ActionId
-&gt; (QErr -&gt; IO ()) -&gt; LiveAsyncActionQuery -&gt; AsyncActionQueryLive
</span><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#AsyncActionQueryLive"><span class="hs-identifier hs-var">AsyncActionQueryLive</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty ActionId
</span><a href="#local-6989586621688119631"><span class="hs-identifier hs-var">actionIds</span></a></span><span> </span><span class="annot"><span class="annottext">QErr -&gt; IO ()
</span><a href="#local-6989586621688119630"><span class="hs-identifier hs-var">onException</span></a></span><span> </span><span class="annot"><span class="annottext">LiveAsyncActionQuery
</span><a href="#local-6989586621688119629"><span class="hs-identifier hs-var">liveQuery</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OperationId
</span><a href="#local-6989586621688119632"><span class="hs-identifier hs-var">opId</span></a></span><span> </span><span class="annot"><span class="annottext">AsyncActionSubscriptionState
</span><a href="#local-6989586621688119633"><span class="hs-identifier hs-var">queriesState</span></a></span><span>
</span><span id="line-268"></span><span>
</span><span id="line-269"></span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#removeAsyncActionLiveQuery"><span class="hs-identifier hs-type">removeAsyncActionLiveQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-270"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#AsyncActionSubscriptionState"><span class="hs-identifier hs-type">AsyncActionSubscriptionState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#OperationId"><span class="hs-identifier hs-type">OperationId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-271"></span><span id="removeAsyncActionLiveQuery"><span class="annot"><span class="annottext">removeAsyncActionLiveQuery :: AsyncActionSubscriptionState -&gt; OperationId -&gt; IO ()
</span><a href="Hasura.GraphQL.Execute.LiveQuery.State.html#removeAsyncActionLiveQuery"><span class="hs-identifier hs-var hs-var">removeAsyncActionLiveQuery</span></a></span></span><span> </span><span id="local-6989586621688119628"><span class="annot"><span class="annottext">AsyncActionSubscriptionState
</span><a href="#local-6989586621688119628"><span class="hs-identifier hs-var">queriesState</span></a></span></span><span> </span><span id="local-6989586621688119627"><span class="annot"><span class="annottext">OperationId
</span><a href="#local-6989586621688119627"><span class="hs-identifier hs-var">opId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-272"></span><span>  </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OperationId -&gt; AsyncActionSubscriptionState -&gt; STM ()
forall k v. (Eq k, Hashable k) =&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#delete"><span class="hs-identifier hs-var">TMap.delete</span></a></span><span> </span><span class="annot"><span class="annottext">OperationId
</span><a href="#local-6989586621688119627"><span class="hs-identifier hs-var">opId</span></a></span><span> </span><span class="annot"><span class="annottext">AsyncActionSubscriptionState
</span><a href="#local-6989586621688119628"><span class="hs-identifier hs-var">queriesState</span></a></span><span>
</span><span id="line-273"></span></pre></body></html>