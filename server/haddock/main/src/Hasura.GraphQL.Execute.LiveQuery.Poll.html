<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | Multiplexed live query poller threads; see &quot;Hasura.GraphQL.Execute.LiveQuery&quot; for details.</span><span>
</span><span id="line-2"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hasura.GraphQL.Execute.LiveQuery.Poll</span><span>
</span><span id="line-3"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * Pollers</span></span><span>
</span><span id="line-4"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#Poller"><span class="hs-identifier">Poller</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-5"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerId"><span class="hs-identifier">PollerId</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerIOState"><span class="hs-identifier">PollerIOState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#pollQuery"><span class="hs-identifier">pollQuery</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerKey"><span class="hs-identifier">PollerKey</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerMap"><span class="hs-identifier">PollerMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#dumpPollerMap"><span class="hs-identifier">dumpPollerMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollDetails"><span class="hs-identifier">PollDetails</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#BatchExecutionDetails"><span class="hs-identifier">BatchExecutionDetails</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#CohortExecutionDetails"><span class="hs-identifier">CohortExecutionDetails</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#LiveQueryPostPollHook"><span class="hs-identifier">LiveQueryPostPollHook</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#defaultLiveQueryPostPollHook"><span class="hs-identifier">defaultLiveQueryPostPollHook</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Cohorts</span></span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#Cohort"><span class="hs-identifier">Cohort</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Plan.html#CohortId"><span class="hs-identifier">CohortId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Plan.html#newCohortId"><span class="hs-identifier">newCohortId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Plan.html#CohortVariables"><span class="hs-identifier">CohortVariables</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#CohortKey"><span class="hs-identifier">CohortKey</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#CohortMap"><span class="hs-identifier">CohortMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Subscribers</span></span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#Subscriber"><span class="hs-identifier">Subscriber</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberId"><span class="hs-identifier">SubscriberId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#newSubscriberId"><span class="hs-identifier">newSubscriberId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberMetadata"><span class="hs-identifier">SubscriberMetadata</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#mkSubscriberMetadata"><span class="hs-identifier">mkSubscriberMetadata</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#unSubscriberMetadata"><span class="hs-identifier">unSubscriberMetadata</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberMap"><span class="hs-identifier">SubscriberMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#OnChange"><span class="hs-identifier">OnChange</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#LGQResponse"><span class="hs-identifier">LGQResponse</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#LiveQueryResponse"><span class="hs-identifier">LiveQueryResponse</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#LiveQueryMetadata"><span class="hs-identifier">LiveQueryMetadata</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberExecutionDetails"><span class="hs-identifier">SubscriberExecutionDetails</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Batch</span></span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#BatchId"><span class="hs-identifier">BatchId</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">where</span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Async</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">A</span></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">STM</span></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Immortal</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Immortal</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Crypto.Hash</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CH</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Aeson.Extended.html"><span class="hs-identifier">Data.Aeson.Extended</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">J</span></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List.Split</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">chunksOf</span></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Monoid</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Sum</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Text.Extended.html"><span class="hs-identifier">Data.Text.Extended</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Time.Clock</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Clock</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.UUID</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">UUID</span></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.UUID.V4</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">UUID</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.AssertNF.CPP.html"><span class="hs-identifier">GHC.AssertNF.CPP</span></a></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.Backend.html"><span class="hs-identifier">Hasura.GraphQL.Execute.Backend</span></a></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Options.html"><span class="hs-identifier">Hasura.GraphQL.Execute.LiveQuery.Options</span></a></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Plan.html"><span class="hs-identifier">Hasura.GraphQL.Execute.LiveQuery.Plan</span></a></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html"><span class="hs-identifier">Hasura.GraphQL.Execute.LiveQuery.TMap</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TMap</span></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.ParameterizedQueryHash.html"><span class="hs-identifier">Hasura.GraphQL.ParameterizedQueryHash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.ParameterizedQueryHash.html#ParameterizedQueryHash"><span class="hs-identifier">ParameterizedQueryHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.Backend.html"><span class="hs-identifier">Hasura.GraphQL.Transport.Backend</span></a></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html"><span class="hs-identifier">Hasura.GraphQL.Transport.HTTP.Protocol</span></a></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html"><span class="hs-identifier">Hasura.GraphQL.Transport.WebSocket.Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#OperationId"><span class="hs-identifier">OperationId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Server.html"><span class="hs-identifier">Hasura.GraphQL.Transport.WebSocket.Server</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">WS</span></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Logging.html"><span class="hs-identifier">Hasura.Logging</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">L</span></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Prelude.html"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html"><span class="hs-identifier">Hasura.RQL.Types.Backend</span></a></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html"><span class="hs-identifier">Hasura.RQL.Types.Common</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier">SourceName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#getNonNegativeInt"><span class="hs-identifier">getNonNegativeInt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html"><span class="hs-identifier">Hasura.Server.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Types.html#RequestId"><span class="hs-identifier">RequestId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Session.html"><span class="hs-identifier">Hasura.Session</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">ListT</span></span><span> </span><span class="hs-keyword">qualified</span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">StmContainers.Map</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">STMMap</span></span><span>
</span><span id="line-77"></span><span>
</span><span id="line-78"></span><span class="hs-comment">-- ----------------------------------------------------------------------------------------------</span><span>
</span><span id="line-79"></span><span class="hs-comment">-- Subscribers</span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span id="local-6989586621688226607"><span id="local-6989586621688226608"></span></span><span class="hs-keyword">newtype</span><span> </span><span id="SubscriberId"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberId"><span class="hs-identifier hs-var">SubscriberId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SubscriberId"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberId"><span class="hs-identifier hs-var">SubscriberId</span></a></span></span><span> </span><span class="hs-special">{</span><span id="unSubscriberId"><span class="annot"><span class="annottext">SubscriberId -&gt; UUID
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#unSubscriberId"><span class="hs-identifier hs-var hs-var">unSubscriberId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">UUID.UUID</span></span><span class="hs-special">}</span><span>
</span><span id="line-82"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688226599"><span id="local-6989586621688226601"><span id="local-6989586621688226603"><span class="annot"><span class="annottext">Int -&gt; SubscriberId -&gt; ShowS
[SubscriberId] -&gt; ShowS
SubscriberId -&gt; String
(Int -&gt; SubscriberId -&gt; ShowS)
-&gt; (SubscriberId -&gt; String)
-&gt; ([SubscriberId] -&gt; ShowS)
-&gt; Show SubscriberId
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [SubscriberId] -&gt; ShowS
$cshowList :: [SubscriberId] -&gt; ShowS
show :: SubscriberId -&gt; String
$cshow :: SubscriberId -&gt; String
showsPrec :: Int -&gt; SubscriberId -&gt; ShowS
$cshowsPrec :: Int -&gt; SubscriberId -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226594"><span id="local-6989586621688226596"><span class="annot"><span class="annottext">SubscriberId -&gt; SubscriberId -&gt; Bool
(SubscriberId -&gt; SubscriberId -&gt; Bool)
-&gt; (SubscriberId -&gt; SubscriberId -&gt; Bool) -&gt; Eq SubscriberId
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: SubscriberId -&gt; SubscriberId -&gt; Bool
$c/= :: SubscriberId -&gt; SubscriberId -&gt; Bool
== :: SubscriberId -&gt; SubscriberId -&gt; Bool
$c== :: SubscriberId -&gt; SubscriberId -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. SubscriberId -&gt; Rep SubscriberId x)
-&gt; (forall x. Rep SubscriberId x -&gt; SubscriberId)
-&gt; Generic SubscriberId
forall x. Rep SubscriberId x -&gt; SubscriberId
forall x. SubscriberId -&gt; Rep SubscriberId x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep SubscriberId x -&gt; SubscriberId
$cfrom :: forall x. SubscriberId -&gt; Rep SubscriberId x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226586"><span id="local-6989586621688226588"><span class="annot"><span class="annottext">Int -&gt; SubscriberId -&gt; Int
SubscriberId -&gt; Int
(Int -&gt; SubscriberId -&gt; Int)
-&gt; (SubscriberId -&gt; Int) -&gt; Hashable SubscriberId
forall a. (Int -&gt; a -&gt; Int) -&gt; (a -&gt; Int) -&gt; Hashable a
hash :: SubscriberId -&gt; Int
$chash :: SubscriberId -&gt; Int
hashWithSalt :: Int -&gt; SubscriberId -&gt; Int
$chashWithSalt :: Int -&gt; SubscriberId -&gt; Int
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Hashable</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226577"><span id="local-6989586621688226579"><span id="local-6989586621688226581"><span id="local-6989586621688226583"><span class="annot"><span class="annottext">[SubscriberId] -&gt; Encoding
[SubscriberId] -&gt; Value
SubscriberId -&gt; Encoding
SubscriberId -&gt; Value
(SubscriberId -&gt; Value)
-&gt; (SubscriberId -&gt; Encoding)
-&gt; ([SubscriberId] -&gt; Value)
-&gt; ([SubscriberId] -&gt; Encoding)
-&gt; ToJSON SubscriberId
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
toEncodingList :: [SubscriberId] -&gt; Encoding
$ctoEncodingList :: [SubscriberId] -&gt; Encoding
toJSONList :: [SubscriberId] -&gt; Value
$ctoJSONList :: [SubscriberId] -&gt; Value
toEncoding :: SubscriberId -&gt; Encoding
$ctoEncoding :: SubscriberId -&gt; Encoding
toJSON :: SubscriberId -&gt; Value
$ctoJSON :: SubscriberId -&gt; Value
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">J.ToJSON</span></span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#newSubscriberId"><span class="hs-identifier hs-type">newSubscriberId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberId"><span class="hs-identifier hs-type">SubscriberId</span></a></span><span>
</span><span id="line-85"></span><span id="newSubscriberId"><span class="annot"><span class="annottext">newSubscriberId :: IO SubscriberId
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#newSubscriberId"><span class="hs-identifier hs-var hs-var">newSubscriberId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-86"></span><span>  </span><span class="annot"><span class="annottext">UUID -&gt; SubscriberId
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberId"><span class="hs-identifier hs-var">SubscriberId</span></a></span><span> </span><span class="annot"><span class="annottext">(UUID -&gt; SubscriberId) -&gt; IO UUID -&gt; IO SubscriberId
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO UUID
</span><span class="hs-identifier hs-var">UUID.nextRandom</span></span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span class="hs-comment">-- | Allows a user of the live query subsystem (currently websocket transport)</span><span>
</span><span id="line-89"></span><span class="hs-comment">-- to attach arbitrary metadata about a subscriber. This information is available</span><span>
</span><span id="line-90"></span><span class="hs-comment">-- as part of Subscriber in CohortExecutionDetails and can be logged by customizing</span><span>
</span><span id="line-91"></span><span class="hs-comment">-- in pollerlog</span><span>
</span><span id="line-92"></span><span class="hs-keyword">newtype</span><span> </span><span id="SubscriberMetadata"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberMetadata"><span class="hs-identifier hs-var">SubscriberMetadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SubscriberMetadata"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberMetadata"><span class="hs-identifier hs-var">SubscriberMetadata</span></a></span></span><span> </span><span class="hs-special">{</span><span id="unSubscriberMetadata"><span class="annot"><span class="annottext">SubscriberMetadata -&gt; Value
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#unSubscriberMetadata"><span class="hs-identifier hs-var hs-var">unSubscriberMetadata</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span class="hs-special">}</span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688226567"><span id="local-6989586621688226569"><span id="local-6989586621688226571"><span class="annot"><span class="annottext">Int -&gt; SubscriberMetadata -&gt; ShowS
[SubscriberMetadata] -&gt; ShowS
SubscriberMetadata -&gt; String
(Int -&gt; SubscriberMetadata -&gt; ShowS)
-&gt; (SubscriberMetadata -&gt; String)
-&gt; ([SubscriberMetadata] -&gt; ShowS)
-&gt; Show SubscriberMetadata
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [SubscriberMetadata] -&gt; ShowS
$cshowList :: [SubscriberMetadata] -&gt; ShowS
show :: SubscriberMetadata -&gt; String
$cshow :: SubscriberMetadata -&gt; String
showsPrec :: Int -&gt; SubscriberMetadata -&gt; ShowS
$cshowsPrec :: Int -&gt; SubscriberMetadata -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226563"><span id="local-6989586621688226565"><span class="annot"><span class="annottext">SubscriberMetadata -&gt; SubscriberMetadata -&gt; Bool
(SubscriberMetadata -&gt; SubscriberMetadata -&gt; Bool)
-&gt; (SubscriberMetadata -&gt; SubscriberMetadata -&gt; Bool)
-&gt; Eq SubscriberMetadata
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: SubscriberMetadata -&gt; SubscriberMetadata -&gt; Bool
$c/= :: SubscriberMetadata -&gt; SubscriberMetadata -&gt; Bool
== :: SubscriberMetadata -&gt; SubscriberMetadata -&gt; Bool
$c== :: SubscriberMetadata -&gt; SubscriberMetadata -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226555"><span id="local-6989586621688226557"><span id="local-6989586621688226559"><span id="local-6989586621688226561"><span class="annot"><span class="annottext">[SubscriberMetadata] -&gt; Encoding
[SubscriberMetadata] -&gt; Value
SubscriberMetadata -&gt; Encoding
SubscriberMetadata -&gt; Value
(SubscriberMetadata -&gt; Value)
-&gt; (SubscriberMetadata -&gt; Encoding)
-&gt; ([SubscriberMetadata] -&gt; Value)
-&gt; ([SubscriberMetadata] -&gt; Encoding)
-&gt; ToJSON SubscriberMetadata
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
toEncodingList :: [SubscriberMetadata] -&gt; Encoding
$ctoEncodingList :: [SubscriberMetadata] -&gt; Encoding
toJSONList :: [SubscriberMetadata] -&gt; Value
$ctoJSONList :: [SubscriberMetadata] -&gt; Value
toEncoding :: SubscriberMetadata -&gt; Encoding
$ctoEncoding :: SubscriberMetadata -&gt; Encoding
toJSON :: SubscriberMetadata -&gt; Value
$ctoJSON :: SubscriberMetadata -&gt; Value
</span><a href="#local-6989586621688226555"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">J.ToJSON</span></a></span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#mkSubscriberMetadata"><span class="hs-identifier hs-type">mkSubscriberMetadata</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Server.html#WSId"><span class="hs-identifier hs-type">WS.WSId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.WebSocket.Protocol.html#OperationId"><span class="hs-identifier hs-type">OperationId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#OperationName"><span class="hs-identifier hs-type">OperationName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.Server.Types.html#RequestId"><span class="hs-identifier hs-type">RequestId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberMetadata"><span class="hs-identifier hs-type">SubscriberMetadata</span></a></span><span>
</span><span id="line-96"></span><span id="mkSubscriberMetadata"><span class="annot"><span class="annottext">mkSubscriberMetadata :: WSId
-&gt; OperationId
-&gt; Maybe OperationName
-&gt; RequestId
-&gt; SubscriberMetadata
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#mkSubscriberMetadata"><span class="hs-identifier hs-var hs-var">mkSubscriberMetadata</span></a></span></span><span> </span><span id="local-6989586621688226554"><span class="annot"><span class="annottext">WSId
</span><a href="#local-6989586621688226554"><span class="hs-identifier hs-var">websocketId</span></a></span></span><span> </span><span id="local-6989586621688226553"><span class="annot"><span class="annottext">OperationId
</span><a href="#local-6989586621688226553"><span class="hs-identifier hs-var">operationId</span></a></span></span><span> </span><span id="local-6989586621688226552"><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688226552"><span class="hs-identifier hs-var">operationName</span></a></span></span><span> </span><span id="local-6989586621688226551"><span class="annot"><span class="annottext">RequestId
</span><a href="#local-6989586621688226551"><span class="hs-identifier hs-var">reqId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-97"></span><span>  </span><span class="annot"><span class="annottext">Value -&gt; SubscriberMetadata
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberMetadata"><span class="hs-identifier hs-var">SubscriberMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; SubscriberMetadata) -&gt; Value -&gt; SubscriberMetadata
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-98"></span><span>    </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">J.object</span></span><span>
</span><span id="line-99"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;websocket_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; WSId -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">WSId
</span><a href="#local-6989586621688226554"><span class="hs-identifier hs-var">websocketId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-100"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;operation_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; OperationId -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">OperationId
</span><a href="#local-6989586621688226553"><span class="hs-identifier hs-var">operationId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-101"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;operation_name&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Maybe OperationName -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">Maybe OperationName
</span><a href="#local-6989586621688226552"><span class="hs-identifier hs-var">operationName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-102"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;request_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; RequestId -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">RequestId
</span><a href="#local-6989586621688226551"><span class="hs-identifier hs-var">reqId</span></a></span><span>
</span><span id="line-103"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="hs-keyword">data</span><span> </span><span id="Subscriber"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#Subscriber"><span class="hs-identifier hs-var">Subscriber</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Subscriber"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#Subscriber"><span class="hs-identifier hs-var">Subscriber</span></a></span></span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_sId"><span class="annot"><span class="annottext">Subscriber -&gt; SubscriberId
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_sId"><span class="hs-identifier hs-var hs-var">_sId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberId"><span class="hs-identifier hs-type">SubscriberId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-107"></span><span>    </span><span id="_sMetadata"><span class="annot"><span class="annottext">Subscriber -&gt; SubscriberMetadata
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_sMetadata"><span class="hs-identifier hs-var hs-var">_sMetadata</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberMetadata"><span class="hs-identifier hs-type">SubscriberMetadata</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-108"></span><span>    </span><span id="_sRequestId"><span class="annot"><span class="annottext">Subscriber -&gt; RequestId
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_sRequestId"><span class="hs-identifier hs-var hs-var">_sRequestId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.Server.Types.html#RequestId"><span class="hs-identifier hs-type">RequestId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-109"></span><span>    </span><span id="_sOperationName"><span class="annot"><span class="annottext">Subscriber -&gt; Maybe OperationName
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_sOperationName"><span class="hs-identifier hs-var hs-var">_sOperationName</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#OperationName"><span class="hs-identifier hs-type">OperationName</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-110"></span><span>    </span><span id="_sOnChangeCallback"><span class="annot"><span class="annottext">Subscriber -&gt; OnChange
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_sOnChangeCallback"><span class="hs-identifier hs-var hs-var">_sOnChangeCallback</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#OnChange"><span class="hs-identifier hs-type">OnChange</span></a></span><span>
</span><span id="line-111"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span class="hs-comment">-- | live query onChange metadata, used for adding more extra analytics data</span><span>
</span><span id="line-114"></span><span class="hs-keyword">data</span><span> </span><span id="LiveQueryMetadata"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#LiveQueryMetadata"><span class="hs-identifier hs-var">LiveQueryMetadata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="LiveQueryMetadata"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#LiveQueryMetadata"><span class="hs-identifier hs-var">LiveQueryMetadata</span></a></span></span><span>
</span><span id="line-115"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_lqmExecutionTime"><span class="annot"><span class="annottext">LiveQueryMetadata -&gt; DiffTime
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_lqmExecutionTime"><span class="hs-identifier hs-var hs-var">_lqmExecutionTime</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Clock.DiffTime</span></span><span>
</span><span id="line-116"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-117"></span><span>
</span><span id="line-118"></span><span class="hs-keyword">data</span><span> </span><span id="LiveQueryResponse"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#LiveQueryResponse"><span class="hs-identifier hs-var">LiveQueryResponse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="LiveQueryResponse"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#LiveQueryResponse"><span class="hs-identifier hs-var">LiveQueryResponse</span></a></span></span><span>
</span><span id="line-119"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_lqrPayload"><span class="annot"><span class="annottext">LiveQueryResponse -&gt; ByteString
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_lqrPayload"><span class="hs-identifier hs-var hs-var">_lqrPayload</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span class="hs-special">,</span><span>
</span><span id="line-120"></span><span>    </span><span id="_lqrExecutionTime"><span class="annot"><span class="annottext">LiveQueryResponse -&gt; DiffTime
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_lqrExecutionTime"><span class="hs-identifier hs-var hs-var">_lqrExecutionTime</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Clock.DiffTime</span></span><span>
</span><span id="line-121"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-122"></span><span>
</span><span id="line-123"></span><span class="hs-keyword">type</span><span> </span><span id="LGQResponse"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#LGQResponse"><span class="hs-identifier hs-var">LGQResponse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#GQResult"><span class="hs-identifier hs-type">GQResult</span></a></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#LiveQueryResponse"><span class="hs-identifier hs-type">LiveQueryResponse</span></a></span><span>
</span><span id="line-124"></span><span>
</span><span id="line-125"></span><span class="hs-keyword">type</span><span> </span><span id="OnChange"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#OnChange"><span class="hs-identifier hs-var">OnChange</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#LGQResponse"><span class="hs-identifier hs-type">LGQResponse</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span class="hs-keyword">type</span><span> </span><span id="SubscriberMap"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberMap"><span class="hs-identifier hs-var">SubscriberMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#TMap"><span class="hs-identifier hs-type">TMap.TMap</span></a></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberId"><span class="hs-identifier hs-type">SubscriberId</span></a></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#Subscriber"><span class="hs-identifier hs-type">Subscriber</span></a></span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span class="hs-comment">-- -------------------------------------------------------------------------------------------------</span><span>
</span><span id="line-130"></span><span class="hs-comment">-- Cohorts</span><span>
</span><span id="line-131"></span><span>
</span><span id="line-132"></span><span class="hs-comment">-- | A batched group of 'Subscriber's who are not only listening to the same query but also have</span><span>
</span><span id="line-133"></span><span class="hs-comment">-- identical session and query variables. Each result pushed to a 'Cohort' is forwarded along to</span><span>
</span><span id="line-134"></span><span class="hs-comment">-- each of its 'Subscriber's.</span><span>
</span><span id="line-135"></span><span class="hs-comment">--</span><span>
</span><span id="line-136"></span><span class="hs-comment">-- In SQL, each 'Cohort' corresponds to a single row in the laterally-joined @_subs@ table (and</span><span>
</span><span id="line-137"></span><span class="hs-comment">-- therefore a single row in the query result).</span><span>
</span><span id="line-138"></span><span class="hs-comment">--</span><span>
</span><span id="line-139"></span><span class="hs-comment">-- See also 'CohortMap'.</span><span>
</span><span id="line-140"></span><span class="hs-keyword">data</span><span> </span><span id="Cohort"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#Cohort"><span class="hs-identifier hs-var">Cohort</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Cohort"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#Cohort"><span class="hs-identifier hs-var">Cohort</span></a></span></span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | a unique identifier used to identify the cohort in the generated query</span><span>
</span><span id="line-142"></span><span>    </span><span id="_cCohortId"><span class="annot"><span class="annottext">Cohort -&gt; CohortId
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_cCohortId"><span class="hs-identifier hs-var hs-var">_cCohortId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Plan.html#CohortId"><span class="hs-identifier hs-type">CohortId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-comment">-- | a hash of the previous query result, if any, used to determine if we need to push an updated</span><span>
</span><span id="line-144"></span><span>    </span><span class="hs-comment">-- result to the subscribers or not</span><span>
</span><span id="line-145"></span><span>    </span><span id="_cPreviousResponse"><span class="annot"><span class="annottext">Cohort -&gt; TVar (Maybe ResponseHash)
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_cPreviousResponse"><span class="hs-identifier hs-var hs-var">_cPreviousResponse</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">STM.TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#ResponseHash"><span class="hs-identifier hs-type">ResponseHash</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-comment">-- | the subscribers we&#8217;ve already pushed a result to; we push new results to them iff the</span><span>
</span><span id="line-147"></span><span>    </span><span class="hs-comment">-- response changes</span><span>
</span><span id="line-148"></span><span>    </span><span id="_cExistingSubscribers"><span class="annot"><span class="annottext">Cohort -&gt; SubscriberMap
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_cExistingSubscribers"><span class="hs-identifier hs-var hs-var">_cExistingSubscribers</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberMap"><span class="hs-identifier hs-type">SubscriberMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-149"></span><span>    </span><span class="hs-comment">-- | subscribers we haven&#8217;t yet pushed any results to; we push results to them regardless if the</span><span>
</span><span id="line-150"></span><span>    </span><span class="hs-comment">-- result changed, then merge them in the map of existing subscribers</span><span>
</span><span id="line-151"></span><span>    </span><span id="_cNewSubscribers"><span class="annot"><span class="annottext">Cohort -&gt; SubscriberMap
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_cNewSubscribers"><span class="hs-identifier hs-var hs-var">_cNewSubscribers</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberMap"><span class="hs-identifier hs-type">SubscriberMap</span></a></span><span>
</span><span id="line-152"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span class="hs-comment">-- | The @BatchId@ is a number based ID to uniquely identify a batch in a single poll and</span><span>
</span><span id="line-155"></span><span class="hs-comment">--   it's used to identify the batch to which a cohort belongs to.</span><span>
</span><span id="line-156"></span><span class="hs-keyword">newtype</span><span> </span><span id="BatchId"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#BatchId"><span class="hs-identifier hs-var">BatchId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="BatchId"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#BatchId"><span class="hs-identifier hs-var">BatchId</span></a></span></span><span> </span><span class="hs-special">{</span><span id="_unBatchId"><span class="annot"><span class="annottext">BatchId -&gt; Int
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_unBatchId"><span class="hs-identifier hs-var hs-var">_unBatchId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">}</span><span>
</span><span id="line-157"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688226525"><span id="local-6989586621688226527"><span id="local-6989586621688226529"><span class="annot"><span class="annottext">Int -&gt; BatchId -&gt; ShowS
[BatchId] -&gt; ShowS
BatchId -&gt; String
(Int -&gt; BatchId -&gt; ShowS)
-&gt; (BatchId -&gt; String) -&gt; ([BatchId] -&gt; ShowS) -&gt; Show BatchId
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [BatchId] -&gt; ShowS
$cshowList :: [BatchId] -&gt; ShowS
show :: BatchId -&gt; String
$cshow :: BatchId -&gt; String
showsPrec :: Int -&gt; BatchId -&gt; ShowS
$cshowsPrec :: Int -&gt; BatchId -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226521"><span id="local-6989586621688226523"><span class="annot"><span class="annottext">BatchId -&gt; BatchId -&gt; Bool
(BatchId -&gt; BatchId -&gt; Bool)
-&gt; (BatchId -&gt; BatchId -&gt; Bool) -&gt; Eq BatchId
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: BatchId -&gt; BatchId -&gt; Bool
$c/= :: BatchId -&gt; BatchId -&gt; Bool
== :: BatchId -&gt; BatchId -&gt; Bool
$c== :: BatchId -&gt; BatchId -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226513"><span id="local-6989586621688226515"><span id="local-6989586621688226517"><span id="local-6989586621688226519"><span class="annot"><span class="annottext">[BatchId] -&gt; Encoding
[BatchId] -&gt; Value
BatchId -&gt; Encoding
BatchId -&gt; Value
(BatchId -&gt; Value)
-&gt; (BatchId -&gt; Encoding)
-&gt; ([BatchId] -&gt; Value)
-&gt; ([BatchId] -&gt; Encoding)
-&gt; ToJSON BatchId
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
toEncodingList :: [BatchId] -&gt; Encoding
$ctoEncodingList :: [BatchId] -&gt; Encoding
toJSONList :: [BatchId] -&gt; Value
$ctoJSONList :: [BatchId] -&gt; Value
toEncoding :: BatchId -&gt; Encoding
$ctoEncoding :: BatchId -&gt; Encoding
toJSON :: BatchId -&gt; Value
$ctoJSON :: BatchId -&gt; Value
</span><a href="#local-6989586621688226513"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">J.ToJSON</span></a></span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>
</span><span id="line-159"></span><span class="hs-comment">{- Note [Blake2b faster than SHA-256]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
At the time of writing, from https://blake2.net, it is stated,
&quot;BLAKE2 is a cryptographic hash function faster than MD5, SHA-1, SHA-2, and SHA-3,
yet is at least as secure as the latest standard SHA-3&quot;.
-}</span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span class="hs-comment">-- | A hash used to determine if the result changed without having to keep the entire result in</span><span>
</span><span id="line-167"></span><span class="hs-comment">-- memory. Using a cryptographic hash ensures that a hash collision is almost impossible: with 256</span><span>
</span><span id="line-168"></span><span class="hs-comment">-- bits, even if a subscription changes once per second for an entire year, the probability of a</span><span>
</span><span id="line-169"></span><span class="hs-comment">-- hash collision is ~4.294417&#215;10-63. See Note [Blake2b faster than SHA-256].</span><span>
</span><span id="line-170"></span><span class="hs-keyword">newtype</span><span> </span><span id="ResponseHash"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#ResponseHash"><span class="hs-identifier hs-var">ResponseHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ResponseHash"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#ResponseHash"><span class="hs-identifier hs-var">ResponseHash</span></a></span></span><span> </span><span class="hs-special">{</span><span id="unResponseHash"><span class="annot"><span class="annottext">ResponseHash -&gt; Digest Blake2b_256
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#unResponseHash"><span class="hs-identifier hs-var hs-var">unResponseHash</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CH.Digest</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CH.Blake2b_256</span></span><span class="hs-special">}</span><span>
</span><span id="line-171"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688226505"><span id="local-6989586621688226507"><span id="local-6989586621688226509"><span class="annot"><span class="annottext">Int -&gt; ResponseHash -&gt; ShowS
[ResponseHash] -&gt; ShowS
ResponseHash -&gt; String
(Int -&gt; ResponseHash -&gt; ShowS)
-&gt; (ResponseHash -&gt; String)
-&gt; ([ResponseHash] -&gt; ShowS)
-&gt; Show ResponseHash
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ResponseHash] -&gt; ShowS
$cshowList :: [ResponseHash] -&gt; ShowS
show :: ResponseHash -&gt; String
$cshow :: ResponseHash -&gt; String
showsPrec :: Int -&gt; ResponseHash -&gt; ShowS
$cshowsPrec :: Int -&gt; ResponseHash -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226501"><span id="local-6989586621688226503"><span class="annot"><span class="annottext">ResponseHash -&gt; ResponseHash -&gt; Bool
(ResponseHash -&gt; ResponseHash -&gt; Bool)
-&gt; (ResponseHash -&gt; ResponseHash -&gt; Bool) -&gt; Eq ResponseHash
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: ResponseHash -&gt; ResponseHash -&gt; Bool
$c/= :: ResponseHash -&gt; ResponseHash -&gt; Bool
== :: ResponseHash -&gt; ResponseHash -&gt; Bool
$c== :: ResponseHash -&gt; ResponseHash -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621688226494"><span id="local-6989586621688226496"><span id="local-6989586621688226498"><span class="annot"><span class="hs-identifier hs-type">J.ToJSON</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#ResponseHash"><span class="hs-identifier hs-type">ResponseHash</span></a></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-174"></span><span>  </span><span id="local-6989586621688226493"><span class="annot"><span class="annottext">toJSON :: ResponseHash -&gt; Value
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">toJSON</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">J.toJSON</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Value)
-&gt; (ResponseHash -&gt; String) -&gt; ResponseHash -&gt; Value
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Digest Blake2b_256 -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">(Digest Blake2b_256 -&gt; String)
-&gt; (ResponseHash -&gt; Digest Blake2b_256) -&gt; ResponseHash -&gt; String
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ResponseHash -&gt; Digest Blake2b_256
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#unResponseHash"><span class="hs-identifier hs-var hs-var">unResponseHash</span></a></span><span>
</span><span id="line-175"></span><span>
</span><span id="line-176"></span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#mkRespHash"><span class="hs-identifier hs-type">mkRespHash</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#ResponseHash"><span class="hs-identifier hs-type">ResponseHash</span></a></span><span>
</span><span id="line-177"></span><span id="mkRespHash"><span class="annot"><span class="annottext">mkRespHash :: ByteString -&gt; ResponseHash
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#mkRespHash"><span class="hs-identifier hs-var hs-var">mkRespHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Digest Blake2b_256 -&gt; ResponseHash
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#ResponseHash"><span class="hs-identifier hs-var">ResponseHash</span></a></span><span> </span><span class="annot"><span class="annottext">(Digest Blake2b_256 -&gt; ResponseHash)
-&gt; (ByteString -&gt; Digest Blake2b_256) -&gt; ByteString -&gt; ResponseHash
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Digest Blake2b_256
forall ba a.
(ByteArrayAccess ba, HashAlgorithm a) =&gt;
ba -&gt; Digest a
</span><span class="hs-identifier hs-var">CH.hash</span></span><span>
</span><span id="line-178"></span><span>
</span><span id="line-179"></span><span class="hs-comment">-- | A key we use to determine if two 'Subscriber's belong in the same 'Cohort'</span><span>
</span><span id="line-180"></span><span class="hs-comment">-- (assuming they already meet the criteria to be in the same 'Poller'). Note</span><span>
</span><span id="line-181"></span><span class="hs-comment">-- the distinction between this and 'CohortId'; the latter is a completely</span><span>
</span><span id="line-182"></span><span class="hs-comment">-- synthetic key used only to identify the cohort in the generated SQL query.</span><span>
</span><span id="line-183"></span><span class="hs-keyword">type</span><span> </span><span id="CohortKey"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#CohortKey"><span class="hs-identifier hs-var">CohortKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Plan.html#CohortVariables"><span class="hs-identifier hs-type">CohortVariables</span></a></span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span class="hs-comment">-- | This has the invariant, maintained in 'removeLiveQuery', that it contains</span><span>
</span><span id="line-186"></span><span class="hs-comment">-- no 'Cohort' with zero total (existing + new) subscribers.</span><span>
</span><span id="line-187"></span><span class="hs-keyword">type</span><span> </span><span id="CohortMap"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#CohortMap"><span class="hs-identifier hs-var">CohortMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#TMap"><span class="hs-identifier hs-type">TMap.TMap</span></a></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#CohortKey"><span class="hs-identifier hs-type">CohortKey</span></a></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#Cohort"><span class="hs-identifier hs-type">Cohort</span></a></span><span>
</span><span id="line-188"></span><span>
</span><span id="line-189"></span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#dumpCohortMap"><span class="hs-identifier hs-type">dumpCohortMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#CohortMap"><span class="hs-identifier hs-type">CohortMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span>
</span><span id="line-190"></span><span id="dumpCohortMap"><span class="annot"><span class="annottext">dumpCohortMap :: CohortMap -&gt; IO Value
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#dumpCohortMap"><span class="hs-identifier hs-var hs-var">dumpCohortMap</span></a></span></span><span> </span><span id="local-6989586621688226486"><span class="annot"><span class="annottext">CohortMap
</span><a href="#local-6989586621688226486"><span class="hs-identifier hs-var">cohortMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-191"></span><span>  </span><span id="local-6989586621688226485"><span class="annot"><span class="annottext">[(CohortKey, Cohort)]
</span><a href="#local-6989586621688226485"><span class="hs-identifier hs-var">cohorts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM [(CohortKey, Cohort)] -&gt; IO [(CohortKey, Cohort)]
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM [(CohortKey, Cohort)] -&gt; IO [(CohortKey, Cohort)])
-&gt; STM [(CohortKey, Cohort)] -&gt; IO [(CohortKey, Cohort)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CohortMap -&gt; STM [(CohortKey, Cohort)]
forall k v. TMap k v -&gt; STM [(k, v)]
</span><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#toList"><span class="hs-identifier hs-var">TMap.toList</span></a></span><span> </span><span class="annot"><span class="annottext">CohortMap
</span><a href="#local-6989586621688226486"><span class="hs-identifier hs-var">cohortMap</span></a></span><span>
</span><span id="line-192"></span><span>  </span><span class="annot"><span class="annottext">([Value] -&gt; Value) -&gt; IO [Value] -&gt; IO Value
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[Value] -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">J.toJSON</span></span><span> </span><span class="annot"><span class="annottext">(IO [Value] -&gt; IO Value)
-&gt; (((CohortKey, Cohort) -&gt; IO Value) -&gt; IO [Value])
-&gt; ((CohortKey, Cohort) -&gt; IO Value)
-&gt; IO Value
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[(CohortKey, Cohort)]
-&gt; ((CohortKey, Cohort) -&gt; IO Value) -&gt; IO [Value]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[(CohortKey, Cohort)]
</span><a href="#local-6989586621688226485"><span class="hs-identifier hs-var">cohorts</span></a></span><span> </span><span class="annot"><span class="annottext">(((CohortKey, Cohort) -&gt; IO Value) -&gt; IO Value)
-&gt; ((CohortKey, Cohort) -&gt; IO Value) -&gt; IO Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621688226481"><span class="annot"><span class="annottext">CohortKey
</span><a href="#local-6989586621688226481"><span class="hs-identifier hs-var">variableValues</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226480"><span class="annot"><span class="annottext">Cohort
</span><a href="#local-6989586621688226480"><span class="hs-identifier hs-var">cohort</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-193"></span><span>    </span><span id="local-6989586621688226479"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688226479"><span class="hs-identifier hs-var">cohortJ</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Cohort -&gt; IO Value
</span><a href="#local-6989586621688226478"><span class="hs-identifier hs-var">dumpCohort</span></a></span><span> </span><span class="annot"><span class="annottext">Cohort
</span><a href="#local-6989586621688226480"><span class="hs-identifier hs-var">cohort</span></a></span><span>
</span><span id="line-194"></span><span>    </span><span class="annot"><span class="annottext">Value -&gt; IO Value
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; IO Value) -&gt; Value -&gt; IO Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-195"></span><span>      </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">J.object</span></span><span>
</span><span id="line-196"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;variables&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; CohortKey -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">CohortKey
</span><a href="#local-6989586621688226481"><span class="hs-identifier hs-var">variableValues</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-197"></span><span>          </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;cohort&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Value -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621688226479"><span class="hs-identifier hs-var">cohortJ</span></a></span><span>
</span><span id="line-198"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-199"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-200"></span><span>    </span><span id="local-6989586621688226478"><span class="annot"><span class="annottext">dumpCohort :: Cohort -&gt; IO Value
</span><a href="#local-6989586621688226478"><span class="hs-identifier hs-var hs-var">dumpCohort</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#Cohort"><span class="hs-identifier hs-type">Cohort</span></a></span><span> </span><span id="local-6989586621688226477"><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621688226477"><span class="hs-identifier hs-var">respId</span></a></span></span><span> </span><span id="local-6989586621688226476"><span class="annot"><span class="annottext">TVar (Maybe ResponseHash)
</span><a href="#local-6989586621688226476"><span class="hs-identifier hs-var">respTV</span></a></span></span><span> </span><span id="local-6989586621688226475"><span class="annot"><span class="annottext">SubscriberMap
</span><a href="#local-6989586621688226475"><span class="hs-identifier hs-var">curOps</span></a></span></span><span> </span><span id="local-6989586621688226474"><span class="annot"><span class="annottext">SubscriberMap
</span><a href="#local-6989586621688226474"><span class="hs-identifier hs-var">newOps</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-201"></span><span>      </span><span class="annot"><span class="annottext">STM Value -&gt; IO Value
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM Value -&gt; IO Value) -&gt; STM Value -&gt; IO Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-202"></span><span>        </span><span id="local-6989586621688226473"><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621688226473"><span class="hs-identifier hs-var">prevResHash</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar (Maybe ResponseHash) -&gt; STM (Maybe ResponseHash)
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">STM.readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (Maybe ResponseHash)
</span><a href="#local-6989586621688226476"><span class="hs-identifier hs-var">respTV</span></a></span><span>
</span><span id="line-203"></span><span>        </span><span id="local-6989586621688226471"><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621688226471"><span class="hs-identifier hs-var">curOpIds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubscriberMap -&gt; STM [(SubscriberId, Subscriber)]
forall k v. TMap k v -&gt; STM [(k, v)]
</span><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#toList"><span class="hs-identifier hs-var">TMap.toList</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberMap
</span><a href="#local-6989586621688226475"><span class="hs-identifier hs-var">curOps</span></a></span><span>
</span><span id="line-204"></span><span>        </span><span id="local-6989586621688226470"><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621688226470"><span class="hs-identifier hs-var">newOpIds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubscriberMap -&gt; STM [(SubscriberId, Subscriber)]
forall k v. TMap k v -&gt; STM [(k, v)]
</span><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#toList"><span class="hs-identifier hs-var">TMap.toList</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberMap
</span><a href="#local-6989586621688226474"><span class="hs-identifier hs-var">newOps</span></a></span><span>
</span><span id="line-205"></span><span>        </span><span class="annot"><span class="annottext">Value -&gt; STM Value
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; STM Value) -&gt; Value -&gt; STM Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-206"></span><span>          </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">J.object</span></span><span>
</span><span id="line-207"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;resp_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; CohortId -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621688226477"><span class="hs-identifier hs-var">respId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-208"></span><span>              </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;current_ops&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; [SubscriberId] -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">((SubscriberId, Subscriber) -&gt; SubscriberId)
-&gt; [(SubscriberId, Subscriber)] -&gt; [SubscriberId]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(SubscriberId, Subscriber) -&gt; SubscriberId
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621688226471"><span class="hs-identifier hs-var">curOpIds</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-209"></span><span>              </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;new_ops&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; [SubscriberId] -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">((SubscriberId, Subscriber) -&gt; SubscriberId)
-&gt; [(SubscriberId, Subscriber)] -&gt; [SubscriberId]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(SubscriberId, Subscriber) -&gt; SubscriberId
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621688226470"><span class="hs-identifier hs-var">newOpIds</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-210"></span><span>              </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;previous_result_hash&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Maybe ResponseHash -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621688226473"><span class="hs-identifier hs-var">prevResHash</span></a></span><span>
</span><span id="line-211"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span class="hs-keyword">data</span><span> </span><span id="CohortSnapshot"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#CohortSnapshot"><span class="hs-identifier hs-var">CohortSnapshot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CohortSnapshot"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#CohortSnapshot"><span class="hs-identifier hs-var">CohortSnapshot</span></a></span></span><span>
</span><span id="line-214"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_csVariables"><span class="annot"><span class="annottext">CohortSnapshot -&gt; CohortKey
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_csVariables"><span class="hs-identifier hs-var hs-var">_csVariables</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Plan.html#CohortVariables"><span class="hs-identifier hs-type">CohortVariables</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-215"></span><span>    </span><span id="_csPreviousResponse"><span class="annot"><span class="annottext">CohortSnapshot -&gt; TVar (Maybe ResponseHash)
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_csPreviousResponse"><span class="hs-identifier hs-var hs-var">_csPreviousResponse</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">STM.TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#ResponseHash"><span class="hs-identifier hs-type">ResponseHash</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-216"></span><span>    </span><span id="_csExistingSubscribers"><span class="annot"><span class="annottext">CohortSnapshot -&gt; [Subscriber]
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_csExistingSubscribers"><span class="hs-identifier hs-var hs-var">_csExistingSubscribers</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#Subscriber"><span class="hs-identifier hs-type">Subscriber</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-217"></span><span>    </span><span id="_csNewSubscribers"><span class="annot"><span class="annottext">CohortSnapshot -&gt; [Subscriber]
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_csNewSubscribers"><span class="hs-identifier hs-var hs-var">_csNewSubscribers</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#Subscriber"><span class="hs-identifier hs-type">Subscriber</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-218"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-219"></span><span>
</span><span id="line-220"></span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#pushResultToCohort"><span class="hs-identifier hs-type">pushResultToCohort</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-221"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#GQResult"><span class="hs-identifier hs-type">GQResult</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BS.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-222"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#ResponseHash"><span class="hs-identifier hs-type">ResponseHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-223"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#LiveQueryMetadata"><span class="hs-identifier hs-type">LiveQueryMetadata</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-224"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#CohortSnapshot"><span class="hs-identifier hs-type">CohortSnapshot</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-225"></span><span>  </span><span class="hs-comment">-- | subscribers to which data has been pushed, subscribers which already</span><span>
</span><span id="line-226"></span><span>  </span><span class="hs-comment">-- have this data (this information is exposed by metrics reporting)</span><span>
</span><span id="line-227"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberExecutionDetails"><span class="hs-identifier hs-type">SubscriberExecutionDetails</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberExecutionDetails"><span class="hs-identifier hs-type">SubscriberExecutionDetails</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-228"></span><span id="pushResultToCohort"><span class="annot"><span class="annottext">pushResultToCohort :: GQResult ByteString
-&gt; Maybe ResponseHash
-&gt; LiveQueryMetadata
-&gt; CohortSnapshot
-&gt; IO ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#pushResultToCohort"><span class="hs-identifier hs-var hs-var">pushResultToCohort</span></a></span></span><span> </span><span id="local-6989586621688226463"><span class="annot"><span class="annottext">GQResult ByteString
</span><a href="#local-6989586621688226463"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621688226462"><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621688226462"><span class="hs-identifier hs-var">respHashM</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#LiveQueryMetadata"><span class="hs-identifier hs-type">LiveQueryMetadata</span></a></span><span> </span><span id="local-6989586621688226461"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621688226461"><span class="hs-identifier hs-var">dTime</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621688226460"><span class="annot"><span class="annottext">CohortSnapshot
</span><a href="#local-6989586621688226460"><span class="hs-identifier hs-var">cohortSnapshot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-229"></span><span>  </span><span id="local-6989586621688226459"><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621688226459"><span class="hs-identifier hs-var">prevRespHashM</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar (Maybe ResponseHash) -&gt; IO (Maybe ResponseHash)
forall a. TVar a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">TVar (Maybe ResponseHash)
</span><a href="#local-6989586621688226457"><span class="hs-identifier hs-var">respRef</span></a></span><span>
</span><span id="line-230"></span><span>  </span><span class="hs-comment">-- write to the current websockets if needed</span><span>
</span><span id="line-231"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621688226456"><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621688226456"><span class="hs-identifier hs-var">subscribersToPush</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226455"><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621688226455"><span class="hs-identifier hs-var">subscribersToIgnore</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-232"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">GQResult ByteString -&gt; Bool
forall a. GQResult a -&gt; Bool
</span><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#isExecError"><span class="hs-identifier hs-var">isExecError</span></a></span><span> </span><span class="annot"><span class="annottext">GQResult ByteString
</span><a href="#local-6989586621688226463"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621688226462"><span class="hs-identifier hs-var">respHashM</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash -&gt; Maybe ResponseHash -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621688226459"><span class="hs-identifier hs-var">prevRespHashM</span></a></span><span>
</span><span id="line-233"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-234"></span><span>        </span><span class="annot"><span class="annottext">String
String -&gt; Maybe ResponseHash -&gt; IO ()
forall a. String -&gt; a -&gt; IO ()
</span><span class="hs-var">$assertNFHere</span></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621688226462"><span class="hs-identifier hs-var">respHashM</span></a></span><span> </span><span class="hs-comment">-- so we don't write thunks to mutable vars</span><span>
</span><span id="line-235"></span><span>        </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TVar (Maybe ResponseHash) -&gt; Maybe ResponseHash -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">STM.writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (Maybe ResponseHash)
</span><a href="#local-6989586621688226457"><span class="hs-identifier hs-var">respRef</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ResponseHash
</span><a href="#local-6989586621688226462"><span class="hs-identifier hs-var">respHashM</span></a></span><span>
</span><span id="line-236"></span><span>        </span><span class="annot"><span class="annottext">([Subscriber], [Subscriber]) -&gt; IO ([Subscriber], [Subscriber])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621688226449"><span class="hs-identifier hs-var">newSinks</span></a></span><span> </span><span class="annot"><span class="annottext">[Subscriber] -&gt; [Subscriber] -&gt; [Subscriber]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621688226448"><span class="hs-identifier hs-var">curSinks</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Subscriber]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-237"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">([Subscriber], [Subscriber]) -&gt; IO ([Subscriber], [Subscriber])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621688226449"><span class="hs-identifier hs-var">newSinks</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621688226448"><span class="hs-identifier hs-var">curSinks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-238"></span><span>  </span><span class="annot"><span class="annottext">[Subscriber] -&gt; IO ()
</span><a href="#local-6989586621688226447"><span class="hs-identifier hs-var">pushResultToSubscribers</span></a></span><span> </span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621688226456"><span class="hs-identifier hs-var">subscribersToPush</span></a></span><span>
</span><span id="line-239"></span><span>  </span><span class="annot"><span class="annottext">([SubscriberExecutionDetails], [SubscriberExecutionDetails])
-&gt; IO ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(([SubscriberExecutionDetails], [SubscriberExecutionDetails])
 -&gt; IO ([SubscriberExecutionDetails], [SubscriberExecutionDetails]))
-&gt; ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
-&gt; IO ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-240"></span><span>    </span><span class="annot"><span class="annottext">ASetter
  ([Subscriber], [Subscriber])
  ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
  Subscriber
  SubscriberExecutionDetails
-&gt; (Subscriber -&gt; SubscriberExecutionDetails)
-&gt; ([Subscriber], [Subscriber])
-&gt; ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-identifier hs-var">over</span></span><span>
</span><span id="line-241"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([Subscriber] -&gt; Identity [SubscriberExecutionDetails])
-&gt; ([Subscriber], [Subscriber])
-&gt; Identity
     ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
forall s t a b. Each s t a b =&gt; Traversal s t a b
</span><span class="hs-identifier hs-var">each</span></span><span> </span><span class="annot"><span class="annottext">(([Subscriber] -&gt; Identity [SubscriberExecutionDetails])
 -&gt; ([Subscriber], [Subscriber])
 -&gt; Identity
      ([SubscriberExecutionDetails], [SubscriberExecutionDetails]))
-&gt; ((Subscriber -&gt; Identity SubscriberExecutionDetails)
    -&gt; [Subscriber] -&gt; Identity [SubscriberExecutionDetails])
-&gt; ASetter
     ([Subscriber], [Subscriber])
     ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
     Subscriber
     SubscriberExecutionDetails
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Subscriber -&gt; Identity SubscriberExecutionDetails)
-&gt; [Subscriber] -&gt; Identity [SubscriberExecutionDetails]
forall s t a b. Each s t a b =&gt; Traversal s t a b
</span><span class="hs-identifier hs-var">each</span></span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#Subscriber"><span class="hs-identifier hs-type">Subscriber</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688226440"><span id="local-6989586621688226441"><span id="local-6989586621688226442"><span id="local-6989586621688226443"><span id="local-6989586621688226444"><span class="annot"><span class="annottext">Maybe OperationName
RequestId
SubscriberMetadata
SubscriberId
OnChange
_sOnChangeCallback :: OnChange
_sOperationName :: Maybe OperationName
_sRequestId :: RequestId
_sMetadata :: SubscriberMetadata
_sId :: SubscriberId
_sOnChangeCallback :: Subscriber -&gt; OnChange
_sOperationName :: Subscriber -&gt; Maybe OperationName
_sRequestId :: Subscriber -&gt; RequestId
_sMetadata :: Subscriber -&gt; SubscriberMetadata
_sId :: Subscriber -&gt; SubscriberId
</span><a href="#local-6989586621688226440"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-243"></span><span>          </span><span class="annot"><span class="annottext">SubscriberId -&gt; SubscriberMetadata -&gt; SubscriberExecutionDetails
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberExecutionDetails"><span class="hs-identifier hs-var">SubscriberExecutionDetails</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621688226444"><span class="hs-identifier hs-var">_sId</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberMetadata
</span><a href="#local-6989586621688226443"><span class="hs-identifier hs-var">_sMetadata</span></a></span><span>
</span><span id="line-244"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621688226456"><span class="hs-identifier hs-var">subscribersToPush</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621688226455"><span class="hs-identifier hs-var">subscribersToIgnore</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-247"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#CohortSnapshot"><span class="hs-identifier hs-type">CohortSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">CohortKey
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688226457"><span class="annot"><span class="annottext">TVar (Maybe ResponseHash)
</span><a href="#local-6989586621688226457"><span class="hs-identifier hs-var">respRef</span></a></span></span><span> </span><span id="local-6989586621688226448"><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621688226448"><span class="hs-identifier hs-var">curSinks</span></a></span></span><span> </span><span id="local-6989586621688226449"><span class="annot"><span class="annottext">[Subscriber]
</span><a href="#local-6989586621688226449"><span class="hs-identifier hs-var">newSinks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CohortSnapshot
</span><a href="#local-6989586621688226460"><span class="hs-identifier hs-var">cohortSnapshot</span></a></span><span>
</span><span id="line-248"></span><span>
</span><span id="line-249"></span><span>    </span><span id="local-6989586621688226438"><span class="annot"><span class="annottext">response :: Either GQExecError LiveQueryResponse
</span><a href="#local-6989586621688226438"><span class="hs-identifier hs-var hs-var">response</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GQResult ByteString
</span><a href="#local-6989586621688226463"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="annot"><span class="annottext">GQResult ByteString
-&gt; (ByteString -&gt; LiveQueryResponse)
-&gt; Either GQExecError LiveQueryResponse
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688226436"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621688226436"><span class="hs-identifier hs-var">payload</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; DiffTime -&gt; LiveQueryResponse
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#LiveQueryResponse"><span class="hs-identifier hs-var">LiveQueryResponse</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621688226436"><span class="hs-identifier hs-var">payload</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621688226461"><span class="hs-identifier hs-var">dTime</span></a></span><span>
</span><span id="line-250"></span><span>    </span><span id="local-6989586621688226447"><span class="annot"><span class="annottext">pushResultToSubscribers :: [Subscriber] -&gt; IO ()
</span><a href="#local-6989586621688226447"><span class="hs-identifier hs-var hs-var">pushResultToSubscribers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-251"></span><span>      </span><span class="annot"><span class="annottext">(Subscriber -&gt; IO ()) -&gt; [Subscriber] -&gt; IO ()
forall (f :: * -&gt; *) a b. Foldable f =&gt; (a -&gt; IO b) -&gt; f a -&gt; IO ()
</span><span class="hs-identifier hs-var">A.mapConcurrently_</span></span><span> </span><span class="annot"><span class="annottext">((Subscriber -&gt; IO ()) -&gt; [Subscriber] -&gt; IO ())
-&gt; (Subscriber -&gt; IO ()) -&gt; [Subscriber] -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#Subscriber"><span class="hs-identifier hs-type">Subscriber</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688226430"><span id="local-6989586621688226431"><span id="local-6989586621688226432"><span id="local-6989586621688226433"><span id="local-6989586621688226434"><span class="annot"><span class="annottext">Maybe OperationName
RequestId
SubscriberMetadata
SubscriberId
OnChange
_sOnChangeCallback :: OnChange
_sOperationName :: Maybe OperationName
_sRequestId :: RequestId
_sMetadata :: SubscriberMetadata
_sId :: SubscriberId
_sOnChangeCallback :: Subscriber -&gt; OnChange
_sOperationName :: Subscriber -&gt; Maybe OperationName
_sRequestId :: Subscriber -&gt; RequestId
_sMetadata :: Subscriber -&gt; SubscriberMetadata
_sId :: Subscriber -&gt; SubscriberId
</span><a href="#local-6989586621688226430"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">OnChange
</span><a href="#local-6989586621688226430"><span class="hs-identifier hs-var">_sOnChangeCallback</span></a></span><span> </span><span class="annot"><span class="annottext">Either GQExecError LiveQueryResponse
</span><a href="#local-6989586621688226438"><span class="hs-identifier hs-var">response</span></a></span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><span id="line-254"></span><span class="hs-comment">-- Pollers</span><span>
</span><span id="line-255"></span><span>
</span><span id="line-256"></span><span class="hs-comment">-- | A unique, multiplexed query. Each 'Poller' has its own polling thread that</span><span>
</span><span id="line-257"></span><span class="hs-comment">-- periodically polls Postgres and pushes results to each of its listening</span><span>
</span><span id="line-258"></span><span class="hs-comment">-- 'Cohort's.</span><span>
</span><span id="line-259"></span><span class="hs-comment">--</span><span>
</span><span id="line-260"></span><span class="hs-comment">-- In SQL, an 'Poller' corresponds to a single, multiplexed query, though in</span><span>
</span><span id="line-261"></span><span class="hs-comment">-- practice, 'Poller's with large numbers of 'Cohort's are batched into</span><span>
</span><span id="line-262"></span><span class="hs-comment">-- multiple concurrent queries for performance reasons.</span><span>
</span><span id="line-263"></span><span class="hs-keyword">data</span><span> </span><span id="Poller"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#Poller"><span class="hs-identifier hs-var">Poller</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Poller"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#Poller"><span class="hs-identifier hs-var">Poller</span></a></span></span><span>
</span><span id="line-264"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_pCohorts"><span class="annot"><span class="annottext">Poller -&gt; CohortMap
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pCohorts"><span class="hs-identifier hs-var hs-var">_pCohorts</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#CohortMap"><span class="hs-identifier hs-type">CohortMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-265"></span><span>    </span><span class="hs-comment">-- | This is in a separate 'STM.TMVar' because it&#8217;s important that we are</span><span>
</span><span id="line-266"></span><span>    </span><span class="hs-comment">-- able to construct 'Poller' values in 'STM.STM' --- we need the insertion</span><span>
</span><span id="line-267"></span><span>    </span><span class="hs-comment">-- into the 'PollerMap' to be atomic to ensure that we don&#8217;t accidentally</span><span>
</span><span id="line-268"></span><span>    </span><span class="hs-comment">-- create two for the same query due to a race. However, we can&#8217;t spawn the</span><span>
</span><span id="line-269"></span><span>    </span><span class="hs-comment">-- worker thread or create the metrics store in 'STM.STM', so we insert it</span><span>
</span><span id="line-270"></span><span>    </span><span class="hs-comment">-- into the 'Poller' only after we&#8217;re certain we won&#8217;t create any duplicates.</span><span>
</span><span id="line-271"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-272"></span><span>    </span><span class="hs-comment">-- This var is &quot;write once&quot;, moving monotonically from empty to full.</span><span>
</span><span id="line-273"></span><span>    </span><span class="hs-comment">-- TODO this could probably be tightened up to something like</span><span>
</span><span id="line-274"></span><span>    </span><span class="hs-comment">-- 'STM PollerIOState'</span><span>
</span><span id="line-275"></span><span>    </span><span id="_pIOState"><span class="annot"><span class="annottext">Poller -&gt; TMVar PollerIOState
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pIOState"><span class="hs-identifier hs-var hs-var">_pIOState</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">STM.TMVar</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerIOState"><span class="hs-identifier hs-type">PollerIOState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-276"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-277"></span><span>
</span><span id="line-278"></span><span class="hs-keyword">data</span><span> </span><span id="PollerIOState"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerIOState"><span class="hs-identifier hs-var">PollerIOState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PollerIOState"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerIOState"><span class="hs-identifier hs-var">PollerIOState</span></a></span></span><span>
</span><span id="line-279"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | a handle on the poller&#8217;s worker thread that can be used to</span><span>
</span><span id="line-280"></span><span>    </span><span class="hs-comment">-- 'Immortal.stop' it if all its cohorts stop listening</span><span>
</span><span id="line-281"></span><span>    </span><span id="_pThread"><span class="annot"><span class="annottext">PollerIOState -&gt; Thread
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pThread"><span class="hs-identifier hs-var hs-var">_pThread</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Immortal.Thread</span></span><span class="hs-special">,</span><span>
</span><span id="line-282"></span><span>    </span><span id="_pId"><span class="annot"><span class="annottext">PollerIOState -&gt; PollerId
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pId"><span class="hs-identifier hs-var hs-var">_pId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerId"><span class="hs-identifier hs-type">PollerId</span></a></span><span>
</span><span id="line-283"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-284"></span><span>
</span><span id="line-285"></span><span id="local-6989586621688226422"><span id="local-6989586621688226423"></span></span><span class="hs-keyword">data</span><span> </span><span id="PollerKey"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerKey"><span class="hs-identifier hs-var">PollerKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-286"></span><span>  </span><span class="hs-comment">-- we don't need operation name here as a subscription will only have a</span><span>
</span><span id="line-287"></span><span>  </span><span class="hs-comment">-- single top level field</span><span>
</span><span id="line-288"></span><span>  </span><span id="PollerKey"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerKey"><span class="hs-identifier hs-var">PollerKey</span></a></span></span><span>
</span><span id="line-289"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_lgSource"><span class="annot"><span class="annottext">PollerKey -&gt; SourceName
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_lgSource"><span class="hs-identifier hs-var hs-var">_lgSource</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-290"></span><span>    </span><span id="_lgRole"><span class="annot"><span class="annottext">PollerKey -&gt; RoleName
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_lgRole"><span class="hs-identifier hs-var hs-var">_lgRole</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.Session.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-291"></span><span>    </span><span id="_lgQuery"><span class="annot"><span class="annottext">PollerKey -&gt; Text
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_lgQuery"><span class="hs-identifier hs-var hs-var">_lgQuery</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-292"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-293"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688226412"><span id="local-6989586621688226414"><span id="local-6989586621688226416"><span class="annot"><span class="annottext">Int -&gt; PollerKey -&gt; ShowS
[PollerKey] -&gt; ShowS
PollerKey -&gt; String
(Int -&gt; PollerKey -&gt; ShowS)
-&gt; (PollerKey -&gt; String)
-&gt; ([PollerKey] -&gt; ShowS)
-&gt; Show PollerKey
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [PollerKey] -&gt; ShowS
$cshowList :: [PollerKey] -&gt; ShowS
show :: PollerKey -&gt; String
$cshow :: PollerKey -&gt; String
showsPrec :: Int -&gt; PollerKey -&gt; ShowS
$cshowsPrec :: Int -&gt; PollerKey -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226408"><span id="local-6989586621688226410"><span class="annot"><span class="annottext">PollerKey -&gt; PollerKey -&gt; Bool
(PollerKey -&gt; PollerKey -&gt; Bool)
-&gt; (PollerKey -&gt; PollerKey -&gt; Bool) -&gt; Eq PollerKey
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: PollerKey -&gt; PollerKey -&gt; Bool
$c/= :: PollerKey -&gt; PollerKey -&gt; Bool
== :: PollerKey -&gt; PollerKey -&gt; Bool
$c== :: PollerKey -&gt; PollerKey -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. PollerKey -&gt; Rep PollerKey x)
-&gt; (forall x. Rep PollerKey x -&gt; PollerKey) -&gt; Generic PollerKey
forall x. Rep PollerKey x -&gt; PollerKey
forall x. PollerKey -&gt; Rep PollerKey x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep PollerKey x -&gt; PollerKey
$cfrom :: forall x. PollerKey -&gt; Rep PollerKey x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-294"></span><span>
</span><span id="line-295"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621688226402"><span id="local-6989586621688226404"><span class="annot"><span class="hs-identifier hs-type">Hashable</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerKey"><span class="hs-identifier hs-type">PollerKey</span></a></span></span></span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621688226395"><span id="local-6989586621688226397"><span id="local-6989586621688226399"><span class="annot"><span class="hs-identifier hs-type">J.ToJSON</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerKey"><span class="hs-identifier hs-type">PollerKey</span></a></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-298"></span><span>  </span><span id="local-6989586621688226394"><span class="annot"><span class="annottext">toJSON :: PollerKey -&gt; Value
</span><a href="#local-6989586621688226394"><span class="hs-identifier hs-var hs-var hs-var hs-var">toJSON</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerKey"><span class="hs-identifier hs-type">PollerKey</span></a></span><span> </span><span id="local-6989586621688226393"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688226393"><span class="hs-identifier hs-var">source</span></a></span></span><span> </span><span id="local-6989586621688226392"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688226392"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span id="local-6989586621688226391"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688226391"><span class="hs-identifier hs-var">query</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-299"></span><span>    </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">J.object</span></span><span>
</span><span id="line-300"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;source&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; SourceName -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688226393"><span class="hs-identifier hs-var">source</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-301"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;role&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; RoleName -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688226392"><span class="hs-keyword hs-var">role</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-302"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;query&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688226391"><span class="hs-identifier hs-var">query</span></a></span><span>
</span><span id="line-303"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span class="hs-keyword">type</span><span> </span><span id="PollerMap"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerMap"><span class="hs-identifier hs-var">PollerMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STMMap.Map</span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerKey"><span class="hs-identifier hs-type">PollerKey</span></a></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#Poller"><span class="hs-identifier hs-type">Poller</span></a></span><span>
</span><span id="line-306"></span><span>
</span><span id="line-307"></span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#dumpPollerMap"><span class="hs-identifier hs-type">dumpPollerMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerMap"><span class="hs-identifier hs-type">PollerMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span>
</span><span id="line-308"></span><span id="dumpPollerMap"><span class="annot"><span class="annottext">dumpPollerMap :: Bool -&gt; PollerMap -&gt; IO Value
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#dumpPollerMap"><span class="hs-identifier hs-var hs-var">dumpPollerMap</span></a></span></span><span> </span><span id="local-6989586621688226390"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688226390"><span class="hs-identifier hs-var">extended</span></a></span></span><span> </span><span id="local-6989586621688226389"><span class="annot"><span class="annottext">PollerMap
</span><a href="#local-6989586621688226389"><span class="hs-identifier hs-var">lqMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-309"></span><span>  </span><span class="annot"><span class="annottext">([Value] -&gt; Value) -&gt; IO [Value] -&gt; IO Value
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[Value] -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">J.toJSON</span></span><span> </span><span class="annot"><span class="annottext">(IO [Value] -&gt; IO Value) -&gt; IO [Value] -&gt; IO Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-310"></span><span>    </span><span id="local-6989586621688226388"><span class="annot"><span class="annottext">[(PollerKey, Poller)]
</span><a href="#local-6989586621688226388"><span class="hs-identifier hs-var">entries</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM [(PollerKey, Poller)] -&gt; IO [(PollerKey, Poller)]
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM [(PollerKey, Poller)] -&gt; IO [(PollerKey, Poller)])
-&gt; STM [(PollerKey, Poller)] -&gt; IO [(PollerKey, Poller)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ListT STM (PollerKey, Poller) -&gt; STM [(PollerKey, Poller)]
forall (m :: * -&gt; *) a. Monad m =&gt; ListT m a -&gt; m [a]
</span><span class="hs-identifier hs-var">ListT.toList</span></span><span> </span><span class="annot"><span class="annottext">(ListT STM (PollerKey, Poller) -&gt; STM [(PollerKey, Poller)])
-&gt; ListT STM (PollerKey, Poller) -&gt; STM [(PollerKey, Poller)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PollerMap -&gt; ListT STM (PollerKey, Poller)
forall key value. Map key value -&gt; ListT STM (key, value)
</span><span class="hs-identifier hs-var">STMMap.listT</span></span><span> </span><span class="annot"><span class="annottext">PollerMap
</span><a href="#local-6989586621688226389"><span class="hs-identifier hs-var">lqMap</span></a></span><span>
</span><span id="line-311"></span><span>    </span><span class="annot"><span class="annottext">[(PollerKey, Poller)]
-&gt; ((PollerKey, Poller) -&gt; IO Value) -&gt; IO [Value]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[(PollerKey, Poller)]
</span><a href="#local-6989586621688226388"><span class="hs-identifier hs-var">entries</span></a></span><span> </span><span class="annot"><span class="annottext">(((PollerKey, Poller) -&gt; IO Value) -&gt; IO [Value])
-&gt; ((PollerKey, Poller) -&gt; IO Value) -&gt; IO [Value]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerKey"><span class="hs-identifier hs-type">PollerKey</span></a></span><span> </span><span id="local-6989586621688226385"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688226385"><span class="hs-identifier hs-var">source</span></a></span></span><span> </span><span id="local-6989586621688226384"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688226384"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span id="local-6989586621688226383"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688226383"><span class="hs-identifier hs-var">query</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#Poller"><span class="hs-identifier hs-type">Poller</span></a></span><span> </span><span id="local-6989586621688226382"><span class="annot"><span class="annottext">CohortMap
</span><a href="#local-6989586621688226382"><span class="hs-identifier hs-var">cohortsMap</span></a></span></span><span> </span><span id="local-6989586621688226381"><span class="annot"><span class="annottext">TMVar PollerIOState
</span><a href="#local-6989586621688226381"><span class="hs-identifier hs-var">ioState</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-312"></span><span>      </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerIOState"><span class="hs-identifier hs-type">PollerIOState</span></a></span><span> </span><span id="local-6989586621688226380"><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621688226380"><span class="hs-identifier hs-var">threadId</span></a></span></span><span> </span><span id="local-6989586621688226379"><span class="annot"><span class="annottext">PollerId
</span><a href="#local-6989586621688226379"><span class="hs-identifier hs-var">pollerId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM PollerIOState -&gt; IO PollerIOState
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM PollerIOState -&gt; IO PollerIOState)
-&gt; STM PollerIOState -&gt; IO PollerIOState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar PollerIOState -&gt; STM PollerIOState
forall a. TMVar a -&gt; STM a
</span><span class="hs-identifier hs-var">STM.readTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar PollerIOState
</span><a href="#local-6989586621688226381"><span class="hs-identifier hs-var">ioState</span></a></span><span>
</span><span id="line-313"></span><span>      </span><span id="local-6989586621688226377"><span class="annot"><span class="annottext">Maybe Value
</span><a href="#local-6989586621688226377"><span class="hs-identifier hs-var">cohortsJ</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-314"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688226390"><span class="hs-identifier hs-var">extended</span></a></span><span>
</span><span id="line-315"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Value -&gt; Maybe Value
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; Maybe Value) -&gt; IO Value -&gt; IO (Maybe Value)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">CohortMap -&gt; IO Value
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#dumpCohortMap"><span class="hs-identifier hs-var">dumpCohortMap</span></a></span><span> </span><span class="annot"><span class="annottext">CohortMap
</span><a href="#local-6989586621688226382"><span class="hs-identifier hs-var">cohortsMap</span></a></span><span>
</span><span id="line-316"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe Value -&gt; IO (Maybe Value)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe Value
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-317"></span><span>      </span><span class="annot"><span class="annottext">Value -&gt; IO Value
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; IO Value) -&gt; Value -&gt; IO Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-318"></span><span>        </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">J.object</span></span><span>
</span><span id="line-319"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;source&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; SourceName -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688226385"><span class="hs-identifier hs-var">source</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-320"></span><span>            </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;role&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; RoleName -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688226384"><span class="hs-keyword hs-var">role</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-321"></span><span>            </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;thread_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">ThreadId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Thread -&gt; ThreadId
</span><span class="hs-identifier hs-var">Immortal.threadId</span></span><span> </span><span class="annot"><span class="annottext">Thread
</span><a href="#local-6989586621688226380"><span class="hs-identifier hs-var">threadId</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-322"></span><span>            </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;poller_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; PollerId -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">PollerId
</span><a href="#local-6989586621688226379"><span class="hs-identifier hs-var">pollerId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-323"></span><span>            </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;multiplexed_query&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688226383"><span class="hs-identifier hs-var">query</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-324"></span><span>            </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;cohorts&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Maybe Value -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">Maybe Value
</span><a href="#local-6989586621688226377"><span class="hs-identifier hs-var">cohortsJ</span></a></span><span>
</span><span id="line-325"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-326"></span><span>
</span><span id="line-327"></span><span class="hs-comment">-- | An ID to track unique 'Poller's, so that we can gather metrics about each</span><span>
</span><span id="line-328"></span><span class="hs-comment">-- poller</span><span>
</span><span id="line-329"></span><span id="local-6989586621688226374"><span id="local-6989586621688226375"></span></span><span class="hs-keyword">newtype</span><span> </span><span id="PollerId"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerId"><span class="hs-identifier hs-var">PollerId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PollerId"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerId"><span class="hs-identifier hs-var">PollerId</span></a></span></span><span> </span><span class="hs-special">{</span><span id="unPollerId"><span class="annot"><span class="annottext">PollerId -&gt; UUID
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#unPollerId"><span class="hs-identifier hs-var hs-var">unPollerId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">UUID.UUID</span></span><span class="hs-special">}</span><span>
</span><span id="line-330"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688226366"><span id="local-6989586621688226368"><span id="local-6989586621688226370"><span class="annot"><span class="annottext">Int -&gt; PollerId -&gt; ShowS
[PollerId] -&gt; ShowS
PollerId -&gt; String
(Int -&gt; PollerId -&gt; ShowS)
-&gt; (PollerId -&gt; String) -&gt; ([PollerId] -&gt; ShowS) -&gt; Show PollerId
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [PollerId] -&gt; ShowS
$cshowList :: [PollerId] -&gt; ShowS
show :: PollerId -&gt; String
$cshow :: PollerId -&gt; String
showsPrec :: Int -&gt; PollerId -&gt; ShowS
$cshowsPrec :: Int -&gt; PollerId -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226362"><span id="local-6989586621688226364"><span class="annot"><span class="annottext">PollerId -&gt; PollerId -&gt; Bool
(PollerId -&gt; PollerId -&gt; Bool)
-&gt; (PollerId -&gt; PollerId -&gt; Bool) -&gt; Eq PollerId
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: PollerId -&gt; PollerId -&gt; Bool
$c/= :: PollerId -&gt; PollerId -&gt; Bool
== :: PollerId -&gt; PollerId -&gt; Bool
$c== :: PollerId -&gt; PollerId -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. PollerId -&gt; Rep PollerId x)
-&gt; (forall x. Rep PollerId x -&gt; PollerId) -&gt; Generic PollerId
forall x. Rep PollerId x -&gt; PollerId
forall x. PollerId -&gt; Rep PollerId x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep PollerId x -&gt; PollerId
$cfrom :: forall x. PollerId -&gt; Rep PollerId x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226352"><span id="local-6989586621688226354"><span id="local-6989586621688226356"><span id="local-6989586621688226358"><span class="annot"><span class="annottext">[PollerId] -&gt; Encoding
[PollerId] -&gt; Value
PollerId -&gt; Encoding
PollerId -&gt; Value
(PollerId -&gt; Value)
-&gt; (PollerId -&gt; Encoding)
-&gt; ([PollerId] -&gt; Value)
-&gt; ([PollerId] -&gt; Encoding)
-&gt; ToJSON PollerId
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
toEncodingList :: [PollerId] -&gt; Encoding
$ctoEncodingList :: [PollerId] -&gt; Encoding
toJSONList :: [PollerId] -&gt; Value
$ctoJSONList :: [PollerId] -&gt; Value
toEncoding :: PollerId -&gt; Encoding
$ctoEncoding :: PollerId -&gt; Encoding
toJSON :: PollerId -&gt; Value
$ctoJSON :: PollerId -&gt; Value
</span><a href="#local-6989586621688226352"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">J.ToJSON</span></a></span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-331"></span><span>
</span><span id="line-332"></span><span class="hs-keyword">data</span><span> </span><span id="SubscriberExecutionDetails"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberExecutionDetails"><span class="hs-identifier hs-var">SubscriberExecutionDetails</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SubscriberExecutionDetails"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberExecutionDetails"><span class="hs-identifier hs-var">SubscriberExecutionDetails</span></a></span></span><span>
</span><span id="line-333"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_sedSubscriberId"><span class="annot"><span class="annottext">SubscriberExecutionDetails -&gt; SubscriberId
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_sedSubscriberId"><span class="hs-identifier hs-var hs-var">_sedSubscriberId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberId"><span class="hs-identifier hs-type">SubscriberId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-334"></span><span>    </span><span id="_sedSubscriberMetadata"><span class="annot"><span class="annottext">SubscriberExecutionDetails -&gt; SubscriberMetadata
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_sedSubscriberMetadata"><span class="hs-identifier hs-var hs-var">_sedSubscriberMetadata</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberMetadata"><span class="hs-identifier hs-type">SubscriberMetadata</span></a></span><span>
</span><span id="line-335"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-336"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688226344"><span id="local-6989586621688226346"><span id="local-6989586621688226348"><span class="annot"><span class="annottext">Int -&gt; SubscriberExecutionDetails -&gt; ShowS
[SubscriberExecutionDetails] -&gt; ShowS
SubscriberExecutionDetails -&gt; String
(Int -&gt; SubscriberExecutionDetails -&gt; ShowS)
-&gt; (SubscriberExecutionDetails -&gt; String)
-&gt; ([SubscriberExecutionDetails] -&gt; ShowS)
-&gt; Show SubscriberExecutionDetails
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [SubscriberExecutionDetails] -&gt; ShowS
$cshowList :: [SubscriberExecutionDetails] -&gt; ShowS
show :: SubscriberExecutionDetails -&gt; String
$cshow :: SubscriberExecutionDetails -&gt; String
showsPrec :: Int -&gt; SubscriberExecutionDetails -&gt; ShowS
$cshowsPrec :: Int -&gt; SubscriberExecutionDetails -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226340"><span id="local-6989586621688226342"><span class="annot"><span class="annottext">SubscriberExecutionDetails -&gt; SubscriberExecutionDetails -&gt; Bool
(SubscriberExecutionDetails -&gt; SubscriberExecutionDetails -&gt; Bool)
-&gt; (SubscriberExecutionDetails
    -&gt; SubscriberExecutionDetails -&gt; Bool)
-&gt; Eq SubscriberExecutionDetails
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: SubscriberExecutionDetails -&gt; SubscriberExecutionDetails -&gt; Bool
$c/= :: SubscriberExecutionDetails -&gt; SubscriberExecutionDetails -&gt; Bool
== :: SubscriberExecutionDetails -&gt; SubscriberExecutionDetails -&gt; Bool
$c== :: SubscriberExecutionDetails -&gt; SubscriberExecutionDetails -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-337"></span><span>
</span><span id="line-338"></span><span class="hs-comment">-- | Execution information related to a cohort on a poll cycle</span><span>
</span><span id="line-339"></span><span class="hs-keyword">data</span><span> </span><span id="CohortExecutionDetails"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#CohortExecutionDetails"><span class="hs-identifier hs-var">CohortExecutionDetails</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CohortExecutionDetails"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#CohortExecutionDetails"><span class="hs-identifier hs-var">CohortExecutionDetails</span></a></span></span><span>
</span><span id="line-340"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_cedCohortId"><span class="annot"><span class="annottext">CohortExecutionDetails -&gt; CohortId
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_cedCohortId"><span class="hs-identifier hs-var hs-var">_cedCohortId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Plan.html#CohortId"><span class="hs-identifier hs-type">CohortId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-341"></span><span>    </span><span id="_cedVariables"><span class="annot"><span class="annottext">CohortExecutionDetails -&gt; CohortKey
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_cedVariables"><span class="hs-identifier hs-var hs-var">_cedVariables</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Plan.html#CohortVariables"><span class="hs-identifier hs-type">CohortVariables</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-342"></span><span>    </span><span class="hs-comment">-- | Nothing in case of an error</span><span>
</span><span id="line-343"></span><span>    </span><span id="_cedResponseSize"><span class="annot"><span class="annottext">CohortExecutionDetails -&gt; Maybe Int
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_cedResponseSize"><span class="hs-identifier hs-var hs-var">_cedResponseSize</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-344"></span><span>    </span><span class="hs-comment">-- | The response on this cycle has been pushed to these above subscribers</span><span>
</span><span id="line-345"></span><span>    </span><span class="hs-comment">-- New subscribers (those which haven't been around during the previous poll</span><span>
</span><span id="line-346"></span><span>    </span><span class="hs-comment">-- cycle) will always be part of this</span><span>
</span><span id="line-347"></span><span>    </span><span id="_cedPushedTo"><span class="annot"><span class="annottext">CohortExecutionDetails -&gt; [SubscriberExecutionDetails]
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_cedPushedTo"><span class="hs-identifier hs-var hs-var">_cedPushedTo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberExecutionDetails"><span class="hs-identifier hs-type">SubscriberExecutionDetails</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-348"></span><span>    </span><span class="hs-comment">-- | The response on this cycle has *not* been pushed to these above</span><span>
</span><span id="line-349"></span><span>    </span><span class="hs-comment">-- subscribers. This would when the response hasn't changed from the previous</span><span>
</span><span id="line-350"></span><span>    </span><span class="hs-comment">-- polled cycle</span><span>
</span><span id="line-351"></span><span>    </span><span id="_cedIgnored"><span class="annot"><span class="annottext">CohortExecutionDetails -&gt; [SubscriberExecutionDetails]
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_cedIgnored"><span class="hs-identifier hs-var hs-var">_cedIgnored</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#SubscriberExecutionDetails"><span class="hs-identifier hs-type">SubscriberExecutionDetails</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-352"></span><span>    </span><span id="_cedBatchId"><span class="annot"><span class="annottext">CohortExecutionDetails -&gt; BatchId
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_cedBatchId"><span class="hs-identifier hs-var hs-var">_cedBatchId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#BatchId"><span class="hs-identifier hs-type">BatchId</span></a></span><span>
</span><span id="line-353"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-354"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688226327"><span id="local-6989586621688226329"><span id="local-6989586621688226331"><span class="annot"><span class="annottext">Int -&gt; CohortExecutionDetails -&gt; ShowS
[CohortExecutionDetails] -&gt; ShowS
CohortExecutionDetails -&gt; String
(Int -&gt; CohortExecutionDetails -&gt; ShowS)
-&gt; (CohortExecutionDetails -&gt; String)
-&gt; ([CohortExecutionDetails] -&gt; ShowS)
-&gt; Show CohortExecutionDetails
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [CohortExecutionDetails] -&gt; ShowS
$cshowList :: [CohortExecutionDetails] -&gt; ShowS
show :: CohortExecutionDetails -&gt; String
$cshow :: CohortExecutionDetails -&gt; String
showsPrec :: Int -&gt; CohortExecutionDetails -&gt; ShowS
$cshowsPrec :: Int -&gt; CohortExecutionDetails -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226323"><span id="local-6989586621688226325"><span class="annot"><span class="annottext">CohortExecutionDetails -&gt; CohortExecutionDetails -&gt; Bool
(CohortExecutionDetails -&gt; CohortExecutionDetails -&gt; Bool)
-&gt; (CohortExecutionDetails -&gt; CohortExecutionDetails -&gt; Bool)
-&gt; Eq CohortExecutionDetails
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: CohortExecutionDetails -&gt; CohortExecutionDetails -&gt; Bool
$c/= :: CohortExecutionDetails -&gt; CohortExecutionDetails -&gt; Bool
== :: CohortExecutionDetails -&gt; CohortExecutionDetails -&gt; Bool
$c== :: CohortExecutionDetails -&gt; CohortExecutionDetails -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-355"></span><span>
</span><span id="line-356"></span><span class="hs-comment">-- | Execution information related to a single batched execution</span><span>
</span><span id="line-357"></span><span class="hs-keyword">data</span><span> </span><span id="BatchExecutionDetails"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#BatchExecutionDetails"><span class="hs-identifier hs-var">BatchExecutionDetails</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="BatchExecutionDetails"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#BatchExecutionDetails"><span class="hs-identifier hs-var">BatchExecutionDetails</span></a></span></span><span>
</span><span id="line-358"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | postgres execution time of each batch</span><span>
</span><span id="line-359"></span><span>    </span><span id="_bedPgExecutionTime"><span class="annot"><span class="annottext">BatchExecutionDetails -&gt; DiffTime
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_bedPgExecutionTime"><span class="hs-identifier hs-var hs-var">_bedPgExecutionTime</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Clock.DiffTime</span></span><span class="hs-special">,</span><span>
</span><span id="line-360"></span><span>    </span><span class="hs-comment">-- | time to taken to push to all cohorts belonging to this batch</span><span>
</span><span id="line-361"></span><span>    </span><span id="_bedPushTime"><span class="annot"><span class="annottext">BatchExecutionDetails -&gt; DiffTime
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_bedPushTime"><span class="hs-identifier hs-var hs-var">_bedPushTime</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Clock.DiffTime</span></span><span class="hs-special">,</span><span>
</span><span id="line-362"></span><span>    </span><span class="hs-comment">-- | id of the batch</span><span>
</span><span id="line-363"></span><span>    </span><span id="_bedBatchId"><span class="annot"><span class="annottext">BatchExecutionDetails -&gt; BatchId
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_bedBatchId"><span class="hs-identifier hs-var hs-var">_bedBatchId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#BatchId"><span class="hs-identifier hs-type">BatchId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-364"></span><span>    </span><span class="hs-comment">-- | execution details of the cohorts belonging to this batch</span><span>
</span><span id="line-365"></span><span>    </span><span id="_bedCohorts"><span class="annot"><span class="annottext">BatchExecutionDetails -&gt; [CohortExecutionDetails]
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_bedCohorts"><span class="hs-identifier hs-var hs-var">_bedCohorts</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#CohortExecutionDetails"><span class="hs-identifier hs-type">CohortExecutionDetails</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-366"></span><span>    </span><span id="_bedBatchResponseSizeBytes"><span class="annot"><span class="annottext">BatchExecutionDetails -&gt; Maybe Int
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_bedBatchResponseSizeBytes"><span class="hs-identifier hs-var hs-var">_bedBatchResponseSizeBytes</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-367"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-368"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688226311"><span id="local-6989586621688226313"><span id="local-6989586621688226315"><span class="annot"><span class="annottext">Int -&gt; BatchExecutionDetails -&gt; ShowS
[BatchExecutionDetails] -&gt; ShowS
BatchExecutionDetails -&gt; String
(Int -&gt; BatchExecutionDetails -&gt; ShowS)
-&gt; (BatchExecutionDetails -&gt; String)
-&gt; ([BatchExecutionDetails] -&gt; ShowS)
-&gt; Show BatchExecutionDetails
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [BatchExecutionDetails] -&gt; ShowS
$cshowList :: [BatchExecutionDetails] -&gt; ShowS
show :: BatchExecutionDetails -&gt; String
$cshow :: BatchExecutionDetails -&gt; String
showsPrec :: Int -&gt; BatchExecutionDetails -&gt; ShowS
$cshowsPrec :: Int -&gt; BatchExecutionDetails -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226307"><span id="local-6989586621688226309"><span class="annot"><span class="annottext">BatchExecutionDetails -&gt; BatchExecutionDetails -&gt; Bool
(BatchExecutionDetails -&gt; BatchExecutionDetails -&gt; Bool)
-&gt; (BatchExecutionDetails -&gt; BatchExecutionDetails -&gt; Bool)
-&gt; Eq BatchExecutionDetails
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: BatchExecutionDetails -&gt; BatchExecutionDetails -&gt; Bool
$c/= :: BatchExecutionDetails -&gt; BatchExecutionDetails -&gt; Bool
== :: BatchExecutionDetails -&gt; BatchExecutionDetails -&gt; Bool
$c== :: BatchExecutionDetails -&gt; BatchExecutionDetails -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-369"></span><span>
</span><span id="line-370"></span><span class="hs-comment">-- | see Note [Minimal LiveQuery Poller Log]</span><span>
</span><span id="line-371"></span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#batchExecutionDetailMinimal"><span class="hs-identifier hs-type">batchExecutionDetailMinimal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#BatchExecutionDetails"><span class="hs-identifier hs-type">BatchExecutionDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span>
</span><span id="line-372"></span><span id="batchExecutionDetailMinimal"><span class="annot"><span class="annottext">batchExecutionDetailMinimal :: BatchExecutionDetails -&gt; Value
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#batchExecutionDetailMinimal"><span class="hs-identifier hs-var hs-var">batchExecutionDetailMinimal</span></a></span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#BatchExecutionDetails"><span class="hs-identifier hs-type">BatchExecutionDetails</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688226301"><span id="local-6989586621688226302"><span id="local-6989586621688226303"><span id="local-6989586621688226304"><span id="local-6989586621688226305"><span class="annot"><span class="annottext">[CohortExecutionDetails]
Maybe Int
DiffTime
BatchId
_bedBatchResponseSizeBytes :: Maybe Int
_bedCohorts :: [CohortExecutionDetails]
_bedBatchId :: BatchId
_bedPushTime :: DiffTime
_bedPgExecutionTime :: DiffTime
_bedBatchResponseSizeBytes :: BatchExecutionDetails -&gt; Maybe Int
_bedCohorts :: BatchExecutionDetails -&gt; [CohortExecutionDetails]
_bedBatchId :: BatchExecutionDetails -&gt; BatchId
_bedPushTime :: BatchExecutionDetails -&gt; DiffTime
_bedPgExecutionTime :: BatchExecutionDetails -&gt; DiffTime
</span><a href="#local-6989586621688226301"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-373"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688226300"><span class="annot"><span class="annottext">batchRespSize :: [Pair]
</span><a href="#local-6989586621688226300"><span class="hs-identifier hs-var hs-var">batchRespSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-374"></span><span>        </span><span class="annot"><span class="annottext">[Pair] -&gt; (Int -&gt; [Pair]) -&gt; Maybe Int -&gt; [Pair]
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span>
</span><span id="line-375"></span><span>          </span><span class="annot"><span class="annottext">[Pair]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-376"></span><span>          </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621688226298"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688226298"><span class="hs-identifier hs-var">respSize</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;batch_response_size_bytes&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688226298"><span class="hs-identifier hs-var">respSize</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-377"></span><span>          </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621688226301"><span class="hs-identifier hs-var">_bedBatchResponseSizeBytes</span></a></span><span>
</span><span id="line-378"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">J.object</span></span><span>
</span><span id="line-379"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;pg_execution_time&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; DiffTime -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621688226305"><span class="hs-identifier hs-var">_bedPgExecutionTime</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-380"></span><span>            </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;push_time&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; DiffTime -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621688226304"><span class="hs-identifier hs-var">_bedPushTime</span></a></span><span>
</span><span id="line-381"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-382"></span><span>            </span><span class="hs-comment">-- log batch resp size only when there are no errors</span><span>
</span><span id="line-383"></span><span>            </span><span class="annot"><span class="annottext">[Pair] -&gt; [Pair] -&gt; [Pair]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Pair]
</span><a href="#local-6989586621688226300"><span class="hs-identifier hs-var">batchRespSize</span></a></span><span>
</span><span id="line-384"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-385"></span><span>
</span><span id="line-386"></span><span class="hs-keyword">data</span><span> </span><span id="PollDetails"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollDetails"><span class="hs-identifier hs-var">PollDetails</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PollDetails"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollDetails"><span class="hs-identifier hs-var">PollDetails</span></a></span></span><span>
</span><span id="line-387"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | the unique ID (basically a thread that run as a 'Poller') for the</span><span>
</span><span id="line-388"></span><span>    </span><span class="hs-comment">-- 'Poller'</span><span>
</span><span id="line-389"></span><span>    </span><span id="_pdPollerId"><span class="annot"><span class="annottext">PollDetails -&gt; PollerId
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pdPollerId"><span class="hs-identifier hs-var hs-var">_pdPollerId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerId"><span class="hs-identifier hs-type">PollerId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-390"></span><span>    </span><span class="hs-comment">-- | the multiplexed SQL query to be run against the database with all the</span><span>
</span><span id="line-391"></span><span>    </span><span class="hs-comment">-- variables together</span><span>
</span><span id="line-392"></span><span>    </span><span id="_pdGeneratedSql"><span class="annot"><span class="annottext">PollDetails -&gt; Text
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pdGeneratedSql"><span class="hs-identifier hs-var hs-var">_pdGeneratedSql</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">,</span><span>
</span><span id="line-393"></span><span>    </span><span class="hs-comment">-- | the time taken to get a snapshot of cohorts from our 'LiveQueriesState'</span><span>
</span><span id="line-394"></span><span>    </span><span class="hs-comment">-- data structure</span><span>
</span><span id="line-395"></span><span>    </span><span id="_pdSnapshotTime"><span class="annot"><span class="annottext">PollDetails -&gt; DiffTime
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pdSnapshotTime"><span class="hs-identifier hs-var hs-var">_pdSnapshotTime</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Clock.DiffTime</span></span><span class="hs-special">,</span><span>
</span><span id="line-396"></span><span>    </span><span class="hs-comment">-- | list of execution batches and their details</span><span>
</span><span id="line-397"></span><span>    </span><span id="_pdBatches"><span class="annot"><span class="annottext">PollDetails -&gt; [BatchExecutionDetails]
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pdBatches"><span class="hs-identifier hs-var hs-var">_pdBatches</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#BatchExecutionDetails"><span class="hs-identifier hs-type">BatchExecutionDetails</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-398"></span><span>    </span><span class="hs-comment">-- | total time spent on a poll cycle</span><span>
</span><span id="line-399"></span><span>    </span><span id="_pdTotalTime"><span class="annot"><span class="annottext">PollDetails -&gt; DiffTime
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pdTotalTime"><span class="hs-identifier hs-var hs-var">_pdTotalTime</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Clock.DiffTime</span></span><span class="hs-special">,</span><span>
</span><span id="line-400"></span><span>    </span><span id="_pdLiveQueryOptions"><span class="annot"><span class="annottext">PollDetails -&gt; LiveQueriesOptions
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pdLiveQueryOptions"><span class="hs-identifier hs-var hs-var">_pdLiveQueryOptions</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Options.html#LiveQueriesOptions"><span class="hs-identifier hs-type">LiveQueriesOptions</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-401"></span><span>    </span><span id="_pdSource"><span class="annot"><span class="annottext">PollDetails -&gt; SourceName
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pdSource"><span class="hs-identifier hs-var hs-var">_pdSource</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-402"></span><span>    </span><span id="_pdRole"><span class="annot"><span class="annottext">PollDetails -&gt; RoleName
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pdRole"><span class="hs-identifier hs-var hs-var">_pdRole</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.Session.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-403"></span><span>    </span><span id="_pdParameterizedQueryHash"><span class="annot"><span class="annottext">PollDetails -&gt; ParameterizedQueryHash
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pdParameterizedQueryHash"><span class="hs-identifier hs-var hs-var">_pdParameterizedQueryHash</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.GraphQL.ParameterizedQueryHash.html#ParameterizedQueryHash"><span class="hs-identifier hs-type">ParameterizedQueryHash</span></a></span><span>
</span><span id="line-404"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-405"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688226282"><span id="local-6989586621688226284"><span id="local-6989586621688226286"><span class="annot"><span class="annottext">Int -&gt; PollDetails -&gt; ShowS
[PollDetails] -&gt; ShowS
PollDetails -&gt; String
(Int -&gt; PollDetails -&gt; ShowS)
-&gt; (PollDetails -&gt; String)
-&gt; ([PollDetails] -&gt; ShowS)
-&gt; Show PollDetails
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [PollDetails] -&gt; ShowS
$cshowList :: [PollDetails] -&gt; ShowS
show :: PollDetails -&gt; String
$cshow :: PollDetails -&gt; String
showsPrec :: Int -&gt; PollDetails -&gt; ShowS
$cshowsPrec :: Int -&gt; PollDetails -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226278"><span id="local-6989586621688226280"><span class="annot"><span class="annottext">PollDetails -&gt; PollDetails -&gt; Bool
(PollDetails -&gt; PollDetails -&gt; Bool)
-&gt; (PollDetails -&gt; PollDetails -&gt; Bool) -&gt; Eq PollDetails
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: PollDetails -&gt; PollDetails -&gt; Bool
$c/= :: PollDetails -&gt; PollDetails -&gt; Bool
== :: PollDetails -&gt; PollDetails -&gt; Bool
$c== :: PollDetails -&gt; PollDetails -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-406"></span><span>
</span><span id="line-407"></span><span class="hs-comment">{- Note [Minimal LiveQuery Poller Log]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
We only want to log the minimal information in the livequery-poller-log as it
could be expensive to log the details of every subscriber (all poller related
information can always be retrieved by dumping the current live queries state)
We capture a lot more details in PollDetails and BatchExecutionDetails than
that is logged currently as other implementations such as pro can use them if
they need to.
-}</span><span>
</span><span id="line-416"></span><span>
</span><span id="line-417"></span><span class="hs-comment">-- | see Note [Minimal LiveQuery Poller Log]</span><span>
</span><span id="line-418"></span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#pollDetailMinimal"><span class="hs-identifier hs-type">pollDetailMinimal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollDetails"><span class="hs-identifier hs-type">PollDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Value</span></span><span>
</span><span id="line-419"></span><span id="pollDetailMinimal"><span class="annot"><span class="annottext">pollDetailMinimal :: PollDetails -&gt; Value
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#pollDetailMinimal"><span class="hs-identifier hs-var hs-var">pollDetailMinimal</span></a></span></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollDetails"><span class="hs-identifier hs-type">PollDetails</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688226268"><span id="local-6989586621688226269"><span id="local-6989586621688226270"><span id="local-6989586621688226271"><span id="local-6989586621688226272"><span id="local-6989586621688226273"><span id="local-6989586621688226274"><span id="local-6989586621688226275"><span id="local-6989586621688226276"><span class="annot"><span class="annottext">[BatchExecutionDetails]
DiffTime
Text
RoleName
SourceName
LiveQueriesOptions
ParameterizedQueryHash
PollerId
_pdParameterizedQueryHash :: ParameterizedQueryHash
_pdRole :: RoleName
_pdSource :: SourceName
_pdLiveQueryOptions :: LiveQueriesOptions
_pdTotalTime :: DiffTime
_pdBatches :: [BatchExecutionDetails]
_pdSnapshotTime :: DiffTime
_pdGeneratedSql :: Text
_pdPollerId :: PollerId
_pdParameterizedQueryHash :: PollDetails -&gt; ParameterizedQueryHash
_pdRole :: PollDetails -&gt; RoleName
_pdSource :: PollDetails -&gt; SourceName
_pdLiveQueryOptions :: PollDetails -&gt; LiveQueriesOptions
_pdTotalTime :: PollDetails -&gt; DiffTime
_pdBatches :: PollDetails -&gt; [BatchExecutionDetails]
_pdSnapshotTime :: PollDetails -&gt; DiffTime
_pdGeneratedSql :: PollDetails -&gt; Text
_pdPollerId :: PollDetails -&gt; PollerId
</span><a href="#local-6989586621688226268"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-420"></span><span>  </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">J.object</span></span><span>
</span><span id="line-421"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;poller_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; PollerId -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">PollerId
</span><a href="#local-6989586621688226276"><span class="hs-identifier hs-var">_pdPollerId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-422"></span><span>      </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;snapshot_time&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; DiffTime -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621688226274"><span class="hs-identifier hs-var">_pdSnapshotTime</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-423"></span><span>      </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;batches&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; [Value] -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">(BatchExecutionDetails -&gt; Value)
-&gt; [BatchExecutionDetails] -&gt; [Value]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">BatchExecutionDetails -&gt; Value
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#batchExecutionDetailMinimal"><span class="hs-identifier hs-var">batchExecutionDetailMinimal</span></a></span><span> </span><span class="annot"><span class="annottext">[BatchExecutionDetails]
</span><a href="#local-6989586621688226273"><span class="hs-identifier hs-var">_pdBatches</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-424"></span><span>      </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;total_time&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; DiffTime -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621688226272"><span class="hs-identifier hs-var">_pdTotalTime</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-425"></span><span>      </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;source&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; SourceName -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688226270"><span class="hs-identifier hs-var">_pdSource</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-426"></span><span>      </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;role&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; RoleName -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">J..=</span></span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688226269"><span class="hs-identifier hs-var">_pdRole</span></a></span><span>
</span><span id="line-427"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-428"></span><span>
</span><span id="line-429"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Hasura.Logging.html#ToEngineLog"><span class="hs-identifier hs-type">L.ToEngineLog</span></a></span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollDetails"><span class="hs-identifier hs-type">PollDetails</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-430"></span><span>  </span><span id="local-6989586621688226264"><span class="annot"><span class="annottext">toEngineLog :: PollDetails -&gt; (LogLevel, EngineLogType Hasura, Value)
</span><a href="Hasura.Logging.html#toEngineLog"><span class="hs-identifier hs-var hs-var hs-var hs-var">toEngineLog</span></a></span></span><span> </span><span id="local-6989586621688226262"><span class="annot"><span class="annottext">PollDetails
</span><a href="#local-6989586621688226262"><span class="hs-identifier hs-var">pl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LogLevel
</span><a href="Hasura.Logging.html#LevelInfo"><span class="hs-identifier hs-var">L.LevelInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EngineLogType Hasura
</span><a href="Hasura.Logging.html#ELTLivequeryPollerLog"><span class="hs-identifier hs-var">L.ELTLivequeryPollerLog</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PollDetails -&gt; Value
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#pollDetailMinimal"><span class="hs-identifier hs-var">pollDetailMinimal</span></a></span><span> </span><span class="annot"><span class="annottext">PollDetails
</span><a href="#local-6989586621688226262"><span class="hs-identifier hs-var">pl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-431"></span><span>
</span><span id="line-432"></span><span class="hs-keyword">type</span><span> </span><span id="LiveQueryPostPollHook"><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#LiveQueryPostPollHook"><span class="hs-identifier hs-var">LiveQueryPostPollHook</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollDetails"><span class="hs-identifier hs-type">PollDetails</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-433"></span><span>
</span><span id="line-434"></span><span class="hs-comment">-- the default LiveQueryPostPollHook</span><span>
</span><span id="line-435"></span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#defaultLiveQueryPostPollHook"><span class="hs-identifier hs-type">defaultLiveQueryPostPollHook</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Logging.html#Logger"><span class="hs-identifier hs-type">L.Logger</span></a></span><span> </span><span class="annot"><a href="Hasura.Logging.html#Hasura"><span class="hs-identifier hs-type">L.Hasura</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#LiveQueryPostPollHook"><span class="hs-identifier hs-type">LiveQueryPostPollHook</span></a></span><span>
</span><span id="line-436"></span><span id="defaultLiveQueryPostPollHook"><span class="annot"><span class="annottext">defaultLiveQueryPostPollHook :: Logger Hasura -&gt; LiveQueryPostPollHook
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#defaultLiveQueryPostPollHook"><span class="hs-identifier hs-var hs-var">defaultLiveQueryPostPollHook</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Logger Hasura -&gt; LiveQueryPostPollHook
forall impl.
Logger impl
-&gt; forall a (m :: * -&gt; *).
   (ToEngineLog a impl, MonadIO m) =&gt;
   a -&gt; m ()
</span><a href="Hasura.Logging.html#unLogger"><span class="hs-identifier hs-var hs-var">L.unLogger</span></a></span><span>
</span><span id="line-437"></span><span>
</span><span id="line-438"></span><span class="hs-comment">-- | Where the magic happens: the top-level action run periodically by each</span><span>
</span><span id="line-439"></span><span class="hs-comment">-- active 'Poller'. This needs to be async exception safe.</span><span>
</span><span id="line-440"></span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#pollQuery"><span class="hs-identifier hs-type">pollQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-441"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621688226258"><span class="annot"><a href="#local-6989586621688226258"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-442"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Transport.Backend.html#BackendTransport"><span class="hs-identifier hs-type">BackendTransport</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688226258"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-443"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollerId"><span class="hs-identifier hs-type">PollerId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-444"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Options.html#LiveQueriesOptions"><span class="hs-identifier hs-type">LiveQueriesOptions</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-445"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#SourceConfig"><span class="hs-identifier hs-type">SourceConfig</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688226258"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-446"></span><span>  </span><span class="annot"><a href="Hasura.Session.html#RoleName"><span class="hs-identifier hs-type">RoleName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-447"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.ParameterizedQueryHash.html#ParameterizedQueryHash"><span class="hs-identifier hs-type">ParameterizedQueryHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-448"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.Backend.html#MultiplexedQuery"><span class="hs-identifier hs-type">MultiplexedQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688226258"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-449"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#CohortMap"><span class="hs-identifier hs-type">CohortMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-450"></span><span>  </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#LiveQueryPostPollHook"><span class="hs-identifier hs-type">LiveQueryPostPollHook</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-451"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-452"></span><span id="pollQuery"><span class="annot"><span class="annottext">pollQuery :: PollerId
-&gt; LiveQueriesOptions
-&gt; (SourceName, SourceConfig b)
-&gt; RoleName
-&gt; ParameterizedQueryHash
-&gt; MultiplexedQuery b
-&gt; CohortMap
-&gt; LiveQueryPostPollHook
-&gt; IO ()
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#pollQuery"><span class="hs-identifier hs-var hs-var">pollQuery</span></a></span></span><span> </span><span id="local-6989586621688226257"><span class="annot"><span class="annottext">PollerId
</span><a href="#local-6989586621688226257"><span class="hs-identifier hs-var">pollerId</span></a></span></span><span> </span><span id="local-6989586621688226256"><span class="annot"><span class="annottext">LiveQueriesOptions
</span><a href="#local-6989586621688226256"><span class="hs-identifier hs-var">lqOpts</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621688226255"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688226255"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226254"><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688226254"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621688226253"><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688226253"><span class="hs-identifier hs-var">roleName</span></a></span></span><span> </span><span id="local-6989586621688226252"><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621688226252"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span></span><span> </span><span id="local-6989586621688226251"><span class="annot"><span class="annottext">MultiplexedQuery b
</span><a href="#local-6989586621688226251"><span class="hs-identifier hs-var">query</span></a></span></span><span> </span><span id="local-6989586621688226250"><span class="annot"><span class="annottext">CohortMap
</span><a href="#local-6989586621688226250"><span class="hs-identifier hs-var">cohortMap</span></a></span></span><span> </span><span id="local-6989586621688226249"><span class="annot"><span class="annottext">LiveQueryPostPollHook
</span><a href="#local-6989586621688226249"><span class="hs-identifier hs-var">postPollHook</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-453"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621688226248"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621688226248"><span class="hs-identifier hs-var">totalTime</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688226247"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621688226247"><span class="hs-identifier hs-var">snapshotTime</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226246"><span class="annot"><span class="annottext">[BatchExecutionDetails]
</span><a href="#local-6989586621688226246"><span class="hs-identifier hs-var">batchesDetails</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (DiffTime, [BatchExecutionDetails])
-&gt; IO (DiffTime, (DiffTime, [BatchExecutionDetails]))
forall (m :: * -&gt; *) a. MonadIO m =&gt; m a -&gt; m (DiffTime, a)
</span><a href="Hasura.Prelude.html#withElapsedTime"><span class="hs-identifier hs-var">withElapsedTime</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (DiffTime, [BatchExecutionDetails])
 -&gt; IO (DiffTime, (DiffTime, [BatchExecutionDetails])))
-&gt; IO (DiffTime, [BatchExecutionDetails])
-&gt; IO (DiffTime, (DiffTime, [BatchExecutionDetails]))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-454"></span><span>    </span><span class="hs-comment">-- snapshot the current cohorts and split them into batches</span><span>
</span><span id="line-455"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621688226244"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621688226244"><span class="hs-identifier hs-var">snapshotTime</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226243"><span class="annot"><span class="annottext">[(BatchId, [(CohortId, CohortSnapshot)])]
</span><a href="#local-6989586621688226243"><span class="hs-identifier hs-var">cohortBatches</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO [(BatchId, [(CohortId, CohortSnapshot)])]
-&gt; IO (DiffTime, [(BatchId, [(CohortId, CohortSnapshot)])])
forall (m :: * -&gt; *) a. MonadIO m =&gt; m a -&gt; m (DiffTime, a)
</span><a href="Hasura.Prelude.html#withElapsedTime"><span class="hs-identifier hs-var">withElapsedTime</span></a></span><span> </span><span class="annot"><span class="annottext">(IO [(BatchId, [(CohortId, CohortSnapshot)])]
 -&gt; IO (DiffTime, [(BatchId, [(CohortId, CohortSnapshot)])]))
-&gt; IO [(BatchId, [(CohortId, CohortSnapshot)])]
-&gt; IO (DiffTime, [(BatchId, [(CohortId, CohortSnapshot)])])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-456"></span><span>      </span><span class="hs-comment">-- get a snapshot of all the cohorts</span><span>
</span><span id="line-457"></span><span>      </span><span class="hs-comment">-- this need not be done in a transaction</span><span>
</span><span id="line-458"></span><span>      </span><span id="local-6989586621688226242"><span class="annot"><span class="annottext">[(CohortKey, Cohort)]
</span><a href="#local-6989586621688226242"><span class="hs-identifier hs-var">cohorts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM [(CohortKey, Cohort)] -&gt; IO [(CohortKey, Cohort)]
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM [(CohortKey, Cohort)] -&gt; IO [(CohortKey, Cohort)])
-&gt; STM [(CohortKey, Cohort)] -&gt; IO [(CohortKey, Cohort)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CohortMap -&gt; STM [(CohortKey, Cohort)]
forall k v. TMap k v -&gt; STM [(k, v)]
</span><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#toList"><span class="hs-identifier hs-var">TMap.toList</span></a></span><span> </span><span class="annot"><span class="annottext">CohortMap
</span><a href="#local-6989586621688226250"><span class="hs-identifier hs-var">cohortMap</span></a></span><span>
</span><span id="line-459"></span><span>      </span><span id="local-6989586621688226241"><span class="annot"><span class="annottext">[(CohortId, CohortSnapshot)]
</span><a href="#local-6989586621688226241"><span class="hs-identifier hs-var">cohortSnapshots</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((CohortKey, Cohort) -&gt; IO (CohortId, CohortSnapshot))
-&gt; [(CohortKey, Cohort)] -&gt; IO [(CohortId, CohortSnapshot)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">STM (CohortId, CohortSnapshot) -&gt; IO (CohortId, CohortSnapshot)
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">STM.atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM (CohortId, CohortSnapshot) -&gt; IO (CohortId, CohortSnapshot))
-&gt; ((CohortKey, Cohort) -&gt; STM (CohortId, CohortSnapshot))
-&gt; (CohortKey, Cohort)
-&gt; IO (CohortId, CohortSnapshot)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(CohortKey, Cohort) -&gt; STM (CohortId, CohortSnapshot)
</span><a href="#local-6989586621688226239"><span class="hs-identifier hs-var">getCohortSnapshot</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(CohortKey, Cohort)]
</span><a href="#local-6989586621688226242"><span class="hs-identifier hs-var">cohorts</span></a></span><span>
</span><span id="line-460"></span><span>      </span><span class="hs-comment">-- cohorts are broken down into batches specified by the batch size</span><span>
</span><span id="line-461"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688226238"><span class="annot"><span class="annottext">cohortBatches :: [[(CohortId, CohortSnapshot)]]
</span><a href="#local-6989586621688226238"><span class="hs-identifier hs-var hs-var">cohortBatches</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [(CohortId, CohortSnapshot)] -&gt; [[(CohortId, CohortSnapshot)]]
forall e. Int -&gt; [e] -&gt; [[e]]
</span><span class="hs-identifier hs-var">chunksOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonNegativeInt -&gt; Int
</span><a href="Hasura.RQL.Types.Common.html#getNonNegativeInt"><span class="hs-identifier hs-var hs-var">getNonNegativeInt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BatchSize -&gt; NonNegativeInt
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Options.html#unBatchSize"><span class="hs-identifier hs-var hs-var">unBatchSize</span></a></span><span> </span><span class="annot"><span class="annottext">BatchSize
</span><a href="#local-6989586621688226236"><span class="hs-identifier hs-var">batchSize</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(CohortId, CohortSnapshot)]
</span><a href="#local-6989586621688226241"><span class="hs-identifier hs-var">cohortSnapshots</span></a></span><span>
</span><span id="line-462"></span><span>      </span><span class="hs-comment">-- associating every batch with their BatchId</span><span>
</span><span id="line-463"></span><span>      </span><span class="annot"><span class="annottext">[(BatchId, [(CohortId, CohortSnapshot)])]
-&gt; IO [(BatchId, [(CohortId, CohortSnapshot)])]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">([(BatchId, [(CohortId, CohortSnapshot)])]
 -&gt; IO [(BatchId, [(CohortId, CohortSnapshot)])])
-&gt; [(BatchId, [(CohortId, CohortSnapshot)])]
-&gt; IO [(BatchId, [(CohortId, CohortSnapshot)])]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[BatchId]
-&gt; [[(CohortId, CohortSnapshot)]]
-&gt; [(BatchId, [(CohortId, CohortSnapshot)])]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; BatchId
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#BatchId"><span class="hs-identifier hs-var">BatchId</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; BatchId) -&gt; [Int] -&gt; [BatchId]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[[(CohortId, CohortSnapshot)]]
</span><a href="#local-6989586621688226238"><span class="hs-identifier hs-var">cohortBatches</span></a></span><span>
</span><span id="line-464"></span><span>
</span><span id="line-465"></span><span>    </span><span class="hs-comment">-- concurrently process each batch</span><span>
</span><span id="line-466"></span><span>    </span><span id="local-6989586621688226235"><span class="annot"><span class="annottext">[BatchExecutionDetails]
</span><a href="#local-6989586621688226235"><span class="hs-identifier hs-var">batchesDetails</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(BatchId, [(CohortId, CohortSnapshot)])]
-&gt; ((BatchId, [(CohortId, CohortSnapshot)])
    -&gt; IO BatchExecutionDetails)
-&gt; IO [BatchExecutionDetails]
forall (t :: * -&gt; *) a b.
Traversable t =&gt;
t a -&gt; (a -&gt; IO b) -&gt; IO (t b)
</span><span class="hs-identifier hs-var">A.forConcurrently</span></span><span> </span><span class="annot"><span class="annottext">[(BatchId, [(CohortId, CohortSnapshot)])]
</span><a href="#local-6989586621688226243"><span class="hs-identifier hs-var">cohortBatches</span></a></span><span> </span><span class="annot"><span class="annottext">(((BatchId, [(CohortId, CohortSnapshot)])
  -&gt; IO BatchExecutionDetails)
 -&gt; IO [BatchExecutionDetails])
-&gt; ((BatchId, [(CohortId, CohortSnapshot)])
    -&gt; IO BatchExecutionDetails)
-&gt; IO [BatchExecutionDetails]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621688226233"><span class="annot"><span class="annottext">BatchId
</span><a href="#local-6989586621688226233"><span class="hs-identifier hs-var">batchId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226232"><span class="annot"><span class="annottext">[(CohortId, CohortSnapshot)]
</span><a href="#local-6989586621688226232"><span class="hs-identifier hs-var">cohorts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-467"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621688226231"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621688226231"><span class="hs-identifier hs-var">queryExecutionTime</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226230"><span class="annot"><span class="annottext">Either QErr [(CohortId, ByteString)]
</span><a href="#local-6989586621688226230"><span class="hs-identifier hs-var">mxRes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SourceConfig b
-&gt; MultiplexedQuery b
-&gt; [(CohortId, CohortKey)]
-&gt; IO (DiffTime, Either QErr [(CohortId, ByteString)])
forall (b :: BackendType) (m :: * -&gt; *).
(BackendTransport b, MonadIO m) =&gt;
SourceConfig b
-&gt; MultiplexedQuery b
-&gt; [(CohortId, CohortKey)]
-&gt; m (DiffTime, Either QErr [(CohortId, ByteString)])
</span><a href="Hasura.GraphQL.Transport.Backend.html#runDBSubscription"><span class="hs-identifier hs-var">runDBSubscription</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688226258"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig b
</span><a href="#local-6989586621688226254"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">MultiplexedQuery b
</span><a href="#local-6989586621688226251"><span class="hs-identifier hs-var">query</span></a></span><span> </span><span class="annot"><span class="annottext">([(CohortId, CohortKey)]
 -&gt; IO (DiffTime, Either QErr [(CohortId, ByteString)]))
-&gt; [(CohortId, CohortKey)]
-&gt; IO (DiffTime, Either QErr [(CohortId, ByteString)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ASetter
  [(CohortId, CohortSnapshot)]
  [(CohortId, CohortKey)]
  CohortSnapshot
  CohortKey
-&gt; (CohortSnapshot -&gt; CohortKey)
-&gt; [(CohortId, CohortSnapshot)]
-&gt; [(CohortId, CohortKey)]
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-identifier hs-var">over</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((CohortId, CohortSnapshot) -&gt; Identity (CohortId, CohortKey))
-&gt; [(CohortId, CohortSnapshot)] -&gt; Identity [(CohortId, CohortKey)]
forall s t a b. Each s t a b =&gt; Traversal s t a b
</span><span class="hs-identifier hs-var">each</span></span><span> </span><span class="annot"><span class="annottext">(((CohortId, CohortSnapshot) -&gt; Identity (CohortId, CohortKey))
 -&gt; [(CohortId, CohortSnapshot)]
 -&gt; Identity [(CohortId, CohortKey)])
-&gt; ((CohortSnapshot -&gt; Identity CohortKey)
    -&gt; (CohortId, CohortSnapshot) -&gt; Identity (CohortId, CohortKey))
-&gt; ASetter
     [(CohortId, CohortSnapshot)]
     [(CohortId, CohortKey)]
     CohortSnapshot
     CohortKey
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(CohortSnapshot -&gt; Identity CohortKey)
-&gt; (CohortId, CohortSnapshot) -&gt; Identity (CohortId, CohortKey)
forall s t a b. Field2 s t a b =&gt; Lens s t a b
</span><span class="hs-identifier hs-var">_2</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CohortSnapshot -&gt; CohortKey
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_csVariables"><span class="hs-identifier hs-var hs-var">_csVariables</span></a></span><span> </span><span class="annot"><span class="annottext">[(CohortId, CohortSnapshot)]
</span><a href="#local-6989586621688226232"><span class="hs-identifier hs-var">cohorts</span></a></span><span>
</span><span id="line-468"></span><span>
</span><span id="line-469"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688226227"><span class="annot"><span class="annottext">lqMeta :: LiveQueryMetadata
</span><a href="#local-6989586621688226227"><span class="hs-identifier hs-var hs-var">lqMeta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; LiveQueryMetadata
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#LiveQueryMetadata"><span class="hs-identifier hs-var">LiveQueryMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">(DiffTime -&gt; LiveQueryMetadata) -&gt; DiffTime -&gt; LiveQueryMetadata
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DiffTime -&gt; DiffTime
forall x y. (Duration x, Duration y) =&gt; x -&gt; y
</span><a href="Data.Time.Clock.Units.html#convertDuration"><span class="hs-identifier hs-var">convertDuration</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621688226231"><span class="hs-identifier hs-var">queryExecutionTime</span></a></span><span>
</span><span id="line-470"></span><span>          </span><span id="local-6989586621688226225"><span class="annot"><span class="annottext">operations :: [(GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
  CohortSnapshot)]
</span><a href="#local-6989586621688226225"><span class="hs-identifier hs-var hs-var">operations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(CohortId, CohortSnapshot)]
-&gt; Either QErr [(CohortId, ByteString)]
-&gt; [(GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
     CohortSnapshot)]
forall (m :: * -&gt; *) k t.
(MonadError GQExecError m, Eq k, Hashable k) =&gt;
[(k, t)]
-&gt; Either QErr [(k, ByteString)]
-&gt; [(m ByteString, k, Maybe (ResponseHash, Int), t)]
</span><a href="#local-6989586621688226224"><span class="hs-identifier hs-var">getCohortOperations</span></a></span><span> </span><span class="annot"><span class="annottext">[(CohortId, CohortSnapshot)]
</span><a href="#local-6989586621688226232"><span class="hs-identifier hs-var">cohorts</span></a></span><span> </span><span class="annot"><span class="annottext">Either QErr [(CohortId, ByteString)]
</span><a href="#local-6989586621688226230"><span class="hs-identifier hs-var">mxRes</span></a></span><span>
</span><span id="line-471"></span><span>          </span><span class="hs-comment">-- batch response size is the sum of the response sizes of the cohorts</span><span>
</span><span id="line-472"></span><span>          </span><span id="local-6989586621688226223"><span class="annot"><span class="annottext">batchResponseSize :: Maybe Int
</span><a href="#local-6989586621688226223"><span class="hs-identifier hs-var hs-var">batchResponseSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-473"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either QErr [(CohortId, ByteString)]
</span><a href="#local-6989586621688226230"><span class="hs-identifier hs-var">mxRes</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-474"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="annot"><span class="annottext">QErr
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Int
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-475"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621688226222"><span class="annot"><span class="annottext">[(CohortId, ByteString)]
</span><a href="#local-6989586621688226222"><span class="hs-identifier hs-var">resp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Maybe Int) -&gt; Int -&gt; Maybe Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Sum Int -&gt; Int
forall a. Sum a -&gt; a
</span><span class="hs-identifier hs-var hs-var">getSum</span></span><span> </span><span class="annot"><span class="annottext">(Sum Int -&gt; Int) -&gt; Sum Int -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((CohortId, ByteString) -&gt; Sum Int)
-&gt; [(CohortId, ByteString)] -&gt; Sum Int
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Sum Int
forall a. a -&gt; Sum a
</span><span class="hs-identifier hs-var">Sum</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Sum Int)
-&gt; ((CohortId, ByteString) -&gt; Int)
-&gt; (CohortId, ByteString)
-&gt; Sum Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Int)
-&gt; ((CohortId, ByteString) -&gt; ByteString)
-&gt; (CohortId, ByteString)
-&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(CohortId, ByteString) -&gt; ByteString
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(CohortId, ByteString)]
</span><a href="#local-6989586621688226222"><span class="hs-identifier hs-var">resp</span></a></span><span>
</span><span id="line-476"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621688226217"><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621688226217"><span class="hs-identifier hs-var">pushTime</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226216"><span class="annot"><span class="annottext">[CohortExecutionDetails]
</span><a href="#local-6989586621688226216"><span class="hs-identifier hs-var">cohortsExecutionDetails</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO [CohortExecutionDetails]
-&gt; IO (DiffTime, [CohortExecutionDetails])
forall (m :: * -&gt; *) a. MonadIO m =&gt; m a -&gt; m (DiffTime, a)
</span><a href="Hasura.Prelude.html#withElapsedTime"><span class="hs-identifier hs-var">withElapsedTime</span></a></span><span> </span><span class="annot"><span class="annottext">(IO [CohortExecutionDetails]
 -&gt; IO (DiffTime, [CohortExecutionDetails]))
-&gt; IO [CohortExecutionDetails]
-&gt; IO (DiffTime, [CohortExecutionDetails])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-477"></span><span>        </span><span class="annot"><span class="annottext">[(GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
  CohortSnapshot)]
-&gt; ((GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
     CohortSnapshot)
    -&gt; IO CohortExecutionDetails)
-&gt; IO [CohortExecutionDetails]
forall (t :: * -&gt; *) a b.
Traversable t =&gt;
t a -&gt; (a -&gt; IO b) -&gt; IO (t b)
</span><span class="hs-identifier hs-var">A.forConcurrently</span></span><span> </span><span class="annot"><span class="annottext">[(GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
  CohortSnapshot)]
</span><a href="#local-6989586621688226225"><span class="hs-identifier hs-var">operations</span></a></span><span> </span><span class="annot"><span class="annottext">(((GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
   CohortSnapshot)
  -&gt; IO CohortExecutionDetails)
 -&gt; IO [CohortExecutionDetails])
-&gt; ((GQResult ByteString, CohortId, Maybe (ResponseHash, Int),
     CohortSnapshot)
    -&gt; IO CohortExecutionDetails)
-&gt; IO [CohortExecutionDetails]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621688226215"><span class="annot"><span class="annottext">GQResult ByteString
</span><a href="#local-6989586621688226215"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226214"><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621688226214"><span class="hs-identifier hs-var">cohortId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226213"><span class="annot"><span class="annottext">Maybe (ResponseHash, Int)
</span><a href="#local-6989586621688226213"><span class="hs-identifier hs-var">respData</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226212"><span class="annot"><span class="annottext">CohortSnapshot
</span><a href="#local-6989586621688226212"><span class="hs-identifier hs-var">snapshot</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-478"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621688226211"><span class="annot"><span class="annottext">[SubscriberExecutionDetails]
</span><a href="#local-6989586621688226211"><span class="hs-identifier hs-var">pushedSubscribers</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226210"><span class="annot"><span class="annottext">[SubscriberExecutionDetails]
</span><a href="#local-6989586621688226210"><span class="hs-identifier hs-var">ignoredSubscribers</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-479"></span><span>            </span><span class="annot"><span class="annottext">GQResult ByteString
-&gt; Maybe ResponseHash
-&gt; LiveQueryMetadata
-&gt; CohortSnapshot
-&gt; IO ([SubscriberExecutionDetails], [SubscriberExecutionDetails])
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#pushResultToCohort"><span class="hs-identifier hs-var">pushResultToCohort</span></a></span><span> </span><span class="annot"><span class="annottext">GQResult ByteString
</span><a href="#local-6989586621688226215"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ResponseHash, Int) -&gt; ResponseHash
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((ResponseHash, Int) -&gt; ResponseHash)
-&gt; Maybe (ResponseHash, Int) -&gt; Maybe ResponseHash
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe (ResponseHash, Int)
</span><a href="#local-6989586621688226213"><span class="hs-identifier hs-var">respData</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LiveQueryMetadata
</span><a href="#local-6989586621688226227"><span class="hs-identifier hs-var">lqMeta</span></a></span><span> </span><span class="annot"><span class="annottext">CohortSnapshot
</span><a href="#local-6989586621688226212"><span class="hs-identifier hs-var">snapshot</span></a></span><span>
</span><span id="line-480"></span><span>          </span><span class="annot"><span class="annottext">CohortExecutionDetails -&gt; IO CohortExecutionDetails
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-481"></span><span>            </span><span class="annot"><span class="annottext">CohortExecutionDetails :: CohortId
-&gt; CohortKey
-&gt; Maybe Int
-&gt; [SubscriberExecutionDetails]
-&gt; [SubscriberExecutionDetails]
-&gt; BatchId
-&gt; CohortExecutionDetails
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#CohortExecutionDetails"><span class="hs-identifier hs-type">CohortExecutionDetails</span></a></span><span>
</span><span id="line-482"></span><span>              </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_cedCohortId :: CohortId
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_cedCohortId"><span class="hs-identifier hs-var">_cedCohortId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621688226214"><span class="hs-identifier hs-var">cohortId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-483"></span><span>                </span><span class="annot"><span class="annottext">_cedVariables :: CohortKey
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_cedVariables"><span class="hs-identifier hs-var">_cedVariables</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CohortSnapshot -&gt; CohortKey
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_csVariables"><span class="hs-identifier hs-var hs-var">_csVariables</span></a></span><span> </span><span class="annot"><span class="annottext">CohortSnapshot
</span><a href="#local-6989586621688226212"><span class="hs-identifier hs-var">snapshot</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-484"></span><span>                </span><span class="annot"><span class="annottext">_cedPushedTo :: [SubscriberExecutionDetails]
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_cedPushedTo"><span class="hs-identifier hs-var">_cedPushedTo</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SubscriberExecutionDetails]
</span><a href="#local-6989586621688226211"><span class="hs-identifier hs-var">pushedSubscribers</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-485"></span><span>                </span><span class="annot"><span class="annottext">_cedIgnored :: [SubscriberExecutionDetails]
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_cedIgnored"><span class="hs-identifier hs-var">_cedIgnored</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SubscriberExecutionDetails]
</span><a href="#local-6989586621688226210"><span class="hs-identifier hs-var">ignoredSubscribers</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-486"></span><span>                </span><span class="annot"><span class="annottext">_cedResponseSize :: Maybe Int
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_cedResponseSize"><span class="hs-identifier hs-var">_cedResponseSize</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ResponseHash, Int) -&gt; Int
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((ResponseHash, Int) -&gt; Int)
-&gt; Maybe (ResponseHash, Int) -&gt; Maybe Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe (ResponseHash, Int)
</span><a href="#local-6989586621688226213"><span class="hs-identifier hs-var">respData</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-487"></span><span>                </span><span class="annot"><span class="annottext">_cedBatchId :: BatchId
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_cedBatchId"><span class="hs-identifier hs-var">_cedBatchId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BatchId
</span><a href="#local-6989586621688226233"><span class="hs-identifier hs-var">batchId</span></a></span><span>
</span><span id="line-488"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-489"></span><span>      </span><span class="annot"><span class="annottext">BatchExecutionDetails -&gt; IO BatchExecutionDetails
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(BatchExecutionDetails -&gt; IO BatchExecutionDetails)
-&gt; BatchExecutionDetails -&gt; IO BatchExecutionDetails
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-490"></span><span>        </span><span class="annot"><span class="annottext">DiffTime
-&gt; DiffTime
-&gt; BatchId
-&gt; [CohortExecutionDetails]
-&gt; Maybe Int
-&gt; BatchExecutionDetails
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#BatchExecutionDetails"><span class="hs-identifier hs-var">BatchExecutionDetails</span></a></span><span>
</span><span id="line-491"></span><span>          </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621688226231"><span class="hs-identifier hs-var">queryExecutionTime</span></a></span><span>
</span><span id="line-492"></span><span>          </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621688226217"><span class="hs-identifier hs-var">pushTime</span></a></span><span>
</span><span id="line-493"></span><span>          </span><span class="annot"><span class="annottext">BatchId
</span><a href="#local-6989586621688226233"><span class="hs-identifier hs-var">batchId</span></a></span><span>
</span><span id="line-494"></span><span>          </span><span class="annot"><span class="annottext">[CohortExecutionDetails]
</span><a href="#local-6989586621688226216"><span class="hs-identifier hs-var">cohortsExecutionDetails</span></a></span><span>
</span><span id="line-495"></span><span>          </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621688226223"><span class="hs-identifier hs-var">batchResponseSize</span></a></span><span>
</span><span id="line-496"></span><span>
</span><span id="line-497"></span><span>    </span><span class="annot"><span class="annottext">(DiffTime, [BatchExecutionDetails])
-&gt; IO (DiffTime, [BatchExecutionDetails])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621688226244"><span class="hs-identifier hs-var">snapshotTime</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BatchExecutionDetails]
</span><a href="#local-6989586621688226235"><span class="hs-identifier hs-var">batchesDetails</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-498"></span><span>
</span><span id="line-499"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688226209"><span class="annot"><span class="annottext">pollDetails :: PollDetails
</span><a href="#local-6989586621688226209"><span class="hs-identifier hs-var hs-var">pollDetails</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-500"></span><span>        </span><span class="annot"><span class="annottext">PollDetails :: PollerId
-&gt; Text
-&gt; DiffTime
-&gt; [BatchExecutionDetails]
-&gt; DiffTime
-&gt; LiveQueriesOptions
-&gt; SourceName
-&gt; RoleName
-&gt; ParameterizedQueryHash
-&gt; PollDetails
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#PollDetails"><span class="hs-identifier hs-type">PollDetails</span></a></span><span>
</span><span id="line-501"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_pdPollerId :: PollerId
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pdPollerId"><span class="hs-identifier hs-var">_pdPollerId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PollerId
</span><a href="#local-6989586621688226257"><span class="hs-identifier hs-var">pollerId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-502"></span><span>            </span><span class="annot"><span class="annottext">_pdGeneratedSql :: Text
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pdGeneratedSql"><span class="hs-identifier hs-var">_pdGeneratedSql</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MultiplexedQuery b -&gt; Text
forall a. ToTxt a =&gt; a -&gt; Text
</span><a href="Data.Text.Extended.html#toTxt"><span class="hs-identifier hs-var">toTxt</span></a></span><span> </span><span class="annot"><span class="annottext">MultiplexedQuery b
</span><a href="#local-6989586621688226251"><span class="hs-identifier hs-var">query</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-503"></span><span>            </span><span class="annot"><span class="annottext">_pdSnapshotTime :: DiffTime
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pdSnapshotTime"><span class="hs-identifier hs-var">_pdSnapshotTime</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621688226247"><span class="hs-identifier hs-var">snapshotTime</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-504"></span><span>            </span><span class="annot"><span class="annottext">_pdBatches :: [BatchExecutionDetails]
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pdBatches"><span class="hs-identifier hs-var">_pdBatches</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[BatchExecutionDetails]
</span><a href="#local-6989586621688226246"><span class="hs-identifier hs-var">batchesDetails</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-505"></span><span>            </span><span class="annot"><span class="annottext">_pdLiveQueryOptions :: LiveQueriesOptions
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pdLiveQueryOptions"><span class="hs-identifier hs-var">_pdLiveQueryOptions</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiveQueriesOptions
</span><a href="#local-6989586621688226256"><span class="hs-identifier hs-var">lqOpts</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-506"></span><span>            </span><span class="annot"><span class="annottext">_pdTotalTime :: DiffTime
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pdTotalTime"><span class="hs-identifier hs-var">_pdTotalTime</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><a href="#local-6989586621688226248"><span class="hs-identifier hs-var">totalTime</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-507"></span><span>            </span><span class="annot"><span class="annottext">_pdSource :: SourceName
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pdSource"><span class="hs-identifier hs-var">_pdSource</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688226255"><span class="hs-identifier hs-var">sourceName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-508"></span><span>            </span><span class="annot"><span class="annottext">_pdRole :: RoleName
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pdRole"><span class="hs-identifier hs-var">_pdRole</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RoleName
</span><a href="#local-6989586621688226253"><span class="hs-identifier hs-var">roleName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-509"></span><span>            </span><span class="annot"><span class="annottext">_pdParameterizedQueryHash :: ParameterizedQueryHash
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#_pdParameterizedQueryHash"><span class="hs-identifier hs-var">_pdParameterizedQueryHash</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ParameterizedQueryHash
</span><a href="#local-6989586621688226252"><span class="hs-identifier hs-var">parameterizedQueryHash</span></a></span><span>
</span><span id="line-510"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-511"></span><span>  </span><span class="annot"><span class="annottext">LiveQueryPostPollHook
</span><a href="#local-6989586621688226249"><span class="hs-identifier hs-var">postPollHook</span></a></span><span> </span><span class="annot"><span class="annottext">PollDetails
</span><a href="#local-6989586621688226209"><span class="hs-identifier hs-var">pollDetails</span></a></span><span>
</span><span id="line-512"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-513"></span><span>    </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Options.html#LiveQueriesOptions"><span class="hs-identifier hs-type">LiveQueriesOptions</span></a></span><span> </span><span id="local-6989586621688226236"><span class="annot"><span class="annottext">BatchSize
</span><a href="#local-6989586621688226236"><span class="hs-identifier hs-var">batchSize</span></a></span></span><span> </span><span class="annot"><span class="annottext">RefetchInterval
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LiveQueriesOptions
</span><a href="#local-6989586621688226256"><span class="hs-identifier hs-var">lqOpts</span></a></span><span>
</span><span id="line-514"></span><span>
</span><span id="line-515"></span><span>    </span><span id="local-6989586621688226239"><span class="annot"><span class="annottext">getCohortSnapshot :: (CohortKey, Cohort) -&gt; STM (CohortId, CohortSnapshot)
</span><a href="#local-6989586621688226239"><span class="hs-identifier hs-var hs-var">getCohortSnapshot</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621688226206"><span class="annot"><span class="annottext">CohortKey
</span><a href="#local-6989586621688226206"><span class="hs-identifier hs-var">cohortVars</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226205"><span class="annot"><span class="annottext">Cohort
</span><a href="#local-6989586621688226205"><span class="hs-identifier hs-var">handlerC</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-516"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#Cohort"><span class="hs-identifier hs-type">Cohort</span></a></span><span> </span><span id="local-6989586621688226204"><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621688226204"><span class="hs-identifier hs-var">resId</span></a></span></span><span> </span><span id="local-6989586621688226203"><span class="annot"><span class="annottext">TVar (Maybe ResponseHash)
</span><a href="#local-6989586621688226203"><span class="hs-identifier hs-var">respRef</span></a></span></span><span> </span><span id="local-6989586621688226202"><span class="annot"><span class="annottext">SubscriberMap
</span><a href="#local-6989586621688226202"><span class="hs-identifier hs-var">curOpsTV</span></a></span></span><span> </span><span id="local-6989586621688226201"><span class="annot"><span class="annottext">SubscriberMap
</span><a href="#local-6989586621688226201"><span class="hs-identifier hs-var">newOpsTV</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cohort
</span><a href="#local-6989586621688226205"><span class="hs-identifier hs-var">handlerC</span></a></span><span>
</span><span id="line-517"></span><span>      </span><span id="local-6989586621688226200"><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621688226200"><span class="hs-identifier hs-var">curOpsL</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubscriberMap -&gt; STM [(SubscriberId, Subscriber)]
forall k v. TMap k v -&gt; STM [(k, v)]
</span><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#toList"><span class="hs-identifier hs-var">TMap.toList</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberMap
</span><a href="#local-6989586621688226202"><span class="hs-identifier hs-var">curOpsTV</span></a></span><span>
</span><span id="line-518"></span><span>      </span><span id="local-6989586621688226199"><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621688226199"><span class="hs-identifier hs-var">newOpsL</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubscriberMap -&gt; STM [(SubscriberId, Subscriber)]
forall k v. TMap k v -&gt; STM [(k, v)]
</span><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#toList"><span class="hs-identifier hs-var">TMap.toList</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberMap
</span><a href="#local-6989586621688226201"><span class="hs-identifier hs-var">newOpsTV</span></a></span><span>
</span><span id="line-519"></span><span>      </span><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
-&gt; ((SubscriberId, Subscriber) -&gt; STM ()) -&gt; STM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621688226199"><span class="hs-identifier hs-var">newOpsL</span></a></span><span> </span><span class="annot"><span class="annottext">(((SubscriberId, Subscriber) -&gt; STM ()) -&gt; STM ())
-&gt; ((SubscriberId, Subscriber) -&gt; STM ()) -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621688226197"><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621688226197"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226196"><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688226196"><span class="hs-identifier hs-var">action</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Subscriber -&gt; SubscriberId -&gt; SubscriberMap -&gt; STM ()
forall k v. (Eq k, Hashable k) =&gt; v -&gt; k -&gt; TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#insert"><span class="hs-identifier hs-var">TMap.insert</span></a></span><span> </span><span class="annot"><span class="annottext">Subscriber
</span><a href="#local-6989586621688226196"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberId
</span><a href="#local-6989586621688226197"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberMap
</span><a href="#local-6989586621688226202"><span class="hs-identifier hs-var">curOpsTV</span></a></span><span>
</span><span id="line-520"></span><span>      </span><span class="annot"><span class="annottext">SubscriberMap -&gt; STM ()
forall k v. TMap k v -&gt; STM ()
</span><a href="Hasura.GraphQL.Execute.LiveQuery.TMap.html#reset"><span class="hs-identifier hs-var">TMap.reset</span></a></span><span> </span><span class="annot"><span class="annottext">SubscriberMap
</span><a href="#local-6989586621688226201"><span class="hs-identifier hs-var">newOpsTV</span></a></span><span>
</span><span id="line-521"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688226193"><span class="annot"><span class="annottext">cohortSnapshot :: CohortSnapshot
</span><a href="#local-6989586621688226193"><span class="hs-identifier hs-var hs-var">cohortSnapshot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CohortKey
-&gt; TVar (Maybe ResponseHash)
-&gt; [Subscriber]
-&gt; [Subscriber]
-&gt; CohortSnapshot
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#CohortSnapshot"><span class="hs-identifier hs-var">CohortSnapshot</span></a></span><span> </span><span class="annot"><span class="annottext">CohortKey
</span><a href="#local-6989586621688226206"><span class="hs-identifier hs-var">cohortVars</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Maybe ResponseHash)
</span><a href="#local-6989586621688226203"><span class="hs-identifier hs-var">respRef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((SubscriberId, Subscriber) -&gt; Subscriber)
-&gt; [(SubscriberId, Subscriber)] -&gt; [Subscriber]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(SubscriberId, Subscriber) -&gt; Subscriber
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621688226200"><span class="hs-identifier hs-var">curOpsL</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((SubscriberId, Subscriber) -&gt; Subscriber)
-&gt; [(SubscriberId, Subscriber)] -&gt; [Subscriber]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(SubscriberId, Subscriber) -&gt; Subscriber
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">[(SubscriberId, Subscriber)]
</span><a href="#local-6989586621688226199"><span class="hs-identifier hs-var">newOpsL</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-522"></span><span>      </span><span class="annot"><span class="annottext">(CohortId, CohortSnapshot) -&gt; STM (CohortId, CohortSnapshot)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CohortId
</span><a href="#local-6989586621688226204"><span class="hs-identifier hs-var">resId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CohortSnapshot
</span><a href="#local-6989586621688226193"><span class="hs-identifier hs-var">cohortSnapshot</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-523"></span><span>
</span><span id="line-524"></span><span>    </span><span id="local-6989586621688226224"><span class="annot"><span class="annottext">getCohortOperations :: [(k, t)]
-&gt; Either QErr [(k, ByteString)]
-&gt; [(m ByteString, k, Maybe (ResponseHash, Int), t)]
</span><a href="#local-6989586621688226224"><span class="hs-identifier hs-var hs-var">getCohortOperations</span></a></span></span><span> </span><span id="local-6989586621688226192"><span class="annot"><span class="annottext">[(k, t)]
</span><a href="#local-6989586621688226192"><span class="hs-identifier hs-var">cohorts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-525"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621688226191"><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688226191"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-526"></span><span>        </span><span class="hs-comment">-- TODO: this is internal error</span><span>
</span><span id="line-527"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688226190"><span class="annot"><span class="annottext">resp :: m ByteString
</span><a href="#local-6989586621688226190"><span class="hs-identifier hs-var hs-var">resp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GQExecError -&gt; m ByteString
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(GQExecError -&gt; m ByteString) -&gt; GQExecError -&gt; m ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Value] -&gt; GQExecError
</span><a href="Hasura.GraphQL.Transport.HTTP.Protocol.html#GQExecError"><span class="hs-identifier hs-var">GQExecError</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Bool -&gt; QErr -&gt; Value
</span><a href="Hasura.Base.Error.html#encodeGQLErr"><span class="hs-identifier hs-var">encodeGQLErr</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">QErr
</span><a href="#local-6989586621688226191"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-528"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">m ByteString
</span><a href="#local-6989586621688226190"><span class="hs-identifier hs-var">resp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621688226186"><span class="hs-identifier hs-var">cohortId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ResponseHash, Int)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621688226185"><span class="hs-identifier hs-var">snapshot</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688226186"><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621688226186"><span class="hs-identifier hs-var">cohortId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226185"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621688226185"><span class="hs-identifier hs-var">snapshot</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(k, t)]
</span><a href="#local-6989586621688226192"><span class="hs-identifier hs-var">cohorts</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-529"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621688226184"><span class="annot"><span class="annottext">[(k, ByteString)]
</span><a href="#local-6989586621688226184"><span class="hs-identifier hs-var">responses</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-530"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688226183"><span class="annot"><span class="annottext">cohortSnapshotMap :: HashMap k t
</span><a href="#local-6989586621688226183"><span class="hs-identifier hs-var hs-var">cohortSnapshotMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(k, t)] -&gt; HashMap k t
forall k v. (Eq k, Hashable k) =&gt; [(k, v)] -&gt; HashMap k v
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(k, t)]
</span><a href="#local-6989586621688226192"><span class="hs-identifier hs-var">cohorts</span></a></span><span>
</span><span id="line-531"></span><span>        </span><span class="annot"><span class="annottext">(((k, ByteString)
  -&gt; Maybe (m ByteString, k, Maybe (ResponseHash, Int), t))
 -&gt; [(k, ByteString)]
 -&gt; [(m ByteString, k, Maybe (ResponseHash, Int), t)])
-&gt; [(k, ByteString)]
-&gt; ((k, ByteString)
    -&gt; Maybe (m ByteString, k, Maybe (ResponseHash, Int), t))
-&gt; [(m ByteString, k, Maybe (ResponseHash, Int), t)]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">((k, ByteString)
 -&gt; Maybe (m ByteString, k, Maybe (ResponseHash, Int), t))
-&gt; [(k, ByteString)]
-&gt; [(m ByteString, k, Maybe (ResponseHash, Int), t)]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">[(k, ByteString)]
</span><a href="#local-6989586621688226184"><span class="hs-identifier hs-var">responses</span></a></span><span> </span><span class="annot"><span class="annottext">(((k, ByteString)
  -&gt; Maybe (m ByteString, k, Maybe (ResponseHash, Int), t))
 -&gt; [(m ByteString, k, Maybe (ResponseHash, Int), t)])
-&gt; ((k, ByteString)
    -&gt; Maybe (m ByteString, k, Maybe (ResponseHash, Int), t))
-&gt; [(m ByteString, k, Maybe (ResponseHash, Int), t)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621688226179"><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621688226179"><span class="hs-identifier hs-var">cohortId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688226178"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621688226178"><span class="hs-identifier hs-var">respBS</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-532"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688226177"><span class="annot"><span class="annottext">respHash :: ResponseHash
</span><a href="#local-6989586621688226177"><span class="hs-identifier hs-var hs-var">respHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ResponseHash
</span><a href="Hasura.GraphQL.Execute.LiveQuery.Poll.html#mkRespHash"><span class="hs-identifier hs-var">mkRespHash</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621688226178"><span class="hs-identifier hs-var">respBS</span></a></span><span>
</span><span id="line-533"></span><span>              </span><span id="local-6989586621688226176"><span class="annot"><span class="annottext">respSize :: Int
</span><a href="#local-6989586621688226176"><span class="hs-identifier hs-var hs-var">respSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621688226178"><span class="hs-identifier hs-var">respBS</span></a></span><span>
</span><span id="line-534"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="hs-comment">-- TODO: currently we ignore the cases when the cohortId from</span><span>
</span><span id="line-535"></span><span>              </span><span class="hs-comment">-- Postgres response is not present in the cohort map of this batch</span><span>
</span><span id="line-536"></span><span>              </span><span class="hs-comment">-- (this shouldn't happen but if it happens it means a logic error and</span><span>
</span><span id="line-537"></span><span>              </span><span class="hs-comment">-- we should log it)</span><span>
</span><span id="line-538"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; m ByteString
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621688226178"><span class="hs-identifier hs-var">respBS</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621688226179"><span class="hs-identifier hs-var">cohortId</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">(ResponseHash, Int) -&gt; Maybe (ResponseHash, Int)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResponseHash
</span><a href="#local-6989586621688226177"><span class="hs-identifier hs-var">respHash</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621688226176"><span class="hs-identifier hs-var">respSize</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span class="hs-special">)</span><span>
</span><span id="line-539"></span><span>                </span><span class="annot"><span class="annottext">(t -&gt; (m ByteString, k, Maybe (ResponseHash, Int), t))
-&gt; Maybe t -&gt; Maybe (m ByteString, k, Maybe (ResponseHash, Int), t)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">k -&gt; HashMap k t -&gt; Maybe t
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621688226179"><span class="hs-identifier hs-var">cohortId</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap k t
</span><a href="#local-6989586621688226183"><span class="hs-identifier hs-var">cohortSnapshotMap</span></a></span><span>
</span><span id="line-540"></span></pre></body></html>