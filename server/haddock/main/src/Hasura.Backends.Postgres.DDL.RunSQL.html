<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | Postgres DDL RunSQL</span><span>
</span><span id="line-2"></span><span class="hs-comment">--</span><span>
</span><span id="line-3"></span><span class="hs-comment">-- Escape hatch for running raw SQL against a postgres database.</span><span>
</span><span id="line-4"></span><span class="hs-comment">--</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- 'runRunSQL' executes the provided raw SQL.</span><span>
</span><span id="line-6"></span><span class="hs-comment">--</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- 'isSchemaCacheBuildRequiredRunSQL' checks for known schema-mutating keywords</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- in the raw SQL text.</span><span>
</span><span id="line-9"></span><span class="hs-comment">--</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- See 'Hasura.Server.API.V2Query' and 'Hasura.Server.API.Query'.</span><span>
</span><span id="line-11"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hasura.Backends.Postgres.DDL.RunSQL</span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#runRunSQL"><span class="hs-identifier">runRunSQL</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#RunSQL"><span class="hs-identifier">RunSQL</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#isSchemaCacheBuildRequiredRunSQL"><span class="hs-identifier">isSchemaCacheBuildRequiredRunSQL</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">where</span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Control</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MonadBaseControl</span></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Aeson</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashSet</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">HS</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Text.Extended.html"><span class="hs-identifier">Data.Text.Extended</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Database.PG.Query</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Q</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.EventTrigger.html"><span class="hs-identifier">Hasura.Backends.Postgres.DDL.EventTrigger</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html"><span class="hs-identifier">Hasura.Backends.Postgres.DDL.Source</span></a></span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html#ToMetadataFetchQuery"><span class="hs-identifier">ToMetadataFetchQuery</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html#fetchFunctionMetadata"><span class="hs-identifier">fetchFunctionMetadata</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html#fetchTableMetadata"><span class="hs-identifier">fetchTableMetadata</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.SQL.Types.html"><span class="hs-identifier">Hasura.Backends.Postgres.SQL.Types</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Base.Error.html"><span class="hs-identifier">Hasura.Base.Error</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.EncJSON.html"><span class="hs-identifier">Hasura.EncJSON</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Prelude.html"><span class="hs-identifier">Hasura.Prelude</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Diff.html"><span class="hs-identifier">Hasura.RQL.DDL.Schema.Diff</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.html"><span class="hs-identifier">Hasura.RQL.Types</span></a></span><span> </span><span class="hs-keyword">hiding</span><span>
</span><span id="line-37"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Backend.html#ConstraintName"><span class="hs-identifier">ConstraintName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#fmFunction"><span class="hs-identifier">fmFunction</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#tmComputedFields"><span class="hs-identifier">tmComputedFields</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.html#tmTable"><span class="hs-identifier">tmTable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.SQL.AnyBackend.html"><span class="hs-identifier">Hasura.SQL.AnyBackend</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AB</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Server.Utils.html"><span class="hs-identifier">Hasura.Server.Utils</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Server.Utils.html#quoteRegex"><span class="hs-identifier">quoteRegex</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Session.html"><span class="hs-identifier">Hasura.Session</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hasura.Tracing.html"><span class="hs-identifier">Hasura.Tracing</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Tracing</span></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Text.Regex.TDFA</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TDFA</span></span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="hs-keyword">data</span><span> </span><span id="RunSQL"><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#RunSQL"><span class="hs-identifier hs-var">RunSQL</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="RunSQL"><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#RunSQL"><span class="hs-identifier hs-var">RunSQL</span></a></span></span><span>
</span><span id="line-49"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="rSql"><span class="annot"><span class="annottext">RunSQL -&gt; Text
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#rSql"><span class="hs-identifier hs-var hs-var">rSql</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">,</span><span>
</span><span id="line-50"></span><span>    </span><span id="rSource"><span class="annot"><span class="annottext">RunSQL -&gt; SourceName
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#rSource"><span class="hs-identifier hs-var hs-var">rSource</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-51"></span><span>    </span><span id="rCascade"><span class="annot"><span class="annottext">RunSQL -&gt; Bool
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#rCascade"><span class="hs-identifier hs-var hs-var">rCascade</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span>
</span><span id="line-52"></span><span>    </span><span id="rCheckMetadataConsistency"><span class="annot"><span class="annottext">RunSQL -&gt; Maybe Bool
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#rCheckMetadataConsistency"><span class="hs-identifier hs-var hs-var">rCheckMetadataConsistency</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-53"></span><span>    </span><span id="rTxAccessMode"><span class="annot"><span class="annottext">RunSQL -&gt; TxAccess
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#rTxAccessMode"><span class="hs-identifier hs-var hs-var">rTxAccessMode</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Q.TxAccess</span></span><span>
</span><span id="line-54"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-55"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688241058"><span id="local-6989586621688241060"><span id="local-6989586621688241062"><span class="annot"><span class="annottext">Int -&gt; RunSQL -&gt; ShowS
[RunSQL] -&gt; ShowS
RunSQL -&gt; String
(Int -&gt; RunSQL -&gt; ShowS)
-&gt; (RunSQL -&gt; String) -&gt; ([RunSQL] -&gt; ShowS) -&gt; Show RunSQL
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [RunSQL] -&gt; ShowS
$cshowList :: [RunSQL] -&gt; ShowS
show :: RunSQL -&gt; String
$cshow :: RunSQL -&gt; String
showsPrec :: Int -&gt; RunSQL -&gt; ShowS
$cshowsPrec :: Int -&gt; RunSQL -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688241053"><span id="local-6989586621688241055"><span class="annot"><span class="annottext">RunSQL -&gt; RunSQL -&gt; Bool
(RunSQL -&gt; RunSQL -&gt; Bool)
-&gt; (RunSQL -&gt; RunSQL -&gt; Bool) -&gt; Eq RunSQL
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: RunSQL -&gt; RunSQL -&gt; Bool
$c/= :: RunSQL -&gt; RunSQL -&gt; Bool
== :: RunSQL -&gt; RunSQL -&gt; Bool
$c== :: RunSQL -&gt; RunSQL -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621688241049"><span class="annot"><span class="hs-identifier hs-type">FromJSON</span></span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#RunSQL"><span class="hs-identifier hs-type">RunSQL</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-58"></span><span>  </span><span id="local-6989586621688241047"><span class="annot"><span class="annottext">parseJSON :: Value -&gt; Parser RunSQL
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">parseJSON</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; (Object -&gt; Parser RunSQL) -&gt; Value -&gt; Parser RunSQL
forall a. String -&gt; (Object -&gt; Parser a) -&gt; Value -&gt; Parser a
</span><span class="hs-identifier hs-var">withObject</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;RunSQL&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Object -&gt; Parser RunSQL) -&gt; Value -&gt; Parser RunSQL)
-&gt; (Object -&gt; Parser RunSQL) -&gt; Value -&gt; Parser RunSQL
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688241044"><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621688241044"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-59"></span><span>    </span><span id="local-6989586621688241043"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688241043"><span class="hs-identifier hs-var">rSql</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621688241044"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">Object -&gt; Text -&gt; Parser Text
forall a. FromJSON a =&gt; Object -&gt; Text -&gt; Parser a
</span><span class="hs-operator hs-var">.:</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;sql&quot;</span></span><span>
</span><span id="line-60"></span><span>    </span><span id="local-6989586621688241041"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688241041"><span class="hs-identifier hs-var">rSource</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621688241044"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">Object -&gt; Text -&gt; Parser (Maybe SourceName)
forall a. FromJSON a =&gt; Object -&gt; Text -&gt; Parser (Maybe a)
</span><span class="hs-operator hs-var">.:?</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;source&quot;</span></span><span> </span><span class="annot"><span class="annottext">Parser (Maybe SourceName) -&gt; SourceName -&gt; Parser SourceName
forall a. Parser (Maybe a) -&gt; a -&gt; Parser a
</span><span class="hs-operator hs-var">.!=</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="Hasura.RQL.Types.Common.html#defaultSource"><span class="hs-identifier hs-var">defaultSource</span></a></span><span>
</span><span id="line-61"></span><span>    </span><span id="local-6989586621688241037"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688241037"><span class="hs-identifier hs-var">rCascade</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621688241044"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">Object -&gt; Text -&gt; Parser (Maybe Bool)
forall a. FromJSON a =&gt; Object -&gt; Text -&gt; Parser (Maybe a)
</span><span class="hs-operator hs-var">.:?</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;cascade&quot;</span></span><span> </span><span class="annot"><span class="annottext">Parser (Maybe Bool) -&gt; Bool -&gt; Parser Bool
forall a. Parser (Maybe a) -&gt; a -&gt; Parser a
</span><span class="hs-operator hs-var">.!=</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-62"></span><span>    </span><span id="local-6989586621688241036"><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621688241036"><span class="hs-identifier hs-var">rCheckMetadataConsistency</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621688241044"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">Object -&gt; Text -&gt; Parser (Maybe Bool)
forall a. FromJSON a =&gt; Object -&gt; Text -&gt; Parser (Maybe a)
</span><span class="hs-operator hs-var">.:?</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;check_metadata_consistency&quot;</span></span><span>
</span><span id="line-63"></span><span>    </span><span id="local-6989586621688241035"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688241035"><span class="hs-identifier hs-var">isReadOnly</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Object
</span><a href="#local-6989586621688241044"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">Object -&gt; Text -&gt; Parser (Maybe Bool)
forall a. FromJSON a =&gt; Object -&gt; Text -&gt; Parser (Maybe a)
</span><span class="hs-operator hs-var">.:?</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;read_only&quot;</span></span><span> </span><span class="annot"><span class="annottext">Parser (Maybe Bool) -&gt; Bool -&gt; Parser Bool
forall a. Parser (Maybe a) -&gt; a -&gt; Parser a
</span><span class="hs-operator hs-var">.!=</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-64"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688241034"><span class="annot"><span class="annottext">rTxAccessMode :: TxAccess
</span><a href="#local-6989586621688241034"><span class="hs-identifier hs-var hs-var">rTxAccessMode</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688241035"><span class="hs-identifier hs-var">isReadOnly</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TxAccess
</span><span class="hs-identifier hs-var">Q.ReadOnly</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">TxAccess
</span><span class="hs-identifier hs-var">Q.ReadWrite</span></span><span>
</span><span id="line-65"></span><span>    </span><span class="annot"><span class="annottext">RunSQL -&gt; Parser RunSQL
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">RunSQL :: Text -&gt; SourceName -&gt; Bool -&gt; Maybe Bool -&gt; TxAccess -&gt; RunSQL
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#RunSQL"><span class="hs-identifier hs-type">RunSQL</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">Bool
Maybe Bool
Text
TxAccess
SourceName
rTxAccessMode :: TxAccess
rCheckMetadataConsistency :: Maybe Bool
rCascade :: Bool
rSource :: SourceName
rSql :: Text
rTxAccessMode :: TxAccess
rCheckMetadataConsistency :: Maybe Bool
rCascade :: Bool
rSource :: SourceName
rSql :: Text
</span><a href="#local-6989586621688241034"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621688241025"><span id="local-6989586621688241027"><span id="local-6989586621688241029"><span class="annot"><span class="hs-identifier hs-type">ToJSON</span></span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#RunSQL"><span class="hs-identifier hs-type">RunSQL</span></a></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-68"></span><span>  </span><span id="local-6989586621688241023"><span class="annot"><span class="annottext">toJSON :: RunSQL -&gt; Value
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">toJSON</span></span></span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#RunSQL"><span class="hs-identifier hs-type">RunSQL</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688241017"><span id="local-6989586621688241018"><span id="local-6989586621688241019"><span id="local-6989586621688241020"><span id="local-6989586621688241021"><span class="annot"><span class="annottext">Bool
Maybe Bool
Text
TxAccess
SourceName
rTxAccessMode :: TxAccess
rCheckMetadataConsistency :: Maybe Bool
rCascade :: Bool
rSource :: SourceName
rSql :: Text
rTxAccessMode :: RunSQL -&gt; TxAccess
rCheckMetadataConsistency :: RunSQL -&gt; Maybe Bool
rCascade :: RunSQL -&gt; Bool
rSource :: RunSQL -&gt; SourceName
rSql :: RunSQL -&gt; Text
</span><a href="#local-6989586621688241017"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-69"></span><span>    </span><span class="annot"><span class="annottext">[Pair] -&gt; Value
</span><span class="hs-identifier hs-var">object</span></span><span>
</span><span id="line-70"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;sql&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688241021"><span class="hs-identifier hs-var">rSql</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-71"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;source&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; SourceName -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688241020"><span class="hs-identifier hs-var">rSource</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-72"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;cascade&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Bool -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688241019"><span class="hs-identifier hs-var">rCascade</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-73"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;check_metadata_consistency&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Maybe Bool -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621688241018"><span class="hs-identifier hs-var">rCheckMetadataConsistency</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-74"></span><span>        </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;read_only&quot;</span></span><span>
</span><span id="line-75"></span><span>          </span><span class="annot"><span class="annottext">Text -&gt; Bool -&gt; Pair
forall kv v. (KeyValue kv, ToJSON v) =&gt; Text -&gt; v -&gt; kv
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TxAccess
</span><a href="#local-6989586621688241017"><span class="hs-identifier hs-var">rTxAccessMode</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-76"></span><span>            </span><span class="annot"><span class="annottext">TxAccess
</span><span class="hs-identifier hs-var">Q.ReadOnly</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-77"></span><span>            </span><span class="annot"><span class="annottext">TxAccess
</span><span class="hs-identifier hs-var">Q.ReadWrite</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-78"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span class="hs-comment">-- | Check for known schema-mutating keywords in the raw SQL text.</span><span>
</span><span id="line-81"></span><span class="hs-comment">--</span><span>
</span><span id="line-82"></span><span class="hs-comment">-- See Note [Checking metadata consistency in run_sql].</span><span>
</span><span id="line-83"></span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#isSchemaCacheBuildRequiredRunSQL"><span class="hs-identifier hs-type">isSchemaCacheBuildRequiredRunSQL</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#RunSQL"><span class="hs-identifier hs-type">RunSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-84"></span><span id="isSchemaCacheBuildRequiredRunSQL"><span class="annot"><span class="annottext">isSchemaCacheBuildRequiredRunSQL :: RunSQL -&gt; Bool
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#isSchemaCacheBuildRequiredRunSQL"><span class="hs-identifier hs-var hs-var">isSchemaCacheBuildRequiredRunSQL</span></a></span></span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#RunSQL"><span class="hs-identifier hs-type">RunSQL</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688241010"><span id="local-6989586621688241011"><span id="local-6989586621688241012"><span id="local-6989586621688241013"><span id="local-6989586621688241014"><span class="annot"><span class="annottext">Bool
Maybe Bool
Text
TxAccess
SourceName
rTxAccessMode :: TxAccess
rCheckMetadataConsistency :: Maybe Bool
rCascade :: Bool
rSource :: SourceName
rSql :: Text
rTxAccessMode :: RunSQL -&gt; TxAccess
rCheckMetadataConsistency :: RunSQL -&gt; Maybe Bool
rCascade :: RunSQL -&gt; Bool
rSource :: RunSQL -&gt; SourceName
rSql :: RunSQL -&gt; Text
</span><a href="#local-6989586621688241010"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TxAccess
</span><a href="#local-6989586621688241010"><span class="hs-identifier hs-var">rTxAccessMode</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-86"></span><span>    </span><span class="annot"><span class="annottext">TxAccess
</span><span class="hs-identifier hs-var">Q.ReadOnly</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-87"></span><span>    </span><span class="annot"><span class="annottext">TxAccess
</span><span class="hs-identifier hs-var">Q.ReadWrite</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Bool -&gt; Bool
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Bool
</span><a href="#local-6989586621688241008"><span class="hs-identifier hs-var">containsDDLKeyword</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688241014"><span class="hs-identifier hs-var">rSql</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621688241011"><span class="hs-identifier hs-var">rCheckMetadataConsistency</span></a></span><span>
</span><span id="line-88"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-89"></span><span>    </span><span id="local-6989586621688241008"><span class="annot"><span class="annottext">containsDDLKeyword :: Text -&gt; Bool
</span><a href="#local-6989586621688241008"><span class="hs-identifier hs-var hs-var">containsDDLKeyword</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-90"></span><span>      </span><span class="annot"><span class="annottext">Regex -&gt; Text -&gt; Bool
forall regex source target.
RegexContext regex source target =&gt;
regex -&gt; source -&gt; target
</span><span class="hs-identifier hs-var">TDFA.match</span></span><span>
</span><span id="line-91"></span><span>        </span><span class="hs-special">$$(</span><span> </span><span class="annot"><a href="Hasura.Server.Utils.html#quoteRegex"><span class="hs-identifier hs-type">quoteRegex</span></a></span><span>
</span><span id="line-92"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">TDFA.defaultCompOpt</span></span><span>
</span><span id="line-93"></span><span>                </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="hs-identifier hs-var">TDFA.caseSensitive</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span class="hs-special">,</span><span>
</span><span id="line-94"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-var">TDFA.multiline</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span class="hs-special">,</span><span>
</span><span id="line-95"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-var">TDFA.lastStarGreedy</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span>
</span><span id="line-96"></span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-97"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">TDFA.defaultExecOpt</span></span><span>
</span><span id="line-98"></span><span>                </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="hs-identifier hs-var">TDFA.captureGroups</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">False</span></span><span>
</span><span id="line-99"></span><span>                </span><span class="hs-special">}</span><span>
</span><span id="line-100"></span><span>              </span><span class="annot"><span class="hs-string">&quot;\\balter\\b|\\bdrop\\b|\\breplace\\b|\\bcreate function\\b|\\bcomment on\\b&quot;</span></span><span>
</span><span id="line-101"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span class="hs-comment">{- Note [Checking metadata consistency in run_sql]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
SQL queries executed by run_sql may change the Postgres schema in arbitrary
ways. We attempt to automatically update the metadata to reflect those changes
as much as possible---for example, if a table is renamed, we want to update the
metadata to track the table under its new name instead of its old one. This
schema diffing (plus some integrity checking) is handled by withMetadataCheck.

But this process has overhead---it involves reloading the metadata, diffing it,
and rebuilding the schema cache---so we don&#8217;t want to do it if it isn&#8217;t
necessary. The user can explicitly disable the check via the
check_metadata_consistency option, and we also skip it if the current
transaction is in READ ONLY mode, since the schema can&#8217;t be modified in that
case, anyway.

However, even if neither read_only or check_metadata_consistency is passed, lots
of queries may not modify the schema at all. As a (fairly stupid) heuristic, we
check if the query contains any keywords for DDL operations, and if not, we skip
the metadata check as well. -}</span><span>
</span><span id="line-122"></span><span>
</span><span id="line-123"></span><span id="local-6989586621688241165"><span id="local-6989586621688241166"><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#fetchMeta"><span class="hs-identifier hs-type">fetchMeta</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-124"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html#ToMetadataFetchQuery"><span class="hs-identifier hs-type">ToMetadataFetchQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688241166"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688241166"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.html#MonadTx"><span class="hs-identifier hs-type">MonadTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688241165"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-125"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Table.html#TableCache"><span class="hs-identifier hs-type">TableCache</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688241166"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-126"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Function.html#FunctionCache"><span class="hs-identifier hs-type">FunctionCache</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688241166"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-127"></span><span>  </span><span class="annot"><a href="#local-6989586621688241165"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Diff.html#TableMeta"><span class="hs-identifier hs-type">TableMeta</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688241166"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Diff.html#FunctionMeta"><span class="hs-identifier hs-type">FunctionMeta</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688241166"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-128"></span><span id="fetchMeta"><span class="annot"><span class="annottext">fetchMeta :: TableCache ('Postgres pgKind)
-&gt; FunctionCache ('Postgres pgKind)
-&gt; m ([TableMeta ('Postgres pgKind)],
      [FunctionMeta ('Postgres pgKind)])
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#fetchMeta"><span class="hs-identifier hs-var hs-var">fetchMeta</span></a></span></span><span> </span><span id="local-6989586621688240991"><span class="annot"><span class="annottext">TableCache ('Postgres pgKind)
</span><a href="#local-6989586621688240991"><span class="hs-identifier hs-var">tables</span></a></span></span><span> </span><span id="local-6989586621688240990"><span class="annot"><span class="annottext">FunctionCache ('Postgres pgKind)
</span><a href="#local-6989586621688240990"><span class="hs-identifier hs-var">functions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-129"></span><span>  </span><span id="local-6989586621688240989"><span class="annot"><span class="annottext">HashMap QualifiedTable (DBTableMetadata ('Postgres pgKind))
</span><a href="#local-6989586621688240989"><span class="hs-identifier hs-var">tableMetaInfos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (HashMap QualifiedTable (DBTableMetadata ('Postgres pgKind)))
forall (pgKind :: PostgresKind) (m :: * -&gt; *).
(Backend ('Postgres pgKind), ToMetadataFetchQuery pgKind,
 MonadTx m) =&gt;
m (DBTablesMetadata ('Postgres pgKind))
</span><a href="Hasura.Backends.Postgres.DDL.Source.html#fetchTableMetadata"><span class="hs-identifier hs-var">fetchTableMetadata</span></a></span><span>
</span><span id="line-130"></span><span>  </span><span id="local-6989586621688240988"><span class="annot"><span class="annottext">HashMap QualifiedFunction [PGRawFunctionInfo]
</span><a href="#local-6989586621688240988"><span class="hs-identifier hs-var">functionMetaInfos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (HashMap QualifiedFunction [PGRawFunctionInfo])
forall (m :: * -&gt; *) (pgKind :: PostgresKind).
MonadTx m =&gt;
m (DBFunctionsMetadata ('Postgres pgKind))
</span><a href="Hasura.Backends.Postgres.DDL.Source.html#fetchFunctionMetadata"><span class="hs-identifier hs-var">fetchFunctionMetadata</span></a></span><span>
</span><span id="line-131"></span><span>
</span><span id="line-132"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688240987"><span class="annot"><span class="annottext">getFunctionMetas :: QualifiedFunction -&gt; [FunctionMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688240987"><span class="hs-identifier hs-var hs-var">getFunctionMetas</span></a></span></span><span> </span><span id="local-6989586621688240986"><span class="annot"><span class="annottext">QualifiedFunction
</span><a href="#local-6989586621688240986"><span class="hs-identifier hs-var">function</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-133"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688240985"><span class="annot"><span class="annottext">mkFunctionMeta :: PGRawFunctionInfo -&gt; FunctionMeta ('Postgres pgKind)
</span><a href="#local-6989586621688240985"><span class="hs-identifier hs-var hs-var">mkFunctionMeta</span></a></span></span><span> </span><span id="local-6989586621688240984"><span class="annot"><span class="annottext">PGRawFunctionInfo
</span><a href="#local-6989586621688240984"><span class="hs-identifier hs-var">rawInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-134"></span><span>              </span><span class="annot"><span class="annottext">OID
-&gt; FunctionName ('Postgres pgKind)
-&gt; FunctionVolatility
-&gt; FunctionMeta ('Postgres pgKind)
forall (b :: BackendType).
OID -&gt; FunctionName b -&gt; FunctionVolatility -&gt; FunctionMeta b
</span><a href="Hasura.RQL.DDL.Schema.Diff.html#FunctionMeta"><span class="hs-identifier hs-var">FunctionMeta</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PGRawFunctionInfo -&gt; OID
</span><a href="Hasura.Backends.Postgres.SQL.Types.html#rfiOid"><span class="hs-identifier hs-var hs-var">rfiOid</span></a></span><span> </span><span class="annot"><span class="annottext">PGRawFunctionInfo
</span><a href="#local-6989586621688240984"><span class="hs-identifier hs-var">rawInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FunctionName ('Postgres pgKind)
QualifiedFunction
</span><a href="#local-6989586621688240986"><span class="hs-identifier hs-var">function</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PGRawFunctionInfo -&gt; FunctionVolatility
</span><a href="Hasura.Backends.Postgres.SQL.Types.html#rfiFunctionType"><span class="hs-identifier hs-var hs-var">rfiFunctionType</span></a></span><span> </span><span class="annot"><span class="annottext">PGRawFunctionInfo
</span><a href="#local-6989586621688240984"><span class="hs-identifier hs-var">rawInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-135"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[FunctionMeta ('Postgres pgKind)]
-&gt; ([PGRawFunctionInfo] -&gt; [FunctionMeta ('Postgres pgKind)])
-&gt; Maybe [PGRawFunctionInfo]
-&gt; [FunctionMeta ('Postgres pgKind)]
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PGRawFunctionInfo -&gt; FunctionMeta ('Postgres pgKind))
-&gt; [PGRawFunctionInfo] -&gt; [FunctionMeta ('Postgres pgKind)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">PGRawFunctionInfo -&gt; FunctionMeta ('Postgres pgKind)
</span><a href="#local-6989586621688240985"><span class="hs-identifier hs-var">mkFunctionMeta</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe [PGRawFunctionInfo] -&gt; [FunctionMeta ('Postgres pgKind)])
-&gt; Maybe [PGRawFunctionInfo] -&gt; [FunctionMeta ('Postgres pgKind)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualifiedFunction
-&gt; HashMap QualifiedFunction [PGRawFunctionInfo]
-&gt; Maybe [PGRawFunctionInfo]
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">QualifiedFunction
</span><a href="#local-6989586621688240986"><span class="hs-identifier hs-var">function</span></a></span><span> </span><span class="annot"><span class="annottext">HashMap QualifiedFunction [PGRawFunctionInfo]
</span><a href="#local-6989586621688240988"><span class="hs-identifier hs-var">functionMetaInfos</span></a></span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span>      </span><span id="local-6989586621688240978"><span class="annot"><span class="annottext">mkComputedFieldMeta :: ComputedFieldInfo ('Postgres pgKind)
-&gt; [ComputedFieldMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688240978"><span class="hs-identifier hs-var hs-var">mkComputedFieldMeta</span></a></span></span><span> </span><span id="local-6989586621688240977"><span class="annot"><span class="annottext">ComputedFieldInfo ('Postgres pgKind)
</span><a href="#local-6989586621688240977"><span class="hs-identifier hs-var">computedField</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-138"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688240976"><span class="annot"><span class="annottext">function :: FunctionName ('Postgres pgKind)
</span><a href="#local-6989586621688240976"><span class="hs-identifier hs-var hs-var">function</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ComputedFieldFunction ('Postgres pgKind)
-&gt; FunctionName ('Postgres pgKind)
forall (b :: BackendType).
ComputedFieldFunction b -&gt; FunctionName b
</span><a href="Hasura.RQL.Types.ComputedField.html#_cffName"><span class="hs-identifier hs-var hs-var">_cffName</span></a></span><span> </span><span class="annot"><span class="annottext">(ComputedFieldFunction ('Postgres pgKind)
 -&gt; FunctionName ('Postgres pgKind))
-&gt; ComputedFieldFunction ('Postgres pgKind)
-&gt; FunctionName ('Postgres pgKind)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ComputedFieldInfo ('Postgres pgKind)
-&gt; ComputedFieldFunction ('Postgres pgKind)
forall (b :: BackendType).
ComputedFieldInfo b -&gt; ComputedFieldFunction b
</span><a href="Hasura.RQL.Types.ComputedField.html#_cfiFunction"><span class="hs-identifier hs-var hs-var">_cfiFunction</span></a></span><span> </span><span class="annot"><span class="annottext">ComputedFieldInfo ('Postgres pgKind)
</span><a href="#local-6989586621688240977"><span class="hs-identifier hs-var">computedField</span></a></span><span>
</span><span id="line-139"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(FunctionMeta ('Postgres pgKind)
 -&gt; ComputedFieldMeta ('Postgres pgKind))
-&gt; [FunctionMeta ('Postgres pgKind)]
-&gt; [ComputedFieldMeta ('Postgres pgKind)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ComputedFieldName
-&gt; FunctionMeta ('Postgres pgKind)
-&gt; ComputedFieldMeta ('Postgres pgKind)
forall (b :: BackendType).
ComputedFieldName -&gt; FunctionMeta b -&gt; ComputedFieldMeta b
</span><a href="Hasura.RQL.DDL.Schema.Diff.html#ComputedFieldMeta"><span class="hs-identifier hs-var">ComputedFieldMeta</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ComputedFieldInfo ('Postgres pgKind) -&gt; ComputedFieldName
forall (b :: BackendType). ComputedFieldInfo b -&gt; ComputedFieldName
</span><a href="Hasura.RQL.Types.ComputedField.html#_cfiName"><span class="hs-identifier hs-var hs-var">_cfiName</span></a></span><span> </span><span class="annot"><span class="annottext">ComputedFieldInfo ('Postgres pgKind)
</span><a href="#local-6989586621688240977"><span class="hs-identifier hs-var">computedField</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([FunctionMeta ('Postgres pgKind)]
 -&gt; [ComputedFieldMeta ('Postgres pgKind)])
-&gt; [FunctionMeta ('Postgres pgKind)]
-&gt; [ComputedFieldMeta ('Postgres pgKind)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualifiedFunction -&gt; [FunctionMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688240987"><span class="hs-identifier hs-var">getFunctionMetas</span></a></span><span> </span><span class="annot"><span class="annottext">FunctionName ('Postgres pgKind)
QualifiedFunction
</span><a href="#local-6989586621688240976"><span class="hs-identifier hs-var">function</span></a></span><span>
</span><span id="line-140"></span><span>
</span><span id="line-141"></span><span>      </span><span id="local-6989586621688240971"><span class="annot"><span class="annottext">tableMetas :: [TableMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688240971"><span class="hs-identifier hs-var hs-var">tableMetas</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(((QualifiedTable, DBTableMetadata ('Postgres pgKind))
  -&gt; TableMeta ('Postgres pgKind))
 -&gt; [(QualifiedTable, DBTableMetadata ('Postgres pgKind))]
 -&gt; [TableMeta ('Postgres pgKind)])
-&gt; [(QualifiedTable, DBTableMetadata ('Postgres pgKind))]
-&gt; ((QualifiedTable, DBTableMetadata ('Postgres pgKind))
    -&gt; TableMeta ('Postgres pgKind))
-&gt; [TableMeta ('Postgres pgKind)]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">((QualifiedTable, DBTableMetadata ('Postgres pgKind))
 -&gt; TableMeta ('Postgres pgKind))
-&gt; [(QualifiedTable, DBTableMetadata ('Postgres pgKind))]
-&gt; [TableMeta ('Postgres pgKind)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap QualifiedTable (DBTableMetadata ('Postgres pgKind))
-&gt; [(QualifiedTable, DBTableMetadata ('Postgres pgKind))]
forall k v. HashMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">HashMap QualifiedTable (DBTableMetadata ('Postgres pgKind))
</span><a href="#local-6989586621688240989"><span class="hs-identifier hs-var">tableMetaInfos</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((QualifiedTable, DBTableMetadata ('Postgres pgKind))
  -&gt; TableMeta ('Postgres pgKind))
 -&gt; [TableMeta ('Postgres pgKind)])
-&gt; ((QualifiedTable, DBTableMetadata ('Postgres pgKind))
    -&gt; TableMeta ('Postgres pgKind))
-&gt; [TableMeta ('Postgres pgKind)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621688240968"><span class="annot"><span class="annottext">QualifiedTable
</span><a href="#local-6989586621688240968"><span class="hs-identifier hs-var">table</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688240967"><span class="annot"><span class="annottext">DBTableMetadata ('Postgres pgKind)
</span><a href="#local-6989586621688240967"><span class="hs-identifier hs-var">tableMetaInfo</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-142"></span><span>        </span><span class="annot"><span class="annottext">TableName ('Postgres pgKind)
-&gt; DBTableMetadata ('Postgres pgKind)
-&gt; [ComputedFieldMeta ('Postgres pgKind)]
-&gt; TableMeta ('Postgres pgKind)
forall (b :: BackendType).
TableName b
-&gt; DBTableMetadata b -&gt; [ComputedFieldMeta b] -&gt; TableMeta b
</span><a href="Hasura.RQL.DDL.Schema.Diff.html#TableMeta"><span class="hs-identifier hs-var">TableMeta</span></a></span><span> </span><span class="annot"><span class="annottext">TableName ('Postgres pgKind)
QualifiedTable
</span><a href="#local-6989586621688240968"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">DBTableMetadata ('Postgres pgKind)
</span><a href="#local-6989586621688240967"><span class="hs-identifier hs-var">tableMetaInfo</span></a></span><span> </span><span class="annot"><span class="annottext">([ComputedFieldMeta ('Postgres pgKind)]
 -&gt; TableMeta ('Postgres pgKind))
-&gt; [ComputedFieldMeta ('Postgres pgKind)]
-&gt; TableMeta ('Postgres pgKind)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-143"></span><span>          </span><span class="annot"><span class="annottext">[ComputedFieldMeta ('Postgres pgKind)]
-&gt; Maybe [ComputedFieldMeta ('Postgres pgKind)]
-&gt; [ComputedFieldMeta ('Postgres pgKind)]
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Maybe [ComputedFieldMeta ('Postgres pgKind)]
 -&gt; [ComputedFieldMeta ('Postgres pgKind)])
-&gt; Maybe [ComputedFieldMeta ('Postgres pgKind)]
-&gt; [ComputedFieldMeta ('Postgres pgKind)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-144"></span><span>            </span><span class="annot"><span class="annottext">QualifiedTable
-&gt; HashMap QualifiedTable (TableInfo ('Postgres pgKind))
-&gt; Maybe (TableInfo ('Postgres pgKind))
forall k v. (Eq k, Hashable k) =&gt; k -&gt; HashMap k v -&gt; Maybe v
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">QualifiedTable
</span><a href="#local-6989586621688240968"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">TableCache ('Postgres pgKind)
HashMap QualifiedTable (TableInfo ('Postgres pgKind))
</span><a href="#local-6989586621688240991"><span class="hs-identifier hs-var">tables</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TableInfo ('Postgres pgKind))
-&gt; (TableInfo ('Postgres pgKind)
    -&gt; [ComputedFieldMeta ('Postgres pgKind)])
-&gt; Maybe [ComputedFieldMeta ('Postgres pgKind)]
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688240964"><span class="annot"><span class="annottext">TableInfo ('Postgres pgKind)
</span><a href="#local-6989586621688240964"><span class="hs-identifier hs-var">tableInfo</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-145"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688240963"><span class="annot"><span class="annottext">tableCoreInfo :: TableCoreInfo ('Postgres pgKind)
</span><a href="#local-6989586621688240963"><span class="hs-identifier hs-var hs-var">tableCoreInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TableInfo ('Postgres pgKind) -&gt; TableCoreInfo ('Postgres pgKind)
forall (b :: BackendType). TableInfo b -&gt; TableCoreInfo b
</span><a href="Hasura.RQL.Types.Table.html#_tiCoreInfo"><span class="hs-identifier hs-var hs-var">_tiCoreInfo</span></a></span><span> </span><span class="annot"><span class="annottext">TableInfo ('Postgres pgKind)
</span><a href="#local-6989586621688240964"><span class="hs-identifier hs-var">tableInfo</span></a></span><span>
</span><span id="line-146"></span><span>                  </span><span id="local-6989586621688240961"><span class="annot"><span class="annottext">computedFields :: [ComputedFieldInfo ('Postgres pgKind)]
</span><a href="#local-6989586621688240961"><span class="hs-identifier hs-var hs-var">computedFields</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FieldInfoMap (FieldInfo ('Postgres pgKind))
-&gt; [ComputedFieldInfo ('Postgres pgKind)]
forall (backend :: BackendType).
FieldInfoMap (FieldInfo backend) -&gt; [ComputedFieldInfo backend]
</span><a href="Hasura.RQL.Types.Table.html#getComputedFieldInfos"><span class="hs-identifier hs-var">getComputedFieldInfos</span></a></span><span> </span><span class="annot"><span class="annottext">(FieldInfoMap (FieldInfo ('Postgres pgKind))
 -&gt; [ComputedFieldInfo ('Postgres pgKind)])
-&gt; FieldInfoMap (FieldInfo ('Postgres pgKind))
-&gt; [ComputedFieldInfo ('Postgres pgKind)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TableCoreInfo ('Postgres pgKind)
-&gt; FieldInfoMap (FieldInfo ('Postgres pgKind))
forall (b :: BackendType) field primaryKeyColumn.
TableCoreInfoG b field primaryKeyColumn -&gt; FieldInfoMap field
</span><a href="Hasura.RQL.Types.Table.html#_tciFieldInfoMap"><span class="hs-identifier hs-var hs-var">_tciFieldInfoMap</span></a></span><span> </span><span class="annot"><span class="annottext">TableCoreInfo ('Postgres pgKind)
</span><a href="#local-6989586621688240963"><span class="hs-identifier hs-var">tableCoreInfo</span></a></span><span>
</span><span id="line-147"></span><span>               </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(ComputedFieldInfo ('Postgres pgKind)
 -&gt; [ComputedFieldMeta ('Postgres pgKind)])
-&gt; [ComputedFieldInfo ('Postgres pgKind)]
-&gt; [ComputedFieldMeta ('Postgres pgKind)]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">ComputedFieldInfo ('Postgres pgKind)
-&gt; [ComputedFieldMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688240978"><span class="hs-identifier hs-var">mkComputedFieldMeta</span></a></span><span> </span><span class="annot"><span class="annottext">[ComputedFieldInfo ('Postgres pgKind)]
</span><a href="#local-6989586621688240961"><span class="hs-identifier hs-var">computedFields</span></a></span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span>      </span><span id="local-6989586621688240957"><span class="annot"><span class="annottext">functionMetas :: [FunctionMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688240957"><span class="hs-identifier hs-var hs-var">functionMetas</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(QualifiedFunction -&gt; [FunctionMeta ('Postgres pgKind)])
-&gt; [QualifiedFunction] -&gt; [FunctionMeta ('Postgres pgKind)]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">QualifiedFunction -&gt; [FunctionMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688240987"><span class="hs-identifier hs-var">getFunctionMetas</span></a></span><span> </span><span class="annot"><span class="annottext">([QualifiedFunction] -&gt; [FunctionMeta ('Postgres pgKind)])
-&gt; [QualifiedFunction] -&gt; [FunctionMeta ('Postgres pgKind)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashMap QualifiedFunction (FunctionInfo ('Postgres pgKind))
-&gt; [QualifiedFunction]
forall k v. HashMap k v -&gt; [k]
</span><span class="hs-identifier hs-var">M.keys</span></span><span> </span><span class="annot"><span class="annottext">FunctionCache ('Postgres pgKind)
HashMap QualifiedFunction (FunctionInfo ('Postgres pgKind))
</span><a href="#local-6989586621688240990"><span class="hs-identifier hs-var">functions</span></a></span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span>  </span><span class="annot"><span class="annottext">([TableMeta ('Postgres pgKind)], [FunctionMeta ('Postgres pgKind)])
-&gt; m ([TableMeta ('Postgres pgKind)],
      [FunctionMeta ('Postgres pgKind)])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TableMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688240971"><span class="hs-identifier hs-var">tableMetas</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[FunctionMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688240957"><span class="hs-identifier hs-var">functionMetas</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span class="hs-comment">-- | Used as an escape hatch to run raw SQL against a database.</span><span>
</span><span id="line-154"></span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#runRunSQL"><span class="hs-identifier hs-type">runRunSQL</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-155"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688240955"><span class="annot"><a href="#local-6989586621688240955"><span class="hs-identifier hs-type">pgKind</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.SQL.Backend.html#PostgresKind"><span class="hs-identifier hs-type">PostgresKind</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621688240954"><span class="annot"><a href="#local-6989586621688240954"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-156"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688240955"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-157"></span><span>    </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html#ToMetadataFetchQuery"><span class="hs-identifier hs-type">ToMetadataFetchQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688240955"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-158"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CacheRWM"><span class="hs-identifier hs-type">CacheRWM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688240954"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-159"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.html#HasServerConfigCtx"><span class="hs-identifier hs-type">HasServerConfigCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688240954"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-160"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#MetadataM"><span class="hs-identifier hs-type">MetadataM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688240954"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-161"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688240954"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-162"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688240954"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-163"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688240954"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-164"></span><span>    </span><span class="annot"><a href="Hasura.Tracing.html#MonadTrace"><span class="hs-identifier hs-type">Tracing.MonadTrace</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688240954"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-165"></span><span>    </span><span class="annot"><a href="Hasura.Session.html#UserInfoM"><span class="hs-identifier hs-type">UserInfoM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688240954"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-166"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-167"></span><span>  </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#RunSQL"><span class="hs-identifier hs-type">RunSQL</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-168"></span><span>  </span><span class="annot"><a href="#local-6989586621688240954"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Hasura.EncJSON.html#EncJSON"><span class="hs-identifier hs-type">EncJSON</span></a></span><span>
</span><span id="line-169"></span><span id="runRunSQL"><span class="annot"><span class="annottext">runRunSQL :: RunSQL -&gt; m EncJSON
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#runRunSQL"><span class="hs-identifier hs-var hs-var">runRunSQL</span></a></span></span><span> </span><span id="local-6989586621688240953"><span class="annot"><span class="annottext">q :: RunSQL
</span><a href="#local-6989586621688240953"><span class="hs-identifier hs-var">q</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#RunSQL"><span class="hs-identifier hs-type">RunSQL</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621688240948"><span id="local-6989586621688240949"><span id="local-6989586621688240950"><span id="local-6989586621688240951"><span id="local-6989586621688240952"><span class="annot"><span class="annottext">Bool
Maybe Bool
Text
TxAccess
SourceName
rTxAccessMode :: TxAccess
rCheckMetadataConsistency :: Maybe Bool
rCascade :: Bool
rSource :: SourceName
rSql :: Text
rTxAccessMode :: RunSQL -&gt; TxAccess
rCheckMetadataConsistency :: RunSQL -&gt; Maybe Bool
rCascade :: RunSQL -&gt; Bool
rSource :: RunSQL -&gt; SourceName
rSql :: RunSQL -&gt; Text
</span><a href="#local-6989586621688240948"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-170"></span><span>  </span><span id="local-6989586621688240947"><span class="annot"><span class="annottext">PGSourceConfig
</span><a href="#local-6989586621688240947"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; m (SourceConfig ('Postgres pgKind))
forall (b :: BackendType) (m :: * -&gt; *).
(CacheRM m, MonadError QErr m, Backend b, MetadataM m) =&gt;
SourceName -&gt; m (SourceConfig b)
</span><a href="Hasura.RQL.Types.html#askSourceConfig"><span class="hs-identifier hs-var">askSourceConfig</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688240955"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688240951"><span class="hs-identifier hs-var">rSource</span></a></span><span>
</span><span id="line-171"></span><span>  </span><span id="local-6989586621688240945"><span class="annot"><span class="annottext">TraceContext
</span><a href="#local-6989586621688240945"><span class="hs-identifier hs-var">traceCtx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m TraceContext
forall (m :: * -&gt; *). MonadTrace m =&gt; m TraceContext
</span><a href="Hasura.Tracing.html#currentContext"><span class="hs-identifier hs-var">Tracing.currentContext</span></a></span><span>
</span><span id="line-172"></span><span>  </span><span id="local-6989586621688240943"><span class="annot"><span class="annottext">UserInfo
</span><a href="#local-6989586621688240943"><span class="hs-identifier hs-var">userInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m UserInfo
forall (m :: * -&gt; *). UserInfoM m =&gt; m UserInfo
</span><a href="Hasura.Session.html#askUserInfo"><span class="hs-identifier hs-var">askUserInfo</span></a></span><span>
</span><span id="line-173"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688240941"><span class="annot"><span class="annottext">pgExecCtx :: PGExecCtx
</span><a href="#local-6989586621688240941"><span class="hs-identifier hs-var hs-var">pgExecCtx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PGSourceConfig -&gt; PGExecCtx
</span><a href="Hasura.Backends.Postgres.Execute.Types.html#_pscExecCtx"><span class="hs-identifier hs-var hs-var">_pscExecCtx</span></a></span><span> </span><span class="annot"><span class="annottext">PGSourceConfig
</span><a href="#local-6989586621688240947"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span>
</span><span id="line-174"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RunSQL -&gt; Bool
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#isSchemaCacheBuildRequiredRunSQL"><span class="hs-identifier hs-var">isSchemaCacheBuildRequiredRunSQL</span></a></span><span> </span><span class="annot"><span class="annottext">RunSQL
</span><a href="#local-6989586621688240953"><span class="hs-identifier hs-var">q</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-175"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-176"></span><span>      </span><span class="hs-comment">-- see Note [Checking metadata consistency in run_sql]</span><span>
</span><span id="line-177"></span><span>      </span><span class="annot"><span class="annottext">SourceName -&gt; Bool -&gt; TxAccess -&gt; TxET QErr m EncJSON -&gt; m EncJSON
forall (pgKind :: PostgresKind) a (m :: * -&gt; *).
(BackendMetadata ('Postgres pgKind), ToMetadataFetchQuery pgKind,
 CacheRWM m, HasServerConfigCtx m, MetadataM m,
 MonadBaseControl IO m, MonadError QErr m, MonadIO m) =&gt;
SourceName -&gt; Bool -&gt; TxAccess -&gt; TxET QErr m a -&gt; m a
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#withMetadataCheck"><span class="hs-identifier hs-var">withMetadataCheck</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621688240955"><span class="hs-identifier hs-type">pgKind</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688240951"><span class="hs-identifier hs-var">rSource</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688240950"><span class="hs-identifier hs-var">rCascade</span></a></span><span> </span><span class="annot"><span class="annottext">TxAccess
</span><a href="#local-6989586621688240948"><span class="hs-identifier hs-var">rTxAccessMode</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr m EncJSON -&gt; m EncJSON)
-&gt; TxET QErr m EncJSON -&gt; m EncJSON
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-178"></span><span>        </span><span class="annot"><span class="annottext">TraceContext -&gt; TxET QErr m EncJSON -&gt; TxET QErr m EncJSON
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
TraceContext -&gt; TxET QErr m a -&gt; TxET QErr m a
</span><a href="Hasura.Backends.Postgres.Connection.html#withTraceContext"><span class="hs-identifier hs-var">withTraceContext</span></a></span><span> </span><span class="annot"><span class="annottext">TraceContext
</span><a href="#local-6989586621688240945"><span class="hs-identifier hs-var">traceCtx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr m EncJSON -&gt; TxET QErr m EncJSON)
-&gt; TxET QErr m EncJSON -&gt; TxET QErr m EncJSON
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-179"></span><span>          </span><span class="annot"><span class="annottext">UserInfo -&gt; TxET QErr m EncJSON -&gt; TxET QErr m EncJSON
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
UserInfo -&gt; TxET QErr m a -&gt; TxET QErr m a
</span><a href="Hasura.Backends.Postgres.Connection.html#withUserInfo"><span class="hs-identifier hs-var">withUserInfo</span></a></span><span> </span><span class="annot"><span class="annottext">UserInfo
</span><a href="#local-6989586621688240943"><span class="hs-identifier hs-var">userInfo</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr m EncJSON -&gt; TxET QErr m EncJSON)
-&gt; TxET QErr m EncJSON -&gt; TxET QErr m EncJSON
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-180"></span><span>            </span><span class="annot"><span class="annottext">Text -&gt; TxET QErr m EncJSON
forall (n :: * -&gt; *). MonadTx n =&gt; Text -&gt; n EncJSON
</span><a href="#local-6989586621688240936"><span class="hs-identifier hs-var">execRawSQL</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688240952"><span class="hs-identifier hs-var">rSql</span></a></span><span>
</span><span id="line-181"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-182"></span><span>      </span><span class="annot"><span class="annottext">PGExecCtx -&gt; TxAccess -&gt; TxET QErr m EncJSON -&gt; m EncJSON
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m, MonadError QErr m, MonadTrace m,
 UserInfoM m) =&gt;
PGExecCtx -&gt; TxAccess -&gt; TxET QErr m a -&gt; m a
</span><a href="Hasura.Backends.Postgres.Connection.html#runTxWithCtx"><span class="hs-identifier hs-var">runTxWithCtx</span></a></span><span> </span><span class="annot"><span class="annottext">PGExecCtx
</span><a href="#local-6989586621688240941"><span class="hs-identifier hs-var">pgExecCtx</span></a></span><span> </span><span class="annot"><span class="annottext">TxAccess
</span><a href="#local-6989586621688240948"><span class="hs-identifier hs-var">rTxAccessMode</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr m EncJSON -&gt; m EncJSON)
-&gt; TxET QErr m EncJSON -&gt; m EncJSON
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; TxET QErr m EncJSON
forall (n :: * -&gt; *). MonadTx n =&gt; Text -&gt; n EncJSON
</span><a href="#local-6989586621688240936"><span class="hs-identifier hs-var">execRawSQL</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621688240952"><span class="hs-identifier hs-var">rSql</span></a></span><span>
</span><span id="line-183"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-184"></span><span>    </span><span id="local-6989586621688241216"><span class="annot"><a href="#local-6989586621688240936"><span class="hs-identifier hs-type">execRawSQL</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.Backends.Postgres.Connection.html#MonadTx"><span class="hs-identifier hs-type">MonadTx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688241216"><span class="hs-identifier hs-type">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621688241216"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="annot"><a href="Hasura.EncJSON.html#EncJSON"><span class="hs-identifier hs-type">EncJSON</span></a></span></span><span>
</span><span id="line-185"></span><span>    </span><span id="local-6989586621688240936"><span class="annot"><span class="annottext">execRawSQL :: Text -&gt; n EncJSON
</span><a href="#local-6989586621688240936"><span class="hs-identifier hs-var hs-var">execRawSQL</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-186"></span><span>      </span><span class="annot"><span class="annottext">(RunSQLRes -&gt; EncJSON) -&gt; n RunSQLRes -&gt; n EncJSON
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ToJSON RunSQLRes =&gt; RunSQLRes -&gt; EncJSON
forall a. ToJSON a =&gt; a -&gt; EncJSON
</span><a href="Hasura.EncJSON.html#encJFromJValue"><span class="hs-identifier hs-var">encJFromJValue</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.RQL.DDL.Schema.html#RunSQLRes"><span class="hs-identifier hs-type">RunSQLRes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(n RunSQLRes -&gt; n EncJSON)
-&gt; (Text -&gt; n RunSQLRes) -&gt; Text -&gt; n EncJSON
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TxE QErr RunSQLRes -&gt; n RunSQLRes
forall (m :: * -&gt; *) a. MonadTx m =&gt; TxE QErr a -&gt; m a
</span><a href="Hasura.Backends.Postgres.Connection.html#liftTx"><span class="hs-identifier hs-var">liftTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr RunSQLRes -&gt; n RunSQLRes)
-&gt; (Text -&gt; TxE QErr RunSQLRes) -&gt; Text -&gt; n RunSQLRes
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(PGTxErr -&gt; QErr) -&gt; Query -&gt; TxE QErr RunSQLRes
forall (m :: * -&gt; *) a e.
(MonadIO m, FromRes a) =&gt;
(PGTxErr -&gt; e) -&gt; Query -&gt; TxET e m a
</span><span class="hs-identifier hs-var">Q.multiQE</span></span><span> </span><span class="annot"><span class="annottext">PGTxErr -&gt; QErr
forall a. ToJSON a =&gt; a -&gt; QErr
</span><a href="#local-6989586621688240930"><span class="hs-identifier hs-var">rawSqlErrHandler</span></a></span><span> </span><span class="annot"><span class="annottext">(Query -&gt; TxE QErr RunSQLRes)
-&gt; (Text -&gt; Query) -&gt; Text -&gt; TxE QErr RunSQLRes
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Query
</span><span class="hs-identifier hs-var">Q.fromText</span></span><span>
</span><span id="line-187"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-188"></span><span>        </span><span id="local-6989586621688240930"><span class="annot"><span class="annottext">rawSqlErrHandler :: a -&gt; QErr
</span><a href="#local-6989586621688240930"><span class="hs-identifier hs-var hs-var">rawSqlErrHandler</span></a></span></span><span> </span><span id="local-6989586621688240928"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621688240928"><span class="hs-identifier hs-var">txe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-189"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; QErr
</span><a href="Hasura.Base.Error.html#err400"><span class="hs-identifier hs-var">err400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#PostgresError"><span class="hs-identifier hs-var">PostgresError</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;query execution failed&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">qeInternal :: Maybe QErrExtra
</span><a href="Hasura.Base.Error.html#qeInternal"><span class="hs-identifier hs-var">qeInternal</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QErrExtra -&gt; Maybe QErrExtra
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(QErrExtra -&gt; Maybe QErrExtra) -&gt; QErrExtra -&gt; Maybe QErrExtra
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Value -&gt; QErrExtra
</span><a href="Hasura.Base.Error.html#ExtraInternal"><span class="hs-identifier hs-var">ExtraInternal</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; QErrExtra) -&gt; Value -&gt; QErrExtra
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Value
forall a. ToJSON a =&gt; a -&gt; Value
</span><span class="hs-identifier hs-var">toJSON</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621688240928"><span class="hs-identifier hs-var">txe</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span class="hs-comment">-- | @'withMetadataCheck' cascade action@ runs @action@ and checks if the schema changed as a</span><span>
</span><span id="line-192"></span><span class="hs-comment">-- result. If it did, it checks to ensure the changes do not violate any integrity constraints, and</span><span>
</span><span id="line-193"></span><span class="hs-comment">-- if not, incorporates them into the schema cache.</span><span>
</span><span id="line-194"></span><span class="hs-comment">-- TODO(antoine): shouldn't this be generalized?</span><span>
</span><span id="line-195"></span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#withMetadataCheck"><span class="hs-identifier hs-type">withMetadataCheck</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-196"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span class="hs-special">(</span><span id="local-6989586621688241228"><span class="annot"><a href="#local-6989586621688241228"><span class="hs-identifier hs-type">pgKind</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hasura.SQL.Backend.html#PostgresKind"><span class="hs-identifier hs-type">PostgresKind</span></a></span><span class="hs-special">)</span><span> </span><span id="local-6989586621688241221"><span class="annot"><a href="#local-6989586621688241221"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621688241226"><span class="annot"><a href="#local-6989586621688241226"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-197"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688241228"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-198"></span><span>    </span><span class="annot"><a href="Hasura.Backends.Postgres.DDL.Source.html#ToMetadataFetchQuery"><span class="hs-identifier hs-type">ToMetadataFetchQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688241228"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-199"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#CacheRWM"><span class="hs-identifier hs-type">CacheRWM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688241226"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-200"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.html#HasServerConfigCtx"><span class="hs-identifier hs-type">HasServerConfigCtx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688241226"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-201"></span><span>    </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCache.Build.html#MetadataM"><span class="hs-identifier hs-type">MetadataM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688241226"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-202"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadBaseControl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621688241226"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-203"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688241226"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-204"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621688241226"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-205"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-206"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Common.html#SourceName"><span class="hs-identifier hs-type">SourceName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-207"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-208"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Q.TxAccess</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-209"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Q.TxET</span></span><span> </span><span class="annot"><a href="Hasura.Base.Error.html#QErr"><span class="hs-identifier hs-type">QErr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688241226"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688241221"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-210"></span><span>  </span><span class="annot"><a href="#local-6989586621688241226"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688241221"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-211"></span><span id="withMetadataCheck"><span class="annot"><span class="annottext">withMetadataCheck :: SourceName -&gt; Bool -&gt; TxAccess -&gt; TxET QErr m a -&gt; m a
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#withMetadataCheck"><span class="hs-identifier hs-var hs-var">withMetadataCheck</span></a></span></span><span> </span><span id="local-6989586621688240923"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688240923"><span class="hs-identifier hs-var">source</span></a></span></span><span> </span><span id="local-6989586621688240922"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688240922"><span class="hs-identifier hs-var">cascade</span></a></span></span><span> </span><span id="local-6989586621688240921"><span class="annot"><span class="annottext">TxAccess
</span><a href="#local-6989586621688240921"><span class="hs-identifier hs-var">txAccess</span></a></span></span><span> </span><span id="local-6989586621688240920"><span class="annot"><span class="annottext">TxET QErr m a
</span><a href="#local-6989586621688240920"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-212"></span><span>  </span><span class="annot"><a href="Hasura.RQL.Types.Source.html#SourceInfo"><span class="hs-identifier hs-type">SourceInfo</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688240918"><span class="annot"><span class="annottext">TableCache ('Postgres pgKind)
</span><a href="#local-6989586621688240918"><span class="hs-identifier hs-var">preActionTables</span></a></span></span><span> </span><span id="local-6989586621688240917"><span class="annot"><span class="annottext">FunctionCache ('Postgres pgKind)
</span><a href="#local-6989586621688240917"><span class="hs-identifier hs-var">preActionFunctions</span></a></span></span><span> </span><span id="local-6989586621688240916"><span class="annot"><span class="annottext">SourceConfig ('Postgres pgKind)
</span><a href="#local-6989586621688240916"><span class="hs-identifier hs-var">sourceConfig</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe QueryTagsConfig
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SourceCustomization
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; m (SourceInfo ('Postgres pgKind))
forall (b :: BackendType) (m :: * -&gt; *).
(CacheRM m, MonadError QErr m, Backend b, MetadataM m) =&gt;
SourceName -&gt; m (SourceInfo b)
</span><a href="Hasura.RQL.Types.html#askSourceInfo"><span class="hs-identifier hs-var">askSourceInfo</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688241228"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688240923"><span class="hs-identifier hs-var">source</span></a></span><span>
</span><span id="line-213"></span><span>
</span><span id="line-214"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621688240914"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621688240914"><span class="hs-identifier hs-var">actionResult</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688240913"><span class="annot"><span class="annottext">MetadataModifier
</span><a href="#local-6989586621688240913"><span class="hs-identifier hs-var">metadataUpdater</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-215"></span><span>    </span><span class="annot"><span class="annottext">m (Either QErr (a, MetadataModifier)) -&gt; m (a, MetadataModifier)
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr (a, MetadataModifier)) -&gt; m (a, MetadataModifier))
-&gt; m (Either QErr (a, MetadataModifier)) -&gt; m (a, MetadataModifier)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-216"></span><span>      </span><span class="annot"><span class="annottext">ExceptT QErr m (a, MetadataModifier)
-&gt; m (Either QErr (a, MetadataModifier))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT QErr m (a, MetadataModifier)
 -&gt; m (Either QErr (a, MetadataModifier)))
-&gt; ExceptT QErr m (a, MetadataModifier)
-&gt; m (Either QErr (a, MetadataModifier))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-217"></span><span>        </span><span class="annot"><span class="annottext">PGExecCtx
-&gt; TxAccess
-&gt; TxET QErr m (a, MetadataModifier)
-&gt; ExceptT QErr m (a, MetadataModifier)
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
PGExecCtx -&gt; TxAccess -&gt; TxET QErr m a -&gt; ExceptT QErr m a
</span><a href="Hasura.Backends.Postgres.Connection.html#runTx"><span class="hs-identifier hs-var">runTx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PGSourceConfig -&gt; PGExecCtx
</span><a href="Hasura.Backends.Postgres.Execute.Types.html#_pscExecCtx"><span class="hs-identifier hs-var hs-var">_pscExecCtx</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig ('Postgres pgKind)
PGSourceConfig
</span><a href="#local-6989586621688240916"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TxAccess
</span><a href="#local-6989586621688240921"><span class="hs-identifier hs-var">txAccess</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr m (a, MetadataModifier)
 -&gt; ExceptT QErr m (a, MetadataModifier))
-&gt; TxET QErr m (a, MetadataModifier)
-&gt; ExceptT QErr m (a, MetadataModifier)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-218"></span><span>          </span><span class="hs-comment">-- Drop event triggers so no interference is caused to the sql query</span><span>
</span><span id="line-219"></span><span>          </span><span class="annot"><span class="annottext">[TableInfo ('Postgres pgKind)]
-&gt; (TableInfo ('Postgres pgKind) -&gt; TxET QErr m ())
-&gt; TxET QErr m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap QualifiedTable (TableInfo ('Postgres pgKind))
-&gt; [TableInfo ('Postgres pgKind)]
forall k v. HashMap k v -&gt; [v]
</span><span class="hs-identifier hs-var">M.elems</span></span><span> </span><span class="annot"><span class="annottext">TableCache ('Postgres pgKind)
HashMap QualifiedTable (TableInfo ('Postgres pgKind))
</span><a href="#local-6989586621688240918"><span class="hs-identifier hs-var">preActionTables</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((TableInfo ('Postgres pgKind) -&gt; TxET QErr m ())
 -&gt; TxET QErr m ())
-&gt; (TableInfo ('Postgres pgKind) -&gt; TxET QErr m ())
-&gt; TxET QErr m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621688240907"><span class="annot"><span class="annottext">TableInfo ('Postgres pgKind)
</span><a href="#local-6989586621688240907"><span class="hs-identifier hs-var">tableInfo</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-220"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688240906"><span class="annot"><span class="annottext">eventTriggers :: EventTriggerInfoMap ('Postgres pgKind)
</span><a href="#local-6989586621688240906"><span class="hs-identifier hs-var hs-var">eventTriggers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TableInfo ('Postgres pgKind)
-&gt; EventTriggerInfoMap ('Postgres pgKind)
forall (b :: BackendType). TableInfo b -&gt; EventTriggerInfoMap b
</span><a href="Hasura.RQL.Types.Table.html#_tiEventTriggerInfoMap"><span class="hs-identifier hs-var hs-var">_tiEventTriggerInfoMap</span></a></span><span> </span><span class="annot"><span class="annottext">TableInfo ('Postgres pgKind)
</span><a href="#local-6989586621688240907"><span class="hs-identifier hs-var">tableInfo</span></a></span><span>
</span><span id="line-221"></span><span>            </span><span class="annot"><span class="annottext">[TriggerName] -&gt; (TriggerName -&gt; TxET QErr m ()) -&gt; TxET QErr m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerInfoMap ('Postgres pgKind) -&gt; [TriggerName]
forall k v. HashMap k v -&gt; [k]
</span><span class="hs-identifier hs-var">M.keys</span></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfoMap ('Postgres pgKind)
</span><a href="#local-6989586621688240906"><span class="hs-identifier hs-var">eventTriggers</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxE QErr () -&gt; TxET QErr m ()
forall (m :: * -&gt; *) a. MonadTx m =&gt; TxE QErr a -&gt; m a
</span><a href="Hasura.Backends.Postgres.Connection.html#liftTx"><span class="hs-identifier hs-var">liftTx</span></a></span><span> </span><span class="annot"><span class="annottext">(TxE QErr () -&gt; TxET QErr m ())
-&gt; (TriggerName -&gt; TxE QErr ()) -&gt; TriggerName -&gt; TxET QErr m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TriggerName -&gt; TxE QErr ()
</span><a href="Hasura.Backends.Postgres.DDL.EventTrigger.html#dropTriggerQ"><span class="hs-identifier hs-var">dropTriggerQ</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span>          </span><span class="hs-comment">-- Get the metadata before the sql query, everything, need to filter this</span><span>
</span><span id="line-224"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621688240903"><span class="annot"><span class="annottext">[TableMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688240903"><span class="hs-identifier hs-var">preActionTableMeta</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688240902"><span class="annot"><span class="annottext">[FunctionMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688240902"><span class="hs-identifier hs-var">preActionFunctionMeta</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TableCache ('Postgres pgKind)
-&gt; FunctionCache ('Postgres pgKind)
-&gt; TxET
     QErr
     m
     ([TableMeta ('Postgres pgKind)], [FunctionMeta ('Postgres pgKind)])
forall (pgKind :: PostgresKind) (m :: * -&gt; *).
(ToMetadataFetchQuery pgKind, BackendMetadata ('Postgres pgKind),
 MonadTx m) =&gt;
TableCache ('Postgres pgKind)
-&gt; FunctionCache ('Postgres pgKind)
-&gt; m ([TableMeta ('Postgres pgKind)],
      [FunctionMeta ('Postgres pgKind)])
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#fetchMeta"><span class="hs-identifier hs-var">fetchMeta</span></a></span><span> </span><span class="annot"><span class="annottext">TableCache ('Postgres pgKind)
</span><a href="#local-6989586621688240918"><span class="hs-identifier hs-var">preActionTables</span></a></span><span> </span><span class="annot"><span class="annottext">FunctionCache ('Postgres pgKind)
</span><a href="#local-6989586621688240917"><span class="hs-identifier hs-var">preActionFunctions</span></a></span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span>          </span><span class="hs-comment">-- Run the action</span><span>
</span><span id="line-227"></span><span>          </span><span id="local-6989586621688240901"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621688240901"><span class="hs-identifier hs-var">actionResult</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TxET QErr m a
</span><a href="#local-6989586621688240920"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-228"></span><span>
</span><span id="line-229"></span><span>          </span><span class="hs-comment">-- Get the metadata after the sql query</span><span>
</span><span id="line-230"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621688240900"><span class="annot"><span class="annottext">[TableMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688240900"><span class="hs-identifier hs-var">postActionTableMeta</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688240899"><span class="annot"><span class="annottext">[FunctionMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688240899"><span class="hs-identifier hs-var">postActionFunctionMeta</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TableCache ('Postgres pgKind)
-&gt; FunctionCache ('Postgres pgKind)
-&gt; TxET
     QErr
     m
     ([TableMeta ('Postgres pgKind)], [FunctionMeta ('Postgres pgKind)])
forall (pgKind :: PostgresKind) (m :: * -&gt; *).
(ToMetadataFetchQuery pgKind, BackendMetadata ('Postgres pgKind),
 MonadTx m) =&gt;
TableCache ('Postgres pgKind)
-&gt; FunctionCache ('Postgres pgKind)
-&gt; m ([TableMeta ('Postgres pgKind)],
      [FunctionMeta ('Postgres pgKind)])
</span><a href="Hasura.Backends.Postgres.DDL.RunSQL.html#fetchMeta"><span class="hs-identifier hs-var">fetchMeta</span></a></span><span> </span><span class="annot"><span class="annottext">TableCache ('Postgres pgKind)
</span><a href="#local-6989586621688240918"><span class="hs-identifier hs-var">preActionTables</span></a></span><span> </span><span class="annot"><span class="annottext">FunctionCache ('Postgres pgKind)
</span><a href="#local-6989586621688240917"><span class="hs-identifier hs-var">preActionFunctions</span></a></span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688240898"><span class="annot"><span class="annottext">preActionTableMeta' :: [TableMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688240898"><span class="hs-identifier hs-var hs-var">preActionTableMeta'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TableMeta ('Postgres pgKind) -&gt; Bool)
-&gt; [TableMeta ('Postgres pgKind)] -&gt; [TableMeta ('Postgres pgKind)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(QualifiedTable
 -&gt; HashMap QualifiedTable (TableInfo ('Postgres pgKind)) -&gt; Bool)
-&gt; HashMap QualifiedTable (TableInfo ('Postgres pgKind))
-&gt; QualifiedTable
-&gt; Bool
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">QualifiedTable
-&gt; HashMap QualifiedTable (TableInfo ('Postgres pgKind)) -&gt; Bool
forall k a. (Eq k, Hashable k) =&gt; k -&gt; HashMap k a -&gt; Bool
</span><span class="hs-identifier hs-var">M.member</span></span><span> </span><span class="annot"><span class="annottext">TableCache ('Postgres pgKind)
HashMap QualifiedTable (TableInfo ('Postgres pgKind))
</span><a href="#local-6989586621688240918"><span class="hs-identifier hs-var">preActionTables</span></a></span><span> </span><span class="annot"><span class="annottext">(QualifiedTable -&gt; Bool)
-&gt; (TableMeta ('Postgres pgKind) -&gt; QualifiedTable)
-&gt; TableMeta ('Postgres pgKind)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TableMeta ('Postgres pgKind) -&gt; QualifiedTable
forall (b :: BackendType). TableMeta b -&gt; TableName b
</span><a href="Hasura.RQL.DDL.Schema.Diff.html#tmTable"><span class="hs-identifier hs-var hs-var">tmTable</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TableMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688240903"><span class="hs-identifier hs-var">preActionTableMeta</span></a></span><span>
</span><span id="line-233"></span><span>              </span><span id="local-6989586621688240895"><span class="annot"><span class="annottext">tablesDiff :: TablesDiff ('Postgres pgKind)
</span><a href="#local-6989586621688240895"><span class="hs-identifier hs-var hs-var">tablesDiff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TableMeta ('Postgres pgKind)]
-&gt; [TableMeta ('Postgres pgKind)] -&gt; TablesDiff ('Postgres pgKind)
forall (b :: BackendType).
Backend b =&gt;
[TableMeta b] -&gt; [TableMeta b] -&gt; TablesDiff b
</span><a href="Hasura.RQL.DDL.Schema.Diff.html#getTablesDiff"><span class="hs-identifier hs-var">getTablesDiff</span></a></span><span> </span><span class="annot"><span class="annottext">[TableMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688240898"><span class="hs-identifier hs-var">preActionTableMeta'</span></a></span><span> </span><span class="annot"><span class="annottext">[TableMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688240900"><span class="hs-identifier hs-var">postActionTableMeta</span></a></span><span>
</span><span id="line-234"></span><span>              </span><span class="annot"><a href="Hasura.RQL.DDL.Schema.Diff.html#FunctionsDiff"><span class="hs-identifier hs-type">FunctionsDiff</span></a></span><span> </span><span id="local-6989586621688240892"><span class="annot"><span class="annottext">[FunctionName ('Postgres pgKind)]
</span><a href="#local-6989586621688240892"><span class="hs-identifier hs-var">droppedFuncs</span></a></span></span><span> </span><span id="local-6989586621688240891"><span class="annot"><span class="annottext">[(FunctionName ('Postgres pgKind), FunctionVolatility)]
</span><a href="#local-6989586621688240891"><span class="hs-identifier hs-var">alteredFuncs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[FunctionMeta ('Postgres pgKind)]
-&gt; [FunctionMeta ('Postgres pgKind)]
-&gt; FunctionsDiff ('Postgres pgKind)
forall (b :: BackendType).
[FunctionMeta b] -&gt; [FunctionMeta b] -&gt; FunctionsDiff b
</span><a href="Hasura.RQL.DDL.Schema.Diff.html#getFunctionsDiff"><span class="hs-identifier hs-var">getFunctionsDiff</span></a></span><span> </span><span class="annot"><span class="annottext">[FunctionMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688240902"><span class="hs-identifier hs-var">preActionFunctionMeta</span></a></span><span> </span><span class="annot"><span class="annottext">[FunctionMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688240899"><span class="hs-identifier hs-var">postActionFunctionMeta</span></a></span><span>
</span><span id="line-235"></span><span>              </span><span id="local-6989586621688240889"><span class="annot"><span class="annottext">overloadedFuncs :: [FunctionName ('Postgres pgKind)]
</span><a href="#local-6989586621688240889"><span class="hs-identifier hs-var hs-var">overloadedFuncs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[FunctionName ('Postgres pgKind)]
-&gt; [FunctionMeta ('Postgres pgKind)]
-&gt; [FunctionName ('Postgres pgKind)]
forall (b :: BackendType).
Backend b =&gt;
[FunctionName b] -&gt; [FunctionMeta b] -&gt; [FunctionName b]
</span><a href="Hasura.RQL.DDL.Schema.Diff.html#getOverloadedFunctions"><span class="hs-identifier hs-var">getOverloadedFunctions</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap QualifiedFunction (FunctionInfo ('Postgres pgKind))
-&gt; [QualifiedFunction]
forall k v. HashMap k v -&gt; [k]
</span><span class="hs-identifier hs-var">M.keys</span></span><span> </span><span class="annot"><span class="annottext">FunctionCache ('Postgres pgKind)
HashMap QualifiedFunction (FunctionInfo ('Postgres pgKind))
</span><a href="#local-6989586621688240917"><span class="hs-identifier hs-var">preActionFunctions</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[FunctionMeta ('Postgres pgKind)]
</span><a href="#local-6989586621688240899"><span class="hs-identifier hs-var">postActionFunctionMeta</span></a></span><span>
</span><span id="line-236"></span><span>
</span><span id="line-237"></span><span>          </span><span class="hs-comment">-- Do not allow overloading functions</span><span>
</span><span id="line-238"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; TxET QErr m () -&gt; TxET QErr m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[QualifiedFunction] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[FunctionName ('Postgres pgKind)]
[QualifiedFunction]
</span><a href="#local-6989586621688240889"><span class="hs-identifier hs-var">overloadedFuncs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TxET QErr m () -&gt; TxET QErr m ())
-&gt; TxET QErr m () -&gt; TxET QErr m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-239"></span><span>            </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; TxET QErr m ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#NotSupported"><span class="hs-identifier hs-var">NotSupported</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; TxET QErr m ()) -&gt; Text -&gt; TxET QErr m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-240"></span><span>              </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;the following tracked function(s) cannot be overloaded: &quot;</span></span><span>
</span><span id="line-241"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[QualifiedFunction] -&gt; Text
forall t (f :: * -&gt; *). (ToTxt t, Foldable f) =&gt; f t -&gt; Text
</span><a href="Data.Text.Extended.html#commaSeparated"><span class="hs-identifier hs-var">commaSeparated</span></a></span><span> </span><span class="annot"><span class="annottext">[FunctionName ('Postgres pgKind)]
[QualifiedFunction]
</span><a href="#local-6989586621688240889"><span class="hs-identifier hs-var">overloadedFuncs</span></a></span><span>
</span><span id="line-242"></span><span>
</span><span id="line-243"></span><span>          </span><span class="hs-comment">-- Report back with an error if cascade is not set</span><span>
</span><span id="line-244"></span><span>          </span><span id="local-6989586621688240882"><span class="annot"><span class="annottext">[SchemaObjId]
</span><a href="#local-6989586621688240882"><span class="hs-identifier hs-var">indirectDeps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SourceName
-&gt; TablesDiff ('Postgres pgKind) -&gt; TxET QErr m [SchemaObjId]
forall (b :: BackendType) (m :: * -&gt; *).
(QErrM m, CacheRM m, Backend b) =&gt;
SourceName -&gt; TablesDiff b -&gt; m [SchemaObjId]
</span><a href="Hasura.RQL.DDL.Schema.Diff.html#getIndirectDependencies"><span class="hs-identifier hs-var">getIndirectDependencies</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688240923"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">TablesDiff ('Postgres pgKind)
</span><a href="#local-6989586621688240895"><span class="hs-identifier hs-var">tablesDiff</span></a></span><span>
</span><span id="line-245"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; TxET QErr m () -&gt; TxET QErr m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SchemaObjId]
</span><a href="#local-6989586621688240882"><span class="hs-identifier hs-var">indirectDeps</span></a></span><span> </span><span class="annot"><span class="annottext">[SchemaObjId] -&gt; [SchemaObjId] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621688240922"><span class="hs-identifier hs-var">cascade</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TxET QErr m () -&gt; TxET QErr m ())
-&gt; TxET QErr m () -&gt; TxET QErr m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SchemaObjId] -&gt; TxET QErr m ()
forall (m :: * -&gt; *). MonadError QErr m =&gt; [SchemaObjId] -&gt; m ()
</span><a href="Hasura.RQL.Types.SchemaCacheTypes.html#reportDependentObjectsExist"><span class="hs-identifier hs-var">reportDependentObjectsExist</span></a></span><span> </span><span class="annot"><span class="annottext">[SchemaObjId]
</span><a href="#local-6989586621688240882"><span class="hs-identifier hs-var">indirectDeps</span></a></span><span>
</span><span id="line-246"></span><span>
</span><span id="line-247"></span><span>          </span><span id="local-6989586621688240875"><span class="annot"><span class="annottext">MetadataModifier
</span><a href="#local-6989586621688240875"><span class="hs-identifier hs-var">metadataUpdater</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WriterT MetadataModifier (TxET QErr m) ()
-&gt; TxET QErr m MetadataModifier
forall (m :: * -&gt; *) w a. Monad m =&gt; WriterT w m a -&gt; m w
</span><span class="hs-identifier hs-var">execWriterT</span></span><span> </span><span class="annot"><span class="annottext">(WriterT MetadataModifier (TxET QErr m) ()
 -&gt; TxET QErr m MetadataModifier)
-&gt; WriterT MetadataModifier (TxET QErr m) ()
-&gt; TxET QErr m MetadataModifier
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-248"></span><span>            </span><span class="hs-comment">-- Purge all the indirect dependents from state</span><span>
</span><span id="line-249"></span><span>            </span><span class="annot"><span class="annottext">[SchemaObjId]
-&gt; (SchemaObjId -&gt; WriterT MetadataModifier (TxET QErr m) ())
-&gt; WriterT MetadataModifier (TxET QErr m) ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="annot"><span class="annottext">[SchemaObjId]
</span><a href="#local-6989586621688240882"><span class="hs-identifier hs-var">indirectDeps</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-250"></span><span>              </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCacheTypes.html#SOSourceObj"><span class="hs-identifier hs-type">SOSourceObj</span></a></span><span> </span><span id="local-6989586621688240871"><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688240871"><span class="hs-identifier hs-var">sourceName</span></a></span></span><span> </span><span id="local-6989586621688240870"><span class="annot"><span class="annottext">AnyBackend SourceObjId
</span><a href="#local-6989586621688240870"><span class="hs-identifier hs-var">objectID</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-251"></span><span>                </span><span class="annot"><span class="annottext">AnyBackend SourceObjId
-&gt; (forall (b :: BackendType).
    BackendMetadata b =&gt;
    SourceObjId b -&gt; WriterT MetadataModifier (TxET QErr m) ())
-&gt; WriterT MetadataModifier (TxET QErr m) ()
forall (c :: BackendType -&gt; Constraint) (i :: BackendType -&gt; *) r.
AllBackendsSatisfy c =&gt;
AnyBackend i -&gt; (forall (b :: BackendType). c b =&gt; i b -&gt; r) -&gt; r
</span><a href="Hasura.SQL.AnyBackend.html#dispatchAnyBackend"><span class="hs-identifier hs-var">AB.dispatchAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Hasura.RQL.Types.Metadata.Backend.html#BackendMetadata"><span class="hs-identifier hs-type">BackendMetadata</span></a></span><span> </span><span class="annot"><span class="annottext">AnyBackend SourceObjId
</span><a href="#local-6989586621688240870"><span class="hs-identifier hs-var">objectID</span></a></span><span> </span><span class="annot"><span class="annottext">((forall (b :: BackendType).
  BackendMetadata b =&gt;
  SourceObjId b -&gt; WriterT MetadataModifier (TxET QErr m) ())
 -&gt; WriterT MetadataModifier (TxET QErr m) ())
-&gt; (forall (b :: BackendType).
    BackendMetadata b =&gt;
    SourceObjId b -&gt; WriterT MetadataModifier (TxET QErr m) ())
-&gt; WriterT MetadataModifier (TxET QErr m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SourceName
-&gt; SourceObjId b
-&gt; WriterT MetadataModifier (TxET QErr m) MetadataModifier
forall (b :: BackendType) (m :: * -&gt; *).
(MonadError QErr m, Backend b) =&gt;
SourceName -&gt; SourceObjId b -&gt; m MetadataModifier
</span><a href="Hasura.RQL.Types.SchemaCacheTypes.html#purgeDependentObject"><span class="hs-identifier hs-var">purgeDependentObject</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688240871"><span class="hs-identifier hs-var">sourceName</span></a></span><span> </span><span class="annot"><span class="annottext">(SourceObjId b
 -&gt; WriterT MetadataModifier (TxET QErr m) MetadataModifier)
-&gt; (MetadataModifier -&gt; WriterT MetadataModifier (TxET QErr m) ())
-&gt; SourceObjId b
-&gt; WriterT MetadataModifier (TxET QErr m) ()
forall (m :: * -&gt; *) a b c.
Monad m =&gt;
(a -&gt; m b) -&gt; (b -&gt; m c) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&gt;=&gt;</span></span><span> </span><span class="annot"><span class="annottext">MetadataModifier -&gt; WriterT MetadataModifier (TxET QErr m) ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span>
</span><span id="line-252"></span><span>              </span><span class="annot"><span class="annottext">SchemaObjId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-253"></span><span>                </span><span class="annot"><span class="annottext">() -&gt; WriterT MetadataModifier (TxET QErr m) ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-254"></span><span>
</span><span id="line-255"></span><span>            </span><span class="hs-comment">-- Purge all dropped functions</span><span>
</span><span id="line-256"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688240865"><span class="annot"><span class="annottext">purgedFuncs :: [QualifiedFunction]
</span><a href="#local-6989586621688240865"><span class="hs-identifier hs-var hs-var">purgedFuncs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((SchemaObjId -&gt; Maybe QualifiedFunction)
 -&gt; [SchemaObjId] -&gt; [QualifiedFunction])
-&gt; [SchemaObjId]
-&gt; (SchemaObjId -&gt; Maybe QualifiedFunction)
-&gt; [QualifiedFunction]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">(SchemaObjId -&gt; Maybe QualifiedFunction)
-&gt; [SchemaObjId] -&gt; [QualifiedFunction]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">[SchemaObjId]
</span><a href="#local-6989586621688240882"><span class="hs-identifier hs-var">indirectDeps</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-257"></span><span>                  </span><span class="annot"><a href="Hasura.RQL.Types.SchemaCacheTypes.html#SOSourceObj"><span class="hs-identifier hs-type">SOSourceObj</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688240863"><span class="annot"><span class="annottext">AnyBackend SourceObjId
</span><a href="#local-6989586621688240863"><span class="hs-identifier hs-var">objectID</span></a></span></span><span>
</span><span id="line-258"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.SchemaCacheTypes.html#SOIFunction"><span class="hs-identifier hs-type">SOIFunction</span></a></span><span> </span><span id="local-6989586621688240861"><span class="annot"><span class="annottext">FunctionName ('Postgres pgKind)
</span><a href="#local-6989586621688240861"><span class="hs-identifier hs-var">qf</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AnyBackend SourceObjId -&gt; Maybe (SourceObjId ('Postgres pgKind))
forall (b :: BackendType) (i :: BackendType -&gt; *).
HasTag b =&gt;
AnyBackend i -&gt; Maybe (i b)
</span><a href="Hasura.SQL.AnyBackend.html#unpackAnyBackend"><span class="hs-identifier hs-var">AB.unpackAnyBackend</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688241228"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AnyBackend SourceObjId
</span><a href="#local-6989586621688240863"><span class="hs-identifier hs-var">objectID</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-259"></span><span>                      </span><span class="annot"><span class="annottext">QualifiedFunction -&gt; Maybe QualifiedFunction
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">FunctionName ('Postgres pgKind)
QualifiedFunction
</span><a href="#local-6989586621688240861"><span class="hs-identifier hs-var">qf</span></a></span><span>
</span><span id="line-260"></span><span>                  </span><span class="annot"><span class="annottext">SchemaObjId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe QualifiedFunction
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-261"></span><span>            </span><span class="annot"><span class="annottext">[QualifiedFunction]
-&gt; (QualifiedFunction -&gt; WriterT MetadataModifier (TxET QErr m) ())
-&gt; WriterT MetadataModifier (TxET QErr m) ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[FunctionName ('Postgres pgKind)]
[QualifiedFunction]
</span><a href="#local-6989586621688240892"><span class="hs-identifier hs-var">droppedFuncs</span></a></span><span> </span><span class="annot"><span class="annottext">[QualifiedFunction] -&gt; [QualifiedFunction] -&gt; [QualifiedFunction]
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">\\</span></span><span> </span><span class="annot"><span class="annottext">[QualifiedFunction]
</span><a href="#local-6989586621688240865"><span class="hs-identifier hs-var">purgedFuncs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((QualifiedFunction -&gt; WriterT MetadataModifier (TxET QErr m) ())
 -&gt; WriterT MetadataModifier (TxET QErr m) ())
-&gt; (QualifiedFunction -&gt; WriterT MetadataModifier (TxET QErr m) ())
-&gt; WriterT MetadataModifier (TxET QErr m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-262"></span><span>              </span><span class="annot"><span class="annottext">MetadataModifier -&gt; WriterT MetadataModifier (TxET QErr m) ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="annot"><span class="annottext">(MetadataModifier -&gt; WriterT MetadataModifier (TxET QErr m) ())
-&gt; (QualifiedFunction -&gt; MetadataModifier)
-&gt; QualifiedFunction
-&gt; WriterT MetadataModifier (TxET QErr m) ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; FunctionName ('Postgres pgKind) -&gt; MetadataModifier
forall (b :: BackendType).
Backend b =&gt;
SourceName -&gt; FunctionName b -&gt; MetadataModifier
</span><a href="Hasura.RQL.Types.Metadata.html#dropFunctionInMetadata"><span class="hs-identifier hs-var">dropFunctionInMetadata</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688241228"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688240923"><span class="hs-identifier hs-var">source</span></a></span><span>
</span><span id="line-263"></span><span>
</span><span id="line-264"></span><span>            </span><span class="hs-comment">-- Process altered functions</span><span>
</span><span id="line-265"></span><span>            </span><span class="annot"><span class="annottext">[(QualifiedFunction, FunctionVolatility)]
-&gt; ((QualifiedFunction, FunctionVolatility)
    -&gt; WriterT MetadataModifier (TxET QErr m) ())
-&gt; WriterT MetadataModifier (TxET QErr m) ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[(FunctionName ('Postgres pgKind), FunctionVolatility)]
[(QualifiedFunction, FunctionVolatility)]
</span><a href="#local-6989586621688240891"><span class="hs-identifier hs-var">alteredFuncs</span></a></span><span> </span><span class="annot"><span class="annottext">(((QualifiedFunction, FunctionVolatility)
  -&gt; WriterT MetadataModifier (TxET QErr m) ())
 -&gt; WriterT MetadataModifier (TxET QErr m) ())
-&gt; ((QualifiedFunction, FunctionVolatility)
    -&gt; WriterT MetadataModifier (TxET QErr m) ())
-&gt; WriterT MetadataModifier (TxET QErr m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621688240857"><span class="annot"><span class="annottext">QualifiedFunction
</span><a href="#local-6989586621688240857"><span class="hs-identifier hs-var">qf</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688240856"><span class="annot"><span class="annottext">FunctionVolatility
</span><a href="#local-6989586621688240856"><span class="hs-identifier hs-var">newTy</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-266"></span><span>              </span><span class="annot"><span class="annottext">Bool
-&gt; WriterT MetadataModifier (TxET QErr m) ()
-&gt; WriterT MetadataModifier (TxET QErr m) ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FunctionVolatility
</span><a href="#local-6989586621688240856"><span class="hs-identifier hs-var">newTy</span></a></span><span> </span><span class="annot"><span class="annottext">FunctionVolatility -&gt; FunctionVolatility -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">FunctionVolatility
</span><a href="Hasura.RQL.Types.Function.html#FTVOLATILE"><span class="hs-identifier hs-var">FTVOLATILE</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(WriterT MetadataModifier (TxET QErr m) ()
 -&gt; WriterT MetadataModifier (TxET QErr m) ())
-&gt; WriterT MetadataModifier (TxET QErr m) ()
-&gt; WriterT MetadataModifier (TxET QErr m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-267"></span><span>                </span><span class="annot"><span class="annottext">Code -&gt; Text -&gt; WriterT MetadataModifier (TxET QErr m) ()
forall (m :: * -&gt; *) a. QErrM m =&gt; Code -&gt; Text -&gt; m a
</span><a href="Hasura.Base.Error.html#throw400"><span class="hs-identifier hs-var">throw400</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="Hasura.Base.Error.html#NotSupported"><span class="hs-identifier hs-var">NotSupported</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; WriterT MetadataModifier (TxET QErr m) ())
-&gt; Text -&gt; WriterT MetadataModifier (TxET QErr m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-268"></span><span>                  </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;type of function &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">QualifiedFunction
</span><a href="#local-6989586621688240857"><span class="hs-identifier hs-var">qf</span></a></span><span> </span><span class="annot"><span class="annottext">QualifiedFunction -&gt; Text -&gt; Text
forall t. ToTxt t =&gt; t -&gt; Text -&gt; Text
</span><a href="Data.Text.Extended.html#%3C%3C%3E"><span class="hs-operator hs-var">&lt;&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; is altered to \&quot;VOLATILE\&quot; which is not supported now&quot;</span></span><span>
</span><span id="line-269"></span><span>
</span><span id="line-270"></span><span>            </span><span class="hs-comment">-- update the metadata with the changes</span><span>
</span><span id="line-271"></span><span>            </span><span class="annot"><span class="annottext">SourceName
-&gt; TableCache ('Postgres pgKind)
-&gt; TablesDiff ('Postgres pgKind)
-&gt; WriterT MetadataModifier (TxET QErr m) ()
forall (b :: BackendType) (m :: * -&gt; *).
(MonadError QErr m, CacheRM m, MonadWriter MetadataModifier m,
 BackendMetadata b) =&gt;
SourceName -&gt; TableCache b -&gt; TablesDiff b -&gt; m ()
</span><a href="Hasura.RQL.DDL.Schema.Diff.html#processTablesDiff"><span class="hs-identifier hs-var">processTablesDiff</span></a></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688240923"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">TableCache ('Postgres pgKind)
</span><a href="#local-6989586621688240918"><span class="hs-identifier hs-var">preActionTables</span></a></span><span> </span><span class="annot"><span class="annottext">TablesDiff ('Postgres pgKind)
</span><a href="#local-6989586621688240895"><span class="hs-identifier hs-var">tablesDiff</span></a></span><span>
</span><span id="line-272"></span><span>
</span><span id="line-273"></span><span>          </span><span class="annot"><span class="annottext">(a, MetadataModifier) -&gt; TxET QErr m (a, MetadataModifier)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621688240901"><span class="hs-identifier hs-var">actionResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MetadataModifier
</span><a href="#local-6989586621688240875"><span class="hs-identifier hs-var">metadataUpdater</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-274"></span><span>
</span><span id="line-275"></span><span>  </span><span class="hs-comment">-- Build schema cache with updated metadata</span><span>
</span><span id="line-276"></span><span>  </span><span class="annot"><span class="annottext">m () -&gt; m ()
forall (m :: * -&gt; *) a. (QErrM m, CacheRM m) =&gt; m a -&gt; m a
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#withNewInconsistentObjsCheck"><span class="hs-identifier hs-var">withNewInconsistentObjsCheck</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-277"></span><span>    </span><span class="annot"><span class="annottext">CacheInvalidations -&gt; MetadataModifier -&gt; m ()
forall (m :: * -&gt; *).
(MetadataM m, CacheRWM m) =&gt;
CacheInvalidations -&gt; MetadataModifier -&gt; m ()
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#buildSchemaCacheWithInvalidations"><span class="hs-identifier hs-var">buildSchemaCacheWithInvalidations</span></a></span><span> </span><span class="annot"><span class="annottext">CacheInvalidations
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">ciSources :: HashSet SourceName
</span><a href="Hasura.RQL.Types.SchemaCache.Build.html#ciSources"><span class="hs-identifier hs-var">ciSources</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; HashSet SourceName
forall a. Hashable a =&gt; a -&gt; HashSet a
</span><span class="hs-identifier hs-var">HS.singleton</span></span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688240923"><span class="hs-identifier hs-var">source</span></a></span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">MetadataModifier
</span><a href="#local-6989586621688240913"><span class="hs-identifier hs-var">metadataUpdater</span></a></span><span>
</span><span id="line-278"></span><span>
</span><span id="line-279"></span><span>  </span><span id="local-6989586621688240848"><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621688240848"><span class="hs-identifier hs-var">postActionSchemaCache</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m SchemaCache
forall (m :: * -&gt; *). CacheRM m =&gt; m SchemaCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#askSchemaCache"><span class="hs-identifier hs-var">askSchemaCache</span></a></span><span>
</span><span id="line-280"></span><span>
</span><span id="line-281"></span><span>  </span><span class="hs-comment">-- Recreate event triggers in hdb_catalog</span><span>
</span><span id="line-282"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688240846"><span class="annot"><span class="annottext">postActionTables :: HashMap QualifiedTable (TableInfo ('Postgres pgKind))
</span><a href="#local-6989586621688240846"><span class="hs-identifier hs-var hs-var">postActionTables</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashMap QualifiedTable (TableInfo ('Postgres pgKind))
-&gt; Maybe (HashMap QualifiedTable (TableInfo ('Postgres pgKind)))
-&gt; HashMap QualifiedTable (TableInfo ('Postgres pgKind))
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">HashMap QualifiedTable (TableInfo ('Postgres pgKind))
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (HashMap QualifiedTable (TableInfo ('Postgres pgKind)))
 -&gt; HashMap QualifiedTable (TableInfo ('Postgres pgKind)))
-&gt; Maybe (HashMap QualifiedTable (TableInfo ('Postgres pgKind)))
-&gt; HashMap QualifiedTable (TableInfo ('Postgres pgKind))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SourceName -&gt; SourceCache -&gt; Maybe (TableCache ('Postgres pgKind))
forall (b :: BackendType).
Backend b =&gt;
SourceName -&gt; SourceCache -&gt; Maybe (TableCache b)
</span><a href="Hasura.RQL.Types.SchemaCache.html#unsafeTableCache"><span class="hs-identifier hs-var">unsafeTableCache</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><a href="Hasura.SQL.Backend.html#Postgres"><span class="hs-identifier hs-type">Postgres</span></a></span><span> </span><span class="annot"><a href="#local-6989586621688241228"><span class="hs-identifier hs-type">pgKind</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SourceName
</span><a href="#local-6989586621688240923"><span class="hs-identifier hs-var">source</span></a></span><span> </span><span class="annot"><span class="annottext">(SourceCache -&gt; Maybe (TableCache ('Postgres pgKind)))
-&gt; SourceCache -&gt; Maybe (TableCache ('Postgres pgKind))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SchemaCache -&gt; SourceCache
</span><a href="Hasura.RQL.Types.SchemaCache.html#scSources"><span class="hs-identifier hs-var hs-var">scSources</span></a></span><span> </span><span class="annot"><span class="annottext">SchemaCache
</span><a href="#local-6989586621688240848"><span class="hs-identifier hs-var">postActionSchemaCache</span></a></span><span>
</span><span id="line-283"></span><span>  </span><span id="local-6989586621688240843"><span class="annot"><span class="annottext">ServerConfigCtx
</span><a href="#local-6989586621688240843"><span class="hs-identifier hs-var">serverConfigCtx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m ServerConfigCtx
forall (m :: * -&gt; *). HasServerConfigCtx m =&gt; m ServerConfigCtx
</span><a href="Hasura.RQL.Types.html#askServerConfigCtx"><span class="hs-identifier hs-var">askServerConfigCtx</span></a></span><span>
</span><span id="line-284"></span><span>  </span><span class="annot"><span class="annottext">m (Either QErr ()) -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; m (Either e a) -&gt; m a
</span><a href="Hasura.Prelude.html#liftEitherM"><span class="hs-identifier hs-var">liftEitherM</span></a></span><span> </span><span class="annot"><span class="annottext">(m (Either QErr ()) -&gt; m ()) -&gt; m (Either QErr ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-285"></span><span>    </span><span class="annot"><span class="annottext">PGSourceConfig -&gt; TxET QErr m () -&gt; m (Either QErr ())
forall (m :: * -&gt; *) a.
(MonadIO m, MonadBaseControl IO m) =&gt;
PGSourceConfig -&gt; TxET QErr m a -&gt; m (Either QErr a)
</span><a href="Hasura.Backends.Postgres.Execute.Types.html#runPgSourceWriteTx"><span class="hs-identifier hs-var">runPgSourceWriteTx</span></a></span><span> </span><span class="annot"><span class="annottext">SourceConfig ('Postgres pgKind)
PGSourceConfig
</span><a href="#local-6989586621688240916"><span class="hs-identifier hs-var">sourceConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(TxET QErr m () -&gt; m (Either QErr ()))
-&gt; TxET QErr m () -&gt; m (Either QErr ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-286"></span><span>      </span><span class="annot"><span class="annottext">[TableInfo ('Postgres pgKind)]
-&gt; (TableInfo ('Postgres pgKind) -&gt; TxET QErr m ())
-&gt; TxET QErr m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashMap QualifiedTable (TableInfo ('Postgres pgKind))
-&gt; [TableInfo ('Postgres pgKind)]
forall k v. HashMap k v -&gt; [v]
</span><span class="hs-identifier hs-var">M.elems</span></span><span> </span><span class="annot"><span class="annottext">HashMap QualifiedTable (TableInfo ('Postgres pgKind))
</span><a href="#local-6989586621688240846"><span class="hs-identifier hs-var">postActionTables</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((TableInfo ('Postgres pgKind) -&gt; TxET QErr m ())
 -&gt; TxET QErr m ())
-&gt; (TableInfo ('Postgres pgKind) -&gt; TxET QErr m ())
-&gt; TxET QErr m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Hasura.RQL.Types.Table.html#TableInfo"><span class="hs-identifier hs-type">TableInfo</span></a></span><span> </span><span id="local-6989586621688240839"><span class="annot"><span class="annottext">TableCoreInfo ('Postgres pgKind)
</span><a href="#local-6989586621688240839"><span class="hs-identifier hs-var">coreInfo</span></a></span></span><span> </span><span class="annot"><span class="annottext">RolePermInfoMap ('Postgres pgKind)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621688240838"><span class="annot"><span class="annottext">EventTriggerInfoMap ('Postgres pgKind)
</span><a href="#local-6989586621688240838"><span class="hs-identifier hs-var">eventTriggers</span></a></span></span><span> </span><span class="annot"><span class="annottext">RolePermInfo ('Postgres pgKind)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-287"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688240837"><span class="annot"><span class="annottext">table :: TableName ('Postgres pgKind)
</span><a href="#local-6989586621688240837"><span class="hs-identifier hs-var hs-var">table</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TableCoreInfo ('Postgres pgKind) -&gt; TableName ('Postgres pgKind)
forall (b :: BackendType) field primaryKeyColumn.
TableCoreInfoG b field primaryKeyColumn -&gt; TableName b
</span><a href="Hasura.RQL.Types.Table.html#_tciName"><span class="hs-identifier hs-var hs-var">_tciName</span></a></span><span> </span><span class="annot"><span class="annottext">TableCoreInfo ('Postgres pgKind)
</span><a href="#local-6989586621688240839"><span class="hs-identifier hs-var">coreInfo</span></a></span><span>
</span><span id="line-288"></span><span>            </span><span id="local-6989586621688240835"><span class="annot"><span class="annottext">columns :: [ColumnInfo ('Postgres pgKind)]
</span><a href="#local-6989586621688240835"><span class="hs-identifier hs-var hs-var">columns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FieldInfoMap (FieldInfo ('Postgres pgKind))
-&gt; [ColumnInfo ('Postgres pgKind)]
forall (backend :: BackendType).
FieldInfoMap (FieldInfo backend) -&gt; [ColumnInfo backend]
</span><a href="Hasura.RQL.Types.Table.html#getCols"><span class="hs-identifier hs-var">getCols</span></a></span><span> </span><span class="annot"><span class="annottext">(FieldInfoMap (FieldInfo ('Postgres pgKind))
 -&gt; [ColumnInfo ('Postgres pgKind)])
-&gt; FieldInfoMap (FieldInfo ('Postgres pgKind))
-&gt; [ColumnInfo ('Postgres pgKind)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TableCoreInfo ('Postgres pgKind)
-&gt; FieldInfoMap (FieldInfo ('Postgres pgKind))
forall (b :: BackendType) field primaryKeyColumn.
TableCoreInfoG b field primaryKeyColumn -&gt; FieldInfoMap field
</span><a href="Hasura.RQL.Types.Table.html#_tciFieldInfoMap"><span class="hs-identifier hs-var hs-var">_tciFieldInfoMap</span></a></span><span> </span><span class="annot"><span class="annottext">TableCoreInfo ('Postgres pgKind)
</span><a href="#local-6989586621688240839"><span class="hs-identifier hs-var">coreInfo</span></a></span><span>
</span><span id="line-289"></span><span>        </span><span class="annot"><span class="annottext">[(TriggerName, EventTriggerInfo ('Postgres pgKind))]
-&gt; ((TriggerName, EventTriggerInfo ('Postgres pgKind))
    -&gt; TxET QErr m ())
-&gt; TxET QErr m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventTriggerInfoMap ('Postgres pgKind)
-&gt; [(TriggerName, EventTriggerInfo ('Postgres pgKind))]
forall k v. HashMap k v -&gt; [(k, v)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfoMap ('Postgres pgKind)
</span><a href="#local-6989586621688240838"><span class="hs-identifier hs-var">eventTriggers</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((TriggerName, EventTriggerInfo ('Postgres pgKind))
  -&gt; TxET QErr m ())
 -&gt; TxET QErr m ())
-&gt; ((TriggerName, EventTriggerInfo ('Postgres pgKind))
    -&gt; TxET QErr m ())
-&gt; TxET QErr m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621688240833"><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621688240833"><span class="hs-identifier hs-var">triggerName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621688240832"><span class="annot"><span class="annottext">EventTriggerInfo ('Postgres pgKind)
</span><a href="#local-6989586621688240832"><span class="hs-identifier hs-var">eti</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-290"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621688240831"><span class="annot"><span class="annottext">opsDefinition :: TriggerOpsDef ('Postgres pgKind)
</span><a href="#local-6989586621688240831"><span class="hs-identifier hs-var hs-var">opsDefinition</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo ('Postgres pgKind)
-&gt; TriggerOpsDef ('Postgres pgKind)
forall (b :: BackendType). EventTriggerInfo b -&gt; TriggerOpsDef b
</span><a href="Hasura.RQL.Types.EventTrigger.html#etiOpsDef"><span class="hs-identifier hs-var hs-var">etiOpsDef</span></a></span><span> </span><span class="annot"><span class="annottext">EventTriggerInfo ('Postgres pgKind)
</span><a href="#local-6989586621688240832"><span class="hs-identifier hs-var">eti</span></a></span><span>
</span><span id="line-291"></span><span>          </span><span class="annot"><span class="annottext">(ReaderT ServerConfigCtx (TxET QErr m) ()
 -&gt; ServerConfigCtx -&gt; TxET QErr m ())
-&gt; ServerConfigCtx
-&gt; ReaderT ServerConfigCtx (TxET QErr m) ()
-&gt; TxET QErr m ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">ReaderT ServerConfigCtx (TxET QErr m) ()
-&gt; ServerConfigCtx -&gt; TxET QErr m ()
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">ServerConfigCtx
</span><a href="#local-6989586621688240843"><span class="hs-identifier hs-var">serverConfigCtx</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT ServerConfigCtx (TxET QErr m) () -&gt; TxET QErr m ())
-&gt; ReaderT ServerConfigCtx (TxET QErr m) () -&gt; TxET QErr m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TriggerName
-&gt; QualifiedTable
-&gt; [ColumnInfo ('Postgres pgKind)]
-&gt; TriggerOpsDef ('Postgres pgKind)
-&gt; ReaderT ServerConfigCtx (TxET QErr m) ()
forall (pgKind :: PostgresKind) (m :: * -&gt; *).
(Backend ('Postgres pgKind), MonadTx m,
 MonadReader ServerConfigCtx m) =&gt;
TriggerName
-&gt; QualifiedTable
-&gt; [ColumnInfo ('Postgres pgKind)]
-&gt; TriggerOpsDef ('Postgres pgKind)
-&gt; m ()
</span><a href="Hasura.Backends.Postgres.DDL.EventTrigger.html#mkAllTriggersQ"><span class="hs-identifier hs-var">mkAllTriggersQ</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerName
</span><a href="#local-6989586621688240833"><span class="hs-identifier hs-var">triggerName</span></a></span><span> </span><span class="annot"><span class="annottext">TableName ('Postgres pgKind)
QualifiedTable
</span><a href="#local-6989586621688240837"><span class="hs-identifier hs-var">table</span></a></span><span> </span><span class="annot"><span class="annottext">[ColumnInfo ('Postgres pgKind)]
</span><a href="#local-6989586621688240835"><span class="hs-identifier hs-var">columns</span></a></span><span> </span><span class="annot"><span class="annottext">TriggerOpsDef ('Postgres pgKind)
</span><a href="#local-6989586621688240831"><span class="hs-identifier hs-var">opsDefinition</span></a></span><span>
</span><span id="line-292"></span><span>
</span><span id="line-293"></span><span>  </span><span class="annot"><span class="annottext">a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621688240914"><span class="hs-identifier hs-var">actionResult</span></a></span><span>
</span><span id="line-294"></span></pre></body></html>